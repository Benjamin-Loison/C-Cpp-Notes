<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-08-16 Tue 23:27 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CPP / C++ Notes - Windows API Programming Win32</title>
<meta name="generator" content="Org mode" />
<meta name="description" content="cpp/c++ code examples and demonstrations."
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
<link href="theme/org-nav-theme.css" rel="stylesheet">
<script src="theme/org-nav-theme.js"></script>
<link rel="icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "%LINEBREAKS" },
                        webFont: "%FONT"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "%LINEBREAKS" },
              font: "%FONT"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "%AUTONUMBER"},
               MultLineWidth: "%MULTLINEWIDTH",
               TagSide: "%TAGSIDE",
               TagIndent: "%TAGINDENT"
             }
});
</script>
<script type="text/javascript"
        src="theme/MathJax/MathJax.js"></script>
</head>
<body>
<div id="content">
<h1 class="title">CPP / C++ Notes - Windows API Programming Win32</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org56b2990">1. Windows API Programming Win32</a>
<ul>
<li><a href="#orge5b642f">1.1. Overview</a></li>
<li><a href="#org8848e96">1.2. [DRAFT] Windows API Idiosyncrasies</a></li>
<li><a href="#orgc26b928">1.3. Windows Tools and Configurations</a>
<ul>
<li><a href="#orgf783619">1.3.1. Tools Shortcuts</a></li>
<li><a href="#org2a3370f">1.3.2. File Path of Development Tools</a></li>
<li><a href="#org5202384">1.3.3. Configuration</a></li>
</ul>
</li>
<li><a href="#org4fa8c53">1.4. Windows API Main Header Files</a></li>
<li><a href="#org665eed9">1.5. Windows API Runtime Libraries</a></li>
<li><a href="#org009738a">1.6. Windows Object Code Binary Format and Scripting Languages</a></li>
<li><a href="#orgd6f4cb7">1.7. WinAPI C Data Types</a>
<ul>
<li><a href="#orgd793a7d">1.7.1. Hungarian Notation</a></li>
<li><a href="#orgeb219a9">1.7.2. General Terminology</a></li>
<li><a href="#org4b917b5">1.7.3. Common Data Types</a></li>
<li><a href="#org4b29149">1.7.4. Other data types</a></li>
<li><a href="#orga2ea014">1.7.5. References</a></li>
</ul>
</li>
<li><a href="#orgab9a79f">1.8. SAL - Source Code Annotation Language</a></li>
<li><a href="#org4ab85d3">1.9. Character Encoding in WinAPI - ANSI x utf8 x utf16 (wchar_t)</a>
<ul>
<li><a href="#org66393ef">1.9.1. Overview</a></li>
<li><a href="#org402cf3c">1.9.2. Unicode UTF8 X Wide Unicode C-strign functions</a></li>
<li><a href="#org4e8e80f">1.9.3. Example - ANSI X Unicode and Windows API</a></li>
</ul>
</li>
<li><a href="#org5938d15">1.10. Environment Variables</a>
<ul>
<li><a href="#orgee6bf5c">1.10.1. Overview</a></li>
<li><a href="#orgf3e0718">1.10.2. Usage of Windows environemnt variables</a></li>
</ul>
</li>
<li><a href="#org5698388">1.11. Primitive IO - Input/Ouput</a>
<ul>
<li><a href="#org895b92b">1.11.1. Overview</a></li>
<li><a href="#orge820c1b">1.11.2. Sample code</a></li>
</ul>
</li>
<li><a href="#org96a01aa">1.12. System Information</a>
<ul>
<li><a href="#org0f7f00d">1.12.1. Oveview</a></li>
<li><a href="#orge40379f">1.12.2. C++ Sample Code Version</a></li>
<li><a href="#org7c8f595">1.12.3. D - DLang Sample Code Version</a></li>
<li><a href="#org2e2e6c0">1.12.4. Rust Sample Code Version</a></li>
</ul>
</li>
<li><a href="#orgce0e94f">1.13. Windows Shortcut - LNK</a>
<ul>
<li><a href="#orgba86700">1.13.1. Overview</a></li>
<li><a href="#org7ff9fa5">1.13.2. Creating shell link</a></li>
<li><a href="#orgc5f76ae">1.13.3. Reading shell link</a></li>
</ul>
</li>
<li><a href="#org565c948">1.14. Windows Registry</a>
<ul>
<li><a href="#org70b8652">1.14.1. Overview</a></li>
<li><a href="#org9077c43">1.14.2. Notable Registry Locations</a></li>
<li><a href="#orgdfb6f1d">1.14.3. Sample Code</a></li>
</ul>
</li>
<li><a href="#orgc3b932c">1.15. Capturing OutputDebugString output</a></li>
<li><a href="#org97179fd">1.16. Listing Windows and Related Processes</a></li>
<li><a href="#orge50f8ce">1.17. Access Tokens</a>
<ul>
<li><a href="#orgb0967cb">1.17.1. Overview</a></li>
<li><a href="#org0332ecb">1.17.2. Inspecting access tokens</a></li>
</ul>
</li>
<li><a href="#org9b8222a">1.18. Reading and writing process memory</a>
<ul>
<li><a href="#orga03e314">1.18.1. Overview</a></li>
<li><a href="#org50b186a">1.18.2. Sample code</a></li>
</ul>
</li>
<li><a href="#org18f7d8b">1.19. Running machine code at runtime</a></li>
<li><a href="#org8c3a48f">1.20. CODE - Display information about current process</a></li>
<li><a href="#org7e7a27a">1.21. CODE - List processes</a></li>
<li><a href="#orgbee611b">1.22. CODE - Show all DLLs or modules load by a process</a></li>
<li><a href="#org13b6906">1.23. CODE - Show files and directories attributes&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cmake">cmake</span>&#xa0;<span class="build">build</span>&#xa0;<span class="demo">demo</span>&#xa0;<span class="code">code</span></span></a></li>
<li><a href="#orge83cfbc">1.24. CODE - List directory files</a></li>
<li><a href="#orgc683efc">1.25. CODE - Enumerate Logical Drivers</a></li>
<li><a href="#org0579ae0">1.26. CODE - Launching and controlling sub-processes</a></li>
<li><a href="#orgbb834bb">1.27. Windows Socket - Winsock</a>
<ul>
<li><a href="#orgbed4c02">1.27.1. Overview</a></li>
<li><a href="#orge8a20ed">1.27.2. CODE - Show IPv4 address of a hostname</a></li>
<li><a href="#orgc4f4900">1.27.3. CODE - Basic Socket Client</a></li>
</ul>
</li>
<li><a href="#org3c4e25f">1.28. WinlNet and UrlMon - APIs for HTTP and FTP protocol</a>
<ul>
<li><a href="#orgec1e9ab">1.28.1. Overview</a></li>
<li><a href="#orgbd0216f">1.28.2. Example</a></li>
<li><a href="#org99cd734">1.28.3. Reference</a></li>
</ul>
</li>
<li><a href="#orgdaeac3a">1.29. Remote repl - telnet-like application</a></li>
<li><a href="#org539fc36">1.30. Embed Resources into Executables</a></li>
<li><a href="#org902305e">1.31. Graphical User Interfaces - WinAPI</a>
<ul>
<li><a href="#org8d403cf">1.31.1. Minimal GUI Program - "hello world"</a></li>
<li><a href="#orgb100170">1.31.2. GUI without WinMain</a></li>
<li><a href="#org3c2c081">1.31.3. GUI without WinMain in DLang (D)</a></li>
<li><a href="#org26b50bc">1.31.4. GUI without WinMain in Rust</a></li>
</ul>
</li>
<li><a href="#org9ccc12a">1.32. Cross-compiling WxWidgets for Windows from Linux</a></li>
<li><a href="#org326a385">1.33. Loading DLLs - shared libraries at runtime</a>
<ul>
<li><a href="#orgbabd084">1.33.1. Example 1 - Basic Dynamic Loading DLL</a></li>
<li><a href="#org89b5d0a">1.33.2. Example 2 - Dynamic loading with a class Wrapper</a></li>
</ul>
</li>
<li><a href="#org259ca1d">1.34. Runnable Shared Libraries DLLs - rundll32</a>
<ul>
<li><a href="#org8c72def">1.34.1. Overview</a></li>
<li><a href="#orgac1eed0">1.34.2. Creating a runnable DLL</a></li>
<li><a href="#orgab1f868">1.34.3. Creating a DLL runner</a></li>
</ul>
</li>
<li><a href="#org1b24ce0">1.35. Read metadata from Windows PE Portable Executable files</a></li>
<li><a href="#orgaa2ec3c">1.36. Install Development Tools and Compilers</a>
<ul>
<li><a href="#orgf268d40">1.36.1. C++ Compilers</a></li>
<li><a href="#org086328b">1.36.2. IDEs and Text Editors</a></li>
<li><a href="#org4ffc588">1.36.3. Essential Windows Instrospection and Debugging Tools</a></li>
<li><a href="#orge3806a4">1.36.4. Other Tools</a></li>
</ul>
</li>
<li><a href="#org0e5a061">1.37. WINAPI Map</a>
<ul>
<li><a href="#orgd4a53b9">1.37.1. Misc.</a></li>
<li><a href="#org4b087a7">1.37.2. Header Files</a></li>
<li><a href="#org542d330">1.37.3. Common HRESULT values</a></li>
<li><a href="#org466ad11">1.37.4. Typedefs</a></li>
<li><a href="#org8be6048">1.37.5. Console</a></li>
<li><a href="#org5d1567a">1.37.6. Memory Allocation</a></li>
<li><a href="#org69eaebe">1.37.7. File</a></li>
<li><a href="#org984b538">1.37.8. Handle - Kernel "Objects"</a></li>
<li><a href="#org5081219">1.37.9. Process Creation</a></li>
<li><a href="#org4605397">1.37.10. Process Information</a></li>
<li><a href="#orgea53c4f">1.37.11. Process Manipulation</a></li>
<li><a href="#orge5a362a">1.37.12. GUI _ Graphical User Interface</a></li>
<li><a href="#org4e24cf6">1.37.13. Dynamic Linking or Runtime Linking</a></li>
</ul>
</li>
<li><a href="#orgaf0962a">1.38. Books</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org56b2990" class="outline-2">
<h2 id="org56b2990"><span class="section-number-2">1</span> Windows API Programming Win32</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orge5b642f" class="outline-3">
<h3 id="orge5b642f"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The Windows API is very low level and obviously-Windows only,
therefore it makes sense in most of cases to take advantage of higher
libraries which encapsulates this API in a C++-friendly. Some of those
libraries are: 
</p>

<p>
Windows-Only  (Microsft-only)
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/cpp/mfc/mfc-and-atl?view=vs-2017">MFC</a> - Microsoft Foundation Classes</li>
<li><a href="https://docs.microsoft.com/en-us/cpp/atl/atl-com-desktop-components?view=vs-2017">ATL</a> - Active Template Library</li>
</ul>

<p>
Windows-Only - Third party.
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Windows_Template_Library">WTL</a> - Windows Template Library - Created by Microsft and later
become opensourced at 2004.
<ul class="org-ul">
<li>Web site: <a href="http://wtl.sourceforge.net/">http://wtl.sourceforge.net/</a></li>
</ul></li>

<li><a href="http://win32-framework.sourceforge.net/">Win32++</a> - "Win32++ is a C++ library used to build windows
applications. Win32++ is a free alternative to MFC. It has the
added advantage of being able to run on a wide range of free
compilers, including Visual Studio Community, and the MinGW
compiler provided with CodeBlocks and Dev-C++."</li>
</ul>

<p>
Cross-Platform: 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Qt_(software)">QT Framework</a> - QT is not only a cross platform GUI library, it
also provides all sort of cross platform libraries for databases,
sockets, text parsing, OpenGL, XML and so on. 
<ul class="org-ul">
<li>Supported on: Windows, MacOSX, Linux, Android, iOS and many other
operating systems.</li>
</ul></li>

<li><a href="https://en.wikipedia.org/wiki/WxWidgets">wxWidgets</a> - Just a well known GUI library.
<ul class="org-ul">
<li>Supported on: Windows, Linux, OSX.</li>
</ul></li>

<li><a href="https://pocoproject.org/docs/">Poco - Framework</a> - A collection of cross-platform libraries
for network: HTTP protocol, FTP, ICMP; database access - SQLite,
MySQL, ODBC and MongoDB; Standardized human-readable data exchange
formats - JSON  and XML; Zip compression; SSL and crypto utils.
<ul class="org-ul">
<li>See: <a href="https://en.wikipedia.org/wiki/POCO_C++_Libraries">POCO C++ Libraries - Wikipedia</a></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org8848e96" class="outline-3">
<h3 id="org8848e96"><span class="section-number-3">1.2</span> [DRAFT] Windows API Idiosyncrasies</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Hungarian Notation</li>

<li>Non standard types:
<ul class="org-ul">
<li>LPSTRING, WORD, DWORD, BOOL, LPVOID &#x2026;</li>
</ul></li>

<li>Paths: Unlike in U*nix-like operating systems which are written
with (/) forward slash, in Windows paths  are written with
backward slash (\) needs to be escaped with double backward slash (\\)
since is slash is used for escape characters such as CR <code>\n</code>, <code>\s</code> and
so on. Thus, a Windows path such as <code>"C:\Users\sombody\file.exe"</code> must be
written as "C:\\Users\\sombody\\file.exe".</li>

<li>Different Calling Conventions in the same OS: (Note: Only for 32 bits x86)
<ul class="org-ul">
<li><code>__stdcall</code></li>
<li><code>__cdecl</code></li>
<li><code>__fastcall</code></li>
</ul></li>

<li>Characters - ANSI X Unicode in API. 
<ul class="org-ul">
<li>Windows API uses 16-bits Unicode wide characters (wchar_t) instead
of 8 bits Unicode UTF-8 which is common in most modern Unix-like
Oses such as Linux, BSD and MacOSX.</li>

<li>Windows API functions generally has two versions, an ANSI
version with suffix 'A' and a wide unicode version with suffix
'W'. For instance the API <span class="underline">CreateDirectory</span>, has an ANSI version (which uses char)
and does not work with UTF8 characteres such as 'ã', 'õ', 'ç', '
我', 'Ж' and so on. And an wide unicode version using wide
character (wchar_t) CreateDirectoryW.</li>
</ul></li>

<li>Many string types</li>

<li>Many C-runtimes and entry points.</li>

<li>Functions has many parameters which makes them pretty complex. The
only way to understand the API is to compile and run small
specific examples.</li>

<li>Not all system calls are documented like open source OSes such as
Linux or BSD.</li>
</ul>
</div>
</div>

<div id="outline-container-orgc26b928" class="outline-3">
<h3 id="orgc26b928"><span class="section-number-3">1.3</span> Windows Tools and Configurations</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-orgf783619" class="outline-4">
<h4 id="orgf783619"><span class="section-number-4">1.3.1</span> Tools Shortcuts</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
This table compiles of Windows' built-in tools for enabling faster
system configuration, debugging and troubleshooting. Those tools
listed in the following table can be opened by typing the command at
the shell (cmd.exe), powershell (powershell.exe) or by using
<span class="underline">Windows-Key + R</span> keybind and then typing the command.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Tool/Command</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><b>System Settings</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Edit Environment Variables</td>
<td class="org-left">rundll32.exe sysdm.cpl,EditEnvironmentVariables</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">System settings and information</td>
<td class="org-left">control.exe system</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Windows Registry</td>
<td class="org-left">regedit</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Services and boot configuration</td>
<td class="org-left">msconfig</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Security Center</td>
<td class="org-left">wscui.cpl</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Services</td>
<td class="org-left">services.msc</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Shared Folders</td>
<td class="org-left">fsmgmt.msc</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">System Information</td>
<td class="org-left">msinfo32</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">User account management</td>
<td class="org-left">Rundll32.exe keymgr.dll,KRShowKeyMgr</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">System Properties / Remote Tab</td>
<td class="org-left">Rundll32.exe shell32.dll,Control_RunDLL Sysdm.cpl,,5</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Component Services - COM, DCOM</td>
<td class="org-left">comexp.msc</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Device Manager</td>
<td class="org-left">devmgmt.msc</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TPM - Trusted Platform Module management</td>
<td class="org-left">tmp.msc</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Install/Unninstall new display languages</td>
<td class="org-left">lpksetup.exe</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><b>Utilities</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Tool for taking screenshot</td>
<td class="org-left">snippingtool</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Task manager</td>
<td class="org-left">taskmgr</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Backup and Restore Utility</td>
<td class="org-left">sdclt</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Certificate Manager</td>
<td class="org-left">certmgr.msc</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Encrypted File System Wizard</td>
<td class="org-left">rekeywiz</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Remote Desktop</td>
<td class="org-left">mstsc</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><b>General</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">View system logs and events</td>
<td class="org-left">eventvwr or eventvwr.exe</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Windows Version</td>
<td class="org-left">winver or winver.exe</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">System restore</td>
<td class="org-left">restrui.exe</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Details about hardware</td>
<td class="org-left">msinfo32</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">DirectX and OpenGL diagnosing tool</td>
<td class="org-left">dxdiag</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Disks and partitions</td>
<td class="org-left">diskmgmt.msc</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><b>Command Line</b> (terminal-only)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Windows version</td>
<td class="org-left">ver</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Summarized system information (CLI only)</td>
<td class="org-left">systeminfo</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">OS information and build number</td>
<td class="org-left">wmic os list brief</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Show all environment variables</td>
<td class="org-left">set</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Network interfaces and local IP address (CLI only)</td>
<td class="org-left">ipconfig</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Show ARP table</td>
<td class="org-left">arp -A</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List all active network connections TCP/IP</td>
<td class="org-left">netstat -ano</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>Processes and services</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List all processes</td>
<td class="org-left">tasklist</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Show all running services</td>
<td class="org-left">sc query</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Show all running services</td>
<td class="org-left">sc queryex</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List all services using WMIC tool</td>
<td class="org-left">wmic service get processid,name,startname,pathname</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List all services in a concise way (brief)</td>
<td class="org-left">wmic service list brief</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Terminate a process using its PID</td>
<td class="org-left">taskkill &lt;PID&gt;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Terminate a process by name (notepad.exe - in this case)</td>
<td class="org-left">taskkill /F /IM notepad.exe</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>Files and Directorires</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Enter a directory</td>
<td class="org-left">cd C:\Users\myser\directory</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Enter disk E: directory</td>
<td class="org-left">E:</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Print a file in command line (akin to Unix's cat)</td>
<td class="org-left">type &lt;FILE&gt;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Delete a file</td>
<td class="org-left">del &lt;FILE&gt;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List current directory</td>
<td class="org-left">dir</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List directory</td>
<td class="org-left">dir &lt;DIRECTORY&gt;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>Users</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Show current user</td>
<td class="org-left">whoami</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Current user's privileges</td>
<td class="org-left">whoami /priv</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Current user's groups</td>
<td class="org-left">whoami /groups</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List user accounts</td>
<td class="org-left">wmic useraccount</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List user accounts brief</td>
<td class="org-left">wmic useraccount list brief</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>Windwos Network and SMB</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List network shares (SMB / SAMBA)</td>
<td class="org-left">wmic share list</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List printers</td>
<td class="org-left">wmic printer list brief</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Installed patches and hotfixes</td>
<td class="org-left">wmic qfe</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>Disks and BIOS</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List disks</td>
<td class="org-left">wmic diskdrive list brief</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List logical disks (C:, E:, &#x2026;)</td>
<td class="org-left">wmic logicaldisk list brief</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List all disks partitions</td>
<td class="org-left">wmic partition get name,size,type</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">List disks and their serial numer</td>
<td class="org-left">wmic diskdrive get Name,Model,SerialNumber,Status</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Get BIOS serial number</td>
<td class="org-left">wmic bios get name,serialnumber,version</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>Shutdown and reboot</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Reboot computer</td>
<td class="org-left">shutdown /r</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Reboot immediately</td>
<td class="org-left">shutdown /r /t 0</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Shutdown computer</td>
<td class="org-left">shutdown /s</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Loggof from current session</td>
<td class="org-left">shutdown /l</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Abort previous shutdown command</td>
<td class="org-left">shutdown /a</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>System Logs</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">View last 5 application logs</td>
<td class="org-left">wevtutil qe Application /f:text /rd:true /c:10</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">View System logs (last 5)</td>
<td class="org-left">wevtutil qe System /f:text /rd:true</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">View Security logs (last 5)</td>
<td class="org-left">wevtutil qe Security /f:text /rd:true</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">View Setup log</td>
<td class="org-left">wevtutil qe Setup /f:text /rd:true</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Clean application logs</td>
<td class="org-left">wevtutil cl Application</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Note: 
</p>
<ul class="org-ul">
<li>Any executable in %PATH% variable can be called without .exe
extension, for instance, <span class="underline">$ notepad.exe</span> can be called with <span class="underline">$ notepad</span>.</li>
<li>(CLI only) =&gt; Command line only, the command only works on terminal (cmd.exe).</li>
<li>A Windows service is similar to a Unix daemon, it is a program that continously
runs in background and does not have any graphical interface</li>
<li>WMIC - Windows Management Instrumentation</li>
</ul>


<p>
<b>Shell folders shortcuts for quick access</b> 
</p>

<p>
The following commands can be run from the terminal or by using the
keybind Windows-Key + R that opens the execute dialog. 
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">shell shortcut</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>User's directories</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Open users home directory %USERPROFILE%</td>
<td class="org-left"><code>shell:profile</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open libraries folder</td>
<td class="org-left"><code>shell:libraries</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open start menu programs folders</td>
<td class="org-left"><code>shell:programs</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">View intalled windows updates</td>
<td class="org-left"><code>shell:AppUpdatesFolder</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open recent documents folder</td>
<td class="org-left"><code>shell:recent</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open sendto folder</td>
<td class="org-left"><code>shell:sendto</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open startup folder</td>
<td class="org-left"><code>shell:startup</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open templates folder</td>
<td class="org-left"><code>shell:templates</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open user pinned folders</td>
<td class="org-left"><code>shell:user pinned</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>System directories</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Open <code>C:\Windows</code> directory</td>
<td class="org-left"><code>shell:windows</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open <code>C:\Windows\System32</code>  folder</td>
<td class="org-left"><code>shell:system</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open SysWow64 folder</td>
<td class="org-left"><code>shell:systemx86</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open <code>C:\Windows\Fonts</code></td>
<td class="org-left"><code>shell:fonts</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Open Resources folder (contains windows themes)</td>
<td class="org-left"><code>shell:themes</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Browse Implicit apps shortcut</td>
<td class="org-left"><code>shell:ImplicitAppShortcuts</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Open shell folder on terminal:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ start <span class="org-string">""</span> <span class="org-string">"shell:systemx86"</span>
</pre>
</div>

<p>
Open Shell folder through Windows-Key + R:
</p>

<ol class="org-ol">
<li>Type Windows-Key + R</li>
<li>Type the shortcu, for instance: <code>shell:windows</code></li>
</ol>


<p>
Open shell folder through explorer.exe 
</p>

<ul class="org-ul">
<li>Type the shell shortcut in explorer.exe, for instance: <code>shell:themes</code></li>
</ul>


<p>
<b>Mounting remote SMB (Server Message Block) network shares</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ net use &lt;DISK&gt; &lt;HOSTNAME&gt;<span class="org-string">\&lt;</span>SHARED-FOLDER&gt; /user:&lt;USERNAME&gt; &lt;PASSWORD&gt; 
</pre>
</div>

<p>
Example: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Example 1 </span>
$ net use z: <span class="org-string">\\</span>10.0.0.2\data  /user:myuser  mypasswd 

<span class="org-comment-delimiter"># </span><span class="org-comment">Example 2 - using computer Netbios name </span>
$ net use z:  mycomputername\data  /user:myuser  mypasswd 

<span class="org-comment-delimiter"># </span><span class="org-comment">Example 3 - using computer Netbios name and with persistence </span>
$ net use z:  <span class="org-string">\\</span>mycomputername\data /persistant:yes  /user:myuser  mypasswd 

   <span class="org-comment-delimiter"># </span><span class="org-comment">-------------------------------------# </span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Enter in the disk mapped to the network share </span>
$ z: 

<span class="org-comment-delimiter"># </span><span class="org-comment">List files in the network share disk </span>
$ dir z:
</pre>
</div>
</div>
</div>
<div id="outline-container-org2a3370f" class="outline-4">
<h4 id="org2a3370f"><span class="section-number-4">1.3.2</span> File Path of Development Tools</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
<b>Powershell x64</b>
</p>

<p>
Powershell:
</p>

<div class="org-src-container">
<pre class="src src-sh">%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe
</pre>
</div>

<p>
Powershell ISE 
</p>

<div class="org-src-container">
<pre class="src src-sh">%windir%\system32\WindowsPowerShell\v1.0\PowerShell_ISE.exe  
</pre>
</div>

<p>
<b>Powershell x86</b> 
</p>

<p>
Powershell:
</p>

<div class="org-src-container">
<pre class="src src-sh">%windir%\syswow64\WindowsPowerShell\v1.0\PowerShell_ISE.exe
</pre>
</div>

<p>
Powershell ISE 
</p>

<div class="org-src-container">
<pre class="src src-sh">%windir%\syswow64\WindowsPowerShell\v1.0\PowerShell_ISE.exe
</pre>
</div>

<p>
<b>Loading MSVC x86-64 (64 bits) (Visual Studio Compiler)</b> 
</p>

<p>
Available at: <a href="https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2019">MSCVC build tools download</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Load MSVC environment variables. </span>
$  %comspec%  /k <span class="org-string">"C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Auxiliary\Build\vcvars64.bat"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Get tooling location </span>
$ where cl.exe
<span class="org-function-name">C</span>:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30037\bin\Hostx64\x64\cl.exe

$ where link.exe
<span class="org-function-name">C</span>:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30037\bin\Hostx64\x64\link.exe
<span class="org-function-name">C</span>:\Users\unix\scoop\apps\git\current\usr\bin\link.exe

$ where dumpbin.exe
<span class="org-function-name">C</span>:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30037\bin\Hostx64\x64\dumpbin.exe
</pre>
</div>

<p>
Once MSVC configuration is loaded, sources can be compiled from
command line using commands like the following:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe application.cpp /Fe:tkinfo.exe /EHsc /Zi /DEBUG advapi32.lib

<span class="org-function-name">Microsoft</span> (R) C/C++ Optimizing Compiler Version 19.29.30037 for x64
<span class="org-function-name">Copyright</span> (C) Microsoft Corporation.  All rights reserved.

tokeninfo.cpp
<span class="org-function-name">Microsoft</span> (R) Incremental Linker Version 14.29.30037.0
<span class="org-function-name">Copyright</span> (C) Microsoft Corporation.  All rights reserved.

<span class="org-function-name">/out</span>:tkinfo.exe
/debug
tokeninfo.obj
advapi32.lib
</pre>
</div>

<p>
<b>Loading MSVC x86 (32 bits) compiler tools</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ %comspec% /k <span class="org-string">"C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Auxiliary\Build\vcvars32.bat"</span>
**********************************************************************
** Visual Studio 2019 Developer Command Prompt v16.10.0
** Copyright (c) 2021 Microsoft Corporation
**********************************************************************
[vcvarsall.bat] Environment initialized for: <span class="org-string">'x86'</span>

<span class="org-function-name">C</span>:\Users\unix&gt;where cl.exe
<span class="org-function-name">C</span>:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30037\bin\Hostx86\x86\cl.exe

$ where link.exe
<span class="org-function-name">C</span>:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30037\bin\Hostx86\x86\link.exe

$ where dumpbin.exe
<span class="org-function-name">C</span>:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30037\bin\Hostx86\x86\dumpbin.exe
</pre>
</div>


<p>
<b>Windows Debugger Tools 64 bits</b> ( Note: <a href="https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk/">available at Windows 10 SDK</a> )
</p>

<p>
Windbg (Windows Graphics Debugger - command line)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-string">"C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe"</span>
</pre>
</div>

<p>
CDB Debugger (Windows command line debugger 64 bits)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-string">"C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\cdb.exe"</span>
</pre>
</div>

<p>
<b>Windows Debugger Tools 32 bits</b> 
</p>

<p>
Windbg (Windows Graphics Debugger - command line)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-string">"C:\Program Files (x86)\Windows Kits\10\Debuggers\x86\windbg.exe"</span>  
</pre>
</div>

<p>
CDB Debugger (Windows command line debugger 64 bits)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-string">"C:\Program Files (x86)\Windows Kits\10\Debuggers\x86\cdb.exe"</span> 
</pre>
</div>
</div>
</div>
<div id="outline-container-org5202384" class="outline-4">
<h4 id="org5202384"><span class="section-number-4">1.3.3</span> Configuration</h4>
<div class="outline-text-4" id="text-1-3-3">
<p>
<b>Editing Evironemnt Variables</b>
</p>

<p>
In order to be able to launch tools from command line just by typing
their name, such as MSBuild.exe or cmake.exe, the directories where
are those tools need to be in the $PATH variable. This variable can be
edited by using the control panel or the following command which
opens the control panel at editing environment variables tab: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ rundll32.exe sysdm.cpl,EditEnvironmentVariables
</pre>
</div>

<p>
<b>Adding tools to the %PATH% Environment Variables</b>
</p>

<p>
<span class="underline">STEP 1</span>: Open the developer prompt: 
</p>

<div class="org-src-container">
<pre class="src src-sh">**********************************************************************
** Visual Studio 2017 Developer Command Prompt v15.5.6
** Copyright (c) 2017 Microsoft Corporation
**********************************************************************
[vcvarsall.bat] Environment initialized for: <span class="org-string">'x64'</span>
</pre>
</div>

<p>
<span class="underline">STEP 2</span>: Get the directory where is the executable, for instance, MSBuild.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-function-name">C</span>:\Users\archbox\source&gt; where msbuild
<span class="org-function-name">C</span>:\Program Files (x86)\Microsoft Visual Studio\2017\Community\MSBuild\15.0\Bin\MSBuild.exe
<span class="org-function-name">C</span>:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSBuild.exe
</pre>
</div>

<p>
This directory(aka path) is: <code>C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\MSBuild\15.0\Bin</code>
</p>

<p>
<span class="underline">STEP 3</span>: Add this directory found at STEP 2 to %PATH% environment variable. 
</p>

<p>
Just open the environment variables tab with the following command and
add the path found at STEP 2.
</p>

<ul class="org-ul">
<li>$ rundll32.exe  sysdm.cpl,EditEnvironmentVariables</li>
</ul>

<p>
Now MSBuild can be launched directly from any tool or console without
specifying its path. 
</p>

<p>
A faster way to collect thoses paths is to redirect the output of
command where to a text file. 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">cd</span> %USERPROFILE%\Desktop 
$ where msbuild  &gt;&gt; paths.txt
$ where nmake    &gt;&gt; paths.txt
$ where dumpbin  &gt;&gt; paths.txt
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4fa8c53" class="outline-3">
<h3 id="org4fa8c53"><span class="section-number-3">1.4</span> Windows API Main Header Files</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Most used headers: 
</p>

<ul class="org-ul">
<li>#include &lt;windows.h&gt;</li>
<li>#include &lt;wchar.h&gt; - Wide Characters - UTF16 chars</li>
<li>#include &lt;tchar.h&gt;</li>
<li>#include &lt;global.h&gt;</li>
<li>#include &lt;nsfbd.h&gt;</li>
</ul>

<p>
Other useful header files: 
</p>

<ul class="org-ul">
<li>windows.h
<ul class="org-ul">
<li>Basic header file of Windows API</li>
</ul></li>
<li>WinError.h
<ul class="org-ul">
<li>Error codes and strings</li>
</ul></li>
<li>tchar.h
<ul class="org-ul">
<li>Provides the macro _T(&#x2026;) and TEXT(&#x2026;) for Unicode/ANSI string
encoding handling.</li>
</ul></li>
<li>wchar.h
<ul class="org-ul">
<li>Wide Character - UTF16 or wchar</li>
</ul></li>
<li>global.h</li>
<li>ntfsb.h</li>
<li>Winsock2.h
<ul class="org-ul">
<li>Network sockets</li>
</ul></li>
<li>Winbase.h
<ul class="org-ul">
<li>Windows types definitions</li>
</ul></li>
<li>WinUser.h
<ul class="org-ul">
<li>Windows Messages</li>
</ul></li>
<li>ShellAPI.h
<ul class="org-ul">
<li>Shell API</li>
</ul></li>
<li>ShFolder.h
<ul class="org-ul">
<li>Folder definitions</li>
</ul></li>
<li>Commdlg.h
<ul class="org-ul">
<li>Commom Controls (COM based)</li>
</ul></li>
<li>Dlgs.h
<ul class="org-ul">
<li>Dialog definitions</li>
</ul></li>
<li>IUnknown.h
<ul class="org-ul">
<li>COM header</li>
</ul></li>
<li>conio.h
<ul class="org-ul">
<li>Console Input/Output functions - it is heritage grom MSDOS.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org665eed9" class="outline-3">
<h3 id="org665eed9"><span class="section-number-3">1.5</span> Windows API Runtime Libraries</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>kernel32.dll
<ul class="org-ul">
<li>Low level NTDLL wrappers.</li>
</ul></li>
<li>user32.dll
<ul class="org-ul">
<li>User interface primitives used by graphical programs with menus,
toolboxes, prompts, windows ..</li>
</ul></li>
<li>shell.dll
<ul class="org-ul">
<li></li>
</ul></li>
<li>gdi32.dll
<ul class="org-ul">
<li>Basic drawing primitives.</li>
</ul></li>
<li>ole32.dll</li>
<li>MSVCRT.DLL
<ul class="org-ul">
<li>Implementation of the C standard library stdlib.</li>
</ul></li>
<li>advapi.dll
<ul class="org-ul">
<li>Contains functions for system-related tasks such as registry and
registry handling.</li>
</ul></li>
<li><code>WS_32.DLL</code>
<ul class="org-ul">
<li>Winsock2 library contains a socket implementation.</li>
</ul></li>
<li>Ntdll.dll
<ul class="org-ul">
<li>Interface to Kernel. Not used by Windows programs directly.</li>
</ul></li>
<li>Wininet.dll
<ul class="org-ul">
<li>Provides high level network APIs, for instance, HttpOpenRequest,
FtpGetFile &#x2026;</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org009738a" class="outline-3">
<h3 id="org009738a"><span class="section-number-3">1.6</span> Windows Object Code Binary Format and Scripting Languages</h3>
<div class="outline-text-3" id="text-1-6">
<p>
Native executables, shared libraries and project files.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Extension</th>
<th scope="col" class="org-left">Executable</th>
<th scope="col" class="org-left">Description</th>
</tr>

<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">Binary Format</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><b>Native Code</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">.exe</td>
<td class="org-left">PE32 or PE64</td>
<td class="org-left">Windows Executable</td>
</tr>

<tr>
<td class="org-left">.scr</td>
<td class="org-left">PE32 or PE64</td>
<td class="org-left">Windows Executable, screen saver animation</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">.dll</td>
<td class="org-left">PE32 or PE64</td>
<td class="org-left">Dynamic Linked Library - It can be Native PE32, PE64 or .NET/CLR DLL</td>
</tr>

<tr>
<td class="org-left">.xll</td>
<td class="org-left">PE32 or PE64</td>
<td class="org-left">Excel native Addin (extensio or plugin). It is a dll with .xll extension.</td>
</tr>

<tr>
<td class="org-left">.pyd</td>
<td class="org-left">PE32 or PE64</td>
<td class="org-left">Python native module on Windows - DLL with .pyd extension instead of .dll.</td>
</tr>

<tr>
<td class="org-left">.cpl</td>
<td class="org-left">PE32 or PE64</td>
<td class="org-left">Control Panel Applet - Also a DLL with .cpl extension.</td>
</tr>

<tr>
<td class="org-left">.sys</td>
<td class="org-left">PE32 or PE64</td>
<td class="org-left">Windows device driver (akin to Linux kernel modules)</td>
</tr>

<tr>
<td class="org-left">.ocx</td>
<td class="org-left">PE32 or PE64</td>
<td class="org-left">Active Control X (DLL)</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>Special Files</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><a href="https://en.wikipedia.org/wiki/Ntoskrnl.exe">Ntoskrnl.exe</a></td>
<td class="org-left">PE32 or PE64</td>
<td class="org-left">Windows-NT Kernel image</td>
</tr>

<tr>
<td class="org-left"><a href="https://en.wikipedia.org/wiki/Microsoft_Windows_library_files#Hal.dll">hall.dll</a></td>
<td class="org-left">PE32 or PE64</td>
<td class="org-left">Hardware Abstraction Layer (HAL)</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>Compilation Binary Files</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">.obj</td>
<td class="org-left">-</td>
<td class="org-left">Object file -&gt; Input to linker before building an executable.</td>
</tr>

<tr>
<td class="org-left">.pdb</td>
<td class="org-left">-</td>
<td class="org-left">Program Debug Database =&gt; Contains executable or DLL debugging symbols.</td>
</tr>

<tr>
<td class="org-left">.lib</td>
<td class="org-left">-</td>
<td class="org-left">Oject File Library or import library</td>
</tr>

<tr>
<td class="org-left">.exp</td>
<td class="org-left">-</td>
<td class="org-left">Exports Library File</td>
</tr>

<tr>
<td class="org-left">.RES</td>
<td class="org-left">-</td>
<td class="org-left">Compiled resource script</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>Source and Project Files</b></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">.def</td>
<td class="org-left">-</td>
<td class="org-left">Export Definition File</td>
</tr>

<tr>
<td class="org-left">.sln</td>
<td class="org-left">-</td>
<td class="org-left">Visual Studio Solution (Project file).</td>
</tr>

<tr>
<td class="org-left">.rs</td>
<td class="org-left">-</td>
<td class="org-left">Resource script - for embedding files into the executable.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Scripting Languages Files: 
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">File Extension</th>
<th scope="col" class="org-left">Interpreter</th>
<th scope="col" class="org-left">Advantage</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">.bat</td>
<td class="org-left">cmd.exe</td>
<td class="org-left">Simplicity</td>
<td class="org-left">Batch Script - Legacy technology from MSDOS, but still useful for small automation.</td>
</tr>

<tr>
<td class="org-left">.vbs or vbe</td>
<td class="org-left">WScript.exe or cscript.exe</td>
<td class="org-left">COM + OOP</td>
<td class="org-left">VBScript -  Visual Basic Script</td>
</tr>

<tr>
<td class="org-left">.js or jse</td>
<td class="org-left">JScript.exe</td>
<td class="org-left">COM + OOP</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">.wcf</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Windows Script File - Allows using many script engines iside the same file.</td>
</tr>

<tr>
<td class="org-left">.ps1 .psm1 .ps1xml</td>
<td class="org-left">Powershell</td>
<td class="org-left">COM + OOP + .NET + Interactive</td>
<td class="org-left">Powershell Script</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">.reg</td>
<td class="org-left">regedit.exe</td>
<td class="org-left">-</td>
<td class="org-left">Windows registry script. Modify Windows registry when executed.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgd6f4cb7" class="outline-3">
<h3 id="orgd6f4cb7"><span class="section-number-3">1.7</span> WinAPI C Data Types</h3>
<div class="outline-text-3" id="text-1-7">
</div>
<div id="outline-container-orgd793a7d" class="outline-4">
<h4 id="orgd793a7d"><span class="section-number-4">1.7.1</span> Hungarian Notation</h4>
<div class="outline-text-4" id="text-1-7-1">
<p>
Windows API uses the Hungarian notation which was intruduced by
Charles Simonyi at Microsoft and Xerox PARC. This notation uses a
prefix to denote the variable type.
</p>

<p>
Notes and remarks:
</p>

<ul class="org-ul">
<li>Many sources advises against this notation and nowadays many IDEs
can provide a variable type by just hovering the mouse over it.</li>

<li>Understanding the notation can help to reason about the Windows
API.</li>

<li>The HN notation is not standardized.</li>
</ul>

<p>
Form: 
</p>

<div class="org-src-container">
<pre class="src src-text">TYPE-PREFIX + NAME + QUALIFIER 
</pre>
</div>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Prefix</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Variable Name Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">b</td>
<td class="org-left">BYTE or BOOL</td>
<td class="org-left">boolean</td>
<td class="org-left">BOOL bFlag; BOOL bIsOnFocus</td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">char</td>
<td class="org-left">Character - 1 byte</td>
<td class="org-left">char cLetter</td>
</tr>

<tr>
<td class="org-left">w</td>
<td class="org-left">WORD</td>
<td class="org-left">word</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dw</td>
<td class="org-left">DWORD</td>
<td class="org-left">double word</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">i</td>
<td class="org-left">int</td>
<td class="org-left">integer</td>
<td class="org-left">int iNumberOfNodes</td>
</tr>

<tr>
<td class="org-left">u32</td>
<td class="org-left">unsigned [int]</td>
<td class="org-left">unsigned integer</td>
<td class="org-left">unsigned u32Nodes</td>
</tr>

<tr>
<td class="org-left">f or fp</td>
<td class="org-left">float</td>
<td class="org-left">float point - single precision</td>
<td class="org-left">fInterestRate</td>
</tr>

<tr>
<td class="org-left">d</td>
<td class="org-left">double</td>
<td class="org-left">float point - double precision</td>
<td class="org-left">dRateOfReturn</td>
</tr>

<tr>
<td class="org-left">n</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">short int</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">sz</td>
<td class="org-left">char* or const char*</td>
<td class="org-left">Pointer to null terminated char array.</td>
<td class="org-left">char* szButtonLabel</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">H</td>
<td class="org-left">HANDLE</td>
<td class="org-left">Handle</td>
<td class="org-left">HANDLE hModule; HMODULE hInstance;</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">-</td>
<td class="org-left">Pointer</td>
<td class="org-left">double* pdwMyPointer;</td>
</tr>

<tr>
<td class="org-left">lp</td>
<td class="org-left">-</td>
<td class="org-left">Long Pointer</td>
<td class="org-left">int* lpiPointer;</td>
</tr>

<tr>
<td class="org-left">fn</td>
<td class="org-left">-</td>
<td class="org-left">Function pointer</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">lpsz</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Long Pointer</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LP</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Long Pointer</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">I</td>
<td class="org-left">-</td>
<td class="org-left">Interface (C++ interface class)</td>
<td class="org-left">class IDrawable &#x2026;</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">-</td>
<td class="org-left">Struct declaration</td>
<td class="org-left">struct SContext { &#x2026; }</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-left">-</td>
<td class="org-left">Class declaration</td>
<td class="org-left">class CUserData{ &#x2026; }</td>
</tr>

<tr>
<td class="org-left">m_</td>
<td class="org-left">-</td>
<td class="org-left">Private member variable name of some class</td>
<td class="org-left">m_pszFileName</td>
</tr>

<tr>
<td class="org-left">s_</td>
<td class="org-left">-</td>
<td class="org-left">Static member of a class</td>
<td class="org-left">static int s_iObjectCount</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Examples in Windows API - Function Create Process:
</p>

<div class="org-src-container">
<pre class="src src-cpp">BOOL <span class="org-type">WINAPI</span> <span class="org-function-name">CreateProcess</span><span class="org-rainbow-delimiters-depth-1">(</span>
  _In_opt_    <span class="org-type">LPCTSTR</span>               <span class="org-variable-name">lpApplicationName</span>,      <span class="org-comment-delimiter">// </span><span class="org-comment">const char*</span>
  _Inout_opt_ <span class="org-type">LPTSTR</span>                <span class="org-variable-name">lpCommandLine</span>,          <span class="org-comment-delimiter">// </span><span class="org-comment">char*</span>
  _In_opt_    <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpProcessAttributes</span>,
  _In_opt_    <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpThreadAttributes</span>,     <span class="org-comment-delimiter">// </span>
  _In_        <span class="org-type">BOOL</span>                  <span class="org-variable-name">bInheritHandles</span>,
  _In_        <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwCreationFlags</span>,
  _In_opt_    <span class="org-type">LPVOID</span>                <span class="org-variable-name">lpEnvironment</span>,
  _In_opt_    <span class="org-type">LPCTSTR</span>               <span class="org-variable-name">lpCurrentDirectory</span>,
  _In_        <span class="org-type">LPSTARTUPINFO</span>         <span class="org-variable-name">lpStartupInfo</span>,
  _Out_       <span class="org-type">LPPROCESS_INFORMATION</span> <span class="org-variable-name">lpProcessInformation</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>dwCreationFlags =&gt; (dw) prefix Indicates that the variable is a
DWORD (int)</li>

<li>lpEnvironment =&gt; (lp - Long Pointer) Indicates that variable is a
void pointer =&gt; (LPVOID = void* )</li>

<li>lpApplicationName =&gt; Indicates that the variable is a pointer to
char or (LPCSTR = const char*)</li>
</ul>


<p>
Furthere Reading: 
</p>

<ul class="org-ul">
<li><b>Coding Conventions: The Hungarian Notation</b>
<ul class="org-ul">
<li><a href="http://cws.cengage.co.uk/rautenbach/students/ancillary_content/hungarian_notation.pdf">http://cws.cengage.co.uk/rautenbach/students/ancillary_content/hungarian_notation.pdf</a></li>
</ul></li>

<li><b>Why I prefer to use the Hungarian Notation</b>
<ul class="org-ul">
<li><a href="https://tommcfarlin.com/hungarian-notation/">https://tommcfarlin.com/hungarian-notation/</a></li>
</ul></li>

<li>Hungarian Notation
<ul class="org-ul">
<li><a href="https://www.reactos.org/wiki/Hungarian_Notation">https://www.reactos.org/wiki/Hungarian_Notation</a></li>
</ul></li>

<li><a href="https://jakewharton.com/just-say-no-to-hungarian-notation/">Just Say mNo to Hungarian Notation - Jake Wharton</a></li>

<li><a href="http://wiki.c2.com/?HungarianNotation">Hungarian Notation</a></li>

<li>Hungarian Notation
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Hungarian_notation">https://en.wikipedia.org/wiki/Hungarian_notation</a></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgeb219a9" class="outline-4">
<h4 id="orgeb219a9"><span class="section-number-4">1.7.2</span> General Terminology</h4>
<div class="outline-text-4" id="text-1-7-2">
<ul class="org-ul">
<li><span class="underline">Handle</span> - Is a unsigned integer number assigned to processes,
windows, buttons, resources and etc. Actually, it is an opaque
pointer to some system data structure (Kernel Object), similar to
Unix's file descriptor pointer. The purpose of using handles or
opaque pointer is to hide the implementation of those data
structures allowing implementators to change their inner working
without disrupting application developers. This approach gives a
pseudo object-oriented interface to the Windows API. See also:

<ul class="org-ul">
<li><span class="underline">Note</span>: A handle can be an <span class="underline">obfuscated pointer</span> exposed as an
integer, void pointer void* (also opaque pointer) or ordinary
opaque pointer (pointer to a C-struct or class which
implementation is not exposed).</li>
</ul></li>

<li><span class="underline">Types of Kernel Objects</span> (Handle is a numeric value related to the
pointer to kernel object C-struct). The name "object" comes from
the idea that it is possible to access the kernel data structure
pointer by the handle using the Win32 API functions. It works in a
similar way to classical object oriented programming where the data
structure and internal representation can only be accessed by the
class methodos. 
<ul class="org-ul">
<li>Symbolic Link</li>
<li>Process
<ul class="org-ul">
<li>A running program, executable. A process has its own address
space, data, stack and heap.</li>
</ul></li>
<li>Job
<ul class="org-ul">
<li>Group of processes managed as group.</li>
</ul></li>
<li>File
<ul class="org-ul">
<li>Open file or I/O device.</li>
</ul></li>
<li>Token
<ul class="org-ul">
<li>Security token used by many Win32 functions.</li>
</ul></li>
<li>Event
<ul class="org-ul">
<li>Synchronization object used for notification.</li>
</ul></li>
<li>Threads
<ul class="org-ul">
<li>Smallest unit of execution within a process.</li>
</ul></li>
<li>Semaphore</li>
<li>Mutex</li>
<li>Timer
<ul class="org-ul">
<li>Object which provides notification after a certain period is
elapsed.</li>
</ul></li>
</ul></li>
</ul>

<p>
References:
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Opaque_pointer">Opaque pointer - Wikipedia</a> - Note: Opaque pointer is also called
"handle classes", "pimpl idiom", "Compiler-firewall", "d-pointer" in C++.</li>
<li><a href="https://en.wikipedia.org/wiki/Handle_(computing)">Handle (computing) - Wikipedia</a></li>
<li><a href="https://stackoverflow.com/questions/2334966/win32-application-arent-so-object-oriented-and-why-there-are-so-many-pointers">c++ - win32 application aren't so object oriented and why there are so many pointers? - Stack Overflow</a></li>
<li><a href="https://dmitryfrank.com/articles/oop_in_c">Object-oriented techniques in C Dmitry Frank</a></li>
<li><a href="https://lwn.net/Articles/444910/">Object-oriented design patterns in the kernel, part 1 </a></li>
</ul>
</div>
</div>
<div id="outline-container-org4b917b5" class="outline-4">
<h4 id="org4b917b5"><span class="section-number-4">1.7.3</span> Common Data Types</h4>
<div class="outline-text-4" id="text-1-7-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Data Type</th>
<th scope="col" class="org-left">Definition</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">BOOL</td>
<td class="org-left">typedef int BOOL</td>
<td class="org-left">Boolean variable true (non zero) or false (zero or 0)</td>
</tr>

<tr>
<td class="org-left">BYTE</td>
<td class="org-left">typedef unsigned char BYTE</td>
<td class="org-left">A byte, 8 bits.</td>
</tr>

<tr>
<td class="org-left">CCHAR</td>
<td class="org-left">typedef char CHAR</td>
<td class="org-left">An 8-bit Windows (ANSI) character.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">DWORD</td>
<td class="org-left">typedef unsigned long DWORD</td>
<td class="org-left">A 32-bit unsigned integer. The range is 0 through 4294967295 decimal.</td>
</tr>

<tr>
<td class="org-left">DWORDLONG</td>
<td class="org-left">typedef unsigned __int64 DWORDLONG</td>
<td class="org-left">64 bits usigned int.</td>
</tr>

<tr>
<td class="org-left">DWORD32</td>
<td class="org-left">typedef unsigned int DWORD32</td>
<td class="org-left">A 32-bit unsigned integer.</td>
</tr>

<tr>
<td class="org-left">DWORD64</td>
<td class="org-left">typedef unsigned __int64 DWORD64</td>
<td class="org-left">A 64-bit unsigned integer.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">FLOAT</td>
<td class="org-left">typedef float FLOAT</td>
<td class="org-left">A floating-point variable.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">INT8</td>
<td class="org-left">typedef signed char INT8</td>
<td class="org-left">An 8-bit signed integer.</td>
</tr>

<tr>
<td class="org-left">INT16</td>
<td class="org-left">typedef signed short INT16</td>
<td class="org-left">A 16-bit signed integer.</td>
</tr>

<tr>
<td class="org-left">INT32</td>
<td class="org-left">typedef signed int INT32</td>
<td class="org-left">A 32-bit signed integer. The range is -2147483648 through 2147483647 decimal.</td>
</tr>

<tr>
<td class="org-left">INT64</td>
<td class="org-left">typedef signed __int64 INT64</td>
<td class="org-left">A 64-bit signed integer.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LPBOOL</td>
<td class="org-left">typedef BOOL far *LPBOOL;</td>
<td class="org-left">A pointer to a BOOL.</td>
</tr>

<tr>
<td class="org-left">LPBYTE</td>
<td class="org-left">typedef BYTE far *LPBYTE</td>
<td class="org-left">A pointer to a BYTE.</td>
</tr>

<tr>
<td class="org-left">LPCSTR, PCSTR</td>
<td class="org-left">typedef __nullterminated CONST CHAR *LPCSTR</td>
<td class="org-left">pointer to a constant null-terminated string of 8-bit Windows (ANSI) characters.</td>
</tr>

<tr>
<td class="org-left">LPCVOID</td>
<td class="org-left">typedef CONST void *LPCVOID;</td>
<td class="org-left">A pointer to a constant of any type.</td>
</tr>

<tr>
<td class="org-left">LPCWSTR, PCWSTR</td>
<td class="org-left">typedef CONST WCHAR *LPCWSTR;</td>
<td class="org-left">A pointer to a constant null-terminated string of 16-bit Unicode characters.</td>
</tr>

<tr>
<td class="org-left">LPDWORD</td>
<td class="org-left">typedef DWORD *LPDWORD</td>
<td class="org-left">A pointer to a DWORD.</td>
</tr>

<tr>
<td class="org-left">LPSTR</td>
<td class="org-left">typedef CHAR *LPSTR;</td>
<td class="org-left">A pointer to a null-terminated string of 8-bit Windows (ANSI) characters.</td>
</tr>

<tr>
<td class="org-left">LPTSTR</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">An LPWSTR if UNICODE is defined, an LPSTR otherwise.</td>
</tr>

<tr>
<td class="org-left">LPWSTR</td>
<td class="org-left">typedef WCHAR *LPWSTR;</td>
<td class="org-left">A pointer to a null-terminated string of 16-bit Unicode characters.</td>
</tr>

<tr>
<td class="org-left">PCHAR</td>
<td class="org-left">typedef CHAR *PCHAR;</td>
<td class="org-left">A pointer to a CHAR.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">CHAR</td>
<td class="org-left">ANSI Char or char</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">WCHAR</td>
<td class="org-left">Wide character 16 bits UTF16</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TCHAR</td>
<td class="org-left">-</td>
<td class="org-left">A WCHAR if UNICODE is defined, a CHAR otherwise.</td>
</tr>

<tr>
<td class="org-left">UCHAR</td>
<td class="org-left">typedef unsigned char UCHAR;</td>
<td class="org-left">An unsigned CHAR.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">WPARAM</td>
<td class="org-left">typedef UINT_PTR WPARAM;</td>
<td class="org-left">A message parameter.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org4b29149" class="outline-4">
<h4 id="org4b29149"><span class="section-number-4">1.7.4</span> Other data types</h4>
<div class="outline-text-4" id="text-1-7-4">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">HANDLE</td>
<td class="org-left">32 bits integer used as a handle</td>
</tr>

<tr>
<td class="org-left">HDC</td>
<td class="org-left">Handle to device context</td>
</tr>

<tr>
<td class="org-left">HWND</td>
<td class="org-left">32-bit unsigned integer used as handle to a window</td>
</tr>

<tr>
<td class="org-left">LONG</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LPARAM</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LPSTR</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LPVOID</td>
<td class="org-left">Generic pointer similar to void*</td>
</tr>

<tr>
<td class="org-left">LRESULT</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">UINT</td>
<td class="org-left">Unsigned integer</td>
</tr>

<tr>
<td class="org-left">WCHAR</td>
<td class="org-left">16-bit Unicode character or Wide-Character</td>
</tr>

<tr>
<td class="org-left">WPARAM</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">HINSTANCE</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orga2ea014" class="outline-4">
<h4 id="orga2ea014"><span class="section-number-4">1.7.5</span> References</h4>
<div class="outline-text-4" id="text-1-7-5">
<p>
General:
</p>

<ul class="org-ul">
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383751(v=vs.85).aspx">Windows Data Types (Windows)</a></li>

<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd374131(v=vs.85).aspx">Windows Data Types for Strings (Windows)</a></li>
</ul>

<p>
Windows Programming:
</p>

<ul class="org-ul">
<li><a href="http://www.tenouk.com/ModuleC.html">The Windows OS Win32 programming tutorial: notes, references and C/Win32 program examples on data type, system error, notation, handles and objects</a></li>

<li><a href="https://scs.senecac.on.ca/~chris.szalwinski/archives/gam666.073/content/windo.html">Seneca | Computer Studies | Introduction to Game Programming</a></li>

<li><a href="https://www.codeproject.com/Articles/3004/The-Complete-Guide-to-C-Strings-Part-II-String-Wra">The Complete Guide to C++ Strings, Part II - String Wrapper Classes - CodeProject</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgab9a79f" class="outline-3">
<h3 id="orgab9a79f"><span class="section-number-3">1.8</span> SAL - Source Code Annotation Language</h3>
<div class="outline-text-3" id="text-1-8">
<p>
Annotation such as <code>__In__</code> or <code>__Out__</code> commonly found on Windows API
documetation, as shown in the code below, is called <span class="underline">SAL - Source Code</span>
<span class="underline">Annotation language</span>. In a C code, it is hard to figure out which
parameters are used to return values or are read-only used only as
input. The SAL solves this problem by declaring which function
parameters are input, read-only and which parameters are output.
</p>

<blockquote>
<p>
SAL is the Microsoft source code annotation language.  By using source
code annotations, you can make the intent behind your code
explicit. These annotations also enable automated static analysis
tools to analyze your code more accurately, with significantly fewer
false positives and false negatives.
</p>
</blockquote>

<p>
&#x2013; <a href="http://msdn.microsoft.com/en-us/library/hh916383.aspx">http://msdn.microsoft.com/en-us/library/hh916383.aspx</a>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HANDLE</span> <span class="org-function-name">CreateRemoteThreadEx</span><span class="org-rainbow-delimiters-depth-1">(</span>
  __in__ <span class="org-type">HANDLE</span>                       <span class="org-variable-name">hProcess</span>,
  __in__ <span class="org-type">LPSECURITY_ATTRIBUTES</span>        <span class="org-variable-name">lpThreadAttributes</span>,
  __in__ <span class="org-type">SIZE_T</span>                       <span class="org-variable-name">dwStackSize</span>,
  __in__ <span class="org-type">LPTHREAD_START_ROUTINE</span>       <span class="org-variable-name">lpStartAddress</span>,
  __in__ <span class="org-type">LPVOID</span>                       <span class="org-variable-name">lpParameter</span>,
  __in__ <span class="org-type">DWORD</span>                        <span class="org-variable-name">dwCreationFlags</span>,
  __in__ <span class="org-type">LPPROC_THREAD_ATTRIBUTE_LIST</span> <span class="org-variable-name">lpAttributeList</span>,
  __out__ <span class="org-type">LPDWORD</span>                     <span class="org-variable-name">lpThreadId</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">DWORD</span> <span class="org-type">WINAPI</span> <span class="org-function-name">FormatMessage</span><span class="org-rainbow-delimiters-depth-1">(</span>
   _In_     <span class="org-type">DWORD</span> <span class="org-variable-name">dwFlags</span>,
   _In_opt_ <span class="org-type">LPCVOID</span> <span class="org-variable-name">lpSource</span>,
   _In_     <span class="org-type">DWORD</span> <span class="org-variable-name">dwMessageId</span>,
   _In_     <span class="org-type">DWORD</span> <span class="org-variable-name">dwLanguageId</span>,
   _Out_    <span class="org-type">LPTSTR</span> <span class="org-variable-name">lpBuffer</span>,
   _In_     <span class="org-type">DWORD</span> <span class="org-variable-name">nSize</span>,
   _In_opt_ <span class="org-type">va_list</span> *<span class="org-variable-name">Arguments</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;

</pre>
</div>

<p>
To allow those annotations in the source code, it is necessary to add
the header <span class="underline">#include &lt;sal.h&gt;</span>. This SAL annotation is not standard among
C++ compilers and is not defined by any C or C++ standard, as a
result, the annotations only works on MSVC - Microsoft Visual C++
Compiler. This feature can be implemented in a portable way with
macros.
</p>

<p>
SAL Fundamentals: 
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">SAL Annotatio</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>_In_</code></td>
<td class="org-left">Input parameter - read only argument no modified inside the by the function.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">Generally has the const qualifier such as const char*.</td>
</tr>

<tr>
<td class="org-left"><code>_In_Out_</code></td>
<td class="org-left">Optional input parameter, can be ignored by passing a null pointer.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>_Out_</code></td>
<td class="org-left">Output paramenter - Argument is written by the called function. It is generally a pointer.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>_Out_opt_</code></td>
<td class="org-left">Optional output parameter. Can be ignored by setting it to null pointer.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>_Inout_</code></td>
<td class="org-left">Data is passed to the function and pontentially modified.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>_Outptr_</code></td>
<td class="org-left">Output to caller. The value returned by written to the parameter is pointer.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>_Outptr_opt_</code></td>
<td class="org-left">Optional output pointer to caller, can be ignored by passing NULL pointer.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Note: if the parameter is not annotated with <code>_opt_</code> the caller is not
supposed to pass a NULL pointer, otherwise the parameter must be
annotated with <code>_In_opt_</code>, <code>_Out_opt_</code> and etc.
</p>

<p>
Usage example: 
</p>

<ul class="org-ul">
<li>This annotation enhances the readability by telling reader which
parameters are input and which parameters are output or used for
returning values.</li>
</ul>

<p>
File: sal1.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sal.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Microsft's Source Code Annotation Language </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Computes elementwise product of two vectors </span>
<span class="org-type">void</span> <span class="org-function-name">vector_element_product</span><span class="org-rainbow-delimiters-depth-1">(</span>
      _In_ <span class="org-type">size_t</span> <span class="org-variable-name">size</span>,
      <span class="org-type">_In_</span> <span class="org-keyword">const</span> <span class="org-type">double</span> xs<span class="org-rainbow-delimiters-depth-2">[]</span>,
      <span class="org-type">_In_</span> <span class="org-keyword">const</span> <span class="org-type">double</span> ys<span class="org-rainbow-delimiters-depth-2">[]</span>,
      _Out_      <span class="org-type">double</span> <span class="org-variable-name">zs</span><span class="org-rainbow-delimiters-depth-2">[]</span>
      <span class="org-rainbow-delimiters-depth-1">){</span>
      <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; size; i++<span class="org-rainbow-delimiters-depth-2">){</span>
          zs<span class="org-rainbow-delimiters-depth-3">[</span>i<span class="org-rainbow-delimiters-depth-3">]</span> = xs<span class="org-rainbow-delimiters-depth-3">[</span>i<span class="org-rainbow-delimiters-depth-3">]</span> * ys<span class="org-rainbow-delimiters-depth-3">[</span>i<span class="org-rainbow-delimiters-depth-3">]</span>;
      <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">showArray</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">size_t</span> <span class="org-variable-name">size</span>, <span class="org-type">double</span> <span class="org-variable-name">xs</span><span class="org-rainbow-delimiters-depth-2">[]</span><span class="org-rainbow-delimiters-depth-1">){</span>
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"("</span> &lt;&lt; size &lt;&lt; <span class="org-string">")[ "</span>;
  <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; size; i++<span class="org-rainbow-delimiters-depth-2">){</span>
    <span class="org-constant">std</span>::cout &lt;&lt; xs<span class="org-rainbow-delimiters-depth-3">[</span>i<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" "</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"] "</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(){</span>
  <span class="org-type">double</span> <span class="org-variable-name">xs</span> <span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-rainbow-delimiters-depth-2">{</span>4, 5, 6, 10<span class="org-rainbow-delimiters-depth-2">}</span>;
  <span class="org-type">double</span> <span class="org-variable-name">ys</span> <span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-rainbow-delimiters-depth-2">{</span>4, 10, 5, 25<span class="org-rainbow-delimiters-depth-2">}</span>;
  <span class="org-type">double</span> <span class="org-variable-name">zs</span> <span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;
  vector_element_product<span class="org-rainbow-delimiters-depth-2">(</span>4, xs, ys, zs<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"xs = "</span>; showArray<span class="org-rainbow-delimiters-depth-2">(</span>4, xs<span class="org-rainbow-delimiters-depth-2">)</span>; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n"</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"ys = "</span>; showArray<span class="org-rainbow-delimiters-depth-2">(</span>4, ys<span class="org-rainbow-delimiters-depth-2">)</span>; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n"</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"zs = "</span>; showArray<span class="org-rainbow-delimiters-depth-2">(</span>4, zs<span class="org-rainbow-delimiters-depth-2">)</span>; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n"</span>;

<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Compiling: 
</p>

<ul class="org-ul">
<li>MSVC (CL.EXE):</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe sal1.cpp /nologo /Fe:sal1-a.exe &amp;&amp; sal1-a.exe
sal1.cpp
<span class="org-function-name">C</span>:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Tools\MSVC\14.12.25827\include\xlocale(313): warning C4530: C++ exception handler used, but unwind semantics are not enabled. Specify /EHsc
xs = (4)[ 4 5 6 10 ]
ys = (4)[ 4 10 5 25 ]
zs = (4)[ 16 50 30 250 ]
</pre>
</div>

<ul class="org-ul">
<li>Mingw/G++</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ g++ sal1.cpp -o <span class="org-keyword">sal1-b.exe</span> -std=c++11 &amp;&amp; sal1-b.exe
xs = (4)[ 4 5 6 10 ]
ys = (4)[ 4 10 5 25 ]
zs = (4)[ 16 50 30 250 ]
</pre>
</div>


<p>
Note: It doesn't work on Linux or other OSes. But it can be
implemented with header files.
</p>

<p>
<b>Open Source SAL Implementation:</b>
</p>

<ul class="org-ul">
<li>Source-code annotation language (SAL) compatibility header -
<a href="https://github.com/nemequ/salieri">https://github.com/nemequ/salieri</a> 

<ul class="org-ul">
<li>"Salieri is a header which provides definitions for Microsoft's
source-code annotation language (SAL). Simply drop the header
into your code and use it instead of including &lt;sal.h&gt; directly,
and you can use SAL annotations even if you want your program to
be portable to compilers which don't support it."</li>

<li>"SAL provides lots of annotations you can use to describe the
behavior of your program. There is a Best Practices and Examples
(SAL) page on MSDN if you want to get a very quick idea of how it
works, but the basic idea is that you end up with something like
this:"</li>
</ul></li>
</ul>

<p>
<b>References:</b>
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/visualstudio/code-quality/understanding-sal">Understanding SAL - Visual Studio | Microsoft Docs</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/hh916382.aspx">Annotating Function Parameters and Return Values</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/ms182032.aspx?f=255&amp;MSPPError=-2147217396">Using SAL Annotations to Reduce C-C++ Code Defects</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/jj159525.aspx">Best Practices and Examples (SAL)</a></li>
<li><a href="https://stackoverflow.com/questions/11457328/what-is-in-in-c">What is <span class="underline">In</span> in C++? - Stack Overflow</a></li>
<li><a href="https://ariccio.com/2015/04/02/preventing-bugs-and-improving-code-quality-with-microsoft-sal-part-2-custom-preconditions-for-structs-objects/">Preventing bugs, and improving code quality with Microsoft SAL (Part 2, custom preconditions for structs &amp; objects) | Alexander Riccio</a></li>
<li>SQLite Source Code Annotated with SAL -
<a href="https://github.com/ariccio/SQLite-Test-SAL">https://github.com/ariccio/SQLite-Test-SAL</a> and <a href="https://ariccio.com/2015/05/10/using-sal-in-the-sqlite-api/">Using SAL in the SQLite API | Alexander Riccio</a></li>
<li><a href="https://www.osr.com/blog/2015/02/23/sal-annotations-dont-hate-im-beautiful/">SAL Annotations: Don’t Hate Me Because I’m Beautiful – OSR</a></li>
</ul>
</div>
</div>

<div id="outline-container-org4ab85d3" class="outline-3">
<h3 id="org4ab85d3"><span class="section-number-3">1.9</span> Character Encoding in WinAPI - ANSI x utf8 x utf16 (wchar_t)</h3>
<div class="outline-text-3" id="text-1-9">
</div>
<div id="outline-container-org66393ef" class="outline-4">
<h4 id="org66393ef"><span class="section-number-4">1.9.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-9-1">
<p>
Unlike Linux, MacOSX and BSD where the API supports unicode UTF-8,
the Windows API only supports ANSI enconding (char) and UTF16 or
Unicode with 2 bytes per character <span class="underline">wchar_t</span>. 
</p>

<p>
<b>Macros and types for enconding portability</b>
</p>

<p>
The following macros are widely used by Windows API for portability
between ANSI and Unicode: 
</p>

<ul class="org-ul">
<li>Strings:
<ul class="org-ul">
<li><a href="http://www.cplusplus.com/reference/string/">&lt;std::string&gt;</a> (UTF8 enconding) - Ordinary string (aka multi-byte string)</li>

<li><a href="http://www.cplusplus.com/reference/string/wstring/">std::wstring</a> (UTF-16 enconding) - Wide string - string defined as
array of wide characters wchar_t.</li>
</ul></li>

<li><span class="underline">TCHAR</span> (Header: &lt;tchar.h&gt;) - When the <span class="underline">UNICODE</span> is defined TCHAR
becomes wchar_t, otherwise, it becomes char.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#ifdef</span> _UNICODE
  <span class="org-keyword">typedef</span> <span class="org-type">wchar_t</span> <span class="org-type">TCHAR</span>;
<span class="org-preprocessor">#else</span>
  <span class="org-keyword">typedef</span> <span class="org-type">char</span> <span class="org-type">TCHAR</span>;
<span class="org-preprocessor">#endif</span>
</pre>
</div>

<ul class="org-ul">
<li>String Literal <b>_T</b> or TEXT macro.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#ifdef</span> _UNICODE 
<span class="org-preprocessor">   #define</span> <span class="org-function-name">_T</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">str</span><span class="org-rainbow-delimiters-depth-1">)</span>   L##str
<span class="org-preprocessor">   #define</span> <span class="org-function-name">TEXT</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">c</span><span class="org-rainbow-delimiters-depth-1">)</span>   L##str
<span class="org-preprocessor">#else</span> 
<span class="org-preprocessor">   #define</span> <span class="org-function-name">_T</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">str</span><span class="org-rainbow-delimiters-depth-1">)</span>     str 
<span class="org-preprocessor">   #define</span> <span class="org-function-name">TEXT</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">str</span><span class="org-rainbow-delimiters-depth-1">)</span>   str
<span class="org-preprocessor">#endif</span>
</pre>
</div>

<ul class="org-ul">
<li>Character array type definition:</li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">Definition</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">LPSTR</td>
<td class="org-left">char*</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LPCSTR</td>
<td class="org-left">const char*</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LPWSTR</td>
<td class="org-left">wchar_t*</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LPCWSTR</td>
<td class="org-left">const wchar_t*</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LPTSTR</td>
<td class="org-left">TCHAR*</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LPCTSTR</td>
<td class="org-left">const TCHAR*</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
<b>String Literals</b>
</p>

<ul class="org-ul">
<li><span class="underline">Utf-8 string literal</span> (narrow characters or multibyte string) -
cannot be used with Windows APIs as they will interpret those
string literals as ANSI, thus not all characters will be
represented.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-string">"UTF8 - Unicode 8 bits multi-byte literal"</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Note: It doesn't work with Windows APIs (Windows specific functions)</span>
<span class="org-type">char</span> <span class="org-variable-name">utf8_text</span> <span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-string">"Random text in Georgian script (UTF8): &#4316;&#4323;&#4321;&#4334;&#4323;&#4320;&#4312;"</span>;
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">Utf-16 string literal</span> (wide characters - wchar_t). Windows Unicode
APIs or functions only works with wide characters (wchar_t).</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">L<span class="org-string">"UTF16 Wchar wide chracters literal"</span>;
<span class="org-type">wchar_t</span> <span class="org-variable-name">utf16_text</span> <span class="org-rainbow-delimiters-depth-1">[]</span> = L<span class="org-string">"Random text in Georgian script (UTF16): &#4316;&#4323;&#4321;&#4334;&#4323;&#4320;&#4312;"</span>;
</pre>
</div>

<ul class="org-ul">
<li>String prefixed with _T or TEXT. If Unicode is defined the string
literal becomes an unicode UTF16 string literal and prefix 'L' is
added to the string, otherwise nothing happens.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">TCHAR</span> <span class="org-variable-name">text</span> <span class="org-rainbow-delimiters-depth-1">[]</span> = _T<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Random text in Georgian script  &#4316;&#4323;&#4321;&#4334;&#4323;&#4320;&#4312;"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">OR </span>
<span class="org-type">TCHAR</span> <span class="org-variable-name">text</span> <span class="org-rainbow-delimiters-depth-1">[]</span> = TEXT<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Random text in Georgian script  &#4316;&#4323;&#4321;&#4334;&#4323;&#4320;&#4312;"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
If <span class="underline">UNICODE</span> is not defined, it becomes: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span> <span class="org-variable-name">text</span> <span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-string">"Random text in Georgian script &#4316;&#4323;&#4321;&#4334;&#4323;&#4320;&#4312;"</span>;
</pre>
</div>

<p>
If Unicode is defined, it becomes: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">wchar_t</span> <span class="org-variable-name">text</span> <span class="org-rainbow-delimiters-depth-1">[]</span> = L<span class="org-string">"Random text in Georgian script &#4316;&#4323;&#4321;&#4334;&#4323;&#4320;&#4312;"</span>;
</pre>
</div>

<p>
<b>Windows APIs - ANSI X Unicode version</b>
</p>

<p>
Almost every function in Windows API such as <a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-createdirectorya">CreateDirectory</a> has an
ANSI and Unicode UTF16 (with wide chars wchar_t) version. The ANSI
version of CreateDirectory API is <a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-createdirectorya">CreateDirectoryA</a> (suffix A) and the
unicode version is <a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-createdirectoryw">CreateDirectoryW</a>. The API <span class="underline">CreateDirectory</span> is
expanded to CreateDirectoryW if #define UNICODE preprocessor flag is
not defined, otherwise it is expanded to CreateDirectoryA. 
</p>

<ul class="org-ul">
<li>ANSI Version:</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CreateDirectoryA</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCSTR</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">const char */</span>  <span class="org-variable-name">lpPathName</span>,
  <span class="org-type">LPSECURITY_ATTRIBUTES</span>    <span class="org-variable-name">lpSecurityAttributes</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>Unicode Version:</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CreateDirectoryW</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCWSTR</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">const wchar_t*  */</span>  <span class="org-variable-name">lpPathName</span>,   
  <span class="org-type">LPSECURITY_ATTRIBUTES</span>          <span class="org-variable-name">lpSecurityAttributes</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org402cf3c" class="outline-4">
<h4 id="org402cf3c"><span class="section-number-4">1.9.2</span> Unicode UTF8 X Wide Unicode C-strign functions</h4>
<div class="outline-text-4" id="text-1-9-2">
<p>
In C++, it is better and safer to use std::string (UTF8 string) or
std::wstring (wchar_t) wide unicode string since they can be modified
at runtime and can take care of memory allocation and
deallocation. However, it is worth knowing the C-functions for the
purposing of reading and understanding Windows API codes which are
mostly written in C rather than C++.
</p>

<p>
The following C-functions are widely used on many C-codes for Windows
and Unix-like operating systems. Nowadays, the APIs of most Unix-like
operating systems uses unicode UTF8 (char) by default, while most low
level Windows API only supports Wide unicode (wchar_t). 
Windows.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">char</th>
<th scope="col" class="org-left">wchar_t - Wide character</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>

<tr>
<th scope="col" class="org-left">UTF8</th>
<th scope="col" class="org-left">UTF16 - Wide Unicode</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">strlen</td>
<td class="org-left"><a href="http://www.cplusplus.com/reference/cwchar/wcslen/">wcslen</a></td>
<td class="org-left">Get string length</td>
</tr>

<tr>
<td class="org-left">strcmp</td>
<td class="org-left"><a href="http://www.cplusplus.com/reference/cwchar/wcscmp/">wcscmp</a></td>
<td class="org-left">Comparre string</td>
</tr>

<tr>
<td class="org-left">strcpy</td>
<td class="org-left"><a href="http://www.cplusplus.com/reference/cwchar/wcsncpy/">wcsncpy</a></td>
<td class="org-left">Copy N-characters from one string to another</td>
</tr>

<tr>
<td class="org-left">strcat</td>
<td class="org-left"><a href="http://www.cplusplus.com/reference/cwchar/wcscat/">wcscat</a></td>
<td class="org-left">Concatenat string</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">strtod</td>
<td class="org-left"><a href="http://www.cplusplus.com/reference/cwchar/wcstod/">wcstod</a></td>
<td class="org-left">Convert wide string to double</td>
</tr>
</tbody>
</table>

<p>
Signature of Wide unicode functions: 
</p>

<ul class="org-ul">
<li>Length of wide string</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">size_t</span> <span class="org-function-name">wcslen</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">wchar_t</span>* <span class="org-variable-name">wcs</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>Copy wide string</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">wchar_t</span>* <span class="org-function-name">wcscpy</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">wchar_t</span>* <span class="org-variable-name">destination</span>, <span class="org-keyword">const</span> <span class="org-type">wchar_t</span>* <span class="org-variable-name">source</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>Concatenate wide string</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">wchar_t</span>* <span class="org-function-name">wcscat</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">wchar_t</span>* <span class="org-variable-name">destination</span>, <span class="org-keyword">const</span> <span class="org-type">wchar_t</span>* <span class="org-variable-name">source</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4e8e80f" class="outline-4">
<h4 id="org4e8e80f"><span class="section-number-4">1.9.3</span> Example - ANSI X Unicode and Windows API</h4>
<div class="outline-text-4" id="text-1-9-3">
<ul class="org-ul">
<li>Source Code: <a href="src/windows/winapi-enconding1.cpp">file:src/windows/winapi-enconding1.cpp</a></li>
</ul>

<p>
Compiling with GCC: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Build </span>
$ g++ winapi-encoding1.cpp -o <span class="org-keyword">out-gcc.exe</span> -std=c++14  
<span class="org-comment-delimiter"># </span><span class="org-comment">Compile </span>
$ out-gcc.exe 
</pre>
</div>

<p>
Compiling with MSVC:
</p>
<ul class="org-ul">
<li>Note: If there is any unicode literal in the source, such as some
text in Chinese or Hidi script, it is necessary to compile with the
options (/source-charset:utf-8 /execution-charset:utf-8), otherwise
the</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Build </span>
$ cl.exe winapi-encoding1.cpp user32.lib /EHsc /Zi /nologo /source-charset:utf-8 /execution-charset:utf-8 <span class="org-sh-escaped-newline">\</span>
   /Fe:out-msvc.exe 
<span class="org-comment-delimiter"># </span><span class="org-comment">Run </span>
$ out-msvc.exe 
</pre>
</div>


<p>
Headers: 
</p>

<ul class="org-ul">
<li>To enable the expansion to unicode versions of WinAPIs, the flags
UNICODE and <code>_UNICODE</code> must be enabled. For instance, if those flags
are enabled CreateDirectory is expanded to CreateDirectoryW and TCHAR
is expanded to wchar_t. Otherwise, CreateDirectory is expanded to
CreateDirectoryA and TCHAR to char.</li>

<li>Note: The unicode flags must be defined before any windows specific
header such as &lt;windows.h&gt; or &lt;tchar.h&gt;.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Enable Unicode version of Windows API compile with -DWITH_UNICODE </span>
<span class="org-preprocessor">#ifdef</span> WITH_UNICODE
<span class="org-preprocessor">  #define</span> <span class="org-variable-name">UNICODE</span>
<span class="org-preprocessor">  #define</span> <span class="org-variable-name">_UNICODE</span>
<span class="org-preprocessor">#endif</span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">tchar.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
</pre>
</div>

<p>
<b>Experiment 1</b> - Print to console: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">===========&gt; EXPERIMENT 1 - Print to Console ============//  </span>
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"\n ===&gt;&gt;&gt; EXPERIMENT 1: Print to terminal [ANSI/UTF8] &lt;&lt;&lt;=== "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-constant">std</span>::cout  &lt;&lt;  <span class="org-string">" [COUT] Some text example - &#1091;&#1082;&#1072;&#1079;&#1072;&#1085; - &#35835;&#20889;&#27721;&#23383;1 "</span> &lt;&lt; <span class="org-string">"\n"</span>;
   <span class="org-constant">std</span>::wcout &lt;&lt; L<span class="org-string">" [WCOUT] Some text example - &#1091;&#1082;&#1072;&#1079;&#1072;&#1085; - &#35835;&#20889;&#27721;&#23383;1 "</span> &lt;&lt; L<span class="org-string">"\n"</span>;  
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Output: 
</p>

<ul class="org-ul">
<li>This piece of code fails because the Windows' console (cmd.exe)
cannot print unicode text by default. It needs to be configured
before printing unicode, otherwise it will print garbage.</li>
</ul>

<div class="org-src-container">
<pre class="src src-text">===&gt;&gt;&gt; EXPERIMENT 1: Print to terminal [ANSI/UTF8] &lt;&lt;&lt;
[COUT] Some text example - &#9572;&#226;&#9576;&#9553;&#9576;&#9617;&#9576;&#9558;&#9576;&#9617;&#9576;&#9564; - &#934;&#187;&#9559;&#963;&#229;&#214;&#181;&#9618;&#235;&#963;&#161;&#249;
[WCOUT] Some text example -
</pre>
</div>

<p>
<b>Experiment 2</b> - Print to File
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">===========&gt; EXPERIMENT 2 - Print to File ============//</span>
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"\n ===&gt;&gt;&gt; EXPERIMENT 2: Write non ANSI Chars to File &lt;&lt;&lt;=== "</span> &lt;&lt; <span class="org-string">"\n"</span>;
<span class="org-function-name">std</span>::stringstream ss;
ss &lt;&lt; <span class="org-string">" Text in Cyrllic Script: &#1045;&#1089;&#1083;&#1080; &#1091;&#1082;&#1072;&#1079;&#1072;&#1085; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;  "</span> &lt;&lt; <span class="org-string">"\n"</span>
   &lt;&lt; <span class="org-string">" Text in Chinese Script: &#35835;&#20889;&#27721;&#23383;1 "</span> &lt;&lt; <span class="org-string">"\n"</span>
   &lt;&lt; <span class="org-string">"\n"</span>;

<span class="org-keyword">auto</span> <span class="org-variable-name">dfile</span> = <span class="org-constant">std</span>::ofstream<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"logging.txt"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
dfile &lt;&lt; ss.str<span class="org-rainbow-delimiters-depth-1">()</span> &lt;&lt; <span class="org-constant">std</span>::flush;
</pre>
</div>

<p>
Output: file - loggin.txt  
</p>
<ul class="org-ul">
<li>By opening the file logging.txt with notepad.exe, it is
possible view all characters as show in the following block.</li>
</ul>

<div class="org-src-container">
<pre class="src src-text">Text in Cyrllic Script: &#1045;&#1089;&#1083;&#1080; &#1091;&#1082;&#1072;&#1079;&#1072;&#1085; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;  
Text in Chinese Script: &#35835;&#20889;&#27721;&#23383;1 
</pre>
</div>

<p>
<b>Experiment 3</b> - WinAPI - <a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-createdirectorya">CreateDirectory</a>  
</p>

<p>
This code experiment attempts to create 3 directories: 
</p>

<ul class="org-ul">
<li>Directory: directoryANSI-读写汉字1 with CreateDirectoryA
function (ANSI version of the underlying API)</li>

<li>Directory: directoryWCHAR-读写汉字 with CreateDirectoryW (Unicode
version of the API).</li>

<li>Directory: directoryTCHAR-读写汉字 with <span class="underline">CreateDirectory macro</span>
which is expanded to CreateDirectoryW when UNICODE is defined,
othewise it is expanded to CreateDirectoryA.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">   <span class="org-comment-delimiter">// </span><span class="org-comment">===========&gt; EXPERIMENT 4 - WinAPI - CreateDirectory ============//</span>
   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ===&gt;&gt;&gt; EXPERIMENT 3: WinAPI CreateDirectory &lt;&lt;&lt;=== "</span> &lt;&lt; <span class="org-constant">std</span>::endl;

   <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-comment-delimiter">// </span><span class="org-comment">-- ANSI Version of CreateDirectory API </span>
       <span class="org-type">bool</span> <span class="org-variable-name">res</span>;
       res = CreateDirectoryA<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"directoryANSI-&#35835;&#20889;&#27721;&#23383;1"</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
       <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Successful 1 ?=  "</span> &lt;&lt; <span class="org-constant">std</span>::boolalpha &lt;&lt; res &lt;&lt; <span class="org-constant">std</span>::endl;
   <span class="org-rainbow-delimiters-depth-1">}</span>

   <span class="org-rainbow-delimiters-depth-1">{</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">-- Unicode (UTF16) - Wide character version of CreateDirectory API </span>
       <span class="org-type">bool</span> <span class="org-variable-name">res</span>;
       res = CreateDirectoryW<span class="org-rainbow-delimiters-depth-2">(</span>L<span class="org-string">"directoryWCHAR-&#35835;&#20889;&#27721;&#23383;"</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
       <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Successful 2 ?= "</span> &lt;&lt; <span class="org-constant">std</span>::boolalpha &lt;&lt; res &lt;&lt; <span class="org-constant">std</span>::endl;       
   <span class="org-rainbow-delimiters-depth-1">}</span>
   <span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">-- TCHAR Version Wide character version of CreateDirectory API </span>
      <span class="org-type">bool</span> <span class="org-variable-name">res</span>;

<span class="org-preprocessor">      #ifdef</span> UNICODE
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] UNICODE (UTF16) CreateDirectory expanded to CreateDirectoryW"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-preprocessor">      #else</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] ANSI CreateDirectory expanded to CreateDirectoryA"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-preprocessor">      #endif</span>
      res = CreateDirectory<span class="org-rainbow-delimiters-depth-2">(</span>_T<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"directoryTCHAR-&#35835;&#20889;&#27721;&#23383;"</span><span class="org-rainbow-delimiters-depth-3">)</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Successful 3 ?= "</span> &lt;&lt; <span class="org-constant">std</span>::boolalpha &lt;&lt; res &lt;&lt; <span class="org-constant">std</span>::endl;        
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Output when compiling without -DWITH_UNICODE: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ g++ winapi-encoding1.cpp -o <span class="org-keyword">out-gcc.exe</span> -std=c++14  &amp;&amp; out-gcc.exe 

 ... ....  ... 
 ===&gt;&gt;&gt; EXPERIMENT 3: WinAPI CreateDirectory &lt;&lt;&lt;=== 
Successful 1 ?=  true
Successful 2 ?= true
 [INFO] ANSI CreateDirectory expanded to CreateDirectoryA
Successful 3 ?= true
 ... ....  ... 
</pre>
</div>

<p>
Directories created: 
</p>

<ul class="org-ul">
<li>[FAILED]  <code>directoryANSI-è¯»å†™æ±‰å­—1</code></li>
<li>[SUCCESS] <code>directoryWCHAR-读写汉字</code>
<ul class="org-ul">
<li>Only the Unicode (CreateDirectoryW) function  works, the ANSI
function CreateDirectoryA fails even if the string is encoded
with UTF-8.</li>
</ul></li>
<li>[FAILED]  <code>directoryTCHAR-è¯»å†™æ±‰å­—</code>
<ul class="org-ul">
<li>Without UNICODE flag, CreateDirectory expands to
CreateDirectoryA.</li>
</ul></li>
</ul>

<p>
Output when compiling without -DWITH_UNICODE: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ g++ winapi-encoding1.cpp -o <span class="org-keyword">out-gcc.exe</span> -std=c++14 -DWITH_UNICODE  &amp;&amp; out-gcc.exe 

    ... .... ... ... ...   
 ===&gt;&gt;&gt; EXPERIMENT 3: WinAPI CreateDirectory &lt;&lt;&lt;=== 
Successful 1 ?=  true
Successful 2 ?= true
 [INFO] UNICODE (UTF16) CreateDirectory expanded to CreateDirectoryW
Successful 3 ?= true
    ... .... ... ... ...   
</pre>
</div>

<p>
Directories created: 
</p>

<ul class="org-ul">
<li>[FAILED] <code>directoryANSI-è¯»å†™æ±‰å­—1</code></li>
<li>[SUCCESS] <code>directoryWCHAR-读写汉字</code></li>
<li>[SUCCESS] <code>directoryTCHAR-读写汉字</code></li>
</ul>


<p>
<b>Experiment 4</b> - WinAPI <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-messagebox">MessageBox</a> function.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">===========&gt; EXPERIMENT 4 - WinAPI - MessageBox ============//</span>
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"\n ===&gt;&gt;&gt; EXPERIMENT 4: MessageBox &lt;&lt;&lt;=== "</span> &lt;&lt; <span class="org-constant">std</span>::endl;

<span class="org-type">DWORD</span> <span class="org-keyword">const</span> <span class="org-variable-name">infoboxOptions</span>  = MB_OK | MB_ICONINFORMATION | MB_SETFOREGROUND;
<span class="org-comment-delimiter">// </span><span class="org-comment">Text in UTF8 =&gt; Note =&gt; Windows API doesn't work with UTF8</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">or multi-byte characters as the API treats the chars as they were ANSI.</span>
<span class="org-type">char</span> <span class="org-variable-name">narrowText</span> <span class="org-rainbow-delimiters-depth-1">[]</span>  = <span class="org-string">"&#54620;&#44397;&#50612; (Korean) / &#35835;&#20889;&#27721;&#23383; - &#23398;&#20013;&#25991; (Chinese)"</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Unicode text in UTF16 </span>
<span class="org-type">wchar_t</span> <span class="org-variable-name">wideText</span> <span class="org-rainbow-delimiters-depth-1">[]</span>  = L<span class="org-string">"&#54620;&#44397;&#50612; (Korean) /  &#35835;&#20889;&#27721;&#23383; - &#23398;&#20013;&#25991; (Chinese)"</span>;
MessageBoxA<span class="org-rainbow-delimiters-depth-1">(</span> 0, narrowText, <span class="org-string">"ANSI (narrow) text:"</span>, infoboxOptions <span class="org-rainbow-delimiters-depth-1">)</span>;    
MessageBoxW<span class="org-rainbow-delimiters-depth-1">(</span> 0, wideText, L<span class="org-string">"Unicode (wide) text:"</span>, infoboxOptions <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Output of <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-messageboxa">MessageBoxA</a> (failure, it cannot deal with unicode UTF-8 chars):
</p>


<div class="figure">
<p><a href="images/messagebox-ansi1.png"><img src="images/messagebox-ansi1.png" alt="messagebox-ansi1.png" /></a>
</p>
</div>

<p>
Output of <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-messageboxw">MessageBoxW</a> (success):
</p>


<div class="figure">
<p><a href="images/messagebox-unicode1.png"><img src="images/messagebox-unicode1.png" alt="messagebox-unicode1.png" /></a>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org5938d15" class="outline-3">
<h3 id="org5938d15"><span class="section-number-3">1.10</span> Environment Variables</h3>
<div class="outline-text-3" id="text-1-10">
</div>
<div id="outline-container-orgee6bf5c" class="outline-4">
<h4 id="orgee6bf5c"><span class="section-number-4">1.10.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-10-1">
<p>
Environment variables are a set of key-value pairs that can be set by
a command line shell or by a parent process for passing configuration
and runtime parameters to applications, subprocesses and shared
libraries. They are also useful for obtaining user information and
locating the path of system directories.
</p>

<p>
Windows APIs for enviroment variables: 
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/procthread/environment-variables">MSDN - Environment Variables</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/WinBase/nf-winbase-getenvironmentvariable">GetEnvironmentVariable function (winbase.h)</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-setenvironmentvariable">SetEnvironmentVariable function (winbase.h)</a></li>
</ul>

<p>
Useful Windows commands (cmd.exe) for environment variables: 
</p>

<ul class="org-ul">
<li>$ set                          =&gt; Show all environment variables</li>
<li>$ echo %PATH%                  =&gt; Show PATH environment variables.</li>
<li>$ set PATH=C:\\app\bin\%PATH%  =&gt; Set path environment variable.</li>
<li>$ set CREDENTIAL=PASS          =&gt; Set environemnt variable CREDENTIAL with value PASS.</li>
</ul>

<p>
<b>Most important environemnt variables</b> 
</p>

<ul class="org-ul">
<li><span class="underline">SystemDriver</span> =&gt; Equivalent to Unix / (slash) root directory.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo %SystemDrive%
<span class="org-function-name">C</span>:
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">SystemRoot</span> =&gt; Path to Windows directory.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo %SystemRoot%
<span class="org-function-name">C</span>:\Windows
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">Windir</span> =&gt; Same as SystemRoot.</li>
</ul>

<pre class="example">
$ echo %WinDir%
C:\Windows
</pre>

<ul class="org-ul">
<li>System32 folder (64 bits applications)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo <span class="org-string">"%SystemRoot%\System32"</span>
<span class="org-string">"C:\Windows\System32"</span>
</pre>
</div>

<ul class="org-ul">
<li>SysWOW64 folder (32 bits applications)
<ul class="org-ul">
<li>Some files: regedit.exe (Registry editor), wscript.exe,
write.exe, wusa.exe, where.exe, whoami.exe, WF.msc, tracert.exe,
tracerpt.exe, tpm.msc, tcmsetup.exe, taskmgr.exe (Task Manager),
runas.exe, rundll32.exe and o on.</li>
<li>See: <a href="https://docs.microsoft.com/en-us/windows/win32/winprog64/file-system-redirector?redirectedfrom=MSDN">File System Redirector</a></li>
<li>See: <a href="https://www.samlogic.net/articles/32-64-bit-windows-folder-x86-syswow64.htm">The SysWOW64 explained</a></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo <span class="org-string">"%SystemRoot%\SysWOW64"</span>
<span class="org-string">"C:\Windows\SysWOW64"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">ProgramFiles</span> =&gt; Directory where 64 bits applications (Windows NT 64
bits) are installed.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo %ProgramFiles%
<span class="org-function-name">C</span>:\Program Files
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">ProgramFiles(x86)</span> =&gt; Directory where are installed 32-bits x86
applications. Note: x86 applications can only access up to 4GB of
RAM and cannot fully harness all hardware resources.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo %ProgramFiles(x86)%
<span class="org-function-name">C</span>:\Program Files (x86)o
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">CommonProgramFiles</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo <span class="org-string">"%CommonProgramFiles%"</span>
<span class="org-string">"C:\Program Files\Common Files"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">CommonProgramFiles(x86)</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo <span class="org-string">"%CommonProgramFiles(x86)%"</span>
<span class="org-string">"C:\Program Files (x86)\Common Files"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">ProgramData</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo %ProgramData%
<span class="org-function-name">C</span>:\ProgramData
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">DriverData</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo <span class="org-string">"%DriverData%"</span>
<span class="org-string">"C:\Windows\System32\Drivers\DriverData"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">UserProfile</span> =&gt; Path to current user's data directory, similar to
Unix $HOME enviroment variable.
<ul class="org-ul">
<li>Note: The application 'ls' (ported from Unix) is not Windows
native. It was used because the command 'dir' does not fully
shows the user directory since it hides the files and directories
'ntuser.init', 'ntuser.dat', 'Applications Data/', 'Start Menu/',
'SendTo', and so on.</li>
</ul></li>
</ul>

<pre class="example">
$ echo %UserProfile%
C:\Users\ha3mx
</pre>

<ul class="org-ul">
<li><span class="underline">Temp</span> =&gt; Directory for temporary files. Equivalent to Unix /tmp</li>
</ul>

<pre class="example">
$ echo %TEMP%
C:\Users\h03fx\AppData\Local\Temp
</pre>

<ul class="org-ul">
<li><span class="underline">APPDATA</span> =&gt;</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo %AppData%
<span class="org-function-name">C</span>:\Users\h03fx\AppData\Roaming
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">LOCALAPPDATA</span> =&gt;</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo %LOCALAPPDATA%
<span class="org-function-name">C</span>:\Users\h03fx\AppData\Local
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">USERNAME</span> =&gt; Name of current user account.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">% echo %USERNAME%
hafcx 
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">USERDOMAIN</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo %USERDOMAIN%
DESKTOP-GMXQCB6
</pre>
</div>

<p>
<b>Directory Exploration</b> 
</p>

<ul class="org-ul">
<li>Directory: %SystemDriver% (using dir command)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ dir %SystemDrive%<span class="org-sh-escaped-newline">\</span>
 Volume<span class="org-keyword"> in</span> drive C has no label.
 Volume Serial Number is BC40-DCC4

 Directory of C:<span class="org-sh-escaped-newline">\</span>

03/18/2019  09:52 PM    &lt;DIR&gt;          PerfLogs
02/06/2021  02:38 AM    &lt;DIR&gt;          Program Files
01/08/2021  08:25 AM    &lt;DIR&gt;          Program Files (x86)
01/05/2021  02:47 AM    &lt;DIR&gt;          Temp
01/05/2021  02:15 AM    &lt;DIR&gt;          Users
01/08/2021  03:08 PM    &lt;DIR&gt;          Windows
               0 File(s)              0 bytes
               6 Dir(s)  87,119,368,192 bytes free
</pre>
</div>

<ul class="org-ul">
<li>Directory: %SystemDriver% (using Unix 'ls' applications that comes with GIT)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ls -la %SystemDrive%<span class="org-sh-escaped-newline">\</span>
total 2660600
drwxr-xr-x 1 hafcx 197121          0 Jan  5 18:01 <span class="org-string">'$Recycle.Bin'</span>/
drwxr-xr-x 1 hafcx 197121          0 May  3 03:37 <span class="org-string">'$WINDOWS.~BT'</span>/
drwxr-xr-x 1 hafcx 197121          0 May  3 03:18 <span class="org-string">'$WinREAgent'</span>/
drwxr-xr-x 1 hafcx 197121          0 May  3  2021  ./
drwxr-xr-x 1 hafcx 197121          0 May  3  2021  ../
drwxr-xr-x 1 hafcx 197121          0 May  3  2021  Config.Msi/
lrwxrwxrwx 1 hafcx 197121          8 Jan  5 00:22 <span class="org-string">'Documents and Settings'</span> -&gt; /c/Users/
-rw-r--r-- 1 hafcx 197121 1717768192 May  3 03:11  hiberfil.sys
-rw-r--r-- 1 hafcx 197121  738197504 May  3 03:11  pagefile.sys
drwxr-xr-x 1 hafcx 197121          0 Mar 18  2019  PerfLogs/
drwxr-xr-x 1 hafcx 197121          0 Feb  6 01:38 <span class="org-string">'Program Files'</span>/
drwxr-xr-x 1 hafcx 197121          0 Jan  8 07:25 <span class="org-string">'Program Files (x86)'</span>/
drwxr-xr-x 1 hafcx 197121          0 Jan  8 07:33  ProgramData/
drwxr-xr-x 1 hafcx 197121          0 Jan  5 00:22  Recovery/
-rw-r--r-- 1 hafcx 197121  268435456 May  3 03:11  swapfile.sys
drwxr-xr-x 1 hafcx 197121          0 Jan  5 00:27 <span class="org-string">'System Volume Information'</span>/
drwxr-xr-x 1 hafcx 197121          0 Jan  5 01:47  Temp/
drwxr-xr-x 1 hafcx 197121          0 Jan  5 01:15  Users/
drwxr-xr-x 1 hafcx 197121          0 Jan  8 14:08  Windows/
</pre>
</div>

<ul class="org-ul">
<li>Directory: %ProgramData%</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">&#955; dir %ProgramData%
 Volume<span class="org-keyword"> in</span> drive C has no label.
 Volume Serial Number is CA82-ED51

 Directory of C:\ProgramData

03/03/2021  04:35 PM    &lt;DIR&gt;          chocolatey
01/05/2021  01:49 AM    &lt;DIR&gt;          Microsoft OneDrive
01/06/2021  05:27 AM    &lt;DIR&gt;          Microsoft Visual Studio
01/06/2021  12:55 PM    &lt;DIR&gt;          Mozilla
01/06/2021  05:45 AM    &lt;DIR&gt;          Package Cache
02/04/2021  05:02 PM    &lt;DIR&gt;          Packages
01/05/2021  06:14 PM    &lt;DIR&gt;          qemu-ga
05/03/2021  03:53 AM    &lt;DIR&gt;          regid.1991-06.com.microsoft
01/08/2021  08:33 AM    &lt;DIR&gt;          shimgen
03/18/2019  09:52 PM    &lt;DIR&gt;          SoftwareDistribution
01/05/2021  02:55 AM    &lt;DIR&gt;          USOPrivate
01/05/2021  01:17 AM    &lt;DIR&gt;          USOShared
01/06/2021  05:46 AM    &lt;DIR&gt;          Windows App Certification Kit
03/18/2019  11:23 PM    &lt;DIR&gt;          WindowsHolographicDevices
               0 File(s)              0 bytes
              14 Dir(s)  92,218,159,104 bytes free
</pre>
</div>

<ul class="org-ul">
<li>Directory: %ProgramFiles%</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ dir <span class="org-string">"%ProgramFiles%"</span>
 Volume<span class="org-keyword"> in</span> drive C has no label.

 Directory of C:\Program Files

02/06/2021  02:38 AM    &lt;DIR&gt;          .
03/18/2019  10:02 PM    &lt;DIR&gt;          Common Files
01/06/2021  05:58 AM    &lt;DIR&gt;          dotnet
03/18/2019  11:21 PM    &lt;DIR&gt;          Internet Explorer
03/03/2021  04:13 PM    &lt;DIR&gt;          Microsoft Update Health Tools
03/18/2019  09:52 PM    &lt;DIR&gt;          ModifiableWindowsApps
  ... ... ... ... ... ... ... ... 
 .... ... ... ... .. .... ... ... 
03/18/2019  10:02 PM    &lt;DIR&gt;          Windows NT
03/18/2019  11:23 PM    &lt;DIR&gt;          Windows Photo Viewer
03/18/2019  11:23 PM    &lt;DIR&gt;          Windows Portable Devices
03/18/2019  09:52 PM    &lt;DIR&gt;          Windows Security
03/18/2019  09:52 PM    &lt;DIR&gt;          WindowsPowerShell
</pre>
</div>

<ul class="org-ul">
<li>Directory: %ProgramFiles(x86)%</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ dir <span class="org-string">"%ProgramFiles(x86)%"</span>
 Volume<span class="org-keyword"> in</span> drive C has no label.

 Directory of C:\Program Files (x86)

01/08/2021  08:25 AM    &lt;DIR&gt;          .
01/08/2021  08:25 AM    &lt;DIR&gt;          ..
01/06/2021  05:45 AM    &lt;DIR&gt;          Application Verifier
01/08/2021  08:26 AM    &lt;DIR&gt;          CodeBlocks
01/06/2021  05:52 AM    &lt;DIR&gt;          Common Files
01/06/2021  05:56 AM    &lt;DIR&gt;          dotnet
01/06/2021  05:50 AM    &lt;DIR&gt;          HTML Help Workshop
03/18/2019  11:21 PM    &lt;DIR&gt;          Internet Explorer
01/06/2021  05:59 AM    &lt;DIR&gt;          Microsoft SDKs
01/06/2021  05:32 AM    &lt;DIR&gt;          Microsoft Visual Studio
01/06/2021  05:55 AM    &lt;DIR&gt;          Microsoft.NET
01/08/2021  03:08 PM    &lt;DIR&gt;          Mozilla Maintenance Service
01/06/2021  05:32 AM    &lt;DIR&gt;          MSBuild
01/06/2021  05:46 AM    &lt;DIR&gt;          Reference Assemblies
01/05/2021  06:14 PM    &lt;DIR&gt;          SPICE Guest Tools
03/18/2019  11:20 PM    &lt;DIR&gt;          Windows Defender
01/06/2021  05:52 AM    &lt;DIR&gt;          Windows Kits
 ... ...  ... ...  ... ...  ... ...  ... ...  ... ... 
 ... ...  ... ...  ... ...  ... ...  ... ...  ... ... 
</pre>
</div>

<ul class="org-ul">
<li>Directory: %UserProfile% =&gt; Windows HOME directory for current  user.
<ul class="org-ul">
<li>Note: NTUSER.DAT is the Windows registry file of current logged user.</li>
<li>Note: This file is not shown with the Windows command line '$ dir'.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ls <span class="org-string">"%UserProfile%"</span>
<span class="org-string">'3D Objects'</span>/
 AppData/
<span class="org-string">'Application Data'</span>@
 Contacts/
 Cookies@
 Desktop/
 Documents/
 Downloads/
 Favorites/
 Links/
<span class="org-string">'Local Settings'</span>@
 MicrosoftEdgeBackups/
 Music/
<span class="org-string">'My Documents'</span>@
 NetHood@
 NTUSER.DAT
 ntuser.dat.LOG1
 ntuser.dat.LOG2
 NTUSER.DAT{fd9a35da-3abd-11e9-aa2c-908c07783950}.TxR.0.regtrans-ms
 NTUSER.DAT{fd9a35da-3abd-11e9-aa2c-908c07783950}.TxR.1.regtrans-ms
 NTUSER.DAT{fd9a35da-3abd-11e9-aa2c-908c07783950}.TxR.2.regtrans-ms
 NTUSER.DAT{fd9a35da-3abd-11e9-aa2c-908c07783950}.TxR.blf
 NTUSER.DAT{fd9a35db-3abd-11e9-aa2c-908c07783950}.TM.blf
 NTUSER.DAT{fd9a35db-3abd-11e9-aa2c-908c07783950}.TMContainer00000000000000000001.regtrans-ms
 NTUSER.DAT{fd9a35db-3abd-11e9-aa2c-908c07783950}.TMContainer00000000000000000002.regtrans-ms
 ntuser.ini
 OneDrive/
 Pictures/
 PrintHood@
 Recent@
<span class="org-string">'Saved Games'</span>/
 scoop/
 Searches/
 SendTo@
<span class="org-string">'Start Menu'</span>@
 Templates@
 Videos/
</pre>
</div>

<ul class="org-ul">
<li>Directory: <span class="underline">%UserProfile%\Start Menu\Programs</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ls  <span class="org-string">"%UserProfile%\Start Menu\Programs"</span>
 Accessibility/          <span class="org-string">'Anaconda3 (64-bit)'</span>/   Maintenance/    Startup/
 Accessories/             CodeBlocks/            OneDrive.lnk*  <span class="org-string">'System Tools'</span>/
<span class="org-string">'Administrative Tools'</span>/   desktop.ini           <span class="org-string">'Scoop Apps'</span>/   <span class="org-string">'Windows PowerShell'</span>/

$ ls  <span class="org-string">"%UserProfile%\Start Menu\Programs\System Tools"</span>
<span class="org-string">'Administrative Tools.lnk'</span>*   computer.lnk*         Desktop.ini           Run.lnk*
<span class="org-string">'Command Prompt.lnk'</span>*        <span class="org-string">'Control Panel.lnk'</span>*  <span class="org-string">'File Explorer.lnk'</span>*

$ ls  <span class="org-string">"%UserProfile%\Start Menu\Programs\Startup"</span>
desktop.ini
</pre>
</div>

<ul class="org-ul">
<li>Directory: %UserProfile%/AppData</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ls <span class="org-string">"%UserProfile%/AppData/"</span>
Local/  LocalLow/  Roaming/

$ ls <span class="org-string">"%UserProfile%/AppData/Local"</span>
<span class="org-string">'Application Data'</span>@          IconCache.db     pip/
 clink/                      Microsoft/       PlaceholderTileLogoFolder/
 CMakeTools/                 MicrosoftEdge/   Publishers/
 Comms/                      Mozilla/         ServiceHub/
 ConnectedDevicesPlatform/   NuGet/           Temp/
 D3DSCache/                  Packages/       <span class="org-string">'Temporary Internet Files'</span>@
 History@                    PeerDistRepub/   VirtualStore/

$ ls <span class="org-string">"%UserProfile%/AppData/Roaming"</span>
 Adobe/              Microsoft/                  NuGet/
<span class="org-string">'Code - Insiders'</span>/  <span class="org-string">'Microsoft Visual Studio'</span>/  <span class="org-string">'Visual Studio Setup'</span>/
 CodeBlocks/         Mozilla/                    vstelemetry/
</pre>
</div>

<ul class="org-ul">
<li>Directory: %UserProfile%/SendTo</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ls <span class="org-string">"%UserProfile%/SendTo/</span>
<span class="org-string">'Bluetooth File Transfer.LNK'*                Documents.mydocs</span>
<span class="org-string">'Compressed (zipped) Folder.ZFSendToTarget'  'Fax Recipient.lnk'*</span>
<span class="org-string">'Desktop (create shortcut).DeskLink'         'Mail Recipient.MAPIMail'</span>
<span class="org-string"> Desktop.ini</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf3e0718" class="outline-4">
<h4 id="orgf3e0718"><span class="section-number-4">1.10.2</span> Usage of Windows environemnt variables</h4>
<div class="outline-text-4" id="text-1-10-2">
<p>
Environment variables can be used for global configuration,
enable/disable logging detail output, setting application credentials
and locating system directories. This program displays several Windows
environment variables by calling the subroutines std::getenv()
(standardized) and GetEvironmentVariable(). The application also
demonstrates how environment variables can be used for changing the
program behavior at startup time.
</p>

<p>
File: <span class="underline">windows-envvars.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">//</span><span class="org-comment">Note: std::get_envvar() is cross-platofrm and standardized.</span>
<span class="org-function-name">std</span>::string
get_envvar<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">p</span> = <span class="org-constant">std</span>::getenv<span class="org-rainbow-delimiters-depth-2">(</span>name.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> p == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> <span class="org-string">""</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-keyword">return</span> p;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> 
<span class="org-function-name">show_envvar</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">s</span> = get_envvar<span class="org-rainbow-delimiters-depth-2">(</span>name<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [ENV] "</span> &lt;&lt; name &lt;&lt; <span class="org-string">" = "</span> &lt;&lt; s &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">std</span>::string
get_envvar2<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">//</span><span class="org-comment">Buffer max size in bytes </span>
  <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">maximum_size</span> = 32767;
  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>maximum_size, <span class="org-string">'\0'</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-type">DWORD</span> <span class="org-variable-name">nread</span> = ::GetEnvironmentVariableA<span class="org-rainbow-delimiters-depth-2">(</span>name.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, buffer.data<span class="org-rainbow-delimiters-depth-3">()</span>, maximum_size<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>nread == 0<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> <span class="org-string">""</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
  buffer.resize<span class="org-rainbow-delimiters-depth-2">(</span>nread<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> buffer;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> 
<span class="org-function-name">show_envvar2</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">s</span> = get_envvar2<span class="org-rainbow-delimiters-depth-2">(</span>name<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [ENV2] "</span> &lt;&lt; name &lt;&lt; <span class="org-string">" = "</span> &lt;&lt; s &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">bool</span> <span class="org-function-name">is_logging_enabled</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Initialized only once. </span>
    <span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-type">bool</span> <span class="org-variable-name">enabled</span> = <span class="org-rainbow-delimiters-depth-2">[]{</span>
        <span class="org-keyword">auto</span> var = get_envvar2<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"LOGGING_ENABLED"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> var == <span class="org-string">"TRUE"</span>;
    <span class="org-rainbow-delimiters-depth-2">}()</span>;
    <span class="org-keyword">return</span> enabled;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">display_factorial</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">int</span> <span class="org-variable-name">p</span> = 1;
  <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 1; i &lt; n + 1; i++<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
      p = p * i;

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> is_logging_enabled<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] p = "</span> &lt;&lt; p &lt;&lt; <span class="org-string">'\n'</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [RESULT] factorial( "</span> &lt;&lt; n &lt;&lt; <span class="org-string">" ) = "</span> &lt;&lt; p &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ============= EXPERIMENT 1 =============="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"SystemDrive"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERPROFILE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERNAME"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERDOMAIN"</span><span class="org-rainbow-delimiters-depth-2">)</span>;      
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"WINDIR"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"PROGRAMDATA"</span><span class="org-rainbow-delimiters-depth-2">)</span>;   
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"SystemRoot"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"AppData"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"LocalAppData"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Temp"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"ProgramFiles"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"ProgramFiles(x86)"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"CommonProgramFiles"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"CommonProgramFiles(x86)"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   show_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"CUSTOM_USER_SUPPLIED"</span><span class="org-rainbow-delimiters-depth-2">)</span>;   

   <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n  ============= EXPERIMENT 2 =============="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"SystemDrive"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERPROFILE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERNAME"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERDOMAIN"</span><span class="org-rainbow-delimiters-depth-2">)</span>;      
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"WINDIR"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"PROGRAMDATA"</span><span class="org-rainbow-delimiters-depth-2">)</span>;   
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"SystemRoot"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"AppData"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"LocalAppData"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Temp"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"ProgramFiles"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"ProgramFiles(x86)"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"CommonProgramFiles"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"CommonProgramFiles(x86)"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   show_envvar2<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"CUSTOM_USER_SUPPLIED"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"====== RUNTIME CONFIGURATION DEMO ========"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   display_factorial<span class="org-rainbow-delimiters-depth-2">(</span>5<span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li>Building with Mingw from command line:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ g++ windows-envvars.cpp -o <span class="org-keyword">out.exe</span> -std=c++1z -Wall -Wextra -g 
</pre>
</div>

<ul class="org-ul">
<li>First run without setting custom environment variables.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ .\out.exe

 ============= EXPERIMENT 1 ==============
 [ENV] SystemDrive = C:
 [ENV] USERPROFILE = C:\Users\hcf5
 [ENV] USERNAME = hcf5
 [ENV] USERDOMAIN = DESKTOP-GXMQDB8
 [ENV] WINDIR = C:\Windows
 [ENV] PROGRAMDATA = C:\ProgramData
 [ENV] SystemRoot = C:\Windows
 [ENV] AppData = C:\Users\hcf5\AppData\Roaming
 [ENV] LocalAppData = C:\Users\hcf5\AppData\Local
 [ENV] Temp = C:\Users\hcf5\AppData\Local\Temp
 [ENV] ProgramFiles = C:\Program Files
 [ENV] ProgramFiles(x86) = C:\Program Files (x86)
 [ENV] CommonProgramFiles = C:\Program Files\Common Files
 [ENV] CommonProgramFiles(x86) = C:\Program Files (x86)\Common Files
 [ENV] CUSTOM_USER_SUPPLIED =

  ============= EXPERIMENT 2 ==============
 [ENV2] SystemDrive = C:
 [ENV2] USERPROFILE = C:\Users\hcf5
 [ENV2] USERNAME = hcf5
 [ENV2] USERDOMAIN = DESKTOP-GXMQDB8
 [ENV2] WINDIR = C:\Windows
 [ENV2] PROGRAMDATA = C:\ProgramData
 [ENV2] SystemRoot = C:\Windows
 [ENV2] AppData = C:\Users\hcf5\AppData\Roaming
 [ENV2] LocalAppData = C:\Users\hcf5\AppData\Local
 [ENV2] Temp = C:\Users\hcf5\AppData\Local\Temp
 [ENV2] ProgramFiles = C:\Program Files
 [ENV2] ProgramFiles(x86) = C:\Program Files (x86)
 [ENV2] CommonProgramFiles = C:\Program Files\Common Files
 [ENV2] CommonProgramFiles(x86) = C:\Program Files (x86)\Common Files
 [ENV2] CUSTOM_USER_SUPPLIED =
======== CONFIG TEST =================
 [RESULT] factorial( 5 ) = 120
</pre>
</div>

<ul class="org-ul">
<li>Second run after setting custom environment variables.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ set <span class="org-variable-name">CUSTOM_USER_SUPPLIED</span>=<span class="org-string">"Hello world! (EN) ola mundo! (PT) hola mundo! (ES) - hallo Welt! (DE)"</span>
$ set <span class="org-variable-name">LOGGING_ENABLED</span>=TRUE

&#955; .\out.exe

 ============= EXPERIMENT 1 ==============
 [ENV] SystemDrive = C:
 [ENV] USERPROFILE = C:\Users\hcf5
 [ENV] USERNAME = hcf5
 [ENV] USERDOMAIN = DESKTOP-GXMQDB8
 [ENV] WINDIR = C:\Windows
 [ENV] PROGRAMDATA = C:\ProgramData
 [ENV] SystemRoot = C:\Windows
 [ENV] AppData = C:\Users\hcf5\AppData\Roaming
 [ENV] LocalAppData = C:\Users\hcf5\AppData\Local
 [ENV] Temp = C:\Users\hcf5\AppData\Local\Temp
 [ENV] ProgramFiles = C:\Program Files
 [ENV] ProgramFiles(x86) = C:\Program Files (x86)
 [ENV] CommonProgramFiles = C:\Program Files\Common Files
 [ENV] CommonProgramFiles(x86) = C:\Program Files (x86)\Common Files
 [ENV] CUSTOM_USER_SUPPLIED = <span class="org-string">"Hello world! (EN) ola mundo! (PT) hola mundo! (ES) - hallo Welt! (DE)"</span>

  ============= EXPERIMENT 2 ==============
 [ENV2] SystemDrive = C:
 [ENV2] USERPROFILE = C:\Users\hcf5
 [ENV2] USERNAME = hcf5
 [ENV2] USERDOMAIN = DESKTOP-GXMQDB8
 [ENV2] WINDIR = C:\Windows
 [ENV2] PROGRAMDATA = C:\ProgramData
 [ENV2] SystemRoot = C:\Windows
 [ENV2] AppData = C:\Users\hcf5\AppData\Roaming
 [ENV2] LocalAppData = C:\Users\hcf5\AppData\Local
 [ENV2] Temp = C:\Users\hcf5\AppData\Local\Temp
 [ENV2] ProgramFiles = C:\Program Files
 [ENV2] ProgramFiles(x86) = C:\Program Files (x86)
 [ENV2] CommonProgramFiles = C:\Program Files\Common Files
 [ENV2] CommonProgramFiles(x86) = C:\Program Files (x86)\Common Files
 [ENV2] CUSTOM_USER_SUPPLIED = <span class="org-string">"Hello world! (EN) ola mundo! (PT) hola mundo! (ES) - hallo Welt! (DE)"</span>
======== CONFIG TEST =================
 [TRACE] p = 1
 [TRACE] p = 2
 [TRACE] p = 6
 [TRACE] p = 24
 [TRACE] p = 120
 [RESULT] factorial( 5 ) = 120
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5698388" class="outline-3">
<h3 id="org5698388"><span class="section-number-3">1.11</span> Primitive IO - Input/Ouput</h3>
<div class="outline-text-3" id="text-1-11">
</div>
<div id="outline-container-org895b92b" class="outline-4">
<h4 id="org895b92b"><span class="section-number-4">1.11.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-11-1">
<p>
Unlike Unix-based operating systems, Windows NT does not use open(),
read(), creat(), close() primitive IO subroutines, instead this
operating system uses CreateFIle(), ReadFile(), WriteFile(),
CloseHandle(). Windows NT also has asynchronous primitive IO
subroutines which does not block the current thread.
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-openfile">CreateFileA()</a> / ANSI Version
<ul class="org-ul">
<li>Brief MSDN: "Creates or opens a file or I/O device. The most
commonly used I/O devices are as follows: file, file stream,
directory, physical disk, volume, console buffer, tape drive,
communications resource, mailslot, and pipe. The function
returns a handle that can be used to access the file or device
for various types of I/O depending on the file or device and the
flags and attributes specified."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-comment-delimiter">// </span><span class="org-comment">---- ANSI version -------------//</span>
 <span class="org-type">HANDLE</span> <span class="org-function-name">CreateFileA</span><span class="org-rainbow-delimiters-depth-1">(</span>
   <span class="org-type">LPCSTR</span>                <span class="org-variable-name">lpFileName</span>,
   <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwDesiredAccess</span>,
   <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwShareMode</span>,
   <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpSecurityAttributes</span>,
   <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwCreationDisposition</span>,
   <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwFlagsAndAttributes</span>,
   <span class="org-type">HANDLE</span>                <span class="org-variable-name">hTemplateFile</span>
 <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">-- Unicode UTF-16 -----version ----//</span>
<span class="org-type">HANDLE</span> <span class="org-function-name">CreateFileW</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCWSTR</span>               <span class="org-variable-name">lpFileName</span>,
  <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwDesiredAccess</span>,
  <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwShareMode</span>,
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpSecurityAttributes</span>,
  <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwCreationDisposition</span>,
  <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwFlagsAndAttributes</span>,
  <span class="org-type">HANDLE</span>                <span class="org-variable-name">hTemplateFile</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile">ReadFile()</a> - Read data from handle to buffer.
<ul class="org-ul">
<li>Brief: "Reads data from the specified file or input/output (I/O)
device. Reads occur at the position specified by the file
pointer if supported by the device. This function is designed
for both synchronous and asynchronous operations. For a similar
function designed solely for asynchronous operation, see
ReadFileEx."</li>
<li>Note: The argument lpBuffer (void*) is a pointer to any
contiguous memory location or any data without any internal
pointer.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">ReadFile</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span>       <span class="org-variable-name">hFile</span>,
  <span class="org-type">LPVOID</span>       <span class="org-variable-name">lpBuffer</span>,
  <span class="org-type">DWORD</span>        <span class="org-variable-name">nNumberOfBytesToRead</span>,
  <span class="org-type">LPDWORD</span>      <span class="org-variable-name">lpNumberOfBytesRead</span>,
  <span class="org-type">LPOVERLAPPED</span> <span class="org-variable-name">lpOverlapped</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile">WriteFile()</a> - Write a buffer to handle.
<ul class="org-ul">
<li>Brief: "Writes data to the specified file or input/output (I/O)
device. This function is designed for both synchronous and
asynchronous operation. For a similar function designed solely
for asynchronous operation, see WriteFileEx."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">WriteFile</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span>       <span class="org-variable-name">hFile</span>,
  <span class="org-type">LPCVOID</span>      <span class="org-variable-name">lpBuffer</span>,
  <span class="org-type">DWORD</span>        <span class="org-variable-name">nNumberOfBytesToWrite</span>,
  <span class="org-type">LPDWORD</span>      <span class="org-variable-name">lpNumberOfBytesWritten</span>,
  <span class="org-type">LPOVERLAPPED</span> <span class="org-variable-name">lpOverlapped</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle">CloseHandle()</a>
<ul class="org-ul">
<li>Brief: "Closes an open object handle."</li>
<li>This function can close all types of handles, including: file,
I/O completion port, mutex, pipe, console input, console screen
buffer, access token and so on.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CloseHandle</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hObject</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Other Windows APIs:
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-deletefilea">DeleteFile()</a>
<ul class="org-ul">
<li>Brief: "Deletes an existing file."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">DeleteFileA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPCSTR</span> <span class="org-variable-name">lpFileName</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">BOOL</span> <span class="org-function-name">DeleteFileW</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPCWSTR</span> <span class="org-variable-name">lpFileName</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createdirectorya">CreateDirectoryA()</a>
<ul class="org-ul">
<li>Brief: "Creates a new directory. If the underlying file system
supports security on files and directories, the function applies
a specified security descriptor to the new directory."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CreateDirectoryA</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCSTR</span>                <span class="org-variable-name">lpPathName</span>,
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpSecurityAttributes</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orge820c1b" class="outline-4">
<h4 id="orge820c1b"><span class="section-number-4">1.11.2</span> Sample code</h4>
<div class="outline-text-4" id="text-1-11-2">
<p>
<b>Files</b>
</p>

<p>
File: <span class="underline">primtive-io.cpp</span>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">//</span><span class="org-comment">Note: std::get_envvar() is cross-platofrm and standardized.</span>
<span class="org-function-name">std</span>::<span class="org-type">string</span>
get_envvar<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">p</span> = <span class="org-constant">std</span>::getenv<span class="org-rainbow-delimiters-depth-2">(</span>name.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> p == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">){</span>
     <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Environment variable not found"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>
   <span class="org-keyword">return</span> <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span>p<span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">struct</span> <span class="org-type">InventoryItem</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-type">int</span>    <span class="org-variable-name">id</span>;
   <span class="org-type">float</span>  <span class="org-variable-name">price</span>;
   <span class="org-type">char</span>   <span class="org-variable-name">product</span><span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">void</span> <span class="org-function-name">run_experiment1</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span> <span class="org-function-name">run_experiment2</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span> <span class="org-function-name">run_experiment3</span><span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [EXPERIMENT 1] ===&gt;&gt; Create a text file with primitive IO ======"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  run_experiment1<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [EXPERIMENT 2] ===&gt;&gt; Create a binary file with structured data ======"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  run_experiment2<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [EXPERIMENT 3] ===&gt;&gt; Read a binary file containing structured data ==="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  run_experiment3<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">run_experiment1</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class="org-keyword">auto</span> desktop_dir = get_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERPROFILE"</span><span class="org-rainbow-delimiters-depth-2">)</span> + <span class="org-string">"\\Desktop"</span>;
  <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Desktop dir = %s \n"</span>, desktop_dir.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">const</span> <span class="org-keyword">auto</span> fpath = desktop_dir + <span class="org-string">"\\testfile.txt"</span>;
  <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] File path = %s \n"</span>, fpath.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">HANDLE</span> <span class="org-variable-name">hFile</span> = CreateFileA<span class="org-rainbow-delimiters-depth-2">(</span> fpath.c_str<span class="org-rainbow-delimiters-depth-3">()</span>          <span class="org-comment-delimiter">// </span><span class="org-comment">File path</span>
                             ,GENERIC_WRITE          <span class="org-comment-delimiter">// </span><span class="org-comment">Open file for writing</span>
                             ,0                      <span class="org-comment-delimiter">// </span><span class="org-comment">File is not shared with any other process.</span>
                             ,<span class="org-constant">NULL</span>                   <span class="org-comment-delimiter">// </span><span class="org-comment">Use default security - It should be nullptr</span>
                             ,CREATE_ALWAYS
                             ,FILE_ATTRIBUTE_NORMAL  <span class="org-comment-delimiter">// </span><span class="org-comment">Normal file</span>
                             ,<span class="org-constant">NULL</span>  <span class="org-rainbow-delimiters-depth-2">)</span>;               <span class="org-comment-delimiter">// </span><span class="org-comment">DO not use attribute</span>

  assert<span class="org-rainbow-delimiters-depth-2">(</span> hFile != INVALID_HANDLE_VALUE &amp;&amp; <span class="org-string">"Returned invalid handle."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_SIZE</span> = 500;
  <span class="org-type">size_t</span> <span class="org-variable-name">len</span> = 0;
  <span class="org-type">BOOL</span> <span class="org-variable-name">error_flag</span> = FALSE;

  <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFFER_SIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Initialize buffer with null character</span>
  memset<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">'\0'</span>, BUFFER_SIZE<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Copy string literal to buffer.</span>
  strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" =&gt;&gt; Buffer line 1 - test - Gotta love Windows NT \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Number of bytes until '\0' null character is found.</span>
  len = strlen<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
  error_flag = WriteFile<span class="org-rainbow-delimiters-depth-2">(</span>  hFile   <span class="org-comment-delimiter">// </span><span class="org-comment">File handle to be writtern</span>
                         , buffer  <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer to be written to file handle</span>
                         , len     <span class="org-comment-delimiter">// </span><span class="org-comment">Number of bytes to be written</span>
                         , <span class="org-constant">NULL</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">[OUTPUT] Number of bytes written</span>
                         , <span class="org-constant">NULL</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">No overlapped structure</span>
                         <span class="org-rainbow-delimiters-depth-2">)</span>;

  assert<span class="org-rainbow-delimiters-depth-2">(</span> error_flag == TRUE &amp;&amp; <span class="org-string">"Unable to write"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" =&gt;&gt; C# CSharp, Dot net, Ponto NET - JAVA \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  len = strlen<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
  WriteFile<span class="org-rainbow-delimiters-depth-2">(</span> hFile, buffer, len, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> error_flag == TRUE &amp;&amp; <span class="org-string">"Unable to write"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Close handle</span>
  CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hFile<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Write binary data</span>
<span class="org-type">void</span> <span class="org-function-name">run_experiment2</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">InventoryItem</span> <span class="org-variable-name">item1</span>;
    item1.id = 200;
    item1.price = 250.61;
    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>item1.product, <span class="org-string">"Some unknown product"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">InventoryItem</span> <span class="org-variable-name">item2</span>;
    item2.id = 976;
    item2.price = 1250.61;
    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>item2.product, <span class="org-string">"Old fashioned feature phone XYZW"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">const</span> <span class="org-keyword">auto</span> desktop_dir = get_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERPROFILE"</span><span class="org-rainbow-delimiters-depth-2">)</span> + <span class="org-string">"\\Desktop"</span>;
    <span class="org-keyword">const</span> <span class="org-keyword">auto</span> fpath = desktop_dir + <span class="org-string">"\\inventory.dat"</span>;

    <span class="org-type">HANDLE</span> <span class="org-variable-name">hFile</span> = CreateFileA<span class="org-rainbow-delimiters-depth-2">(</span> fpath.c_str<span class="org-rainbow-delimiters-depth-3">()</span>
                             ,GENERIC_WRITE
                             ,0
                             ,<span class="org-constant">NULL</span>
                             ,CREATE_ALWAYS
                             ,FILE_ATTRIBUTE_NORMAL
                             ,<span class="org-constant">NULL</span>  <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">BOOL</span> <span class="org-variable-name">error_flag</span> = FALSE;

    error_flag = WriteFile<span class="org-rainbow-delimiters-depth-2">(</span>hFile, &amp;item1, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">struct</span> <span class="org-type">InventoryItem</span><span class="org-rainbow-delimiters-depth-3">)</span>, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> error_flag == TRUE &amp;&amp; <span class="org-string">"Unable to write"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    error_flag = WriteFile<span class="org-rainbow-delimiters-depth-2">(</span>hFile, &amp;item2, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">struct</span> <span class="org-type">InventoryItem</span><span class="org-rainbow-delimiters-depth-3">)</span>, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> error_flag == TRUE &amp;&amp; <span class="org-string">"Unable to write"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hFile<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Read binary data.</span>
<span class="org-type">void</span> <span class="org-function-name">run_experiment3</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">const</span> <span class="org-keyword">auto</span> desktop_dir = get_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERPROFILE"</span><span class="org-rainbow-delimiters-depth-2">)</span> + <span class="org-string">"\\Desktop"</span>;
    <span class="org-keyword">const</span> <span class="org-keyword">auto</span> fpath = desktop_dir + <span class="org-string">"\\inventory.dat"</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Open file for reading</span>
    <span class="org-type">HANDLE</span> <span class="org-variable-name">hFile</span> = CreateFileA<span class="org-rainbow-delimiters-depth-2">(</span> fpath.c_str<span class="org-rainbow-delimiters-depth-3">()</span>
                             ,GENERIC_READ
                             ,0
                             ,<span class="org-constant">NULL</span>
                             ,OPEN_EXISTING
                             ,FILE_ATTRIBUTE_NORMAL
                             ,<span class="org-constant">NULL</span>  <span class="org-rainbow-delimiters-depth-2">)</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> hFile != INVALID_HANDLE_VALUE &amp;&amp; <span class="org-string">"Returned invalid handle."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">BOOL</span> <span class="org-variable-name">error_flag</span> = FALSE;
    <span class="org-type">DWORD</span> <span class="org-variable-name">nbytes_read</span> = 0;

    <span class="org-type">InventoryItem</span> <span class="org-variable-name">buffer</span>;

    error_flag = ReadFile<span class="org-rainbow-delimiters-depth-2">(</span>hFile, &amp;buffer, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">struct</span> <span class="org-type">InventoryItem</span><span class="org-rainbow-delimiters-depth-3">)</span>
                          , &amp;nbytes_read, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> error_flag == TRUE &amp;&amp; <span class="org-string">"Unable to read."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> nbytes_read == <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">struct</span> <span class="org-type">InventoryItem</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr, <span class="org-string">" [ITEM 1] Id = %d ; price = %f; product = %s \n"</span>
                  , buffer.id, buffer.price, buffer.product<span class="org-rainbow-delimiters-depth-2">)</span>;

    error_flag = ReadFile<span class="org-rainbow-delimiters-depth-2">(</span>hFile, &amp;buffer, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">struct</span> <span class="org-type">InventoryItem</span><span class="org-rainbow-delimiters-depth-3">)</span>
                          , &amp;nbytes_read, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> error_flag == TRUE &amp;&amp; <span class="org-string">"Unable to read."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> nbytes_read == <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">struct</span> <span class="org-type">InventoryItem</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr, <span class="org-string">" [ITEM 2] Id = %d ; price = %f; product = %s \n"</span>
                  , buffer.id, buffer.price, buffer.product<span class="org-rainbow-delimiters-depth-2">)</span>;

    CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hFile<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [STATUS] Type return to terminate this application \n"</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>;
    <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::cin, line<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Delete file 'inventory.dat'</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> DeleteFileA<span class="org-rainbow-delimiters-depth-3">(</span>fpath.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span> == TRUE <span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ primitive-io.cpp -o <span class="org-keyword">out.cmp</span> -std=c++1z -Wall -Wextra -g -static

$ g++ primitive-io.cpp -o <span class="org-keyword">out.exe</span> -std=c++1z -Wall -Wextra -g -static
</pre>
</div>

<p>
<b>Running</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-function-name">C</span>:\Users\user_001\Desktop&gt; out.cmp

 [EXPERIMENT 1] ===&gt;&gt; Create a text file with primitive IO ======
 [TRACE] Desktop dir = C:\Users\user_001\Desktop
 [TRACE] File path = C:\Users\user_001\Desktop\testfile.txt

 [EXPERIMENT 2] ===&gt;&gt; Create a binary file with structured data ======

 [EXPERIMENT 3] ===&gt;&gt; Read a binary file containing structured data ===
 [ITEM 1] Id = 200 ; price = 250.610001; product = Some unknown product
 [ITEM 2] Id = 976 ; price = 1250.609985; product = Old fashioned feature phone XYZW
 [STATUS] Type return to terminate this application
</pre>
</div>

<p>
<b>Check generated files from other terminal</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ type testfile.txt
 =&gt;&gt; Buffer line 1 - test - Gotta love Windows NT
 =&gt;&gt; C# CSharp, Dot net, Ponto NET - JAVA

<span class="org-comment-delimiter"># </span><span class="org-comment">Not possible to show file content because it contains</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">structured binary data (non readable bytes)</span>
$ type inventory.dat
&#9562;)&#163;zCSome unknown productH&#231;&#8730;&#9566;&#160;&#8962;&#9786;&#9786;&#9786;hpK&#225;&#8252;&#8593;&#9658;H^r&#9829;&#9566;&#160;&#8962;&#9786;... ....
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org96a01aa" class="outline-3">
<h3 id="org96a01aa"><span class="section-number-3">1.12</span> System Information</h3>
<div class="outline-text-3" id="text-1-12">
</div>
<div id="outline-container-org0f7f00d" class="outline-4">
<h4 id="org0f7f00d"><span class="section-number-4">1.12.1</span> Oveview</h4>
<div class="outline-text-4" id="text-1-12-1">
<p>
Sample codes using several Windows API subroutines for obtaining
system information such as path to key directories, amount of working
memory, username and etc. 
</p>

<p>
<b>Documentation</b> 
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/shlobj_core/nf-shlobj_core-shgetfolderlocation">SHGetFolderLocation function</a>
<ul class="org-ul">
<li>Determine path of special folders.</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-globalmemorystatusex">GlobalMemoryStatusEx function (sysinfoapi.h)</a>
<ul class="org-ul">
<li>Get amount of RAM memory (physical memory, aka working memory)
available; amount of page file used and amount of virtual
memory informations.</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/system-information-functions">System Information Functions</a>
<ul class="org-ul">
<li>Documentation functions for retrieving system information.</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo">GetSystemInfo()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemdirectorya">GetSystemDirectory()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemwindowsdirectorya">GetSystemWindowsDirectory()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/wow64apiset/nf-wow64apiset-getsystemwow64directorya">GetSystemWow64Directory()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/Winbase/nf-winbase-getusernamea">GetUserName()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getversion">GetVersion()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/operating-system-version">Operating System Version</a>
<ul class="org-ul">
<li>Brief: "The Version API Helper functions are used to determine
the version of the operating system that is currently
running. For more information, see Getting the System Version."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getsystemmetrics">GetSystemMetrics function (winuser.h)</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformation">GetLogicalProcessorInformation function (sysinfoapi.h)</a>
<ul class="org-ul">
<li>Determines the number of logical processors available. Intel and
AMD-based CPU cores can execute more than one stream of
instructions simultaneously when hyper-thread is enabled. For
instance, if a processor IC (Integrated Circuit) chip on the
motherboard, has 4 cores and each core has 2 hyper-threads, the
processor has 4 x 2 = 8 logical cores. Therefore, the processor
can run up to 8 threads simultaneously and has 8 hardware
threads.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orge40379f" class="outline-4">
<h4 id="orge40379f"><span class="section-number-4">1.12.2</span> C++ Sample Code Version</h4>
<div class="outline-text-4" id="text-1-12-2">
<p>
File: <span class="underline">sysinfo.cpp</span>
</p>


<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">shfolder.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">For CSIDL_ constants</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">shlobj.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    <span class="org-comment-delimiter">// </span><span class="org-comment">For CSIDL_ constants</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">#include &lt;shlobj_core.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">VersionHelpers.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sysinfoapi.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-function-name">std</span>::string getSystemDirectory<span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-function-name">std</span>::string getWindowsDirectory<span class="org-rainbow-delimiters-depth-1">()</span>;


<span class="org-comment-delimiter">// </span><span class="org-comment">Wrap functions with signature:</span>
<span class="org-comment-delimiter">//   </span><span class="org-comment">=&gt;&gt; using Func = UINT (*) (TCHAR* buffer, UINT n)</span>
<span class="org-comment-delimiter">//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">The function returns a string by writing n bytes to the buffer</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">and returns the string lenght in bytes. If the buffer is not</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">enough larger to hold the string, the calling code should resize</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">it with the number of characters returned by the function call.</span>
<span class="org-comment-delimiter">//</span>
<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Func</span>, <span class="org-keyword">typename</span> <span class="org-type">T</span> = UINT<span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">wrap_fun</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Func</span>&amp;&amp; <span class="org-variable-name">func</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Func</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">wrap_fun2</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Func</span>&amp;&amp; <span class="org-variable-name">func</span>, <span class="org-type">DWORD</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;

<span class="org-function-name">std</span>::string get_shfolder_path<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">csidl</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_system_memory_info</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_windows_version</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_processor_info</span><span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======= Windows Version =================="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha;
  show_windows_version<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Is it Windows Sever? = "</span> &lt;&lt; ::IsWindowsServer<span class="org-rainbow-delimiters-depth-2">()</span>      &lt;&lt; <span class="org-string">'\n'</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Is &gt;= Windows 10?    = "</span> &lt;&lt; ::IsWindows10OrGreater<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">'\n'</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Is &gt;= Windows XP?    = "</span> &lt;&lt; ::IsWindowsXPOrGreater<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">'\n'</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Is &gt;= Windows 8?     = "</span> &lt;&lt; ::IsWindows8OrGreater<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">'\n'</span>;


  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== System Memory Info  =============="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  show_system_memory_info<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== Hardware Info  ==================="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  show_processor_info<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== System Information =============="</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Path to Windows Directory = "</span>
            &lt;&lt; wrap_fun<span class="org-rainbow-delimiters-depth-2">(</span>&amp;GetWindowsDirectoryA<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Path to Windows System Directory = "</span>
            &lt;&lt; wrap_fun<span class="org-rainbow-delimiters-depth-2">(</span>&amp;GetSystemDirectoryA<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Path to WOW64 Directory = "</span>
            &lt;&lt; wrap_fun<span class="org-rainbow-delimiters-depth-2">(</span>&amp;GetSystemWow64DirectoryA<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Computer name = "</span>
            &lt;&lt; wrap_fun2<span class="org-rainbow-delimiters-depth-2">(</span>&amp;GetComputerNameA, 32767<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Note: This function fails if the username uses</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">non ASCII characters such as Japanese Hiragrama</span>
  <span class="org-comment-delimiter">//</span><span class="org-comment">, Katakana or Kanji.</span>
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Username (account login name) = "</span>
            &lt;&lt; wrap_fun2<span class="org-rainbow-delimiters-depth-2">(</span>&amp;GetUserNameA, 32767<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Documentation at:</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">https://docs.microsoft.com/en-us/windows/win32/api/shlobj_core/nf-shlobj_core-shgetfolderpatha</span>
  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ========= Special Directories ================="</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; AdminTools = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_ADMINTOOLS<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; AppData = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_APPDATA<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; LocalAppData = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_LOCAL_APPDATA<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; CommonAppData = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_COMMON_APPDATA<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Common Admin Tools = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_COMMON_ADMINTOOLS<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Common Documents = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_COMMON_DOCUMENTS<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; My Pictures = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_MYPICTURES<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Personal Documents = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_PERSONAL<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Recent Folder = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_RECENT<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Internet Cache = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_INTERNET_CACHE<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; System Folder = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_SYSTEM<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Windows Folder "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_WINDOWS<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Program Files Folder = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_PROGRAM_FILES<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Program Files Common Folder = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_PROGRAM_FILES_COMMON<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Startup Folder = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_STARTUP<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Startup Menu Folder = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_STARTMENU<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt;&gt; Sendto Folder = "</span>
            &lt;&lt; get_shfolder_path<span class="org-rainbow-delimiters-depth-2">(</span>CSIDL_SENDTO<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">std::cout &lt;&lt; " =&gt;&gt; Recycler Bin Folder = "</span>
   <span class="org-comment-delimiter">//       </span><span class="org-comment">&lt;&lt; get_shfolder_path(CSIDL_BITBUCKET) &lt;&lt; '\n';</span>

  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">//</span><span class="org-comment">=================================//</span>

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Func</span>, <span class="org-keyword">typename</span> <span class="org-type">T</span> = UINT<span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">wrap_fun</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Func</span>&amp;&amp; <span class="org-variable-name">func</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">T</span> <span class="org-variable-name">n</span> = 0;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Determine the size of the buffer for storing the result.</span>
  n = func<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> n != 0 &amp;&amp; <span class="org-string">"Failure =&gt; Handle this error."</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Create a buffer with N null characters 0x00</span>
  <span class="org-keyword">auto</span> <span class="org-variable-name">buffer</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>n, <span class="org-string">'\0'</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  n = func<span class="org-rainbow-delimiters-depth-2">(</span>buffer.data<span class="org-rainbow-delimiters-depth-3">()</span>, n<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> n != 0<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> buffer;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Func</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">wrap_fun2</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Func</span>&amp;&amp; <span class="org-variable-name">func</span>, <span class="org-type">DWORD</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">auto</span> <span class="org-variable-name">buffer</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>size, <span class="org-string">'\0'</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> func<span class="org-rainbow-delimiters-depth-3">(</span>buffer.data<span class="org-rainbow-delimiters-depth-4">()</span>, &amp;size<span class="org-rainbow-delimiters-depth-3">)</span> != 0<span class="org-rainbow-delimiters-depth-2">)</span>;
  buffer.resize<span class="org-rainbow-delimiters-depth-2">(</span>size<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> buffer;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">std</span>::string
get_shfolder_path<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">csidl</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-2">(</span>MAX_PATH, 0<span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-type">HRESULT</span> <span class="org-variable-name">h</span> = ::SHGetFolderPathA<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">nullptr</span>
                                ,csidl
                                ,<span class="org-constant">nullptr</span>
                                ,0
                                ,path.data<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   assert<span class="org-rainbow-delimiters-depth-2">(</span> SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>h<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Find position of first null char in the buffer.</span>
   <span class="org-type">void</span>* <span class="org-variable-name">ps</span> = memchr<span class="org-rainbow-delimiters-depth-2">(</span> &amp;path<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, <span class="org-string">'\0'</span>, MAX_PATH<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-type">ptrdiff_t</span> <span class="org-variable-name">pA</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">ptrdiff_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>ps<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-type">ptrdiff_t</span> <span class="org-variable-name">pB</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">ptrdiff_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> path.data<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
   path.resize<span class="org-rainbow-delimiters-depth-2">(</span>pA - pB<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">return</span> path;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">show_system_memory_info</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">MEMORYSTATUSEX</span> <span class="org-variable-name">st</span>;
    st.dwLength = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>st<span class="org-rainbow-delimiters-depth-2">)</span>;
    ::GlobalMemoryStatusEx<span class="org-rainbow-delimiters-depth-2">(</span>&amp;st<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Factor =&gt; Bytes to megabytes</span>
    <span class="org-keyword">constexpr</span> <span class="org-type">double</span> <span class="org-variable-name">factor</span> = 1.0 / <span class="org-rainbow-delimiters-depth-2">(</span>1024 * 1024 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Percent of total physical memory used        = %ld  \n"</span>, st.dwMemoryLoad<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Total physical memory in Megabytes           = %.3f \n"</span>, st.ullTotalPhys * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Free memory in MB form total physical memory = %.3f \n"</span>, st.ullAvailPhys * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Total size of page file in MB                = %.3f \n"</span>, st.ullTotalPageFile * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Free memory of page file   MB                = %.3f \n"</span>, st.ullAvailPageFile * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Total virtual memory in  MB                  = %.3f \n"</span>, st.ullTotalVirtual * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Free virtual memory MB                       = %.3f \n"</span>, st.ullAvailVirtual * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Amount of extended memory available in MB    = %.3f \n"</span>, st.ullAvailExtendedVirtual * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">show_windows_version</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">DWORD</span> <span class="org-variable-name">version</span>, <span class="org-variable-name">majorVersion</span>, <span class="org-variable-name">minorVersion</span>, <span class="org-variable-name">build</span>;
  version = majorVersion = minorVersion = build = 0;

  version = GetVersion<span class="org-rainbow-delimiters-depth-2">()</span>;
  majorVersion = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">DWORD</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> LOBYTE<span class="org-rainbow-delimiters-depth-3">(</span> LOWORD<span class="org-rainbow-delimiters-depth-4">(</span>version<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  minorVersion = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">DWORD</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> LOBYTE<span class="org-rainbow-delimiters-depth-3">(</span> HIWORD<span class="org-rainbow-delimiters-depth-4">(</span>version<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>version &lt; 0x80000000<span class="org-rainbow-delimiters-depth-2">){</span> build = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">DWORD</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>HIWORD<span class="org-rainbow-delimiters-depth-4">(</span>version<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>           
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Windows Version = %ld.%ld (%ld) \n"</span>, majorVersion, minorVersion, build<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">show_processor_info</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">SYSTEM_INFO</span> <span class="org-variable-name">info</span>;
    ::GetNativeSystemInfo<span class="org-rainbow-delimiters-depth-2">(</span>&amp;info<span class="org-rainbow-delimiters-depth-2">)</span>;

    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Processor architecture = %ld \n"</span>, info.wProcessorArchitecture<span class="org-rainbow-delimiters-depth-2">)</span>;    

    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Processor arch is x86 = %s \n"</span>
           , PROCESSOR_ARCHITECTURE_INTEL ==  info.wProcessorArchitecture ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Processor arch is AMD64 x64 (AMD or Intel = %s \n"</span>
           , PROCESSOR_ARCHITECTURE_AMD64 ==  info.wProcessorArchitecture ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-preprocessor">#if</span> <span class="org-preprocessor">defined</span><span class="org-rainbow-delimiters-depth-2">(</span>PROCESSOR_ARCHITECTURE_ARM<span class="org-rainbow-delimiters-depth-2">)</span>
        printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Processor arch is ARM = %s \n"</span>
           , PROCESSOR_ARCHITECTURE_ARM ==  info.wProcessorArchitecture ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-preprocessor">#endif</span> 

<span class="org-preprocessor">#if</span> <span class="org-preprocessor">defined</span><span class="org-rainbow-delimiters-depth-2">(</span>PROCESSOR_ARCHITECTURE_ARM64<span class="org-rainbow-delimiters-depth-2">)</span>   
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Processor arch is ARM64 = %s \n"</span>
           , PROCESSOR_ARCHITECTURE_ARM64 ==  info.wProcessorArchitecture ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-preprocessor">#endif</span> 

    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Page size (virtual memory) in bytes = %ld \n"</span>, info.dwPageSize<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Number of processors                = %ld \n"</span>, info.dwNumberOfProcessors<span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>


<p>
<b>Building and running</b>  (MINGW compiler)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ sysinfo.cpp -o <span class="org-keyword">sysinfo.exe</span> -std=c++1z -Wall -Wextra -g -static &amp;&amp; <span class="org-builtin">.</span>\sysinfo.exe

======= Windows Version ==================
[*] Windows Version = 10.98 (19042) 
[*] Is it Windows Sever? = false
[*] Is &gt;= Windows 10?    = true
[*] Is &gt;= Windows XP?    = true
[*] Is &gt;= Windows 8?     = true

======== System Memory Info  ==============
[*] Percent of total physical memory used        = 45  
[*] Total physical memory<span class="org-keyword"> in</span> Megabytes           = 4095.484 
[*] Free memory<span class="org-keyword"> in</span> MB form total physical memory = 2219.480 
[*] Total size of page file<span class="org-keyword"> in</span> MB                = 5503.484 
[*] Free memory of page file   MB                = 3580.918 
[*] Total virtual memory<span class="org-keyword"> in</span>  MB                  = 134217727.875 
[*] Free virtual memory MB                       = 134213543.578 
[*] Amount of extended memory available<span class="org-keyword"> in</span> MB    = 0.000 

======== Hardware Info  ===================
[*] Processor architecture = 9 
[*] Processor arch is x86 = FALSE 
[*] Processor arch is AMD64 x64 (AMD or Intel = TRUE 
[*] Processor arch is ARM = FALSE 
[*] Processor arch is ARM64 = FALSE 
[*] Page size (virtual memory) <span class="org-keyword">in</span> bytes = 4096 
[*] Number of processors                = 2 

======== System Information ==============
[*] Path to Windows Directory = C:\WINDOWS\0
[*] Path to Windows System Directory = C:\WINDOWS\system32\0
[*] Path to WOW64 Directory = C:\WINDOWS\SysWOW64\0
[*] Computer name = DESKTOP-GLJQDB6
[*] Username (account login name) = user_001\0

========= Special Directories =================
=&gt;&gt; AdminTools = C:\Users\user_001\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Administrative Tools
=&gt;&gt; AppData = C:\Users\user_001\AppData\Roaming
=&gt;&gt; LocalAppData = C:\Users\user_001\AppData\Local
=&gt;&gt; CommonAppData = C:\ProgramData
=&gt;&gt; Common Admin Tools = C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Administrative Tools
=&gt;&gt; Common Documents = C:\Users\Public\Documents
=&gt;&gt; My Pictures = C:\Users\user_001\Pictures
=&gt;&gt; Personal Documents = C:\Users\user_001\Documents
=&gt;&gt; Recent Folder = C:\Users\user_001\AppData\Roaming\Microsoft\Windows\Recent
=&gt;&gt; Internet Cache = C:\Users\user_001\AppData\Local\Microsoft\Windows\INetCache
=&gt;&gt; System Folder = C:\WINDOWS\system32
=&gt;&gt; Windows Folder C:\WINDOWS
=&gt;&gt; Program Files Folder = C:\Program Files
=&gt;&gt; Program Files Common Folder = C:\Program Files\Common Files
=&gt;&gt; Startup Folder = C:\Users\user_001\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
=&gt;&gt; Startup Menu Folder = C:\Users\user_001\AppData\Roaming\Microsoft\Windows\Start Menu
=&gt;&gt; Sendto Folder = C:\Users\user_001\AppData\Roaming\Microsoft\Windows\SendTo
</pre>
</div>
</div>
</div>

<div id="outline-container-org7c8f595" class="outline-4">
<h4 id="org7c8f595"><span class="section-number-4">1.12.3</span> D - DLang Sample Code Version</h4>
<div class="outline-text-4" id="text-1-12-3">
<p>
Definition of SYTEM_INFO struct in C <a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/ns-sysinfoapi-system_info">(MSDN Docs)</a>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">_SYSTEM_INFO</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">union</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">dwOemId</span>;
    <span class="org-keyword">struct</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-type">WORD</span> <span class="org-variable-name">wProcessorArchitecture</span>;
      <span class="org-type">WORD</span> <span class="org-variable-name">wReserved</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-variable-name">DUMMYSTRUCTNAME</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-variable-name">DUMMYUNIONNAME</span>;
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwPageSize</span>;
  <span class="org-type">LPVOID</span>    <span class="org-variable-name">lpMinimumApplicationAddress</span>;
  <span class="org-type">LPVOID</span>    <span class="org-variable-name">lpMaximumApplicationAddress</span>;
  <span class="org-type">DWORD_PTR</span> <span class="org-variable-name">dwActiveProcessorMask</span>;
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwNumberOfProcessors</span>;
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwProcessorType</span>;
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwAllocationGranularity</span>;
  <span class="org-type">WORD</span>      <span class="org-variable-name">wProcessorLevel</span>;
  <span class="org-type">WORD</span>      <span class="org-variable-name">wProcessorRevision</span>;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">SYSTEM_INFO</span>, *<span class="org-type">LPSYSTEM_INFO</span>;
</pre>
</div>

<p>
The last line: '} SYSTEM_INFO, *LPSYSTEM_INFO;' is equivalent to the
following statement in C or C++: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent statement in C or old C++-style </span>
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">_SYSTEM_INFO</span> <span class="org-type">SYSTEM_INFO</span>; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent statement in modern C++ </span>
<span class="org-keyword">using</span> <span class="org-type">SYSTEM_INFO</span> = <span class="org-keyword">struct</span> _SYSTEM_INFO;

<span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent statement in C or old C++-style </span>
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">_SYSTEM_INFO</span> * <span class="org-type">LPSYSTEM_INFO</span>; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent statement in modern C++ </span>
<span class="org-keyword">using</span> <span class="org-type">LPSYSTEM_INFO</span> = <span class="org-keyword">struct</span> _SYSTEM_INFO *;

</pre>
</div>

<p>
Definition MEMORYSTATUSEX in C:  <a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/ns-sysinfoapi-memorystatusex">(MSDN)</a>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">_MEMORYSTATUSEX</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwLength</span>;
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwMemoryLoad</span>;
  <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullTotalPhys</span>;
  <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullAvailPhys</span>;
  <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullTotalPageFile</span>;
  <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullAvailPageFile</span>;
  <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullTotalVirtual</span>;
  <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullAvailVirtual</span>;
  <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullAvailExtendedVirtual</span>;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">MEMORYSTATUSEX</span>, *<span class="org-type">LPMEMORYSTATUSEX</span>;
</pre>
</div>

<p>
<b>Files</b> 
</p>

<p>
File: <span class="underline">systeminfo.d</span>
</p>

<div class="org-src-container">
<pre class="src src-c++"><span class="org-type">import</span> <span class="org-variable-name">std</span>.stdio;
<span class="org-type">import</span> <span class="org-variable-name">core</span>.stdc.stdio;
<span class="org-type">import</span> <span class="org-variable-name">std</span>.range: empty;
<span class="org-type">import</span> <span class="org-variable-name">std</span>.string;
<span class="org-type">import</span> <span class="org-variable-name">core</span>.stdc.string: strlen;
<span class="org-type">import</span> <span class="org-variable-name">std</span>.conv : to;

<span class="org-comment-delimiter">//</span><span class="org-comment">---- Useful type aliases ------------//</span>
<span class="org-type">alias</span> <span class="org-variable-name">HANDLE</span>  = <span class="org-type">void</span>*;
<span class="org-type">alias</span> <span class="org-variable-name">HWND</span>    = <span class="org-type">void</span>*;
<span class="org-type">alias</span> <span class="org-variable-name">LPCSTR</span>  = <span class="org-keyword">const</span> <span class="org-type">char</span>*;
<span class="org-type">alias</span> <span class="org-variable-name">LPSTR</span>   = <span class="org-type">char</span>*;
<span class="org-type">alias</span> <span class="org-variable-name">WORD</span>    = <span class="org-type">short</span>;
<span class="org-type">alias</span> <span class="org-variable-name">DWORD</span>   = <span class="org-type">int</span>;
<span class="org-type">alias</span> <span class="org-variable-name">DWORD_PTR</span> = DWORD*;
<span class="org-type">alias</span> <span class="org-variable-name">LPDWORD</span> = DWORD*;
<span class="org-type">alias</span> <span class="org-variable-name">UINT</span>    = uint;
<span class="org-type">alias</span> <span class="org-variable-name">HRESULT</span> = <span class="org-type">long</span>;
<span class="org-type">alias</span> <span class="org-variable-name">BOOL</span>    = <span class="org-type">int</span>;
<span class="org-type">alias</span> <span class="org-variable-name">ULONGLONG</span> = <span class="org-type">long</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">int64 - 64 bits </span>
<span class="org-type">alias</span> <span class="org-variable-name">DWORDLONG</span> = <span class="org-type">long</span>; 
<span class="org-type">alias</span> <span class="org-variable-name">LPVOID</span>    = <span class="org-type">void</span>*;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Started D application. Ok \n\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== General Basic Info =================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Computer Name = "</span>, computer_name<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Windows System Directory path = "</span>
          , wrap_function<span class="org-rainbow-delimiters-depth-3">(</span>&amp;GetSystemWindowsDirectoryA <span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Windows Directory =  "</span>
          , wrap_function<span class="org-rainbow-delimiters-depth-3">(</span>&amp;GetSystemDirectoryA<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Windows Wow64 Directory =  "</span>
          , wrap_function<span class="org-rainbow-delimiters-depth-3">(</span>&amp;GetSystemWow64DirectoryA<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== Processor Information ============\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  show_processor_info<span class="org-rainbow-delimiters-depth-2">()</span>;

  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== Memory Information ================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">MEMORYSTATUSEX</span> <span class="org-variable-name">st</span>;
  st.dwLength = st.<span class="org-keyword">sizeof</span> ;
  GlobalMemoryStatusEx<span class="org-rainbow-delimiters-depth-2">(</span>&amp;st<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Factor =&gt; Bytes to megabytes</span>
  <span class="org-keyword">const</span> <span class="org-type">double</span> <span class="org-variable-name">factor</span> = 1.0 / <span class="org-rainbow-delimiters-depth-2">(</span>1024 * 1024 <span class="org-rainbow-delimiters-depth-2">)</span>;
  printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Percent of total physical memory used        = %ld  \n"</span>, st.dwMemoryLoad<span class="org-rainbow-delimiters-depth-2">)</span>;
  printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Total physical memory in Megabytes           = %.3f \n"</span>, st.ullTotalPhys * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
  printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Free memory in MB form total physical memory = %.3f \n"</span>, st.ullAvailPhys * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
  printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Total size of page file in MB                = %.3f \n"</span>, st.ullTotalPageFile * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
  printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Free memory of page file   MB                = %.3f \n"</span>, st.ullAvailPageFile * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
  printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Total virtual memory in  MB                  = %.3f \n"</span>, st.ullTotalVirtual * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
  printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Free virtual memory MB                       = %.3f \n"</span>, st.ullAvailVirtual * factor <span class="org-rainbow-delimiters-depth-2">)</span>;
  printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Amount of extended memory available in MB    = %.3f \n"</span>, st.ullAvailExtendedVirtual * factor <span class="org-rainbow-delimiters-depth-2">)</span>;  



  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ===========  Directory Paths ===============\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Profiles path      =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_PROFILE<span class="org-rainbow-delimiters-depth-3">)</span>         <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] AppData path       =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_APPDATA<span class="org-rainbow-delimiters-depth-3">)</span>         <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] LocalAppData path  =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_LOCAL_APPDATA<span class="org-rainbow-delimiters-depth-3">)</span>   <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Start menu path    =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_STARTMENU<span class="org-rainbow-delimiters-depth-3">)</span>       <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Desktop path       =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_DESKTOP<span class="org-rainbow-delimiters-depth-3">)</span>         <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Admin Tools Path   =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_ADMINTOOLS<span class="org-rainbow-delimiters-depth-3">)</span>      <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Favorite path      =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_FAVORITES<span class="org-rainbow-delimiters-depth-3">)</span>       <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Startup path       =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_STARTUP<span class="org-rainbow-delimiters-depth-3">)</span>         <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Recent folder path =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_RECENT<span class="org-rainbow-delimiters-depth-3">)</span>          <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Sendto path        =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_SENDTO<span class="org-rainbow-delimiters-depth-3">)</span>          <span class="org-rainbow-delimiters-depth-2">)</span>;   
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program path       =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_PROGRAM_FILES<span class="org-rainbow-delimiters-depth-3">)</span>   <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Windows path       =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_WINDOWS<span class="org-rainbow-delimiters-depth-3">)</span>         <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] System path        =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_SYSTEM<span class="org-rainbow-delimiters-depth-3">)</span>          <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Fonts folder       =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_FONTS<span class="org-rainbow-delimiters-depth-3">)</span>           <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] System 86 path     =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_SYSTEMX86<span class="org-rainbow-delimiters-depth-3">)</span>       <span class="org-rainbow-delimiters-depth-2">)</span>;
  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Progrm Files x86   =  "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_PROGRAM_FILESX86<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;


  <span class="org-comment-delimiter">// </span><span class="org-comment">Display Final Message is graphical GUI modal dialog.</span>
  MessageBoxA<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer </span>
              null
              <span class="org-comment-delimiter">// </span><span class="org-comment">Text - content </span>
             , <span class="org-string">"Application terminated Ok"</span>
              <span class="org-comment-delimiter">// </span><span class="org-comment">Title </span>
             , <span class="org-string">"Notification"</span>
              <span class="org-comment-delimiter">// </span><span class="org-comment">Flags </span>
             , 0x00000000 | 0x00000020 <span class="org-rainbow-delimiters-depth-2">)</span>;


  writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Terminated gracefully. Ok "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">===========================================================================//</span>

<span class="org-keyword">struct</span> <span class="org-type">MEMORYSTATUSEX</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">dwLength</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">dwMemoryLoad</span>;
    <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullTotalPhys</span>;
    <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullAvailPhys</span>;
    <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullTotalPageFile</span>;
    <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullAvailPageFile</span>;
    <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullTotalVirtual</span>;
    <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullAvailVirtual</span>;
    <span class="org-type">DWORDLONG</span> <span class="org-variable-name">ullAvailExtendedVirtual</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">alias</span> <span class="org-variable-name">LPMEMORYSTATUSEX</span> = MEMORYSTATUSEX*;

<span class="org-keyword">struct</span> <span class="org-type">SYSTEM_INFO</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">union</span>  <span class="org-type">DUMMYUNIONNAME</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">dwOemId</span>;

    <span class="org-keyword">struct</span> <span class="org-type">DUMMYSTRUCTNAME</span>
    <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-type">WORD</span> <span class="org-variable-name">wProcessorArchitecture</span>;
      <span class="org-type">WORD</span> <span class="org-variable-name">wReserved</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>;

    <span class="org-type">DUMMYSTRUCTNAME</span> <span class="org-variable-name">proc</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>;
  <span class="org-type">DUMMYUNIONNAME</span> <span class="org-variable-name">dummy</span>;

  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwPageSize</span>;
  <span class="org-type">LPVOID</span>    <span class="org-variable-name">lpMinimumApplicationAddress</span>;
  <span class="org-type">LPVOID</span>    <span class="org-variable-name">lpMaximumApplicationAddress</span>;
  <span class="org-type">DWORD_PTR</span> <span class="org-variable-name">dwActiveProcessorMask</span>;
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwNumberOfProcessors</span>;
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwProcessorType</span>;
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwAllocationGranularity</span>;
  <span class="org-type">WORD</span>      <span class="org-variable-name">wProcessorLevel</span>;
  <span class="org-type">WORD</span>      <span class="org-variable-name">wProcessorRevision</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">alias</span> <span class="org-variable-name">LPSYSTEM_INFO</span> = SYSTEM_INFO*;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">GetComputerNameA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPSTR</span> <span class="org-variable-name">lpBuffer</span>, <span class="org-type">LPDWORD</span> <span class="org-variable-name">nSize</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">UINT</span> <span class="org-function-name">GetSystemWindowsDirectoryA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPSTR</span> <span class="org-variable-name">buffer</span>, <span class="org-type">UINT</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">UINT</span> <span class="org-function-name">GetSystemDirectoryA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPSTR</span> <span class="org-variable-name">buffer</span>, <span class="org-type">UINT</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">UINT</span> <span class="org-function-name">GetSystemWow64DirectoryA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPSTR</span> <span class="org-variable-name">buffer</span>, <span class="org-type">UINT</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>Windows<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">int</span> <span class="org-function-name">MessageBoxA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HWND</span> <span class="org-variable-name">hWnd</span>, <span class="org-type">LPCSTR</span> <span class="org-variable-name">lpText</span>, <span class="org-type">LPCSTR</span> <span class="org-variable-name">lpCaption</span>, <span class="org-type">UINT</span> <span class="org-variable-name">uType</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span> <span class="org-rainbow-delimiters-depth-1">(</span>Windows<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">HRESULT</span> <span class="org-function-name">SHGetFolderPathA</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">HWND</span> <span class="org-variable-name">hwnd</span>, <span class="org-type">int</span> <span class="org-variable-name">csidl</span>, <span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span>
                                          , <span class="org-type">DWORD</span> <span class="org-variable-name">flag</span>, <span class="org-type">LPSTR</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>Windows<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">GlobalMemoryStatusEx</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPMEMORYSTATUSEX</span> <span class="org-variable-name">lpBuffer</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">void</span> <span class="org-function-name">GetNativeSystemInfo</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPSYSTEM_INFO</span> <span class="org-variable-name">lpSystemInfo</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for C function pointer</span>
<span class="org-type">alias</span> <span class="org-variable-name">callback_t</span> = <span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">UINT</span> <span class="org-function-name">function</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPSTR</span> <span class="org-variable-name">buffer</span>, <span class="org-type">UINT</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">string</span> <span class="org-function-name">wrap_function</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">callback_t</span> <span class="org-variable-name">callback</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">Stack-allocated buffer, similar to char buffer[2048] in C or C++.</span>
  <span class="org-type">char</span><span class="org-rainbow-delimiters-depth-2">[</span>2048<span class="org-rainbow-delimiters-depth-2">]</span> buffer;
  <span class="org-type">UINT</span> <span class="org-variable-name">len</span> = callback<span class="org-rainbow-delimiters-depth-2">(</span>&amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, 2048<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-type">string</span> <span class="org-variable-name">res</span> = to<span class="org-negation-char">!</span>string<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-3">[</span>0 .. len<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> res;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">string</span> <span class="org-function-name">get_sh_folder_path</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">csidl</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">char</span><span class="org-rainbow-delimiters-depth-2">[</span>600<span class="org-rainbow-delimiters-depth-2">]</span> buffer;
  SHGetFolderPathA<span class="org-rainbow-delimiters-depth-2">(</span>null, csidl, null, 0, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Obtain number of characters until `\0` null char is found.</span>
  <span class="org-keyword">auto</span> <span class="org-variable-name">len</span> = strlen<span class="org-rainbow-delimiters-depth-2">(</span> cast<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-3">)</span> buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Remove trailing null characters </span>
  <span class="org-type">string</span> <span class="org-variable-name">res</span> = to<span class="org-negation-char">!</span>string<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-3">[</span>0 .. len<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> res;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">string</span> <span class="org-function-name">computer_name</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>  
  <span class="org-type">char</span><span class="org-rainbow-delimiters-depth-2">[</span>600<span class="org-rainbow-delimiters-depth-2">]</span> buffer;
  <span class="org-type">DWORD</span> <span class="org-variable-name">size</span> = 600;
  <span class="org-type">BOOL</span> <span class="org-variable-name">status</span> = GetComputerNameA<span class="org-rainbow-delimiters-depth-2">(</span>&amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, &amp;size<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> status == 1<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">auto</span> <span class="org-variable-name">len</span> = strlen<span class="org-rainbow-delimiters-depth-2">(</span> cast<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-3">)</span> buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-type">string</span> <span class="org-variable-name">res</span> = to<span class="org-negation-char">!</span>string<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-3">[</span>0 .. len<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> res;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_INTEL</span>    = 0;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_MIPS</span>     = 1;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_ALPHA</span>    = 2;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_PPC</span>      = 3;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_SHX</span>      = 4;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_ARM</span>      = 5;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_IA64</span>     = 6;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_ALPHA64</span>  = 7;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_MSIL</span>     = 8;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_AMD64</span>    = 9;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_ARM64</span>    = 12;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">PROCESSOR_ARCHITECTURE_UNKNOWN</span>  = 0xFFFF;

<span class="org-type">void</span> <span class="org-function-name">show_processor_info</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">SYSTEM_INFO</span> <span class="org-variable-name">info</span>;
    GetNativeSystemInfo<span class="org-rainbow-delimiters-depth-2">(</span>&amp;info<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">arch</span> = info.dummy.proc.wProcessorArchitecture;
    writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Processor architecture = "</span>, arch<span class="org-rainbow-delimiters-depth-2">)</span>;    

    writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Processor arch is x86 = "</span>
           , PROCESSOR_ARCHITECTURE_INTEL ==  cast<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span> arch ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Processor arch is AMD64 x64 (AMD or Intel) =  "</span>
           , PROCESSOR_ARCHITECTURE_AMD64 ==  cast<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span> arch ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Processor arch is ARM = "</span>
           , PROCESSOR_ARCHITECTURE_ARM ==  cast<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span> arch ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Processor arch is ARM64 = "</span>
           , PROCESSOR_ARCHITECTURE_ARM64 ==  cast<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span> arch ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Page size (virtual memory) in bytes = "</span>, info.dwPageSize<span class="org-rainbow-delimiters-depth-2">)</span>;
    writeln<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Number of processors = "</span>, info.dwNumberOfProcessors<span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_PROFILE</span>           = 0x0028;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_DESKTOP</span>           = 0x0000;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_PROGRAMS</span>          = 0x0002;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_STARTMENU</span>         = 0x000b;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_APPDATA</span>           = 0x001a;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_PROGRAM_FILES</span>     = 0x0026;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_ADMINTOOLS</span>        = 0x0030;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_LOCAL_APPDATA</span>     = 0x001c;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_FAVORITES</span>         = 0x0006;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_STARTUP</span>           = 0x0007;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_RECENT</span>            = 0x0008;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_SENDTO</span>            = 0x0009;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_WINDOWS</span>           = 0x0024;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_SYSTEM</span>            = 0x0025;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_FONTS</span>             = 0x0014;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_PROGRAM_FILESX86</span>  = 0x002a;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">CSIDL_SYSTEMX86</span>         = 0x0029;
</pre>
</div>

<p>
<b>Building</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ dmd sysinfo.d  -m64 Kernel32.lib Ntdll.lib User32.lib
</pre>
</div>

<p>
<b>Analyzing the PE32 executable binary file</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Location of tool</span>
$ where ldd
<span class="org-function-name">C</span>:\Users\User_001\scoop\apps\git\current\usr\bin\ldd.exe

<span class="org-comment-delimiter"># </span><span class="org-comment">Location of tool</span>
$ where file
<span class="org-function-name">C</span>:\Users\User_001\scoop\apps\git\current\usr\bin\file.exe

<span class="org-comment-delimiter"># </span><span class="org-comment">Check file type </span>
$ file sysinfo.exe
<span class="org-function-name">sysinfo.exe</span>: PE32+ executable (console) x86-64, for MS Windows

<span class="org-comment-delimiter"># </span><span class="org-comment">Check file size in Kilo bytes  (Kbytes)</span>
$ du -h sysinfo.exe
476K    sysinfo.exe

<span class="org-comment-delimiter"># </span><span class="org-comment">View dependencies (Shared libraries)</span>
$ ldd sysinfo.exe
        ntdll.dll =&gt; /c/WINDOWS/SYSTEM32/ntdll.dll (0x7ffe52eb0000)
        KERNEL32.DLL =&gt; /c/WINDOWS/System32/KERNEL32.DLL (0x7ffe510c0000)
        KERNELBASE.dll =&gt; /c/WINDOWS/System32/KERNELBASE.dll (0x7ffe50b30000)
        USER32.dll =&gt; /c/WINDOWS/System32/USER32.dll (0x7ffe51920000)
        win32u.dll =&gt; /c/WINDOWS/System32/win32u.dll (0x7ffe50870000)
        GDI32.dll =&gt; /c/WINDOWS/System32/GDI32.dll (0x7ffe515c0000)
        gdi32full.dll =&gt; /c/WINDOWS/System32/gdi32full.dll (0x7ffe50e00000)
        msvcp_win.dll =&gt; /c/WINDOWS/System32/msvcp_win.dll (0x7ffe50720000)
        ucrtbase.dll =&gt; /c/WINDOWS/System32/ucrtbase.dll (0x7ffe505f0000)
        SHELL32.dll =&gt; /c/WINDOWS/System32/SHELL32.dll (0x7ffe51ac0000)
</pre>
</div>

<p>
<b>Running</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ .\sysinfo.exe
 [TRACE] Started D application. Ok


 ======== General Basic Info =================

 [INFO] Computer Name = DESKTOP-GLXQAB76A
 [INFO] Windows System Directory path = C:\WINDOWS
 [INFO] Windows Directory =  C:\WINDOWS\system32
 [INFO] Windows Wow64 Directory =  C:\WINDOWS\SysWOW64

 ======== Processor Information ============

 [*] Processor architecture = 9
 [*] Processor arch is x86 = FALSE
 [*] Processor arch is AMD64 x64 (AMD or Intel) =  TRUE
 [*] Processor arch is ARM = FALSE
 [*] Processor arch is ARM64 = FALSE
 [*] Page size (virtual memory) <span class="org-keyword">in</span> bytes = 4096
 [*] Number of processors = 2

 ======== Memory Information ================

 [*] Percent of total physical memory used        = 40
 [*] Total physical memory<span class="org-keyword"> in</span> Megabytes           = 4095.484
 [*] Free memory<span class="org-keyword"> in</span> MB form total physical memory = 2447.137
 [*] Total size of page file<span class="org-keyword"> in</span> MB                = 4799.484
 [*] Free memory of page file   MB                = 2882.293
 [*] Total virtual memory<span class="org-keyword"> in</span>  MB                  = 134217727.875
 [*] Free virtual memory MB                       = 134213528.680
 [*] Amount of extended memory available<span class="org-keyword"> in</span> MB    = 0.000

 ===========  Directory Paths ===============

 [INFO] Profiles path      =  C:\Users\User_001
 [INFO] AppData path       =  C:\Users\User_001\AppData\Roaming
 [INFO] LocalAppData path  =  C:\Users\User_001\AppData\Local
 [INFO] Start menu path    =  C:\Users\User_001\AppData\Roaming\Microsoft\Windows\Start Menu
 [INFO] Desktop path       =  C:\Users\User_001\Desktop
 [INFO] Admin Tools Path   =  C:\Users\User_001\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Administrative Tools
 [INFO] Favorite path      =  C:\Users\User_001\Favorites
 [INFO] Startup path       =  C:\Users\User_001\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
 [INFO] Recent folder path =  C:\Users\User_001\AppData\Roaming\Microsoft\Windows\Recent
 [INFO] Sendto path        =  C:\Users\User_001\AppData\Roaming\Microsoft\Windows\SendTo
 [INFO] Program path       =  C:\Program Files
 [INFO] Windows path       =  C:\WINDOWS
 [INFO] System path        =  C:\WINDOWS\system32
 [INFO] Fonts folder       =  C:\WINDOWS\Fonts
 [INFO] System 86 path     =  C:\WINDOWS\SysWOW64
 [INFO] Progrm Files x86   =  C:\Program Files (x86)
 [TRACE] Terminated gracefully. Ok
</pre>
</div>
</div>
</div>
<div id="outline-container-org2e2e6c0" class="outline-4">
<h4 id="org2e2e6c0"><span class="section-number-4">1.12.4</span> Rust Sample Code Version</h4>
<div class="outline-text-4" id="text-1-12-4">
<p>
This rust version is an stil incomplete attempt of rewrite the C++ version.
</p>

<ul class="org-ul">
<li>Note: The CSIDL_ constants are extracted from <a href="https://github.com/reactos/reactos/blob/3fa57b8ff7fcee47b8e2ed869aecaf4515603f3f/sdk/include/psdk/shlobj.h">shlobj.h (React-OS source)</a>.</li>
</ul>

<p>
File: <span class="underline">sysinfo.rs</span> 
</p>

<div class="org-src-container">
<pre class="src src-c++">#<span class="org-rainbow-delimiters-depth-1">[</span>allow<span class="org-rainbow-delimiters-depth-2">(</span>warnings, unused_variables<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>
#<span class="org-rainbow-delimiters-depth-1">[</span>allow<span class="org-rainbow-delimiters-depth-2">(</span>warnings, unused_imports<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>
#<span class="org-rainbow-delimiters-depth-1">[</span>allow<span class="org-rainbow-delimiters-depth-2">(</span>dead_code<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>
#<span class="org-rainbow-delimiters-depth-1">[</span>allow<span class="org-rainbow-delimiters-depth-2">(</span>warnings, unused_mut<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>

use <span class="org-constant">std</span>::<span class="org-constant">os</span>::raw::<span class="org-rainbow-delimiters-depth-1">{</span>c_int, c_char, c_long, c_void, c_uint<span class="org-rainbow-delimiters-depth-1">}</span>;
<span class="org-type">use</span> <span class="org-constant">std</span>::<span class="org-constant">ffi</span>::<span class="org-variable-name">CString</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Useful Type aliases</span>
<span class="org-type">type</span> <span class="org-variable-name">HANDLE</span>  = *mut c_void;
<span class="org-type">type</span> <span class="org-variable-name">HWND</span>    = *mut c_void;
<span class="org-type">type</span> <span class="org-variable-name">LPCSTR</span>  = *<span class="org-keyword">const</span> c_char;
<span class="org-type">type</span> <span class="org-variable-name">LPSTR</span>   = *mut u8;
<span class="org-type">type</span> <span class="org-variable-name">DWORD</span>   = c_int;
<span class="org-type">type</span> <span class="org-variable-name">UINT</span>    = c_uint;
<span class="org-type">type</span> <span class="org-variable-name">HRESULT</span> = c_long;
<span class="org-type">type</span> <span class="org-variable-name">BOOL</span>    = c_int;

<span class="org-type">fn</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">The type [u8, 400] =&gt; Is similar to C++ type: uint8_t var[400]</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">or to the type std::array&lt;uint8_t, 400&gt;.</span>
    let <span class="org-type">mut</span> <span class="org-variable-name">buffer2</span>: <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-constant">u8</span>; 400<span class="org-rainbow-delimiters-depth-2">]</span> = <span class="org-rainbow-delimiters-depth-2">[</span>0; 400<span class="org-rainbow-delimiters-depth-2">]</span>;
    let <span class="org-type">mut</span> <span class="org-variable-name">nread</span>: UINT;
    unsafe <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">GetSystemWindowsDirectoryA(buffer.as_mut_ptr(), buffer_size as UINT );</span>
        nread = GetSystemWindowsDirectoryA<span class="org-rainbow-delimiters-depth-3">(</span>buffer2.as_mut_ptr<span class="org-rainbow-delimiters-depth-4">()</span>, buffer2.len<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-type">as</span> <span class="org-variable-name">UINT</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">println!(" [INFO] Windows path = {:?}", buffer);</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">println!(" [INFO] Buffer2 = {:?}", buffer2);</span>
    <span class="org-type">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">std</span>::<span class="org-constant">str</span>::from_utf8<span class="org-rainbow-delimiters-depth-2">(</span>&amp;buffer2<span class="org-rainbow-delimiters-depth-3">[</span>..<span class="org-rainbow-delimiters-depth-4">(</span>nread <span class="org-type">as</span> <span class="org-variable-name">usize</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>.unwrap<span class="org-rainbow-delimiters-depth-2">()</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Windows System Directory Path[2] = {:?}"</span>, s<span class="org-rainbow-delimiters-depth-2">)</span>;

    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Windows System Directory Path[1] = {}"</span>
             , wrap_function<span class="org-rainbow-delimiters-depth-3">(</span>GetSystemWindowsDirectoryA<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Windows Directory = {} "</span>
             , wrap_function<span class="org-rainbow-delimiters-depth-3">(</span>GetSystemDirectoryA<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Windows Wow64 Directory = {} "</span>
             , wrap_function<span class="org-rainbow-delimiters-depth-3">(</span>GetSystemWow64DirectoryA<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">const</span> <span class="org-type">CSIDL_PROFILE</span>:          c_int = 0x0028;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_DESKTOP</span>:          c_int = 0x0000;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_PROGRAMS</span>:         c_int = 0x0002;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_STARTMENU</span>:        c_int = 0x000b;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_APPDATA</span>:          c_int = 0x001a;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_PROGRAM_FILES</span>:    c_int = 0x0026;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_ADMINTOOLS</span>:       c_int = 0x0030;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_LOCAL_APPDATA</span>:    c_int = 0x001c;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_FAVORITES</span>:        c_int = 0x0006;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_STARTUP</span>:          c_int = 0x0007;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_RECENT</span>:           c_int = 0x0008;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_SENDTO</span>:           c_int = 0x0009;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_WINDOWS</span>:          c_int = 0x0024;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_SYSTEM</span>:           c_int = 0x0025;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_FONTS</span>:            c_int = 0x0014;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_PROGRAM_FILESX86</span>: c_int = 0x002a;
    <span class="org-keyword">const</span> <span class="org-type">CSIDL_SYSTEMX86</span>:        c_int = 0x0029;


    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n =========================================="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Profiles path      = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_PROFILE<span class="org-rainbow-delimiters-depth-3">)</span>       <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] AppData path       = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_APPDATA<span class="org-rainbow-delimiters-depth-3">)</span>       <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] LocalAppData path  = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_LOCAL_APPDATA<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Start menu path    = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_STARTMENU<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Desktop path       = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_DESKTOP<span class="org-rainbow-delimiters-depth-3">)</span>       <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Admin Tools Path   = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_ADMINTOOLS<span class="org-rainbow-delimiters-depth-3">)</span>    <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Favorite path      = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_FAVORITES<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Startup path       = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_STARTUP<span class="org-rainbow-delimiters-depth-3">)</span>       <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Recent folder path = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_RECENT<span class="org-rainbow-delimiters-depth-3">)</span>        <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Sendto path        = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_SENDTO<span class="org-rainbow-delimiters-depth-3">)</span>        <span class="org-rainbow-delimiters-depth-2">)</span>;   
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program path       = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_PROGRAM_FILES<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Windows path       = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_WINDOWS<span class="org-rainbow-delimiters-depth-3">)</span>       <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] System path        = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_SYSTEM<span class="org-rainbow-delimiters-depth-3">)</span>        <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Fonts folder       = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_FONTS<span class="org-rainbow-delimiters-depth-3">)</span>         <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] System 86 path     = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_SYSTEMX86<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-rainbow-delimiters-depth-2">)</span>;
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Progrm Files x86   = {} "</span>, get_sh_folder_path<span class="org-rainbow-delimiters-depth-3">(</span>CSIDL_PROGRAM_FILESX86<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">//</span><span class="org-comment">========================================================//</span>

#<span class="org-rainbow-delimiters-depth-1">[</span>link<span class="org-rainbow-delimiters-depth-2">(</span>name = <span class="org-string">"shell32"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span> 
<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">fn</span> <span class="org-function-name">SHGetFolderPathA</span><span class="org-rainbow-delimiters-depth-2">(</span> hwnd: HWND, csidl: c_int
                        , hToken: HANDLE, flag: DWORD, path: LPSTR<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; HRESULT;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">fn</span> <span class="org-function-name">get_sh_folder_path</span><span class="org-rainbow-delimiters-depth-1">(</span>csidl: c_int<span class="org-rainbow-delimiters-depth-1">)</span> -&gt; String
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">const</span> <span class="org-type">max_path</span>: usize = 260;
    <span class="org-type">let</span> <span class="org-type">mut</span> <span class="org-variable-name">buffer</span>: <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-constant">u8</span>; max_path<span class="org-rainbow-delimiters-depth-2">]</span> = <span class="org-rainbow-delimiters-depth-2">[</span>0; max_path<span class="org-rainbow-delimiters-depth-2">]</span>;
    <span class="org-type">let</span> <span class="org-variable-name">status</span>: HRESULT;
    unsafe <span class="org-rainbow-delimiters-depth-2">{</span> 
        status = SHGetFolderPathA<span class="org-rainbow-delimiters-depth-3">(</span>  <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-4">()</span>
                         , csidl
                         , <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-4">()</span>
                         , 0
                         , buffer.as_mut_ptr<span class="org-rainbow-delimiters-depth-4">()</span>
                        <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    assert<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span> status &gt;= 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">let</span> <span class="org-variable-name">st</span> = <span class="org-constant">std</span>::<span class="org-constant">str</span>::from_utf8<span class="org-rainbow-delimiters-depth-2">(</span> &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>..<span class="org-rainbow-delimiters-depth-4">(</span>max_path<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-rainbow-delimiters-depth-2">)</span>.unwrap<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-type">let</span> <span class="org-type">mut</span> <span class="org-variable-name">res</span>: String = st.to_string<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Remove \0 null characters.</span>
    res = res.trim_matches<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">char</span>::from<span class="org-rainbow-delimiters-depth-3">(</span>0<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>.to_string<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">return</span> res;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">/* </span>
<span class="org-comment">    *   UINT GetSystemWindowsDirectoryA(</span>
<span class="org-comment">    *                   LPSTR lpBuffer,</span>
<span class="org-comment">    *                   UINT  uSize</span>
<span class="org-comment">    *                   );</span>
<span class="org-comment">    **********************************************/</span>
    <span class="org-type">fn</span> <span class="org-function-name">GetSystemWindowsDirectoryA</span><span class="org-rainbow-delimiters-depth-2">(</span>buffer: LPSTR, size: UINT<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; UINT; 

    <span class="org-type">fn</span> <span class="org-function-name">GetSystemDirectoryA</span><span class="org-rainbow-delimiters-depth-2">(</span>buffer: LPSTR, size: UINT<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; UINT; 
    <span class="org-type">fn</span> <span class="org-function-name">GetSystemWow64DirectoryA</span><span class="org-rainbow-delimiters-depth-2">(</span>buffer: LPSTR, size: UINT<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; UINT; 
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">type</span> <span class="org-variable-name">Callback1</span> = unsafe <span class="org-keyword">extern</span> <span class="org-string">"C"</span> fn<span class="org-rainbow-delimiters-depth-1">(</span>buffer: LPSTR, size: UINT<span class="org-rainbow-delimiters-depth-1">)</span> -&gt; UINT;

<span class="org-type">fn</span> <span class="org-function-name">wrap_function</span><span class="org-rainbow-delimiters-depth-1">(</span>callback: Callback1<span class="org-rainbow-delimiters-depth-1">)</span> -&gt; String
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">let</span> <span class="org-type">mut</span> <span class="org-variable-name">buffer2</span>: <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-constant">u8</span>; 400<span class="org-rainbow-delimiters-depth-2">]</span> = <span class="org-rainbow-delimiters-depth-2">[</span>0; 400<span class="org-rainbow-delimiters-depth-2">]</span>;
    <span class="org-type">let</span> <span class="org-type">mut</span> <span class="org-variable-name">nread</span>: UINT = 0;
    unsafe <span class="org-rainbow-delimiters-depth-2">{</span>
        nread = callback<span class="org-rainbow-delimiters-depth-3">(</span>buffer2.as_mut_ptr<span class="org-rainbow-delimiters-depth-4">()</span>, buffer2.len<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-type">as</span> <span class="org-variable-name">UINT</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">std</span>::<span class="org-constant">str</span>::from_utf8<span class="org-rainbow-delimiters-depth-2">(</span>&amp;buffer2<span class="org-rainbow-delimiters-depth-3">[</span>..<span class="org-rainbow-delimiters-depth-4">(</span>nread <span class="org-type">as</span> <span class="org-variable-name">usize</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>.unwrap<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">return</span> s.to_string<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ rustc sysinfo.rs 
</pre>
</div>

<p>
<b>Analyzing the PE32 executable binary file</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ where ldd
<span class="org-function-name">C</span>:\Users\User_001\scoop\apps\git\current\usr\bin\ldd.exe

$ where file
<span class="org-function-name">C</span>:\Users\User_001\scoop\apps\git\current\usr\bin\file.exe

$ file sysinfo.exe
<span class="org-function-name">sysinfo.exe</span>: PE32+ executable (console) x86-64, for MS Windows

$ du -h sysinfo.exe
172K    sysinfo.exe

$ ldd sysinfo.exe
        ntdll.dll =&gt; /c/WINDOWS/SYSTEM32/ntdll.dll (0x7ffe52eb0000)
        KERNEL32.DLL =&gt; /c/WINDOWS/System32/KERNEL32.DLL (0x7ffe510c0000)
        KERNELBASE.dll =&gt; /c/WINDOWS/System32/KERNELBASE.dll (0x7ffe50b30000)
        SHELL32.dll =&gt; /c/WINDOWS/System32/SHELL32.dll (0x7ffe51ac0000)
        msvcp_win.dll =&gt; /c/WINDOWS/System32/msvcp_win.dll (0x7ffe50720000)
        ucrtbase.dll =&gt; /c/WINDOWS/System32/ucrtbase.dll (0x7ffe505f0000)
        USER32.dll =&gt; /c/WINDOWS/System32/USER32.dll (0x7ffe51920000)
        win32u.dll =&gt; /c/WINDOWS/System32/win32u.dll (0x7ffe50870000)
        GDI32.dll =&gt; /c/WINDOWS/System32/GDI32.dll (0x7ffe515c0000)
        gdi32full.dll =&gt; /c/WINDOWS/System32/gdi32full.dll (0x7ffe50e00000)
        VCRUNTIME140.dll =&gt; /c/WINDOWS/SYSTEM32/VCRUNTIME140.dll (0x7ffe49e30000)
</pre>
</div>

<p>
<b>Running</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ .\sysinfo.exe

 [INFO] Windows System Directory Path[2] = <span class="org-string">"C:\\WINDOWS"</span>
 [INFO] Windows System Directory Path[1] = C:\WINDOWS
 [INFO] Windows Directory = C:\WINDOWS\system32
 [INFO] Windows Wow64 Directory = C:\WINDOWS\SysWOW64

 ==========================================
 [INFO] Profiles path      = C:\Users\User_001
 [INFO] AppData path       = C:\Users\User_001\AppData\Roaming
 [INFO] LocalAppData path  = C:\Users\User_001\AppData\Local
 [INFO] Start menu path    = C:\Users\User_001\AppData\Roaming\Microsoft\Windows\Start Menu
 [INFO] Desktop path       = C:\Users\User_001\Desktop
 [INFO] Admin Tools Path   = C:\Users\User_001\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Administrative Tools
 [INFO] Favorite path      = C:\Users\User_001\Favorites
 [INFO] Startup path       = C:\Users\User_001\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
 [INFO] Recent folder path = C:\Users\User_001\AppData\Roaming\Microsoft\Windows\Recent
 [INFO] Sendto path        = C:\Users\User_001\AppData\Roaming\Microsoft\Windows\SendTo
 [INFO] Program path       = C:\Program Files
 [INFO] Windows path       = C:\WINDOWS
 [INFO] System path        = C:\WINDOWS\system32
 [INFO] Fonts folder       = C:\WINDOWS\Fonts
 [INFO] System 86 path     = C:\WINDOWS\SysWOW64
 [INFO] Progrm Files x86   = C:\Program Files (x86)

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgce0e94f" class="outline-3">
<h3 id="orgce0e94f"><span class="section-number-3">1.13</span> Windows Shortcut - LNK</h3>
<div class="outline-text-3" id="text-1-13">
</div>
<div id="outline-container-orgba86700" class="outline-4">
<h4 id="orgba86700"><span class="section-number-4">1.13.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-13-1">
<p>
The following code snippet creates several Windows shortcuts, also
known as Windows Shell Link (*.lnk files), which are similar to Unix's
symbolic links and Free-Desktop .desktop (FreeDesktop standard)
launchers used on X11. Shell link files allows creating launchers to
executable and directories. Unlike the X11 Free-Desktop standard
*.desktop files, which are text files, the Windows shell link files
are structured binary files, as a result, they only can be viewed
by using Windows facilities or by using a hexadecimal editor.
</p>

<p>
<b>Documentation</b>
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/shell/links">Shell Links</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/unknwn/nn-unknwn-iunknown">IUnknown COM Interface</a> (header: unknown.h)
<ul class="org-ul">
<li>Brief: "Enables clients to get pointers to other interfaces on
a given object through the QueryInterface method, and manage
the existence of the object through the AddRef and Release
methods. All other COM interfaces are inherited, directly or
indirectly, from IUnknown. Therefore, the three methods in
IUnknown are the first entries in the vtable for every
interface."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishelllinka">IShellLinkA COM Interface</a> (header: shobjidl_core.h)
<ul class="org-ul">
<li>Brief: "Exposes methods that create, modify, and resolve Shell
links."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/objidl/nn-objidl-ipersist">IPersist COM Interface</a> (header: objidl.h)
<ul class="org-ul">
<li>Brief: "Provides the CLSID of an object that can be stored
persistently in the system. Allows the object to specify which
object handler to use in the client process, as it is used in
the default implementation of marshaling."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance">CoCreateInstance()</a>
<ul class="org-ul">
<li>Brief: "Creates and default-initializes a single object of the
class associated with a specified CLSID."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/learnwin32/creating-an-object-in-com">Creating an Object in COM</a></li>
</ul>


<p>
Windows Shortcut Binary Format Specification:
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/16cb4ca1-9339-4d0c-a68d-bf1d6cc0f943">{MS-SHLLINK}: Shell Link (.LNK) Binary File Format</a>
<ul class="org-ul">
<li>Official specification of the Windows LNK file format.</li>
</ul></li>

<li><a href="https://formats.kaitai.io/windows_lnk_file/index.html">Windows shell link file: format specification</a>
<ul class="org-ul">
<li>Kaitai Format Gallery.</li>
</ul></li>

<li><a href="https://web.archive.org/web/20191001124542/https://ithreats.files.wordpress.com/2009/05/lnk_the_windows_shortcut_file_format.pdf">The Windows Shortcut Format</a> [PDF] (Jesse Hager)</li>

<li><a href="https://github.com/reactos/reactos/blob/3fa57b8ff7fcee47b8e2ed869aecaf4515603f3f/sdk/tools/mkshelllink/mkshelllink.c">File: mkshelllink.c</a> - ReactorOS implementation.</li>
</ul>


<p>
X11 Free Desktop Shortcut Specification (for comparison)
</p>

<ul class="org-ul">
<li><a href="https://www.freedesktop.org/wiki/">https://www.freedesktop.org/wiki/</a></li>

<li><a href="https://en.wikipedia.org/wiki/Freedesktop.org">https://en.wikipedia.org/wiki/Freedesktop.org</a></li>

<li><a href="https://specifications.freedesktop.org/desktop-entry-spec/desktop-entry-spec-latest.html">Desktop Entry Specification</a>
<ul class="org-ul">
<li>Specification of *.desktop shortcut files used on Linux and BSD
X11 or Wayland desktop environments.</li>
</ul></li>

<li><a href="https://wiki.archlinux.org/title/desktop_entries">ArchLinux - Desktop Entries </a></li>

<li><a href="https://developer.gnome.org/integration-guide/stable/desktop-files.html.en">Desktop files: putting your application in the desktop menus</a></li>
</ul>
</div>
</div>
<div id="outline-container-org7ff9fa5" class="outline-4">
<h4 id="org7ff9fa5"><span class="section-number-4">1.13.2</span> Creating shell link</h4>
<div class="outline-text-4" id="text-1-13-2">
<p>
This sample application instantiates an object of COM (Component
Object Model) class ShellLink and obtains the two interface pointers
to the object, IShellLinkA and IPersistFile for creating Windows shell
links, LNK shortcut files. 
</p>

<p>
<b>Files</b>
</p>

<p>
File: <span class="underline">winshortcut.cpp</span>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">INITGUID</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Necessary for MINGW</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">shlobj.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">shobjidl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">shlguid.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">comdef.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">comdefsp.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Get environment variable</span>
<span class="org-function-name">std</span>::string get_envvar<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Create Windows Shortcut (aka shell Link - LNK File)</span>
<span class="org-type">BOOL</span> <span class="org-function-name">createWindowsShortcut</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">fileName</span>
                           , <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">arguments</span>
                           , <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span>
                           , <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class="org-keyword">auto</span> homedir= get_envvar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERPROFILE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">const</span> <span class="org-keyword">auto</span> desktop_dir = homedir + <span class="org-string">"\\Desktop"</span>;
  <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Desktop dir = %s \n"</span>, desktop_dir.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Create shortcut to Notepad.exe at user's Desktop directory.</span>
  createWindowsShortcut<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Executable or command that the shortcut will launch.</span>
                          <span class="org-string">"notepad.exe"</span>
                         <span class="org-comment-delimiter">// </span><span class="org-comment">Arguments used by Notepad.exe</span>
                         , <span class="org-string">""</span>
                         <span class="org-comment-delimiter">// </span><span class="org-comment">Absolute path to where the shortcut will be created.</span>
                         , desktop_dir + <span class="org-string">"\\Notepad.lnk"</span>
                         , <span class="org-string">"Shortcut for notepad.exe"</span>
                         <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Create shortcut for the DxDiag.exe utility</span>
  createWindowsShortcut<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Executable or command that the shortcut will launch.</span>
                          <span class="org-string">"dxdiag"</span>
                         , <span class="org-string">""</span>
                         <span class="org-comment-delimiter">// </span><span class="org-comment">Absolute path to where the shortcut will be created.</span>
                         , desktop_dir + <span class="org-string">"\\DxDiagTool.lnk"</span>
                         , <span class="org-string">"Shortcut for DirectX and OpenGL diagnosing tool."</span>
                         <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Create shortcut to user's home directory</span>
  createWindowsShortcut<span class="org-rainbow-delimiters-depth-2">(</span>   homedir
                         , <span class="org-string">""</span>
                         , desktop_dir + <span class="org-string">"\\HomeDirectory.lnk"</span>
                         , <span class="org-string">"Shortcut for my documents"</span>
                         <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Create shortcut to Device Manager for viewing user hardware settings.</span>
  createWindowsShortcut<span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-string">"RunDll32.exe"</span>
                         , <span class="org-string">"devmgr.dll DeviceManager_Execute"</span>
                         , desktop_dir + <span class="org-string">"\\Device_Manager.lnk"</span>
                         , <span class="org-string">"Shortcut for device manager."</span>
                         <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Create shortcut for starting Notepad.exe automatically after reboot.</span>
  createWindowsShortcut<span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-string">"notepad.exe"</span>
                        , <span class="org-string">""</span>
                        , homedir + <span class="org-string">"\\Start Menu\\Programs\\Startup\\MyNotepad.lnk"</span>
                        , <span class="org-string">"Notepad.exe tools"</span>
                        <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Application terminated Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">==== I M P L E M E N T A T I O N S ============== //</span>

<span class="org-function-name">std</span>::string
get_envvar<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">p</span> = <span class="org-constant">std</span>::getenv<span class="org-rainbow-delimiters-depth-2">(</span>name.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> p == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> <span class="org-string">""</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-keyword">return</span> p;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">BOOL</span> <span class="org-function-name">createWindowsShortcut</span><span class="org-rainbow-delimiters-depth-1">(</span>
              <span class="org-comment-delimiter">// </span><span class="org-comment">Executable or command launched by the Windows shortcut</span>
               <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">filePath_</span>
              <span class="org-comment-delimiter">// </span><span class="org-comment">Arguments used by the executable</span>
              , <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args_</span>
              <span class="org-comment-delimiter">// </span><span class="org-comment">Absolute path to where the shortcut file will be created.</span>
              <span class="org-comment-delimiter">// </span><span class="org-comment">Note: This path must include the extenion .lnk, for instance</span>
              <span class="org-comment-delimiter">// </span><span class="org-comment">this argument could be: "C:\\Users\\MyUser\\Desktop\\Notepad.exe"</span>
              , <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path_</span>
              <span class="org-comment-delimiter">// </span><span class="org-comment">Title or description of the shortcut file.</span>
              , <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">title_</span>
            <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">fileName</span> = filePath_.c_str<span class="org-rainbow-delimiters-depth-2">()</span>;
  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">args</span>     = args_.c_str<span class="org-rainbow-delimiters-depth-2">()</span>;
  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">path</span>     = path_.c_str<span class="org-rainbow-delimiters-depth-2">()</span>;
  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">title</span>    = title_.c_str<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">"\n [TRACE] Creating shortcut for command = '%s' \n"</span>, fileName<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Creating shortcut as file = '%s' \n"</span>, path<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Intialize COM</span>
  CoInitializeEx<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">NULL</span>, 0 <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to COM interface</span>
  <span class="org-type">IShellLink</span>* <span class="org-variable-name">ptr_com</span> = <span class="org-constant">nullptr</span>;

  <span class="org-type">HRESULT</span> <span class="org-variable-name">hres</span> = CoCreateInstance<span class="org-rainbow-delimiters-depth-2">(</span>
                        <span class="org-comment-delimiter">// </span><span class="org-comment">CLSID =&gt;&gt; Unique universal identifier for Shell Link class</span>
                        <span class="org-comment-delimiter">// </span><span class="org-comment">The class is the concrete implememntation of a COM Interface</span>
                        <span class="org-comment-delimiter">// </span><span class="org-comment">(COM - Component Object Model)</span>
                           CLSID_ShellLink
                         , <span class="org-constant">NULL</span>
                         <span class="org-comment-delimiter">// </span><span class="org-comment">This constant 'CLSCTX_INPROC_SERVER' means that the</span>
                         <span class="org-comment-delimiter">// </span><span class="org-comment">COM server is in-process,in other words, the COM server</span>
                         <span class="org-comment-delimiter">// </span><span class="org-comment">is provide by a DLL (Dynamic Linked Library)</span>
                         , CLSCTX_INPROC_SERVER
                         <span class="org-comment-delimiter">// </span><span class="org-comment">IID (Interface Identifier) =&gt; Unique universal identifier (GUID)</span>
                         <span class="org-comment-delimiter">// </span><span class="org-comment">for the COM interface that the COM class conforms to.</span>
                         , IID_IShellLink
                         <span class="org-comment-delimiter">// </span><span class="org-comment">void** =&gt; [OUTPUT] Parameter that returns pointer to COM</span>
                         <span class="org-comment-delimiter">// </span><span class="org-comment">Interface</span>
                         , <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">LPVOID</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>&amp;ptr_com<span class="org-rainbow-delimiters-depth-3">)</span>
                       <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> FALSE; <span class="org-rainbow-delimiters-depth-2">}</span>
  assert<span class="org-rainbow-delimiters-depth-2">(</span> ptr_com != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">IPersistFile</span>* <span class="org-variable-name">ptr_com2</span> = <span class="org-constant">nullptr</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Query comp object pointed by ptr_com and check whether</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">it implements the interface IPersistFile. If the query is</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">successful, the pointer ptr_com2 will be not NULL.</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">LPVOID = void**</span>
  hres = ptr_com-&gt;QueryInterface<span class="org-rainbow-delimiters-depth-2">(</span>IID_IPersistFile, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">void</span>**<span class="org-rainbow-delimiters-depth-3">)</span> &amp;ptr_com2<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> FALSE; <span class="org-rainbow-delimiters-depth-2">}</span>
  assert<span class="org-rainbow-delimiters-depth-2">(</span> ptr_com2 != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  ptr_com-&gt;SetPath<span class="org-rainbow-delimiters-depth-2">(</span>fileName<span class="org-rainbow-delimiters-depth-2">)</span>;
  ptr_com-&gt;SetDescription<span class="org-rainbow-delimiters-depth-2">(</span>title<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>args_ != <span class="org-string">""</span><span class="org-rainbow-delimiters-depth-2">){</span> ptr_com-&gt;SetArguments<span class="org-rainbow-delimiters-depth-3">(</span>args<span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">WCHAR</span> <span class="org-variable-name">out_path</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_PATH<span class="org-rainbow-delimiters-depth-2">]</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Change string to Unicode</span>
  MultiByteToWideChar<span class="org-rainbow-delimiters-depth-2">(</span>CP_ACP, 0, path, -1, out_path, MAX_PATH<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Save Windows shortcut</span>
  ptr_com2-&gt;Save<span class="org-rainbow-delimiters-depth-2">(</span>out_path, TRUE<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Release COM interface pointers</span>
  ptr_com2-&gt;Release<span class="org-rainbow-delimiters-depth-2">()</span>;
  ptr_com-&gt;Release<span class="org-rainbow-delimiters-depth-2">()</span>;

  CoUninitialize<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-keyword">return</span> TRUE;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building with Mingw</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ winshortcut.cpp -o <span class="org-keyword">winshortcut-mingw.exe</span> -std=c++1z -lole32 -loleaut32 -Wall -Wextra -g
</pre>
</div>

<p>
<b>Building with MSVC CL.exe</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe winshortcut.cpp
<span class="org-function-name">Microsoft</span> (R) C/C++ Optimizing Compiler Version 19.28.29335 for x64
<span class="org-function-name">Copyright</span> (C) Microsoft Corporation.  All rights reserved.

winshortcut.cpp
<span class="org-function-name">Microsoft</span> (R) Incremental Linker Version 14.28.29335.0
<span class="org-function-name">Copyright</span> (C) Microsoft Corporation.  All rights reserved.

<span class="org-function-name">/out</span>:winshortcut.exe
winshortcut.obj
</pre>
</div>

<p>
<b>Analyse the files with 'file' Linux tool from GIT</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ file winshortcut.exe
<span class="org-function-name">winshortcut.exe</span>: PE32+ executable (console) x86-64, for MS Windows

$ file winshortcut-mingw.exe
<span class="org-function-name">winshortcut-mingw.exe</span>: PE32+ executable (console) x86-64, for MS Windows

$ file winshortcut.obj
<span class="org-function-name">winshortcut.obj</span>: Intel amd64 COFF object file, not stripped, 881 sections, symbol <span class="org-variable-name">offset</span>=0x106a9, 2772 symbols
</pre>
</div>

<p>
<b>Run application for creating Windows shortcuts</b>
</p>

<ul class="org-ul">
<li>After the application is run, the shortcuts can be executed either
from command line or by clicking at them at the Desktop directory.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ .\winshortcut.exe
[TRACE] Desktop dir = C:\Users\user_001\Desktop

[TRACE] Creating shortcut for command = <span class="org-string">'notepad.exe'</span>
[TRACE] Creating shortcut as file = <span class="org-string">'C:\Users\user_001\Desktop\Notepad.lnk'</span>

[TRACE] Creating shortcut for command = <span class="org-string">'dxdiag'</span>
[TRACE] Creating shortcut as file = <span class="org-string">'C:\Users\user_001\Desktop\DxDiagTool.lnk'</span>

[TRACE] Creating shortcut for command = <span class="org-string">'C:\Users\user_001'</span>
[TRACE] Creating shortcut as file = <span class="org-string">'C:\Users\user_001\Desktop\HomeDirectory.lnk'</span>

[TRACE] Creating shortcut for command = <span class="org-string">'RunDll32.exe'</span>
[TRACE] Creating shortcut as file = <span class="org-string">'C:\Users\user_001\Desktop\Device_Manager.lnk'</span>

[TRACE] Creating shortcut for command = <span class="org-string">'notepad.exe'</span>
[TRACE] Creating shortcut as file = <span class="org-string">'C:\Users\user_001\Start Menu\Programs\Startup\MyNotepad.lnk'</span>
[TRACE] Application terminated Ok.
</pre>
</div>

<p>
<b>Run shortcuts from command line</b>
</p>

<p>
List all shortcut files at Desktop directory:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls %USERPROFILE%/Desktop/*.lnk
<span class="org-string">'C:\Users\user_001/Desktop/CodeBlocks.lnk'</span>*
<span class="org-string">'C:\Users\user_001/Desktop/Device_Manager.lnk'</span>*
<span class="org-string">'C:\Users\user_001/Desktop/DxDiagTool.lnk'</span>*
<span class="org-string">'C:\Users\user_001/Desktop/HomeDirectory.lnk'</span>*
<span class="org-string">'C:\Users\user_001/Desktop/Notepad.lnk'</span>*
</pre>
</div>

<p>
View shortcut files:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ file Notepad.lnk
<span class="org-function-name">Notepad.lnk</span>: MS Windows shortcut, Item id list present
, Has Description string, Has Relative path
, <span class="org-variable-name">ctime</span>=Mon Jan  1 08:00:00 1601
, <span class="org-variable-name">mtime</span>=Mon Jan  1 08:00:00 1601, <span class="org-variable-name">atime</span>=Mon Jan
1 08:00:00 1601, <span class="org-variable-name">length</span>=0, <span class="org-variable-name">window</span>=hide


$ file DxDiagTool.lnk
<span class="org-function-name">DxDiagTool.lnk</span>: MS Windows shortcut, Item id list present,
Has Description string, Has Relative path, <span class="org-variable-name">ctime</span>=Mon Jan
1 08:00:00 1601, <span class="org-variable-name">mtime</span>=Mon Jan  1 08:00:00 1601,
<span class="org-variable-name">atime</span>=Mon Jan  1 08:00:00 1601, <span class="org-variable-name">length</span>=0, <span class="org-variable-name">window</span>=hide
</pre>
</div>

<p>
Run shortcut from command line:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Run shortcut lnk that launches Notepad.exe</span>
$ .<span class="org-string">\\</span>Notepad.lnk

<span class="org-comment-delimiter"># </span><span class="org-comment">Run shortcut lnk that launches DxDiagTool.lnk</span>
$ .\DxDiagTool.lnk

<span class="org-comment-delimiter"># </span><span class="org-comment">Run shortcutr that opens the directory C:\\Users\user_001 (%USERPROFILE%) directory</span>
$ HomeDirectory.lnk
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc5f76ae" class="outline-4">
<h4 id="orgc5f76ae"><span class="section-number-4">1.13.3</span> Reading shell link</h4>
<div class="outline-text-4" id="text-1-13-3">
<p>
This application prints information about Windows shell link files LNK
(extension .lnk). It displays the path to shell link file, the command
line arguments passed to the executable, the working directory and the
icon path.
</p>

<p>
<b>Files:</b>
</p>

<p>
File: <span class="underline">lnkdump.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">INITGUID</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Necessary for MINGW</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">shlobj.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">shobjidl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">shlguid.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">comdef.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">comdefsp.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-function-name">std</span>::string guid_to_string<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">GUID</span> <span class="org-variable-name">g</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span> stderr
                 , <span class="org-string">"\n Read Windows shell link shortcut files LNK (*.lnk extension) "</span>
                   <span class="org-string">"\n Usage: "</span>
                   <span class="org-string">"\n  $ lnkdump &lt;SHELL-LINK-FILE&gt; "</span>
                <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-keyword">return</span> EXIT_FAILURE;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">file</span> = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Display UUID of COM interfaces and classes </span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> file == <span class="org-string">"guid"</span> <span class="org-rainbow-delimiters-depth-2">)</span> 
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span> stderr, <span class="org-string">" [INFO] (class)       CLSID_ShellLink = %s \n"</span>
                  , guid_to_string<span class="org-rainbow-delimiters-depth-4">(</span>CLSID_ShellLink<span class="org-rainbow-delimiters-depth-4">)</span>.c_str<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span> stderr, <span class="org-string">" [INFO] (interface)      IID_IUnknown = %s  \n"</span>
                , guid_to_string<span class="org-rainbow-delimiters-depth-4">(</span>IID_IUnknown<span class="org-rainbow-delimiters-depth-4">)</span>.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span> stderr, <span class="org-string">" [INFO] (interface)     IID_IDispatch = %s  \n"</span>
                , guid_to_string<span class="org-rainbow-delimiters-depth-4">(</span>IID_IDispatch<span class="org-rainbow-delimiters-depth-4">)</span>.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span> stderr, <span class="org-string">" [INFO] (interface)    IID_IShellLink = %s  \n"</span>
                , guid_to_string<span class="org-rainbow-delimiters-depth-4">(</span>IID_IShellLink<span class="org-rainbow-delimiters-depth-4">)</span>.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span> stderr, <span class="org-string">" [INFO] (interface)  IID_IPersistFile = %s  \n"</span>
                  , guid_to_string<span class="org-rainbow-delimiters-depth-4">(</span>IID_IPersistFile<span class="org-rainbow-delimiters-depth-4">)</span>.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-keyword">return</span> EXIT_SUCCESS;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">Intialize COM</span>
  CoInitializeEx<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">NULL</span>, 0 <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to COM interface</span>
  <span class="org-type">IShellLinkA</span>* <span class="org-variable-name">ptr_com</span> = <span class="org-constant">nullptr</span>;

  <span class="org-type">HRESULT</span> <span class="org-variable-name">hres</span> = CoCreateInstance<span class="org-rainbow-delimiters-depth-2">(</span>
                           CLSID_ShellLink
                         , <span class="org-constant">NULL</span>
                         , CLSCTX_INPROC_SERVER
                         , IID_IShellLink
                         , <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">void</span>**<span class="org-rainbow-delimiters-depth-3">&gt;(</span>&amp;ptr_com<span class="org-rainbow-delimiters-depth-3">)</span>
                       <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> FALSE; <span class="org-rainbow-delimiters-depth-2">}</span>
  assert<span class="org-rainbow-delimiters-depth-2">(</span> ptr_com != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to IPersisteFile =&gt; Not allocated by the caller.</span>
  <span class="org-type">IPersistFile</span>* <span class="org-variable-name">ptr_com2</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Retrieve interface from COM object</span>
  hres = ptr_com-&gt;QueryInterface<span class="org-rainbow-delimiters-depth-2">(</span> IID_IPersistFile, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">void</span>**<span class="org-rainbow-delimiters-depth-3">)</span> &amp;ptr_com2<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> ptr_com2 != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">WCHAR</span> <span class="org-variable-name">fpath_wchar</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_PATH<span class="org-rainbow-delimiters-depth-2">]</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Convert to UTF16 unicode wide character</span>
  MultiByteToWideChar<span class="org-rainbow-delimiters-depth-2">(</span>CP_ACP, 0, file.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, -1, fpath_wchar, MAX_PATH<span class="org-rainbow-delimiters-depth-2">)</span>;

  hres = ptr_com2-&gt;Load<span class="org-rainbow-delimiters-depth-2">(</span>fpath_wchar, STGM_READ<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> &amp;&amp; <span class="org-string">"Failed to read shortcut"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Resolve shell link</span>
  hres = ptr_com-&gt;Resolve<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> &amp;&amp; <span class="org-string">"Failed to resolve shell link"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">===== Read shortcut LNK data ======================///</span>

  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span>, <span class="org-variable-name">arguments</span>, <span class="org-variable-name">description</span>, <span class="org-variable-name">directory</span>, <span class="org-variable-name">icon</span>;

  <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_PATH<span class="org-rainbow-delimiters-depth-2">]</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Get shortcut description</span>
  hres = ptr_com-&gt;GetDescription<span class="org-rainbow-delimiters-depth-2">(</span>buffer, MAX_PATH<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [WARN] Failed to get description \n"</span> <span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
  description  = buffer;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Get path to shell link target, application called by the</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">shell link.</span>
  <span class="org-type">WIN32_FIND_DATA</span> <span class="org-variable-name">wfd</span>;
  hres = ptr_com-&gt;GetPath<span class="org-rainbow-delimiters-depth-2">(</span> buffer
                         , MAX_PATH
                         , <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">WIN32_FIND_DATA</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>&amp;wfd<span class="org-rainbow-delimiters-depth-3">)</span>
                         , SLGP_SHORTPATH
                         <span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  path = buffer;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Get working directory of shell link</span>
  hres = ptr_com-&gt;GetWorkingDirectory<span class="org-rainbow-delimiters-depth-2">(</span>buffer, MAX_PATH<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  directory = buffer;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Get working directory of shell link</span>
  hres = ptr_com-&gt;GetArguments<span class="org-rainbow-delimiters-depth-2">(</span>buffer, MAX_PATH<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  arguments = buffer;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Get Icon location</span>
  <span class="org-type">int</span> <span class="org-variable-name">n</span> = 0;
  hres = ptr_com-&gt;GetIconLocation<span class="org-rainbow-delimiters-depth-2">(</span>buffer, MAX_PATH, &amp;n<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  icon = buffer;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Get hotkey</span>
  <span class="org-type">WORD</span> <span class="org-variable-name">Hotkey</span> = 0;
  hres = ptr_com-&gt;GetHotkey<span class="org-rainbow-delimiters-depth-2">(</span>&amp;Hotkey<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hres<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*]          Path  = "</span> &lt;&lt;  path        &lt;&lt; <span class="org-string">'\n'</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*]      Arguments = "</span> &lt;&lt;  arguments   &lt;&lt; <span class="org-string">'\n'</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*]    Description = "</span> &lt;&lt;  description &lt;&lt; <span class="org-string">'\n'</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*]   Working dir  = "</span> &lt;&lt;  directory   &lt;&lt; <span class="org-string">'\n'</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*]           Icon = "</span> &lt;&lt;  icon        &lt;&lt; <span class="org-string">'\n'</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*]         Hotkey = "</span> &lt;&lt;  Hotkey      &lt;&lt; <span class="org-string">'\n'</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Release COM interface pointers</span>
  ptr_com-&gt;Release<span class="org-rainbow-delimiters-depth-2">()</span>;
  ptr_com2-&gt;Release<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Shutdown COM</span>
  CoUninitialize<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-keyword">return</span> EXIT_SUCCESS;

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">------ End of main -----------//</span>

   <span class="org-comment-delimiter">// </span><span class="org-comment">================================//</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Print GUID (Global Unique Identifier)</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">or UUID (Universal Unique Identifier)</span>
<span class="org-function-name">std</span>::string 
guid_to_string<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">GUID</span> <span class="org-variable-name">g</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">size</span> = 300;
  <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>size<span class="org-rainbow-delimiters-depth-2">]</span>;
  memset<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">'\0'</span> ,size<span class="org-rainbow-delimiters-depth-2">)</span>;

  snprintf<span class="org-rainbow-delimiters-depth-2">(</span> buffer, size
            , <span class="org-string">"{%08lX-%04hX-%04hX-%02hhX%02hhX-%02hhX%02hhX%02hhX%02hhX%02hhX%02hhX}"</span>
            , g.Data1, g.Data2, g.Data3
            , g.Data4<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, g.Data4<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, g.Data4<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, g.Data4<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span>
            , g.Data4<span class="org-rainbow-delimiters-depth-3">[</span>4<span class="org-rainbow-delimiters-depth-3">]</span>, g.Data4<span class="org-rainbow-delimiters-depth-3">[</span>5<span class="org-rainbow-delimiters-depth-3">]</span>, g.Data4<span class="org-rainbow-delimiters-depth-3">[</span>6<span class="org-rainbow-delimiters-depth-3">]</span>, g.Data4<span class="org-rainbow-delimiters-depth-3">[</span>7<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">out</span> = buffer;
   <span class="org-keyword">return</span> out;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building:</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ lnkdump.cpp -o <span class="org-keyword">lnkdump.exe</span> -lole32 -loleaut32 -lcomctl32 -luuid -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
<b>Running</b> 
</p>

<p>
Show help: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ lnkdump.exe

 Read Windows shell link shortcut files LNK (*.lnk extension)
 Usage:
  $ lnkdump &lt;SHELL-LINK-FILE&gt;
</pre>
</div>

<p>
Display the GUID (Global Unique Identifier) of COM interfaces and
classes: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ lnkdump.exe  guid
 [INFO] (class)       CLSID_ShellLink = {00021401-0000-0000-C000-000000000046}
 [INFO] (interface)      IID_IUnknown = {00000000-0000-0000-C000-000000000046}
 [INFO] (interface)     IID_IDispatch = {00020400-0000-0000-C000-000000000046}
 [INFO] (interface)    IID_IShellLink = {000214EE-0000-0000-C000-000000000046}
 [INFO] (interface)  IID_IPersistFile = {0000010B-0000-0000-C000-000000000046}
</pre>
</div>

<p>
Inspect LNK (Windows shortcut) files: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ lnkdump.exe  <span class="org-string">"x64 Native Tools Command Prompt for VS 2019.lnk"</span>
 [*]          Path  = C:\Windows\System32\cmd.exe
 [*]      Arguments = /k <span class="org-string">"C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Auxiliary\Build\vcvars64.bat"</span>
 [*]    Description = Open Visual Studio 2019 Tools Command Prompt for targeting x64
 [*]   Working dir  = C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools<span class="org-sh-escaped-newline">\</span>
 [*]           Icon =
 [*]         Hotkey = 0


$ lnkdump.exe <span class="org-string">"Windows PowerShell (x86).lnk"</span>
 [*]          Path  = C:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe
 [*]      Arguments =
 [*]    Description = Performs object-based (command-line) functions
 [*]   Working dir  = %HOMEDRIVE%%HOMEPATH%
 [*]           Icon = %SystemRoot%\syswow64\WindowsPowerShell\v1.0\powershell.exe
 [*]         Hotkey = 0


$ lnkdump.exe <span class="org-string">"Windows PowerShell ISE.lnk"</span>
 [*]          Path  = C:\Windows\system32\WindowsPowerShell\v1.0\PowerShell_ISE.exe
 [*]      Arguments =
 [*]    Description = Windows PowerShell Integrated Scripting Environment. Performs object-based (command-line) functions
 [*]   Working dir  = %HOMEDRIVE%%HOMEPATH%
 [*]           Icon = %SystemRoot%\system32\WindowsPowerShell\v1.0\powershell_ise.exe
 [*]         Hotkey = 0


$ lnkdump.exe Device_Manager.lnk
 [*]          Path  = C:\WINDOWS\system32\RunDll32.exe
 [*]      Arguments = devmgr.dll DeviceManager_Execute
 [*]    Description = Shortcut for device manager.
 [*]   Working dir  =
 [*]           Icon =
 [*]         Hotkey = 0

$ lnkdump.exe <span class="org-string">"Print Management.lnk"</span>
 [*]          Path  = C:\WINDOWS\system32\printmanagement.msc
 [*]      Arguments =
 [*]    Description = Manages local printers and remote print servers.
 [*]   Working dir  =
 [*]           Icon = %systemroot%\system32\pmcsnap.dll
 [*]         Hotkey = 0

$ lnkdump.exe  <span class="org-string">"Component Services.lnk"</span>
 [*]          Path  = C:\WINDOWS\system32\comexp.msc
 [*]      Arguments =
 [*]    Description = Manage COM+ applications, COM and DCOM system configuration, and the Distributed Transaction Coordinator.
 [*]   Working dir  =
 [*]           Icon = %systemroot%\system32\comres.dll
 [*]         Hotkey = 0
</pre>
</div>

<p>
Find COM In-process Server (DLL - shared library) that provides the
COM class <span class="underline">CLSID_ShellLink</span> by using Powershell on the Visual Studio
developer's prompt. 
</p>

<pre class="example">
$ powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:\&gt; Get-ChildItem Registry::"HKCR\CLSID\{00021401-0000-0000-C000-000000000046}"


    Hive: HKCR\CLSID\{00021401-0000-0000-C000-000000000046}


Name                           Property
----                           --------
Implemented Categories
InProcServer32                 (default)      : C:\Windows\System32\windows.storage.dll
                               ThreadingModel : Both
OverrideFileSystemProperties   System.Kind : 1
ProgID                         (default) : lnkfile
shellex

</pre>

<p>
View DLL symbols: 
</p>

<div class="org-src-container">
<pre class="src src-sh">PS C:<span class="org-string">\&gt;</span> dumpbin.exe /exports C:\Windows\System32\windows.storage.dll
<span class="org-function-name">Microsoft</span> (R) COFF/PE Dumper Version 14.28.29335.0
<span class="org-function-name">Copyright</span> (C) Microsoft Corporation.  All rights reserved.


Dump of file C:\Windows\System32\windows.storage.dll

File Type: DLL

  Section contains the following exports for Windows.Storage.dll

    00000000 characteristics
    1FA0233D time date stamp
        0.00 version
           2 ordinal base
        2008 number of functions
         242 number of names

    ordinal hint RVA      name

          8    0 000651D0 AssocCreateForClasses
  ...   ...   ...   ...   ...   ...   ...   ...   ...   ... 
  ...   ...   ...   ...   ...   ...   ...   ...   ...   ... 

         46   28 0018BF80 DllCanUnloadNow                <span class="org-comment-delimiter"># </span><span class="org-comment">&lt;=== Functions that </span>
         47   29 00184BA0 DllGetActivationFactory        <span class="org-comment-delimiter"># </span><span class="org-comment">must be implemented by a COM server.</span>
         48   2A 000C6FE0 DllGetClassObject
         49   2B 001C1A30 DllMain
         50   2C 001AEFB0 DllRegisterServer
         51   2D 001AEFB0 DllUnregisterServer
   ... ...... ..... ....   ... ...... ..... ....   ... ...... ..... .... 
  ... ...... ..... ....   ... ...... ..... ....   ... ...... ..... .... 

  Summary

        9000 .data
        3000 .didat
       52000 .pdata
      184000 .rdata
       1F000 .reloc
        4000 .rsrc
      58A000 .text
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org565c948" class="outline-3">
<h3 id="org565c948"><span class="section-number-3">1.14</span> Windows Registry</h3>
<div class="outline-text-3" id="text-1-14">
</div>
<div id="outline-container-org70b8652" class="outline-4">
<h4 id="org70b8652"><span class="section-number-4">1.14.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-14-1">
<p>
The Windows registry is a tree-like database used by the operating
system and by other applications for storing system configurations and
user-specific settings. The data is stored as a tree data structure,
where each child node is a key and each key may have zero or more
value, which a entry comprised of a label and value.
</p>

<p>
<b>Documentation of Windows Registry APIs</b> 
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/about-the-registry">About the registry</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/structure-of-the-registry">Structure of the Registry</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/predefined-keys">Predefined Keys</a></li>

<li>Function: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa">RegOpenKeyExA()</a>
<ul class="org-ul">
<li>Brief: "Opens the specified registry key. Note that key names
are not case sensitive."</li>
</ul></li>

<li>Function: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexw">RegOpenKeyExW()</a>
<ul class="org-ul">
<li>Brief: "Opens the specified registry key. Note that key names
are not case sensitive."</li>
</ul></li>

<li>Function:  <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regenumkeya">RegEnumKeyA()</a>
<ul class="org-ul">
<li>Brief: "Enumerates the subkeys of the specified open registry
key. The function retrieves the name of one subkey each time it
is called."</li>
</ul></li>

<li>Function: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regenumkeyexa">RegEnumKeyExA()</a>
<ul class="org-ul">
<li>Brief: "Enumerates the subkeys of the specified open registry
key. The function retrieves information about one subkey each
time it is called."</li>
</ul></li>

<li>Function: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regenumkeyexw">RegEnumKeyExW()</a>
<ul class="org-ul">
<li>Brief: "Enumerates the subkeys of the specified open registry
key. The function retrieves information about one subkey each
time it is called."</li>
</ul></li>

<li>Function: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-reggetvaluea">RegGetValueA()</a>
<ul class="org-ul">
<li>Brief: "Retrieves the type and data for the specified registry
value."</li>
</ul></li>

<li>Function: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-reggetvaluew">RegGetValueW()</a>
<ul class="org-ul">
<li>Brief: "Retrieves the type and data for the specified registry value."</li>
</ul></li>

<li>Function: <a href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryvaluea">RegQueryValueA()</a>
<ul class="org-ul">
<li>Brief: "Retrieves the data associated with the default or
unnamed value of a specified registry key. The data must be a
null-terminated string."</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9077c43" class="outline-4">
<h4 id="org9077c43"><span class="section-number-4">1.14.2</span> Notable Registry Locations</h4>
<div class="outline-text-4" id="text-1-14-2">
<ul class="org-ul">
<li>Root Keys
<ul class="org-ul">
<li><code>HKLM</code> or <code>HKEY_LOCAL_MACHINE</code></li>
<li><code>HKCR</code> or <code>HKEY_CLASSES_ROOT</code></li>
<li><code>HKCU</code> or <code>HKEY_CURRENT_USER</code></li>
<li><code>HKCC</code> or <code>HKEY_CURRENT_CONFIG</code></li>
</ul></li>
</ul>


<ul class="org-ul">
<li><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\hivelist</code>
<ul class="org-ul">
<li>Lists all paths to files where Windows registry data are
stored.</li>
</ul></li>

<li><code>HKEY_CLASSES_ROOT\CLSID</code>
<ul class="org-ul">
<li>Contains all registered COM (Component Object Model) class ID
as subkeys, where each subkey is a GUID (Universal Unique
Identifier), a 128-bit unique random number encoded as
hexadecimal.</li>

<li>Example: The COM In-process server (<code>C:\Windows\System32\oleaut32.dll</code>) has the CLSID -
0000002F-0000-0000-C000-000000000046 and the registry key:
<code>HKEY_CLASSES_ROOT\CLSID\{0000002F-0000-0000-C000-000000000046}</code>.</li>
</ul></li>

<li><code>HKEY_CLASSES_ROOT\Interface</code>
<ul class="org-ul">
<li>Contains all COM interfaces registered in the systems. Each
subkey is the interface IID (GUID - global unique identifier).</li>
</ul></li>

<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\\Advancede</code>
<ul class="org-ul">
<li>Windows Explorer settings.</li>
</ul></li>

<li><code>HKEY_LOCAL_MACHINE\SYSTEM\\CurrentControlSet\Services</code>
<ul class="org-ul">
<li>Subkeys are services that launched at system startup time after reboot.</li>
</ul></li>

<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion</code>
<ul class="org-ul">
<li>The entries (values) in this key, contains information about
the current Windows Version:
<ul class="org-ul">
<li>Value: <span class="underline">EditionID</span> =&gt; (example: Professional)</li>
<li>Value: <span class="underline">ProductName</span> =&gt; (example: Windows 10 Pro)</li>
<li>Value: <span class="underline">RegisteredOwner</span></li>
<li>Value: <span class="underline">CurrentBuild</span></li>
<li>Value: <span class="underline">BuildLab</span> (example: 1941.vb_release.191206-1406)</li>
</ul></li>
</ul></li>

<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths</code>
<ul class="org-ul">
<li>Every subkey entry is an application that can be launched without
specifying the full from Windows-Key + R box or from terminal.</li>
</ul></li>

<li><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment</code>
<ul class="org-ul">
<li>System-wide environment variables (defined for all users).</li>
</ul></li>

<li><code>HKEY_CURRENT_USER\Environment</code>
<ul class="org-ul">
<li>User-specific environment variables.</li>
</ul></li>

<li><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs</code>
<ul class="org-ul">
<li>See: <a href="https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order?redirectedfrom=MSDN">Dynamic Linker library search order</a></li>
</ul></li>
</ul>


<p>
<b>Windows Registry Files</b> 
</p>

<p>
The Windows registry data can be stored in several files in the
system. Some of those files are:  
</p>

<ul class="org-ul">
<li>Directory: <code>%SystemRoot%\System32\config</code></li>

<li>File: <code>%UserProfile%\Ntuser.dat</code></li>

<li>FIle: <code>%UserProfile%\Local Settings\Application Data\Microsoft\Windows\UsrClass.dat</code></li>
</ul>

<p>
List all files where Windows <span class="underline">registry data</span> are stored using PowerShell. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ItemProperty Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\hivelist

\REGISTRY\MACHINE\HARDWARE                                           :
\REGISTRY\MACHINE\SYSTEM                                             : \Device\HarddiskVolume2\Windows\System32\config\SYSTEM
\REGISTRY\MACHINE\BCD00000000                                        : \Device\HarddiskVolume1\Boot\BCD
\REGISTRY\MACHINE\SOFTWARE                                           : \Device\HarddiskVolume2\Windows\System32\config\SOFTWARE
\REGISTRY\USER<span class="org-string">\.</span>DEFAULT                                              : \Device\HarddiskVolume2\Windows\System32\config\DEFAULT
\REGISTRY\MACHINE\SECURITY                                           : \Device\HarddiskVolume2\Windows\System32\config\SECURITY
\REGISTRY\MACHINE\SAM                                                : \Device\HarddiskVolume2\Windows\System32\config\SAM
\REGISTRY\USER\S-1-5-20                                              : \Device\HarddiskVolume2\Windows\ServiceProfiles\NetworkService\NTUSER.DAT
\REGISTRY\USER\S-1-5-19                                              : \Device\HarddiskVolume2\Windows\ServiceProfiles\LocalService\NTUSER.DAT
\REGISTRY\USER\S-1-5-21-795742887-3693175558-2200833936-1001         : \Device\HarddiskVolume2\Users\User_001\NTUSER.DAT
\REGISTRY\USER\S-1-5-21-795742887-3693175558-2200833936-1001_Classes : \Device\HarddiskVolume2\Users\User_001\AppData\Local\Microsoft\Windows\usrClass.dat
<span class="org-function-name">PSPath</span>                                                               : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\hivelist
<span class="org-function-name">PSParentPath</span>                                                         : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control
<span class="org-function-name">PSChildName</span>                                                          : hivelist
<span class="org-function-name">PSProvider</span>                                                           : Microsoft.PowerShell.Core\Registry
</pre>
</div>

<p>
Query system-wide environment variables from registry: 
</p>

<div class="org-src-container">
<pre class="src src-sh">PS C:<span class="org-string">\&gt;</span> ItemProperty Registry::<span class="org-string">"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment"</span>


<span class="org-function-name">ComSpec</span>                : C:\WINDOWS\system32\cmd.exe
<span class="org-function-name">DriverData</span>             : C:\Windows\System32\Drivers\DriverData
<span class="org-function-name">OS</span>                     : Windows_NT
<span class="org-function-name">PATHEXT</span>                : .COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC
<span class="org-function-name">PROCESSOR_ARCHITECTURE</span> : AMD64
<span class="org-function-name">PSModulePath</span>           : C:\Program Files\WindowsPowerShell\Modules;C:\WINDOWS\system32\WindowsPowerShell\v1.0\Modules
<span class="org-function-name">TEMP</span>                   : C:\WINDOWS\TEMP
<span class="org-function-name">TMP</span>                    : C:\WINDOWS\TEMP
<span class="org-function-name">USERNAME</span>               : SYSTEM
<span class="org-function-name">windir</span>                 : C:\WINDOWS
<span class="org-function-name">Path</span>                   : C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0<span class="org-string">\;</span>C:\WINDOWS\System32\OpenSSH<span class="org-string">\;</span>C:\Pr
                         ogram Files\dotnet<span class="org-string">\;</span>C:\ProgramData\chocolatey\bin;C:\D\dmd2\windows\bin
<span class="org-function-name">ChocolateyInstall</span>      : C:\ProgramData\chocolatey
<span class="org-function-name">NUMBER_OF_PROCESSORS</span>   : 2
<span class="org-function-name">PROCESSOR_LEVEL</span>        : 6
<span class="org-function-name">PROCESSOR_IDENTIFIER</span>   : Intel64 Family 6 Model 23 Stepping 3, GenuineIntel
<span class="org-function-name">PROCESSOR_REVISION</span>     : 1703
<span class="org-function-name">PSPath</span>                 : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment
<span class="org-function-name">PSParentPath</span>           : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager
<span class="org-function-name">PSChildName</span>            : Environment
<span class="org-function-name">PSProvider</span>             : Microsoft.PowerShell.Core\Registry
</pre>
</div>

<p>
Query user-specific environment variables from registry: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ powershell.exe
Windows PowerShell
<span class="org-function-name">Copyright</span> (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:<span class="org-string">\&gt;</span> ItemProperty Registry::<span class="org-string">"HKEY_CURRENT_USER\Environment"</span>


<span class="org-function-name">TEMP</span>                     : C:\Users\User_001\AppData\Local\Temp
<span class="org-function-name">TMP</span>                      : C:\Users\User_001\AppData\Local\Temp
<span class="org-function-name">Path</span>                     : C:\Users\User_001<span class="org-string">\.</span>cargo\bin;C:\Users\User_001\scoop\apps\gcc\current\bin;... .... 
                           ps
<span class="org-function-name">OneDrive</span>                 : C:\Users\User_001\OneDrive
<span class="org-function-name">GIT_INSTALL_ROOT</span>         : C:\Users\User_001\scoop\apps\git\current
<span class="org-function-name">CMDER_ROOT</span>               : C:\Users\User_001\scoop\apps\cmder\current
<span class="org-function-name">ConEmuDir</span>                : C:\Users\User_001\scoop\apps\cmder\current\vendor\conemu-maximus5
<span class="org-function-name">ChocolateyLastPathUpdate</span> : 132545935735602224
<span class="org-function-name">PSPath</span>                   : Microsoft.PowerShell.Core\Registry::HKEY_CURRENT_USER\Environment
<span class="org-function-name">PSParentPath</span>             : Microsoft.PowerShell.Core\Registry::HKEY_CURRENT_USER
<span class="org-function-name">PSChildName</span>              : Environment
<span class="org-function-name">PSProvider</span>               : Microsoft.PowerShell.Core\Registry

</pre>
</div>

<p>
List all subkeys from the key App Paths" which are applications that
can be launched without providing full path from Windows-Key+R box or
from terminal: 
</p>

<div class="org-src-container">
<pre class="src src-sh">PS C:<span class="org-string">\&gt;</span> Get-ChildItem -Path Registry::<span class="org-string">"HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths"</span>


    Hive: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths


Name                           Property
----                           --------
cmmgr32.exe                    CmNative          : 2
                               CmstpExtensionDll : C:\Windows\System32\cmcfg32.dll
<span class="org-function-name">codeblocks.exe</span>                 (default) : C:\Program Files (x86)\CodeBlocks\codeblocks.exe
dfshim.dll                     UseURL : 1
<span class="org-function-name">firefox.exe</span>                    (default) : C:\Program Files\Mozilla Firefox\firefox.exe
                               Path      : C:\Program Files\Mozilla Firefox
fsquirt.exe                    DropTarget : {047ea9a1-93cc-415a-a2d3-d7ffb3ca5187}
<span class="org-function-name">IEDIAG.EXE</span>                     (default) : C:\Program Files\Internet Explorer\IEDIAGCMD.EXE
                               Path      : C:\Program Files\Internet Explorer;
<span class="org-function-name">IEDIAGCMD.EXE</span>                  (default) : C:\Program Files\Internet Explorer\IEDIAGCMD.EXE
                               Path      : C:\Program Files\Internet Explorer;
<span class="org-function-name">IEXPLORE.EXE</span>                   (default) : C:\Program Files\Internet Explorer\IEXPLORE.EXE
                               Path      : C:\Program Files\Internet Explorer;
install.exe                    BlockOnTSNonInstallMode : 1
<span class="org-function-name">licensemanagershellext.exe</span>     (default) : C:\WINDOWS\System32\licensemanagershellext.exe
<span class="org-function-name">mip.exe</span>                        (default) : C:\Program Files\Common Files\Microsoft Shared\Ink\mip.exe
<span class="org-function-name">mplayer2.exe</span>                   (default) : C:\Program Files (x86)\Windows Media Player\wmplayer.exe
                               Path      : C:\Program Files (x86)\Windows Media Player
<span class="org-function-name">msedge.exe</span>                     (default) : C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe
                               Path      : C:\Program Files (x86)\Microsoft\Edge\Application
<span class="org-function-name">pbrush.exe</span>                     (default) : C:\WINDOWS\System32\mspaint.exe
                               Path      : C:\WINDOWS\System32
<span class="org-function-name">PowerShell.exe</span>                 (default) : C:\WINDOWS\system32\WindowsPowerShell\v1.0\PowerShell.exe
setup.exe                      BlockOnTSNonInstallMode : 1
<span class="org-function-name">SnippingTool.exe</span>               (default) : C:\WINDOWS\system32\SnippingTool.exe
table30.exe                    UseShortName :
<span class="org-function-name">TabTip.exe</span>                     (default) : C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe
<span class="org-function-name">wab.exe</span>                        (default) : C:\Program Files\Windows Mail\wab.exe
                               Path      : C:\Program Files\Windows Mail
<span class="org-function-name">wabmig.exe</span>                     (default) : C:\Program Files\Windows Mail\wabmig.exe
<span class="org-function-name">wmplayer.exe</span>                   (default) : C:\Program Files (x86)\Windows Media Player\wmplayer.exe
                               Path      : C:\Program Files (x86)\Windows Media Player
<span class="org-function-name">WORDPAD.EXE</span>                    (default) : <span class="org-string">"C:\Program Files\Windows NT\Accessories\WORDPAD.EXE"</span>
<span class="org-function-name">WRITE.EXE</span>                      (default) : <span class="org-string">"C:\Program Files\Windows NT\Accessories\WORDPAD.EXE"</span>
</pre>
</div>

<p>
Query all known DLLs: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ powershell
Windows PowerShell
<span class="org-function-name">Copyright</span> (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS&gt; ItemProperty Registry::<span class="org-string">"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs"</span>


<span class="org-function-name">_wow64cpu</span>    : wow64cpu.dll
<span class="org-function-name">_wowarmhw</span>    : wowarmhw.dll
<span class="org-function-name">_xtajit</span>      : xtajit.dll
<span class="org-function-name">advapi32</span>     : advapi32.dll
<span class="org-function-name">clbcatq</span>      : clbcatq.dll
<span class="org-function-name">combase</span>      : combase.dll
<span class="org-function-name">COMDLG32</span>     : COMDLG32.dll
<span class="org-function-name">coml2</span>        : coml2.dll
<span class="org-function-name">DifxApi</span>      : difxapi.dll
<span class="org-function-name">gdi32</span>        : gdi32.dll
<span class="org-function-name">gdiplus</span>      : gdiplus.dll
<span class="org-function-name">IMAGEHLP</span>     : IMAGEHLP.dll
<span class="org-function-name">IMM32</span>        : IMM32.dll
<span class="org-function-name">kernel32</span>     : kernel32.dll
<span class="org-function-name">MSCTF</span>        : MSCTF.dll
<span class="org-function-name">MSVCRT</span>       : MSVCRT.dll
<span class="org-function-name">NORMALIZ</span>     : NORMALIZ.dll
<span class="org-function-name">NSI</span>          : NSI.dll
<span class="org-function-name">ole32</span>        : ole32.dll
<span class="org-function-name">OLEAUT32</span>     : OLEAUT32.dll
<span class="org-function-name">PSAPI</span>        : PSAPI.DLL
<span class="org-function-name">rpcrt4</span>       : rpcrt4.dll
<span class="org-function-name">sechost</span>      : sechost.dll
<span class="org-function-name">Setupapi</span>     : Setupapi.dll
<span class="org-function-name">SHCORE</span>       : SHCORE.dll
<span class="org-function-name">SHELL32</span>      : SHELL32.dll
<span class="org-function-name">SHLWAPI</span>      : SHLWAPI.dll
<span class="org-function-name">user32</span>       : user32.dll
<span class="org-function-name">WLDAP32</span>      : WLDAP32.dll
<span class="org-function-name">wow64</span>        : wow64.dll
<span class="org-function-name">wow64win</span>     : wow64win.dll
<span class="org-function-name">WS2_32</span>       : WS2_32.dll
<span class="org-function-name">PSPath</span>       : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session
               Manager\KnownDLLs
<span class="org-function-name">PSParentPath</span> : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session
               Manager
<span class="org-function-name">PSChildName</span>  : KnownDLLs
<span class="org-function-name">PSProvider</span>   : Microsoft.PowerShell.Core\Registry

</pre>
</div>

<p>
<b>See</b> 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Windows_Registry">Windows Registry - Wikipedia</a></li>

<li><a href="https://github.com/msuhanov/regf/blob/master/Windows%20registry%20file%20format%20specification.md">Windows Registry File Format Specification</a> (Binary Format Description)</li>

<li><a href="https://superuser.com/questions/111311/where-are-registry-files-stored-in-windows">Where are Registry Files stored in Windows?</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-hives?redirectedfrom=MSDN">Registry Hives</a></li>

<li><a href="https://adamtheautomator.com/powershell-get-registry-value/">Powershell Get Registry Value</a></li>

<li><a href="https://devblogs.microsoft.com/scripting/use-powershell-to-enumerate-registry-property-values/">Use PowerShell to Enumerate Registry Property Values</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgdfb6f1d" class="outline-4">
<h4 id="orgdfb6f1d"><span class="section-number-4">1.14.3</span> Sample Code</h4>
<div class="outline-text-4" id="text-1-14-3">
<p>
<b>Files</b> 
</p>

<p>
File: <span class="underline">registry.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">map</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">MAX_KEY_LENGTH</span> = 255;
<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">MAX_VALUE_NAME</span> = 16383;

<span class="org-comment-delimiter">// </span><span class="org-comment">Read a value from registry key.</span>
<span class="org-function-name">std</span>::string readRegistry_SZ<span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">HKEY</span> <span class="org-variable-name">hkey</span>
                            , <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span>
                            , <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">key</span> <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::string readRegistry_SZ<span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">full_path</span>
                        , <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">key</span> <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Read Dword from registry</span>
<span class="org-type">DWORD</span> <span class="org-function-name">readRegistry_DW</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HKEY</span> <span class="org-variable-name">hkey</span>
                      , <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span>
                      , <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">key</span> <span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-type">void</span> <span class="org-function-name">enumKeyValues</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HKEY</span> <span class="org-variable-name">root</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> ;

<span class="org-type">void</span> <span class="org-function-name">enumKeys</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HKEY</span> <span class="org-variable-name">root</span>,<span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span>, <span class="org-type">DWORD</span> <span class="org-variable-name">nmax_keys</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class="org-type">HKEY</span> <span class="org-variable-name">hkcu</span> = HKEY_CURRENT_USER;

  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ====== [ STEP 1] ===== Show Registry Keys ====================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-rainbow-delimiters-depth-2">{</span>
     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" =&gt;&gt; Windows Explorer Settings ==== \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">path</span> = <span class="org-string">"Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced"</span>;
     enumKeyValues<span class="org-rainbow-delimiters-depth-3">(</span>HKEY_CURRENT_USER, path<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n====== [ STEP 2 ] ====== Reading Windows Explorer Settings=====\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-rainbow-delimiters-depth-2">{</span>
     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" Location of COM Server with CLSID = {EC231970-6AFD-4215-A72E-97242BB08680} \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">com_path_key</span> = <span class="org-string">"CLSID\\{EC231970-6AFD-4215-A72E-97242BB08680}\\InProcServer32"</span>;
     <span class="org-keyword">const</span> <span class="org-type">HKEY</span> <span class="org-variable-name">hcr</span> = HKEY_CLASSES_ROOT;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  COM Server file path = "</span> &lt;&lt; readRegistry_SZ<span class="org-rainbow-delimiters-depth-3">(</span>hcr, com_path_key, <span class="org-string">""</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n====== [ STEP 3 ] ====== Reading Windows Explorer Settings =======\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-rainbow-delimiters-depth-2">{</span>
     <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">path</span> = <span class="org-string">"Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced"</span>;

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"  Key =&gt;&gt; Hidden[DWORD] =  %ld \n"</span>, readRegistry_DW<span class="org-rainbow-delimiters-depth-4">(</span> hkcu, path, <span class="org-string">"Hidden"</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"  Key =&gt;&gt; HideFileExt[DWORD] = %ld \n"</span>, readRegistry_DW<span class="org-rainbow-delimiters-depth-4">(</span> hkcu, path, <span class="org-string">"HideFileExt"</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;

  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n====== [ STEP 4 ] ===== Listing all services that can be started after reboot ===="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-rainbow-delimiters-depth-2">{</span>

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"\n Listing of services (daemons) that can be launched after reboot, at startup time. "</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     enumKeys<span class="org-rainbow-delimiters-depth-3">(</span> HKEY_LOCAL_MACHINE, <span class="org-string">"SYSTEM\\CurrentControlSet\\Services"</span>, -1<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- I M P L E M E N T A T I O N S -------------//</span>
<span class="org-comment-delimiter">//</span>


<span class="org-function-name">std</span>::string
readRegistry_SZ<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HKEY</span> <span class="org-variable-name">hkey</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">key</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">HKEY</span>  <span class="org-variable-name">key_handle</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">Type</span>   = REG_SZ;
    <span class="org-keyword">auto</span>  <span class="org-variable-name">result</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>1024, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">size</span>   = result.size<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> RegOpenKeyExA<span class="org-rainbow-delimiters-depth-3">(</span> hkey, path.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, 0
                       , KEY_QUERY_VALUE, &amp;key_handle<span class="org-rainbow-delimiters-depth-3">)</span> != ERROR_SUCCESS <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>  <span class="org-keyword">return</span> <span class="org-string">"&lt;NOT-FOUND:KEY&gt;"</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> RegQueryValueEx<span class="org-rainbow-delimiters-depth-3">(</span>key_handle, key.c_str<span class="org-rainbow-delimiters-depth-4">()</span>
            , <span class="org-constant">NULL</span>, &amp;Type, <span class="org-rainbow-delimiters-depth-4">(</span>LPBYTE<span class="org-rainbow-delimiters-depth-4">)</span> &amp;result<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>, &amp;size<span class="org-rainbow-delimiters-depth-3">)</span> != ERROR_SUCCESS<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        RegCloseKey <span class="org-rainbow-delimiters-depth-3">(</span>key_handle<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> <span class="org-string">"&lt;NOT-FOUND:VALUE&gt;"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    RegCloseKey <span class="org-rainbow-delimiters-depth-2">(</span>key_handle<span class="org-rainbow-delimiters-depth-2">)</span>;
    result.resize<span class="org-rainbow-delimiters-depth-2">(</span>size-1<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> result;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-function-name">std</span>::string
readRegistry_SZ<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">full_path</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">key</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hkcu</span> = <span class="org-string">"HKEY_CURRENT_USER\\"</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Check whether string has prefix 'HKEY_CURRENT_USER\\'</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::strncmp<span class="org-rainbow-delimiters-depth-3">(</span>full_path.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, hkcu, <span class="org-constant">std</span>::strlen<span class="org-rainbow-delimiters-depth-4">(</span>hkcu<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == 0 <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-3">{</span> full_path.begin<span class="org-rainbow-delimiters-depth-4">()</span> + strlen<span class="org-rainbow-delimiters-depth-4">(</span>hkcu<span class="org-rainbow-delimiters-depth-4">)</span>, full_path.end<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">}</span>;
      <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"\n [TRACE] path = "</span> &lt;&lt; path &lt;&lt; <span class="org-constant">std</span>::endl;
      <span class="org-keyword">return</span> readRegistry_SZ<span class="org-rainbow-delimiters-depth-3">(</span>HKEY_CURRENT_USER, path, key<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">return</span> <span class="org-string">"&lt;NOT-FOUND&gt;"</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">DWORD</span>
<span class="org-function-name">readRegistry_DW</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HKEY</span> <span class="org-variable-name">hkey</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">key</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">HKEY</span>  <span class="org-variable-name">key_handle</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">Type</span>   = REG_DWORD;
    <span class="org-type">DWORD</span> <span class="org-variable-name">result</span> = 0;
    <span class="org-type">DWORD</span> <span class="org-variable-name">ret</span>    = 0;
    <span class="org-type">DWORD</span> <span class="org-variable-name">size</span>   = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>DWORD<span class="org-rainbow-delimiters-depth-2">)</span>;

    ret = RegOpenKeyExA<span class="org-rainbow-delimiters-depth-2">(</span> hkey, path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, 0
                         , KEY_QUERY_VALUE, &amp;key_handle<span class="org-rainbow-delimiters-depth-2">)</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> ret == ERROR_SUCCESS <span class="org-rainbow-delimiters-depth-2">)</span>;

    ret = RegQueryValueExA<span class="org-rainbow-delimiters-depth-2">(</span> key_handle, key.c_str<span class="org-rainbow-delimiters-depth-3">()</span>
                          , <span class="org-constant">NULL</span>, &amp;Type, <span class="org-rainbow-delimiters-depth-3">(</span>LPBYTE<span class="org-rainbow-delimiters-depth-3">)</span> &amp;result, &amp;size <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ret != ERROR_SUCCESS <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        RegCloseKey <span class="org-rainbow-delimiters-depth-3">(</span>key_handle<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::perror<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to query key"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    RegCloseKey <span class="org-rainbow-delimiters-depth-2">(</span>key_handle<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> result;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Query all values from a given registry key</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Adapted from: https://docs.microsoft.com/en-us/windows/win32/sysinfo/enumerating-registry-subkeys</span>
<span class="org-type">void</span> <span class="org-function-name">enumKeyValues</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HKEY</span> <span class="org-variable-name">root</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

    <span class="org-type">TCHAR</span>    <span class="org-variable-name">achClass</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_PATH<span class="org-rainbow-delimiters-depth-2">]</span> = TEXT<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">""</span><span class="org-rainbow-delimiters-depth-2">)</span>;  <span class="org-comment-delimiter">// </span><span class="org-comment">buffer for class name</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cchClassName</span> = MAX_PATH;  <span class="org-comment-delimiter">// </span><span class="org-comment">size of class string</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cSubKeys</span>=0;               <span class="org-comment-delimiter">// </span><span class="org-comment">number of subkeys</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cbMaxSubKey</span>;              <span class="org-comment-delimiter">// </span><span class="org-comment">longest subkey size</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cchMaxClass</span>;              <span class="org-comment-delimiter">// </span><span class="org-comment">longest class string</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cValues</span>;              <span class="org-comment-delimiter">// </span><span class="org-comment">number of values for key</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cchMaxValue</span>;          <span class="org-comment-delimiter">// </span><span class="org-comment">longest value name</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cbMaxValueData</span>;       <span class="org-comment-delimiter">// </span><span class="org-comment">longest value data</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cbSecurityDescriptor</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">size of security descriptor</span>
    <span class="org-type">FILETIME</span> <span class="org-variable-name">ftLastWriteTime</span>;      <span class="org-comment-delimiter">// </span><span class="org-comment">last write time</span>

    <span class="org-type">DWORD</span> <span class="org-variable-name">i</span>, <span class="org-variable-name">retCode</span>;

    <span class="org-type">TCHAR</span>  <span class="org-variable-name">achValue</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_VALUE_NAME<span class="org-rainbow-delimiters-depth-2">]</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">cchValue</span> = MAX_VALUE_NAME;

    <span class="org-type">HKEY</span> <span class="org-variable-name">hKey</span><span class="org-rainbow-delimiters-depth-2">{}</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">ret</span> = RegOpenKeyEx<span class="org-rainbow-delimiters-depth-2">(</span>root, path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, 0, KEY_READ, &amp;hKey <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ret != ERROR_SUCCESS <span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">goto</span> <span class="org-constant">error</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Get the class name and the value count.</span>
    retCode = RegQueryInfoKey<span class="org-rainbow-delimiters-depth-2">(</span>
        hKey,                    <span class="org-comment-delimiter">// </span><span class="org-comment">key handle</span>
        achClass,                <span class="org-comment-delimiter">// </span><span class="org-comment">buffer for class name</span>
        &amp;cchClassName,           <span class="org-comment-delimiter">// </span><span class="org-comment">size of class string</span>
        <span class="org-constant">NULL</span>,                    <span class="org-comment-delimiter">// </span><span class="org-comment">reserved</span>
        &amp;cSubKeys,               <span class="org-comment-delimiter">// </span><span class="org-comment">number of subkeys</span>
        &amp;cbMaxSubKey,            <span class="org-comment-delimiter">// </span><span class="org-comment">longest subkey size</span>
        &amp;cchMaxClass,            <span class="org-comment-delimiter">// </span><span class="org-comment">longest class string</span>
        &amp;cValues,                <span class="org-comment-delimiter">// </span><span class="org-comment">number of values for this key</span>
        &amp;cchMaxValue,            <span class="org-comment-delimiter">// </span><span class="org-comment">longest value name</span>
        &amp;cbMaxValueData,         <span class="org-comment-delimiter">// </span><span class="org-comment">longest value data</span>
        &amp;cbSecurityDescriptor,   <span class="org-comment-delimiter">// </span><span class="org-comment">security descriptor</span>
        &amp;ftLastWriteTime<span class="org-rainbow-delimiters-depth-2">)</span>;       <span class="org-comment-delimiter">// </span><span class="org-comment">last write time</span>


    <span class="org-comment-delimiter">// </span><span class="org-comment">Enumerate the key values.</span>
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>cValues<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">goto</span> <span class="org-constant">cleanup</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-string">"\n  -&gt;&gt; Number of values: %ld \n\n "</span>, cValues<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-keyword">auto</span> key_types_db = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">DWORD</span>, <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;{</span>
          <span class="org-rainbow-delimiters-depth-3">{</span> REG_BINARY,              <span class="org-string">"REG_BINARY"</span> <span class="org-rainbow-delimiters-depth-3">}</span>
        , <span class="org-rainbow-delimiters-depth-3">{</span> REG_DWORD,               <span class="org-string">"REG_DWORD"</span> <span class="org-rainbow-delimiters-depth-3">}</span>
        , <span class="org-rainbow-delimiters-depth-3">{</span> REG_DWORD_LITTLE_ENDIAN, <span class="org-string">"REG_DWORD_LITTLE_ENDIAN"</span> <span class="org-rainbow-delimiters-depth-3">}</span>
        , <span class="org-rainbow-delimiters-depth-3">{</span> REG_DWORD_BIG_ENDIAN,    <span class="org-string">"REG_DWORD_BIG_ENDIAN"</span> <span class="org-rainbow-delimiters-depth-3">}</span>
        , <span class="org-rainbow-delimiters-depth-3">{</span> REG_LINK,                <span class="org-string">"REG_LINK"</span> <span class="org-rainbow-delimiters-depth-3">}</span>
        , <span class="org-rainbow-delimiters-depth-3">{</span> REG_SZ,                  <span class="org-string">"REG_SZ(string)"</span><span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-keyword">for</span> <span class="org-rainbow-delimiters-depth-2">(</span>i=0, retCode=ERROR_SUCCESS; i&lt;cValues; i++<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
         cchValue = MAX_VALUE_NAME;
         achValue<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> = <span class="org-string">'\0'</span>;
         retCode = RegEnumValue<span class="org-rainbow-delimiters-depth-3">(</span>hKey, i, achValue, &amp;cchValue, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         assert<span class="org-rainbow-delimiters-depth-3">(</span> retCode == ERROR_SUCCESS<span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-type">DWORD</span> <span class="org-variable-name">keyType</span> = 0;
         retCode = RegGetValueA<span class="org-rainbow-delimiters-depth-3">(</span>hKey, <span class="org-constant">NULL</span>, achValue, RRF_RT_ANY, &amp;keyType, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         assert<span class="org-rainbow-delimiters-depth-3">(</span> retCode == ERROR_SUCCESS<span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">auto</span> <span class="org-variable-name">it</span> = key_types_db.find<span class="org-rainbow-delimiters-depth-3">(</span>keyType<span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">keyDesc</span> = <span class="org-rainbow-delimiters-depth-3">(</span> it != key_types_db.end<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span> ? it-&gt;second : <span class="org-string">"&lt;UNKNOWN&gt;"</span>;

         <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-string">"   =&gt;&gt; (%ld) %s / type = '%s' \n"</span>
                     , i+1, achValue, keyDesc.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-function-name">cleanup</span>:
     RegCloseKey<span class="org-rainbow-delimiters-depth-2">(</span>hKey<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span>;
<span class="org-function-name">error</span>:
     <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERRO] Unable to open Key with path = "</span> &lt;&lt; path &lt;&lt; <span class="org-constant">std</span>::endl;
     RegCloseKey<span class="org-rainbow-delimiters-depth-2">(</span>hKey<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Enumerate subkeys of a given Windows registry key.</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Adapted from: https://docs.microsoft.com/en-us/windows/win32/sysinfo/enumerating-registry-subkeys</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">---------------------------------------------------</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Set  max_keys to -1 in order to show all keys.</span>
<span class="org-type">void</span> <span class="org-function-name">enumKeys</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HKEY</span> <span class="org-variable-name">root</span>,<span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span>, <span class="org-type">DWORD</span> <span class="org-variable-name">nmax_keys</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">TCHAR</span>    <span class="org-variable-name">achKey</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_KEY_LENGTH<span class="org-rainbow-delimiters-depth-2">]</span>;   <span class="org-comment-delimiter">// </span><span class="org-comment">buffer for subkey name</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cbName</span>;                   <span class="org-comment-delimiter">// </span><span class="org-comment">size of name string</span>
    <span class="org-type">TCHAR</span>    <span class="org-variable-name">achClass</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_PATH<span class="org-rainbow-delimiters-depth-2">]</span> = TEXT<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">""</span><span class="org-rainbow-delimiters-depth-2">)</span>;  <span class="org-comment-delimiter">// </span><span class="org-comment">buffer for class name</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cchClassName</span> = MAX_PATH;  <span class="org-comment-delimiter">// </span><span class="org-comment">size of class string</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cSubKeys</span>=0;               <span class="org-comment-delimiter">// </span><span class="org-comment">number of subkeys</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cbMaxSubKey</span>;              <span class="org-comment-delimiter">// </span><span class="org-comment">longest subkey size</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cchMaxClass</span>;              <span class="org-comment-delimiter">// </span><span class="org-comment">longest class string</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cValues</span>;              <span class="org-comment-delimiter">// </span><span class="org-comment">number of values for key</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cchMaxValue</span>;          <span class="org-comment-delimiter">// </span><span class="org-comment">longest value name</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cbMaxValueData</span>;       <span class="org-comment-delimiter">// </span><span class="org-comment">longest value data</span>
    <span class="org-type">DWORD</span>    <span class="org-variable-name">cbSecurityDescriptor</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">size of security descriptor</span>
    <span class="org-type">FILETIME</span> <span class="org-variable-name">ftLastWriteTime</span>;      <span class="org-comment-delimiter">// </span><span class="org-comment">last write time</span>

    <span class="org-type">DWORD</span> <span class="org-variable-name">i</span>, <span class="org-variable-name">retCode</span>;

    <span class="org-type">HKEY</span> <span class="org-variable-name">hKey</span><span class="org-rainbow-delimiters-depth-2">{}</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">ret</span> = RegOpenKeyEx<span class="org-rainbow-delimiters-depth-2">(</span>root, path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, 0, KEY_READ, &amp;hKey <span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> ret == ERROR_SUCCESS <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Get the class name and the value count.</span>
    retCode = RegQueryInfoKey<span class="org-rainbow-delimiters-depth-2">(</span> hKey, achClass, &amp;cchClassName,  <span class="org-constant">NULL</span>
                               , &amp;cSubKeys, &amp;cbMaxSubKey, &amp;cchMaxClass, &amp;cValues
                               , &amp;cchMaxValue, &amp;cbMaxValueData, &amp;cbSecurityDescriptor
                               ,&amp;ftLastWriteTime<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Enumerate the subkeys, until RegEnumKeyEx fails.</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>cSubKeys <span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    printf<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-string">"\nNumber of subkeys: %ld\n"</span>, cSubKeys<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Show maximum of N Keys</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">nkeys</span> = <span class="org-rainbow-delimiters-depth-2">(</span> cSubKeys &gt; nmax_keys<span class="org-rainbow-delimiters-depth-2">)</span> ? nmax_keys : cSubKeys;

    <span class="org-keyword">for</span> <span class="org-rainbow-delimiters-depth-2">(</span>i=0; i &lt; nkeys; i++<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        cbName = MAX_KEY_LENGTH;
        retCode = RegEnumKeyEx<span class="org-rainbow-delimiters-depth-3">(</span>hKey, i, achKey, &amp;cbName, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>, &amp;ftLastWriteTime<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>retCode == ERROR_SUCCESS<span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-string">" [*] (%ld) %s\n"</span>, i+1, achKey <span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ registry.cpp -o <span class="org-keyword">registry.exe</span> -std=c++1z -Wall -Wextra   
</pre>
</div>

<p>
<b>Running</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ registry.exe

 ====== [ STEP 1] ===== Show Registry Keys ====================

 =&gt;&gt; Windows Explorer Settings ==== 

  -&gt;&gt; Number of values: 28 

    =&gt;&gt; (1) Start_SearchFiles / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (2) ServerAdminUI / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (3) Hidden / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (4) ShowCompColor / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (5) HideFileExt / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (6) DontPrettyPath / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (7) ShowInfoTip / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (8) HideIcons / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (9) MapNetDrvBtn / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (10) WebView / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (11) Filter / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (12) ShowSuperHidden / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (13) SeparateProcess / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (14) AutoCheckSelect / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (15) IconsOnly / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (16) ShowTypeOverlay / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (17) ShowStatusBar / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (18) StoreAppsOnTaskbar / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (19) ListviewAlphaSelect / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (20) ListviewShadow / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (21) TaskbarAnimations / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (22) StartMenuInit / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (23) TaskbarStateLastRun / type = <span class="org-string">'REG_BINARY'</span> 
   =&gt;&gt; (24) ShowCortanaButton / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (25) ReindexedProfile / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (26) Start_TrackProgs / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (27) StartMigratedBrowserPin / type = <span class="org-string">'REG_DWORD'</span> 
   =&gt;&gt; (28) TaskbarMigratedBrowserPin / type = <span class="org-string">'REG_DWORD'</span> 

====== [ STEP 2 ] ====== Reading Windows Explorer <span class="org-variable-name">Settings</span>=====

 Location of COM Server with CLSID = {EC231970-6AFD-4215-A72E-97242BB08680} 
  COM Server file path = C:\Windows\System32\wbem\Microsoft.Uev.AgentWmi.dll

====== [ STEP 3 ] ====== Reading Windows Explorer Settings =======

  Key =&gt;&gt; Hidden[DWORD] =  2 
  Key =&gt;&gt; HideFileExt[DWORD] = 1 

====== [ STEP 4 ] ===== Listing all services that can be started after reboot ====

 Listing of services (daemons) that can be launched after reboot, at startup time. 
Number of subkeys: 692
 [*] (1) .NET CLR Data
 [*] (2) .NET CLR Networking
 [*] (3) .NET CLR Networking 4.0.0.0
 [*] (4) .NET Data Provider for Oracle
 [*] (5) .NET Data Provider for SqlServer
 [*] (6) .NET Memory Cache 4.0
 [*] (7) .NETFramework
 [*] (8) 1394ohci
 [*] (9) 3ware
 [*] (10) AarSvc
 [*] (11) AarSvc_2b782
 [*] (12) ACPI
 [*] (13) AcpiDev
 [*] (14) acpiex
 [*] (15) acpipagr

  ... ...   ... ...   ... ...   ... ...   ... ...   ... ... 
  ... ...   ... ...   ... ...   ... ...   ... ...   ... ... 

 [*] (522) Telemetry
 [*] (523) terminpt
 [*] (524) TermService
 [*] (525) Themes
 [*] (526) TieringEngineService
 [*] (527) TimeBrokerSvc
 [*] (528) TokenBroker
 [*] (529) TPM
 [*] (530) TrkWks
 [*] (531) TroubleshootingSvc
 [*] (532) TrustedInstaller
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc3b932c" class="outline-3">
<h3 id="orgc3b932c"><span class="section-number-3">1.15</span> Capturing OutputDebugString output</h3>
<div class="outline-text-3" id="text-1-15">
<p>
Logging and printing output to terminal with std::cout, printf or
fprintf, does not work for any executable compiled for the window
subsystem, even if it was launched from the terminal. As a result,
applications built for the window subsystem, often uses the Windows
API <span class="underline">OutputDebugString()</span> for logging that can be viewed using the
DebugView sysinternal tool. 
</p>

<p>
In this experiment, the program testprog.exe logs its execution
through OutputDebugString() api and the program logview.exe waits for
any OutputDebugString() call and displays the OutputDebugString
message, process PID, and path to process' executable. 
</p>

<p>
Apis Used: 
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-openmutexw">OpenMutexW()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-createmutexa">CreateMutexA()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-createeventa">CreateEventA()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createfilemappinga">CreateFileMappingA()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/sync/using-event-objects">Using Event Objects (Synchronization)</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-mapviewoffile">MapViewOfFile()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-outputdebugstringa">OutputDebugStringA()</a> [ANSI]</li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-outputdebugstringw">OutputDebugStringW()</a> [UNICODE]</li>
</ul>

<p>
ReactOS implementation of OutputDebugString:
</p>

<ul class="org-ul">
<li><a href="https://github.com/reactos/reactos/blob/3fa57b8ff7fcee47b8e2ed869aecaf4515603f3f/dll/win32/kernel32/client/debugger.c#L728">File - debugger.c - line 728</a></li>
</ul>

<p>
<b>Project Files</b> 
</p>

<p>
File: <span class="underline">logview.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">tchar.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">struct</span> <span class="org-type">alignas</span><span class="org-rainbow-delimiters-depth-1">(</span>4<span class="org-rainbow-delimiters-depth-1">)</span> OutputDebugStringBuffer
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">pid</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">4KiB - 4 Kbytes buffer </span>
    <span class="org-type">char</span> <span class="org-variable-name">data</span><span class="org-rainbow-delimiters-depth-2">[</span>4096 - <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">DWORD</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">]</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-function-name">std</span>::string get_process_path<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">pid</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Link against this function without any headers containing this declaration.</span>
<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-type">void</span> <span class="org-function-name">QueryFullProcessImageNameA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span>, <span class="org-type">int</span> <span class="org-variable-name">n</span>, <span class="org-type">char</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">DWORD</span>* <span class="org-variable-name">buffer_size</span><span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  static_assert<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>OutputDebugStringBuffer<span class="org-rainbow-delimiters-depth-3">)</span> == 4096 <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">---- The following constansts must have those exact name ----- //</span>
  <span class="org-keyword">constexpr</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">strDBWinMutex</span>         = <span class="org-string">"DBWinMutex"</span>;
  <span class="org-keyword">constexpr</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">strDBWIN_BUFFER_READY</span> = <span class="org-string">"DBWIN_BUFFER_READY"</span>;
  <span class="org-keyword">constexpr</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">strDBWIN_DATA_READY</span>   = <span class="org-string">"DBWIN_DATA_READY"</span>;
  <span class="org-keyword">constexpr</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">strDBWIN_BUFFER</span>       = <span class="org-string">"DBWIN_BUFFER"</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Instatiate mutex </span>
  <span class="org-type">HANDLE</span> <span class="org-variable-name">dbWinMutex</span> = ::OpenMutex<span class="org-rainbow-delimiters-depth-2">(</span>MUTEX_ALL_ACCESS, FALSE, strDBWinMutex<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>dbWinMutex == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    dbWinMutex =  ::CreateMutex<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">nullptr</span>, FALSE, strDBWinMutex<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">HANDLE</span> <span class="org-variable-name">bufferReady</span> = OpenEvent<span class="org-rainbow-delimiters-depth-2">(</span>EVENT_MODIFY_STATE, FALSE, strDBWIN_BUFFER_READY<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>bufferReady == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    bufferReady = ::CreateEvent<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">nullptr</span>, FALSE, TRUE, strDBWIN_BUFFER_READY<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>


  <span class="org-type">HANDLE</span> <span class="org-variable-name">dataReady</span> = ::OpenEvent<span class="org-rainbow-delimiters-depth-2">(</span>EVENT_MODIFY_STATE, FALSE, strDBWIN_DATA_READY<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>dataReady == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    dataReady = ::CreateEvent<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">nullptr</span>, FALSE, FALSE, strDBWIN_DATA_READY<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">HANDLE</span> <span class="org-variable-name">bufferMap</span> =::OpenFileMapping<span class="org-rainbow-delimiters-depth-2">(</span>FILE_MAP_READ, FALSE, strDBWIN_BUFFER<span class="org-rainbow-delimiters-depth-2">)</span>; 

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>bufferMap == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Creating file mapping"</span> &lt;&lt; <span class="org-constant">std</span>::endl;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Memory mapped file segment (shared memory)</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">that can be accessed by multiple processes.</span>
    bufferMap = CreateFileMapping<span class="org-rainbow-delimiters-depth-3">(</span>  INVALID_HANDLE_VALUE
                                  , <span class="org-constant">nullptr</span>
                                  , PAGE_READWRITE
                                  , 0
                                  , <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>OutputDebugStringBuffer<span class="org-rainbow-delimiters-depth-4">)</span>
                                  , strDBWIN_BUFFER
                                  <span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">auto</span> <span class="org-variable-name">wbuffer</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">OutputDebugStringBuffer</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span> ::MapViewOfFile<span class="org-rainbow-delimiters-depth-3">(</span>bufferMap, SECTION_MAP_READ, 0, 0, 0<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>wbuffer == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: failed to get buffer view"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-keyword">return</span> EXIT_FAILURE;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Waiting messages ..."</span> &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Block current thread until any other process calls OutputDebugString()</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">function. </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">r</span> = WaitForSingleObject<span class="org-rainbow-delimiters-depth-3">(</span>dataReady, INFINITE<span class="org-rainbow-delimiters-depth-3">)</span>;    

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>r == WAIT_OBJECT_0<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span> stdout
                  , <span class="org-string">" PID = %ld ; Exe = %s \n"</span>
                    <span class="org-string">" &gt;&gt; %s             \n\n"</span>
                  , wbuffer-&gt;pid
                  , get_process_path<span class="org-rainbow-delimiters-depth-5">(</span>wbuffer-&gt;pid<span class="org-rainbow-delimiters-depth-5">)</span>.c_str<span class="org-rainbow-delimiters-depth-5">()</span>
                  , wbuffer-&gt;data
                   <span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>
    SetEvent<span class="org-rainbow-delimiters-depth-3">(</span>bufferReady<span class="org-rainbow-delimiters-depth-3">)</span>;


  <span class="org-rainbow-delimiters-depth-2">}</span>  

  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-function-name">std</span>::string get_process_path<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">pid</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Process handle      </span>
      <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = OpenProcess<span class="org-rainbow-delimiters-depth-2">(</span> PROCESS_QUERY_INFORMATION  | PROCESS_VM_READ, FALSE, pid<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">If hProc is null, it means that the function OpenProcess() has failed.</span>
      assert<span class="org-rainbow-delimiters-depth-2">(</span> hProc != 0<span class="org-rainbow-delimiters-depth-2">)</span>;

      <span class="org-type">DWORD</span> <span class="org-variable-name">size</span> = MAX_PATH;
      <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_PATH<span class="org-rainbow-delimiters-depth-2">]</span>;

      <span class="org-comment-delimiter">// </span><span class="org-comment">Obtain path to proces image (executable path)</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Note: This function does not work with Unicode path names containing non</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">ascii characters such as Korean Hangul characters</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">For dealing with unicde use the API - QueryFullProcessImageNameW() instead.</span>
      QueryFullProcessImageNameA<span class="org-rainbow-delimiters-depth-2">(</span>hProc, 0, buffer, &amp;size<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">Close proces handle disposing this reosurce.</span>
      CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hProc<span class="org-rainbow-delimiters-depth-2">)</span>;

      <span class="org-keyword">return</span> <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span>buffer<span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
File: <span class="underline">testprog.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">int</span> <span class="org-variable-name">sum</span> = 0;
  <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>1000<span class="org-rainbow-delimiters-depth-2">]</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Initialize buffer </span>
  memset<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">'0'</span>, 1000<span class="org-rainbow-delimiters-depth-2">)</span>;


  <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; 5; i++<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::snprintf<span class="org-rainbow-delimiters-depth-3">(</span>buffer, 1000, <span class="org-string">" [INFO] i = %d ; sum = %d "</span>, i, sum<span class="org-rainbow-delimiters-depth-3">)</span>;
    sum += sum + i * i;
    OutputDebugStringA<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stdout, <span class="org-string">"%s\n"</span>, buffer<span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Block current thread for about 5 seconds.</span>
    Sleep<span class="org-rainbow-delimiters-depth-3">(</span>500<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::snprintf<span class="org-rainbow-delimiters-depth-2">(</span>buffer, 1000, <span class="org-string">" [INFO] Shutdown gracefully Ok. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"%s\n"</span>, buffer<span class="org-rainbow-delimiters-depth-2">)</span>;  
  OutputDebugStringA<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ logview.cpp -o <span class="org-keyword">logview.exe</span> -std=c++1z -Wall -Wextra -g
$ g++ testprog.cpp -o <span class="org-keyword">testprog.exe</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running <span class="underline">logview.exe</span> from terminal 1 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ .\logview.exe
Creating file mapping
Waiting messages ...
 PID = 8088 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] i = 0 ; sum = 0

 PID = 8088 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] i = 1 ; sum = 0

 PID = 8088 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] i = 2 ; sum = 1

 PID = 8088 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] i = 3 ; sum = 6

 PID = 8088 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] i = 4 ; sum = 21

 PID = 8088 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] Shutdown gracefully Ok.

 PID = 7940 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] i = 0 ; sum = 0

 PID = 7940 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] i = 1 ; sum = 0

 PID = 7940 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] i = 2 ; sum = 1

 PID = 7940 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] i = 3 ; sum = 6

 PID = 7940 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] i = 4 ; sum = 21

 PID = 7940 ; Exe = C:\Users\User_001\Desktop\output_debug\testprog.exe
 &gt;&gt;  [INFO] Shutdown gracefully Ok.

</pre>
</div>

<p>
Running <span class="underline">testprog.exe</span> from terminal 2
</p>

<div class="org-src-container">
<pre class="src src-sh">$ .\testprog.exe
 [INFO] i = 0 ; sum = 0
 [INFO] i = 1 ; sum = 0
 [INFO] i = 2 ; sum = 1
 [INFO] i = 3 ; sum = 6
 [INFO] i = 4 ; sum = 21
 [INFO] Shutdown gracefully Ok.


$ .\testprog.exe
 [INFO] i = 0 ; sum = 0
 [INFO] i = 1 ; sum = 0
 [INFO] i = 2 ; sum = 1
 [INFO] i = 3 ; sum = 6
 [INFO] i = 4 ; sum = 21
 [INFO] Shutdown gracefully Ok.
</pre>
</div>
</div>
</div>
<div id="outline-container-org97179fd" class="outline-3">
<h3 id="org97179fd"><span class="section-number-3">1.16</span> Listing Windows and Related Processes</h3>
<div class="outline-text-3" id="text-1-16">
<p>
The following code lists all visible windows titles, the related process ID
(PID) and the path to the process' executable file.
</p>

<p>
<b>Windows API Docs</b> 
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getdesktopwindow">GetDesktopWindow()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getwindow">GetWindow()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getclassname">GetClassName()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getwindowtexta">GetWindowText()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-findwindowa">FindWindowA()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getwindowthreadprocessid">GetWindowThreadProcessId()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getwindowtexta">GetWindowTextA()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess">OpenProcess()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-queryfullprocessimagenamea">QueryFullProcessImageNameA()</a></li>
</ul>

<p>
<b>Files</b> 
</p>

<p>
File: <span class="underline">enum-windows.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  <span class="org-type">HWND</span> <span class="org-variable-name">hDesk</span>  = GetDesktopWindow<span class="org-rainbow-delimiters-depth-2">()</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> hDesk != 0 <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Current Winmdow </span>
  <span class="org-type">HWND</span> <span class="org-variable-name">cwd</span> = GetWindow<span class="org-rainbow-delimiters-depth-2">(</span>hDesk, GW_CHILD<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert <span class="org-rainbow-delimiters-depth-2">(</span> cwd != 0 <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">SIZE</span> = 2048; <span class="org-comment-delimiter">// </span><span class="org-comment">2kbytes buffer</span>
  <span class="org-type">char</span> <span class="org-variable-name">buffer_window_title</span><span class="org-rainbow-delimiters-depth-2">[</span>SIZE<span class="org-rainbow-delimiters-depth-2">]</span>;
  <span class="org-type">char</span> <span class="org-variable-name">buffer_window_class</span><span class="org-rainbow-delimiters-depth-2">[</span>SIZE<span class="org-rainbow-delimiters-depth-2">]</span>;
  <span class="org-type">char</span> <span class="org-variable-name">buffer_executable_path</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_PATH<span class="org-rainbow-delimiters-depth-2">]</span>;

  <span class="org-type">int</span> <span class="org-variable-name">n</span> = 0;
  <span class="org-type">DWORD</span> <span class="org-variable-name">pid</span> = 0;

  <span class="org-comment-delimiter">// </span><span class="org-comment">If true the application does not list windows</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">with empty titles. </span>
  <span class="org-type">bool</span> <span class="org-variable-name">hide_empty_title</span> = <span class="org-constant">true</span>;

  <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> cwd <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Initialize and clean buffer</span>
      memset<span class="org-rainbow-delimiters-depth-3">(</span>buffer_window_title, <span class="org-string">'\0'</span>, SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;
      memset<span class="org-rainbow-delimiters-depth-3">(</span>buffer_window_class, <span class="org-string">'\0'</span>, SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;
      memset<span class="org-rainbow-delimiters-depth-3">(</span>buffer_executable_path, <span class="org-string">'\0'</span>, MAX_PATH<span class="org-rainbow-delimiters-depth-3">)</span>;

      <span class="org-comment-delimiter">// </span><span class="org-comment">Get Window title </span>
      GetWindowTextA<span class="org-rainbow-delimiters-depth-3">(</span>cwd, buffer_window_title, SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">Get Window class </span>
      GetClassName<span class="org-rainbow-delimiters-depth-3">(</span> cwd, buffer_window_class, SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">Get Window PID (Process Identifier) - unique identifier.</span>
      GetWindowThreadProcessId<span class="org-rainbow-delimiters-depth-3">(</span>cwd, &amp;pid<span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">Window visibility</span>
      <span class="org-type">bool</span> <span class="org-variable-name">isVisible</span> = IsWindowVisible<span class="org-rainbow-delimiters-depth-3">(</span>cwd<span class="org-rainbow-delimiters-depth-3">)</span>;

      <span class="org-comment-delimiter">// </span><span class="org-comment">Process handle      </span>
      <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = OpenProcess<span class="org-rainbow-delimiters-depth-3">(</span> PROCESS_QUERY_INFORMATION  | PROCESS_VM_READ, FALSE, pid<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">assert( hProc != 0);</span>
      <span class="org-type">DWORD</span> <span class="org-variable-name">size</span> = MAX_PATH;

      <span class="org-comment-delimiter">// </span><span class="org-comment">Obtain path to proces image (executable)</span>
      QueryFullProcessImageNameA<span class="org-rainbow-delimiters-depth-3">(</span>hProc, 0, buffer_executable_path, &amp;size<span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">Close proces handle disposing this reosurce.</span>
      CloseHandle<span class="org-rainbow-delimiters-depth-3">(</span>hProc<span class="org-rainbow-delimiters-depth-3">)</span>;


      <span class="org-comment-delimiter">// </span><span class="org-comment">Display only visible windows with non empty title.</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-4">(</span>hide_empty_title &amp;&amp; strlen<span class="org-rainbow-delimiters-depth-5">(</span>buffer_window_title<span class="org-rainbow-delimiters-depth-5">)</span> == 0<span class="org-rainbow-delimiters-depth-4">)</span> &amp;&amp; isVisible <span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Display window title </span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-string">" [*] =&gt; n = %d / Visible = %s  "</span>
                     <span class="org-string">"\n   =&gt;       Title = '%s' "</span>
                     <span class="org-string">"\n   =&gt;         PID = %ld  "</span>
                     <span class="org-string">"\n   =&gt;  Executable = %s  "</span>
                     <span class="org-string">"\n   =&gt;       Class = %s \n\n"</span>
                     , n++, isVisible ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span>
                     , buffer_window_title, pid, buffer_executable_path
                     , buffer_window_class
                     <span class="org-rainbow-delimiters-depth-4">)</span>;      
      <span class="org-rainbow-delimiters-depth-3">}</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">GO to next window</span>
      cwd = GetNextWindow<span class="org-rainbow-delimiters-depth-3">(</span>cwd, GW_HWNDNEXT<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
<b>Building:</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">g++ enum-windows.cpp -o <span class="org-keyword">enum-windows.exe</span> -std=c++1z -Wall -Wextra -pedantic-errors
</pre>
</div>

<p>
<b>Running</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$  enum-windows.exe 

[*] =&gt; n = 0 / Visible = TRUE  
  =&gt;       Title = <span class="org-string">'Cmder'</span> 
  =&gt;         PID = 2268  
  =&gt;  Executable = C:\Users\User_001\scoop\apps\cmder\1.3.17\vendor\conemu-maximus5\ConEmu64.exe  
  =&gt;       Class = VirtualConsoleClass 

[*] =&gt; n = 1 / Visible = TRUE  
  =&gt;       Title = <span class="org-string">'emacs@DESKTOP-GLXQFC6'</span> 
  =&gt;         PID = 7648  
  =&gt;  Executable = C:\Users\User_001\scoop\apps\emacs\27.1\bin\emacs.exe  
  =&gt;       Class = Emacs 

[*] =&gt; n = 2 / Visible = TRUE  
  =&gt;       Title = <span class="org-string">'System Configuration'</span> 
  =&gt;         PID = 7048  
  =&gt;  Executable =   
  =&gt;       Class = <span class="org-comment-delimiter">#</span><span class="org-comment">32770 </span>

[*] =&gt; n = 3 / Visible = TRUE  
  =&gt;       Title = <span class="org-string">'Event Viewer'</span> 
  =&gt;         PID = 5944  
  =&gt;  Executable =   
  =&gt;       Class = MMCMainFrame 

[*] =&gt; n = 4 / Visible = TRUE  
  =&gt;       Title = <span class="org-string">'About Windows'</span> 
  =&gt;         PID = 1368  
  =&gt;  Executable = C:\Windows\System32\winver.exe  
  =&gt;       Class = <span class="org-comment-delimiter">#</span><span class="org-comment">32770 </span>

[*] =&gt; n = 5 / Visible = TRUE  
  =&gt;       Title = <span class="org-string">'Settings'</span> 
  =&gt;         PID = 3704  
  =&gt;  Executable = C:\Windows\ImmersiveControlPanel\SystemSettings.exe  
  =&gt;       Class = Windows.UI.Core.CoreWindow 

[*] =&gt; n = 6 / Visible = TRUE  
  =&gt;       Title = <span class="org-string">'Settings'</span> 
  =&gt;         PID = 6988  
  =&gt;  Executable = C:\Windows\System32\ApplicationFrameHost.exe  
  =&gt;       Class = ApplicationFrameWindow 

[*] =&gt; n = 7 / Visible = TRUE  
  =&gt;       Title = <span class="org-string">'Microsoft Text Input Application'</span> 
  =&gt;         PID = 5896  
  =&gt;  Executable = C:\Windows\SystemApps\MicrosoftWindows.Client.CBS_cw5n1h2txyewy\InputApp\TextInputHost.exe  
  =&gt;       Class = Windows.UI.Core.CoreWindow 

[*] =&gt; n = 8 / Visible = TRUE  
  =&gt;       Title = <span class="org-string">'Program Manager'</span> 
  =&gt;         PID = 4316  
  =&gt;  Executable = C:\Windows\explorer.exe  
  =&gt;       Class = Progman 

</pre>
</div>
</div>
</div>

<div id="outline-container-orge50f8ce" class="outline-3">
<h3 id="orge50f8ce"><span class="section-number-3">1.17</span> Access Tokens</h3>
<div class="outline-text-3" id="text-1-17">
</div>
<div id="outline-container-orgb0967cb" class="outline-4">
<h4 id="orgb0967cb"><span class="section-number-4">1.17.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-17-1">
<p>
An access tokens are Windows kernel objects that contain information
about user identity, capabilities, privileges, domain and groups that
the user belongs to. They are generated when an user logs on and is
successfully authenticated. When any process is startd, it receives
the user access token. As a result, the process capabilities are
limited to the same permissions and capabilities granted by the user's
token. 
</p>

<p>
Tokens can also used for applying the principle of least privilege
which advices that an application should be granted the minimum
necessary privilege to perform its work. For instance, several system
operations including, loading device drivers, set system time or read
a process' memory, require a token to be granted with the specific
privilege that enables the operation. For instance, loading device
driver requies the token to have the <span class="underline">SeLoadDriverPrivilege</span>, reading a
process' memory requires <span class="underline">SeDugPrivilege</span> and so on.
</p>

<p>
Some windows privileges contanst <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants">(MSDN)</a>
</p>

<ul class="org-ul">
<li>SeBackupPrivilege
<ul class="org-ul">
<li>Constant: <code>SE_BACKUP_NAME</code></li>
<li>Privilege required for debugging operations.</li>
</ul></li>

<li>SeCreateGlobalPrivilege
<ul class="org-ul">
<li>constant: <code>SE_CREATE_GLOBAL_NAME</code></li>
<li>Privilege required for creating named pipes, file mapping or
shared memory namespaces in global namespace.</li>
</ul></li>

<li>SeCreateSymbolicLinkPrivilege
<ul class="org-ul">
<li>constant: <code>SE_CREATE_SYMBOLIC_LINK_NAME</code></li>
<li>Privilege required for creating symbolic links.</li>
</ul></li>

<li>SeDebugPrivilege
<ul class="org-ul">
<li>Constant: <code>SE_DEBUG_NAME</code></li>
<li>Privilege needed for enabling debugging operations on processes
not owned by the user, for instance, reading process virtual
memory, writing to process virtual memory.</li>
</ul></li>

<li>SeLoadDriverPrivilege
<ul class="org-ul">
<li>Constant: <code>SE_LOAD_DRIVER_NAME</code></li>
<li>Privilegy necessary for loading device drivers.</li>
</ul></li>
</ul>


<p>
Widely used terminology:
</p>

<ul class="org-ul">
<li>UNC - Universal Name Convention</li>

<li>UAC - User Account Control</li>

<li>ACE - Access Control Entries</li>

<li>ACL - Access Control List</li>

<li>DACL - Discretionary Access Control List</li>

<li>SACL - System Access Control List</li>

<li>SID - Security Identifier (User account unique identifer or ID)</li>

<li>LSA - Local Security Authority</li>

<li>LSAS - Local Security Subsystem Service</li>

<li>SCM - Service Control Manager</li>
</ul>


<p>
<b>Relevant documentation reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control">MSDN - Access Control (Authorization)</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/authorization-functions">MSDN - Authorization Functions (Authorization)</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/how-dacls-control-access-to-an-object">How AccessCheck Works</a> [MUST-READ]</li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens">MSDN - Access Tokens</a> [MUST-READ]</li>

<li><a href="https://docs.microsoft.com/en-us/windows/desktop/SecAuthZ/privilege-constants">MSDN - Privilege Constants</a> [MUST-READ]</li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/well-known-sids">MSDN - Well-known SIDs</a> [MUST-READ]</li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-luid">LUID structure (winnt.h)</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/aces-to-control-access-to-an-object-s-properties">ACEs to Control Access to an Object's Properties</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/lsa-authentication">MSDN - LSA Authentication</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/procthread/isolated-user-mode--ium--processes">MSDN - Isolated User Mode (IUM) Processes</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/securable-objects">MSDN - Securable Objects</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/enabling-and-disabling-privileges-in-c">Enabling and Disabling Privileges in C++</a>&#x2013;</li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/finding-the-owner-of-a-file-object-in-c">MSDN - Finding the Owner of a File Object in C++</a></li>
</ul>


<p>
<b>Token and Process Windows APIs</b>
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle">CloseHandle()</a>
<ul class="org-ul">
<li>Brief: "Closes an open object handle."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CloseHandle</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hObject</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocessid">GetCurrentPRocessId()</a>
<ul class="org-ul">
<li>Brief: "Retrieves the process identifier of the calling process."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">DWORD</span> <span class="org-function-name">GetCurrentProcessId</span><span class="org-rainbow-delimiters-depth-1">()</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess">OpenProcess()</a>
<ul class="org-ul">
<li>Brief: "Opens an existing local process object."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HANDLE</span> <span class="org-function-name">OpenProcess</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">DWORD</span> <span class="org-variable-name">dwDesiredAccess</span>,
  <span class="org-type">BOOL</span>  <span class="org-variable-name">bInheritHandle</span>,
  <span class="org-type">DWORD</span> <span class="org-variable-name">dwProcessId</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-isprocesscritical">IsProcessCritical()</a>
<ul class="org-ul">
<li>Brief: "Determines whether the specified process is considered critical."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">IsProcessCritical</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProcess</span>, <span class="org-type">PBOOL</span> <span class="org-variable-name">Critical</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocess">GetCurrentProcess()</a>
<ul class="org-ul">
<li>Brief: "Retrieves a pseudo handle for the current process."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HANDLE</span> <span class="org-function-name">GetCurrentProcess</span><span class="org-rainbow-delimiters-depth-1">()</span>;
</pre>
</div>


<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocesstoken">OpenProcessToken()</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">OpenProcessToken</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span>  <span class="org-variable-name">ProcessHandle</span>,
  <span class="org-type">DWORD</span>   <span class="org-variable-name">DesiredAccess</span>,
  <span class="org-type">PHANDLE</span> <span class="org-variable-name">TokenHandle</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-gettokeninformation">GetTokenInformation()</a>
<ul class="org-ul">
<li>Brief: "The GetTokenInformation function retrieves a specified
type of information about an access token. The calling process
must have appropriate access rights to obtain the information."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">GetTokenInformation</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span>                  <span class="org-variable-name">TokenHandle</span>,
  <span class="org-type">TOKEN_INFORMATION_CLASS</span> <span class="org-variable-name">TokenInformationClass</span>,
  <span class="org-type">LPVOID</span>                  <span class="org-variable-name">TokenInformation</span>,
  <span class="org-type">DWORD</span>                   <span class="org-variable-name">TokenInformationLength</span>,
  <span class="org-type">PDWORD</span>                  <span class="org-variable-name">ReturnLength</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-lookupaccountsida">LookupAccountSidA()</a>
<ul class="org-ul">
<li>Brief: "The LookupAccountSid function accepts a security
identifier (SID) as input. It retrieves the name of the account
for this SID and the name of the first domain on which this SID
is found."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">LookupAccountSidA</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCSTR</span>        <span class="org-variable-name">lpSystemName</span>,
  <span class="org-type">PSID</span>          <span class="org-variable-name">Sid</span>,
  <span class="org-type">LPSTR</span>         <span class="org-variable-name">Name</span>,
  <span class="org-type">LPDWORD</span>       <span class="org-variable-name">cchName</span>,
  <span class="org-type">LPSTR</span>         <span class="org-variable-name">ReferencedDomainName</span>,
  <span class="org-type">LPDWORD</span>       <span class="org-variable-name">cchReferencedDomainName</span>,
  <span class="org-type">PSID_NAME_USE</span> <span class="org-variable-name">peUse</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-lookupprivilegevaluea">LookupPrivilegeValueA()</a> [ANSI-VERSION]
<ul class="org-ul">
<li>Brief: "The LookupPrivilegeValue function retrieves the locally
unique identifier (LUID) used on a specified system to locally
represent the specified privilege name."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">LookupPrivilegeValueA</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCSTR</span> <span class="org-variable-name">lpSystemName</span>,
  <span class="org-type">LPCSTR</span> <span class="org-variable-name">lpName</span>,
  <span class="org-type">PLUID</span>  <span class="org-variable-name">lpLuid</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-lookupprivilegevaluew">LookupPrivilegeValueW()</a> [UNICODE-VERSION]</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">LookupPrivilegeValueW</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCWSTR</span> <span class="org-variable-name">lpSystemName</span>,
  <span class="org-type">LPCWSTR</span> <span class="org-variable-name">lpName</span>,
  <span class="org-type">PLUID</span>   <span class="org-variable-name">lpLuid</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-adjusttokengroups">AdjustTokenGroups()</a>
<ul class="org-ul">
<li>Brief: "The AdjustTokenGroups function enables or disables
groups already present in the specified access token. Access to
TOKEN_ADJUST_GROUPS is required to enable or disable groups in
an access token."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">AdjustTokenGroups</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span>        <span class="org-variable-name">TokenHandle</span>,
  <span class="org-type">BOOL</span>          <span class="org-variable-name">ResetToDefault</span>,
  <span class="org-type">PTOKEN_GROUPS</span> <span class="org-variable-name">NewState</span>,
  <span class="org-type">DWORD</span>         <span class="org-variable-name">BufferLength</span>,
  <span class="org-type">PTOKEN_GROUPS</span> <span class="org-variable-name">PreviousState</span>,
  <span class="org-type">PDWORD</span>        <span class="org-variable-name">ReturnLength</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-adjusttokenprivileges">AdjustTokenPrivileges()</a>
<ul class="org-ul">
<li>Brief: "The AdjustTokenPrivileges function enables or disables
privileges in the specified access token. Enabling or disabling
privileges in an access token requires TOKEN_ADJUST_PRIVILEGES
access."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">AdjustTokenPrivileges</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span>            <span class="org-variable-name">TokenHandle</span>,
  <span class="org-type">BOOL</span>              <span class="org-variable-name">DisableAllPrivileges</span>,
  <span class="org-type">PTOKEN_PRIVILEGES</span> <span class="org-variable-name">NewState</span>,
  <span class="org-type">DWORD</span>             <span class="org-variable-name">BufferLength</span>,
  <span class="org-type">PTOKEN_PRIVILEGES</span> <span class="org-variable-name">PreviousState</span>,
  <span class="org-type">PDWORD</span>            <span class="org-variable-name">ReturnLength</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-duplicatetoken">DuplicateToken()</a>
<ul class="org-ul">
<li>Brief: "The DuplicateToken function creates a new access token
that duplicates one already in existence."</li>
</ul></li>
</ul>


<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">DuplicateToken</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span>                       <span class="org-variable-name">ExistingTokenHandle</span>,
  <span class="org-type">SECURITY_IMPERSONATION_LEVEL</span> <span class="org-variable-name">ImpersonationLevel</span>,
  <span class="org-type">PHANDLE</span>                      <span class="org-variable-name">DuplicateTokenHandle</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-istokenrestricted">IsTokenRestricted()</a>
<ul class="org-ul">
<li>Brief: "The IsTokenRestricted function indicates whether a token
contains a list of restricted security identifiers (SIDs)."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">IsTokenRestricted</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HANDLE</span> <span class="org-variable-name">TokenHandle</span> <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessasusera">CreateProcessAsUserA()</a>
<ul class="org-ul">
<li>Brief: "Creates a new process and its primary thread. The new
process runs in the security context of the user represented by
the specified token."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CreateProcessAsUserA</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span>                <span class="org-variable-name">hToken</span>,
  <span class="org-type">LPCSTR</span>                <span class="org-variable-name">lpApplicationName</span>,
  <span class="org-type">LPSTR</span>                 <span class="org-variable-name">lpCommandLine</span>,
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpProcessAttributes</span>,
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpThreadAttributes</span>,
  <span class="org-type">BOOL</span>                  <span class="org-variable-name">bInheritHandles</span>,
  <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwCreationFlags</span>,
  <span class="org-type">LPVOID</span>                <span class="org-variable-name">lpEnvironment</span>,
  <span class="org-type">LPCSTR</span>                <span class="org-variable-name">lpCurrentDirectory</span>,
  <span class="org-type">LPSTARTUPINFOA</span>        <span class="org-variable-name">lpStartupInfo</span>,
  <span class="org-type">LPPROCESS_INFORMATION</span> <span class="org-variable-name">lpProcessInformation</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessasuserw">CreateProcessAsUserW()</a>
<ul class="org-ul">
<li>Brief: "Creates a new process and its primary thread. The new
process runs in the security context of the user represented by
the specified token."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CreateProcessAsUserW</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span>                <span class="org-variable-name">hToken</span>,
  <span class="org-type">LPCWSTR</span>               <span class="org-variable-name">lpApplicationName</span>,
  <span class="org-type">LPWSTR</span>                <span class="org-variable-name">lpCommandLine</span>,
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpProcessAttributes</span>,
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpThreadAttributes</span>,
  <span class="org-type">BOOL</span>                  <span class="org-variable-name">bInheritHandles</span>,
  <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwCreationFlags</span>,
  <span class="org-type">LPVOID</span>                <span class="org-variable-name">lpEnvironment</span>,
  <span class="org-type">LPCWSTR</span>               <span class="org-variable-name">lpCurrentDirectory</span>,
  <span class="org-type">LPSTARTUPINFOW</span>        <span class="org-variable-name">lpStartupInfo</span>,
  <span class="org-type">LPPROCESS_INFORMATION</span> <span class="org-variable-name">lpProcessInformation</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org0332ecb" class="outline-4">
<h4 id="org0332ecb"><span class="section-number-4">1.17.2</span> Inspecting access tokens</h4>
<div class="outline-text-4" id="text-1-17-2">
<p>
This code demmonstrates the usage of many Windows NT token APIs
application programming interfaces by querying token information and
privilege from system processes passed as PID command line argument.
</p>

<p>
<b>Project Files</b> 
</p>

<p>
File: <span class="underline">tokeninfo.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-type">void</span> <span class="org-function-name">QueryFullProcessImageNameA</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span>, <span class="org-type">int</span> <span class="org-variable-name">n</span>
                                           , <span class="org-type">char</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">DWORD</span>* <span class="org-variable-name">buffer_size</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-type">BOOL</span> <span class="org-function-name">IsProcessCritical</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProcess</span>, <span class="org-type">PBOOL</span>  <span class="org-variable-name">Critical</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-type">BOOL</span> <span class="org-function-name">ConvertSidToStringSidA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">PSID</span> <span class="org-variable-name">Sid</span>,  <span class="org-type">LPSTR</span>* <span class="org-variable-name">StringSid</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">bool</span>            <span class="org-function-name">tokenHasPrivilege</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">privilege</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span>           <span class="org-function-name">showTokenPrivilege</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">privilege</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span> <span class="org-function-name">show_process_token_privilege</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">int</span> <span class="org-variable-name">pid</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">BOOL</span>              <span class="org-function-name">isTokenElevated</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span> <span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">BOOL</span>                 <span class="org-function-name">SetPrivilege</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HANDLE</span>  <span class="org-variable-name">hToken</span>, <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpszPrivilege</span>, <span class="org-type">BOOL</span> <span class="org-variable-name">bEnablePrivilege</span><span class="org-rainbow-delimiters-depth-1">)</span>; 


<span class="org-comment-delimiter">// </span><span class="org-comment">======================================================================//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> argc &lt; 2 <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"\n Usage: %s [COMMAND] [ARGUMENT]"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"\n =&gt; Show process token information"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"\n $ .%s proc [PID] \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"\n =&gt; Set debug privilege and show current privileges"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"\n $ %s priv \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;    
    <span class="org-keyword">return</span> EXIT_FAILURE;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">auto</span> <span class="org-variable-name">command</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-rainbow-delimiters-depth-2">}</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> command == <span class="org-string">"proc"</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
     <span class="org-type">DWORD</span> <span class="org-variable-name">pid</span> =  <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">If pid == 0 =&gt; Show privileges of current process.</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> pid == 0<span class="org-rainbow-delimiters-depth-3">){</span> pid = GetCurrentProcessId<span class="org-rainbow-delimiters-depth-4">()</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
     show_process_token_privilege<span class="org-rainbow-delimiters-depth-3">(</span> pid <span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-keyword">return</span> EXIT_SUCCESS;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> command == <span class="org-string">"priv"</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>

    <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = GetCurrentProcess<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span> = <span class="org-constant">nullptr</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>OpenProcessToken<span class="org-rainbow-delimiters-depth-4">(</span>hProc, TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">{</span> 
      <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error - unable to open process Token. =&gt; Check GetLastError() error code. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-constant">std</span>::abort<span class="org-rainbow-delimiters-depth-4">()</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>

    assert<span class="org-rainbow-delimiters-depth-3">(</span> hToken != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>;


    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-string">" Is process elevated (admin)? = %s \n"</span>
                , isTokenElevated<span class="org-rainbow-delimiters-depth-4">(</span>hToken<span class="org-rainbow-delimiters-depth-4">)</span> ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Set debug privilege =&gt; Necessary for reading or writing to/from process memory.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: SE_DEBUG_NAME == 'SeDebugPrivilege'</span>
    SetPrivilege<span class="org-rainbow-delimiters-depth-3">(</span> hToken, SE_DEBUG_NAME, TRUE<span class="org-rainbow-delimiters-depth-3">)</span>;
    showTokenPrivilege<span class="org-rainbow-delimiters-depth-3">(</span> hToken, SE_DEBUG_NAME <span class="org-rainbow-delimiters-depth-3">)</span>;    

    <span class="org-comment-delimiter">// </span><span class="org-comment">Backup privilege </span>
    SetPrivilege<span class="org-rainbow-delimiters-depth-3">(</span> hToken, <span class="org-string">"SeBackupPrivilege"</span>, TRUE<span class="org-rainbow-delimiters-depth-3">)</span>;
    showTokenPrivilege<span class="org-rainbow-delimiters-depth-3">(</span> hToken, <span class="org-string">"SeBackupPrivilege"</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Privilege for creating global objects </span>
    SetPrivilege<span class="org-rainbow-delimiters-depth-3">(</span> hToken, <span class="org-string">"SeCreateGlobalPrivilege"</span>, TRUE<span class="org-rainbow-delimiters-depth-3">)</span>;
    showTokenPrivilege<span class="org-rainbow-delimiters-depth-3">(</span> hToken, <span class="org-string">"SeCreateGlobalPrivilege"</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Privilege for loading drivers </span>
    SetPrivilege<span class="org-rainbow-delimiters-depth-3">(</span> hToken, <span class="org-string">"SeLoadDriverPrivilege"</span>, TRUE<span class="org-rainbow-delimiters-depth-3">)</span>;
    showTokenPrivilege<span class="org-rainbow-delimiters-depth-3">(</span> hToken, <span class="org-string">"SeLoadDriverPrivilege"</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-keyword">return</span> EXIT_SUCCESS;
  <span class="org-rainbow-delimiters-depth-2">}</span>


  <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">======= I M P L E M E N T A T I O N  S ================ //</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Check whether process is running with administrative privilege (admin)</span>
<span class="org-type">BOOL</span> <span class="org-function-name">isTokenElevated</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  <span class="org-type">TOKEN_ELEVATION</span> <span class="org-variable-name">elevation</span>;
  <span class="org-type">DWORD</span> <span class="org-variable-name">size</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span> TOKEN_ELEVATION <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>GetTokenInformation<span class="org-rainbow-delimiters-depth-3">(</span> hToken, TokenElevation, &amp;elevation
                            , <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span> TOKEN_ELEVATION<span class="org-rainbow-delimiters-depth-4">)</span>, &amp;size <span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> FALSE;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">return</span> elevation.TokenIsElevated;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">bool</span> <span class="org-function-name">tokenHasPrivilege</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">privilege</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">LUID</span> <span class="org-variable-name">luid</span>;
    <span class="org-type">PRIVILEGE_SET</span> <span class="org-variable-name">prvset</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>LookupPrivilegeValue<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">nullptr</span>, privilege, &amp;luid<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
       fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Function LookipPrivilegeAndValue() failed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-constant">std</span>::abort<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    prvset.Control                 = PRIVILEGE_SET_ALL_NECESSARY;
    prvset.Privilege<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>.Luid       = luid;
    prvset.Privilege<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>.Attributes = SE_PRIVILEGE_ENABLED;;
    prvset.PrivilegeCount          = 1;

    <span class="org-type">BOOL</span> <span class="org-variable-name">ret</span>;
    PrivilegeCheck<span class="org-rainbow-delimiters-depth-2">(</span>hToken, &amp;prvset, &amp;ret<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> ret == TRUE;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">showTokenPrivilege</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">privilege</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  <span class="org-type">bool</span> <span class="org-variable-name">p</span> = tokenHasPrivilege<span class="org-rainbow-delimiters-depth-2">(</span>hToken, privilege<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stdout, <span class="org-string">"\n [*] Has privilege? %s = %s \n"</span>
               , privilege, p ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">show_process_token_privilege</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">pid</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">Get handle to process</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">----------------------------------------------</span>
  assert<span class="org-rainbow-delimiters-depth-2">(</span> pid &gt; 0 <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = OpenProcess<span class="org-rainbow-delimiters-depth-2">(</span>PROCESS_QUERY_LIMITED_INFORMATION, FALSE, pid<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> hProc == <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>  
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-string">" Error =&gt; Unable to open process =&gt; Error code = %ld"</span>
                , GetLastError<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-constant">std</span>::abort<span class="org-rainbow-delimiters-depth-3">()</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">Get path to process</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">---------------------------------------------------</span>
  <span class="org-type">DWORD</span> <span class="org-variable-name">size</span> = MAX_PATH;
  <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_PATH<span class="org-rainbow-delimiters-depth-2">]</span>;      
  <span class="org-comment-delimiter">// </span><span class="org-comment">Obtain path to proces image (executable path)</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">Note: This function does not work with Unicode path names containing non</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">ascii characters such as Korean Hangul characters.</span>
  QueryFullProcessImageNameA<span class="org-rainbow-delimiters-depth-2">(</span>hProc, 0, buffer, &amp;size<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Get process' access token</span>
  <span class="org-comment-delimiter">//</span><span class="org-comment">----------------------------------------------------------------</span>
  <span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span> = <span class="org-constant">nullptr</span>;
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>OpenProcessToken<span class="org-rainbow-delimiters-depth-3">(</span>hProc, TOKEN_QUERY, &amp;hToken<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span> 
     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error - unable to open process Token. =&gt; Check GetLastError() error code. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-constant">std</span>::abort<span class="org-rainbow-delimiters-depth-3">()</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>


  <span class="org-comment-delimiter">// </span><span class="org-comment">Retrieve information about user which created the process </span>
  <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------------------</span>

  <span class="org-type">DWORD</span> <span class="org-variable-name">needed</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Determine the buffer size</span>
  GetTokenInformation<span class="org-rainbow-delimiters-depth-2">(</span> hToken, TokenUser, <span class="org-constant">NULL</span>, 0, &amp;needed<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">auto</span> <span class="org-variable-name">tuser</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">TOKEN_USER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span> LocalAlloc<span class="org-rainbow-delimiters-depth-3">(</span> LPTR, needed<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;    
  assert<span class="org-rainbow-delimiters-depth-2">(</span> tuser != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  GetTokenInformation<span class="org-rainbow-delimiters-depth-2">(</span> hToken, TokenUser, tuser, needed, &amp;needed<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">PSID</span> <span class="org-variable-name">psid</span> = tuser-&gt;User.Sid;
  <span class="org-type">char</span> <span class="org-variable-name">buffer_user</span><span class="org-rainbow-delimiters-depth-2">[</span>500<span class="org-rainbow-delimiters-depth-2">]</span>;
  <span class="org-type">char</span> <span class="org-variable-name">buffer_domain</span><span class="org-rainbow-delimiters-depth-2">[</span>500<span class="org-rainbow-delimiters-depth-2">]</span>;
  <span class="org-type">DWORD</span> <span class="org-variable-name">size_user</span>   = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>buffer_user<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-type">DWORD</span> <span class="org-variable-name">size_domain</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>buffer_domain<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">SID_NAME_USE</span> <span class="org-variable-name">snu</span>;
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>LookupAccountSid<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">nullptr</span>, psid
                         , buffer_user,  &amp;size_user
                         , buffer_domain, &amp;size_domain
                         , &amp;snu <span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-string">"Error. Function LookupAccountSid() failed =&gt; Last error code = %ld"</span>
                , GetLastError<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::abort<span class="org-rainbow-delimiters-depth-3">()</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">/// </span><span class="org-comment">Note: This string is allocated by the calee (function);</span>
  <span class="org-type">char</span>* <span class="org-variable-name">pBuffer_sid</span> = <span class="org-constant">nullptr</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Convert SID (Security identifier) to string</span>
  assert<span class="org-rainbow-delimiters-depth-2">(</span> ConvertSidToStringSidA<span class="org-rainbow-delimiters-depth-3">(</span>psid, &amp;pBuffer_sid<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Display process information </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">----------------------------------------------------------</span>
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TOKEN] &gt;&gt; Pid = %d ; EXE = %s \n"</span>, pid, buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" User account = %s \n"</span>, buffer_user   <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" User domain  = %s \n"</span>, buffer_domain <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" SID          = %s \n"</span>, pBuffer_sid   <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">BOOL</span> <span class="org-variable-name">is_critical</span> = FALSE;
  IsProcessCritical<span class="org-rainbow-delimiters-depth-2">(</span>hProc, &amp;is_critical<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Is process critical = %s \n"</span>, is_critical ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Is process elevated (admin)? = %s \n"</span>, isTokenElevated<span class="org-rainbow-delimiters-depth-3">(</span>hToken<span class="org-rainbow-delimiters-depth-3">)</span> ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Is token restricted = %s \n"</span>, IsTokenRestricted<span class="org-rainbow-delimiters-depth-3">(</span>hToken<span class="org-rainbow-delimiters-depth-3">)</span> ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;


  <span class="org-comment-delimiter">// </span><span class="org-comment">Display privileges that the token grants to  the process.</span>
  <span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------</span>
  <span class="org-comment-delimiter">//</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">SeAssignPrimaryTokenPrivilege =&gt; Allows replacing process-level token </span>
  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, SE_ASSIGNPRIMARYTOKEN_NAME<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">SeBackupPrivilege =&gt; Allows files and directories backup (access to any file)</span>
  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, SE_BACKUP_NAME <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">SeDebugPrivilege =&gt; Allows opening process memory and performing debugging operations </span>
  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, SE_DEBUG_NAME <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">SeIncreaseQuotaPrivilege</span>
  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, SE_INCREASE_QUOTA_NAME <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">SeTcbPrivilege =&gt; </span>
  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, SE_TCB_NAME <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Impersonate a client after authentication</span>

  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, <span class="org-string">"SeImpersonatePrivilege"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">//  </span><span class="org-comment">Load and unload device drivers</span>
  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, <span class="org-string">"SeLoadDriverPrivilege"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Change system time </span>
  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, <span class="org-string">"SeSystemtimePrivilege"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">//  </span><span class="org-comment">Create global objects</span>
  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, <span class="org-string">"SeCreateGlobalPrivilege"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Create symbolic links </span>
  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, <span class="org-string">"SeCreateSymbolicLinkPrivilege"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Managing and auditig the security log</span>
  showTokenPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, <span class="org-string">"SeSecurityPrivilege"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hProc<span class="org-rainbow-delimiters-depth-2">)</span>;
  CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hToken<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: MSDN Example </span>
<span class="org-type">BOOL</span> <span class="org-function-name">SetPrivilege</span><span class="org-rainbow-delimiters-depth-1">(</span>
      <span class="org-type">HANDLE</span>  <span class="org-variable-name">hToken</span>            <span class="org-comment-delimiter">// </span><span class="org-comment">access token handle</span>
    , <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpszPrivilege</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">name of privilege to enable/disable</span>
    , <span class="org-type">BOOL</span>    <span class="org-variable-name">bEnablePrivilege</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">to enable or disable privilege</span>
    <span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">TOKEN_PRIVILEGES</span> <span class="org-variable-name">tp</span>;
    <span class="org-type">LUID</span> <span class="org-variable-name">luid</span>;

    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>LookupPrivilegeValue<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">NULL</span>, lpszPrivilege, &amp;luid <span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>        
    <span class="org-rainbow-delimiters-depth-2">{</span>
        printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"LookupPrivilegeValue error: %ld\n"</span>, GetLastError<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>; 
        <span class="org-keyword">return</span> FALSE; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

    tp.PrivilegeCount = 1;
    tp.Privileges<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>.Luid = luid;
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>bEnablePrivilege<span class="org-rainbow-delimiters-depth-2">)</span>
        tp.Privileges<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>.Attributes = SE_PRIVILEGE_ENABLED;
    <span class="org-keyword">else</span>
        tp.Privileges<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>.Attributes = 0;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Enable the privilege or disable all privileges.</span>

    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>AdjustTokenPrivileges<span class="org-rainbow-delimiters-depth-3">(</span>
           hToken, 
           FALSE, 
           &amp;tp, 
           <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>TOKEN_PRIVILEGES<span class="org-rainbow-delimiters-depth-4">)</span>, 
           <span class="org-rainbow-delimiters-depth-4">(</span>PTOKEN_PRIVILEGES<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-constant">NULL</span>, 
           <span class="org-rainbow-delimiters-depth-4">(</span>PDWORD<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> 
          printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"AdjustTokenPrivileges error: %ld\n"</span>, GetLastError<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>; 
          <span class="org-keyword">return</span> FALSE; 
    <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>GetLastError<span class="org-rainbow-delimiters-depth-3">()</span> == ERROR_NOT_ALL_ASSIGNED<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
          printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"The token does not have the specified privilege. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-keyword">return</span> FALSE;
    <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-keyword">return</span> TRUE;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ tokeninfo.cpp -o <span class="org-keyword">tokeninfo.exe</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
<b>Experiment 1</b> - run as non administrator - querying process privileges.
</p>

<div class="org-src-container">
<pre class="src src-sh">&#955; .\tokeninfo.exe proc 0
 [TOKEN] &gt;&gt; Pid = 3100 ; EXE = C:\Users\User_001\Desktop\tokeninfo.exe
 User account = User_001
 User domain  = DESKTOP-FA8FC0Q
 SID          = S-1-5-20-3640651439-4294530408-2125417441-1261
 Is process critical = FALSE
 Is process elevated (admin)? = FALSE
 Is token restricted = FALSE

 [*] Has privilege? SeAssignPrimaryTokenPrivilege = FALSE

 [*] Has privilege? SeBackupPrivilege = FALSE

 [*] Has privilege? SeDebugPrivilege = FALSE

 [*] Has privilege? SeIncreaseQuotaPrivilege = FALSE

 [*] Has privilege? SeTcbPrivilege = FALSE

 [*] Has privilege? SeImpersonatePrivilege = FALSE

 [*] Has privilege? SeLoadDriverPrivilege = FALSE

 [*] Has privilege? SeSystemtimePrivilege = FALSE

 [*] Has privilege? SeCreateGlobalPrivilege = FALSE

 [*] Has privilege? SeCreateSymbolicLinkPrivilege = FALSE

 [*] Has privilege? SeSecurityPrivilege = FALSE

</pre>
</div>

<p>
Check user privileges with command <span class="underline">whoami</span>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                          State
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled
</pre>
</div>

<p>
<b>Experiment 2</b> - run as administrator - querying process own privilge
</p>

<div class="org-src-container">
<pre class="src src-sh">$ .\tokeninfo.exe proc 0
 [TOKEN] &gt;&gt; Pid = 7784 ; EXE = C:\Users\User_001\Desktop\tokeninfo.exe
 User account = User_001 
 User domain  = DESKTOP-FA8FC0Q
 SID          = S-1-5-20-3640651439-4294530408-2125417441-1261
 Is process critical = FALSE
 Is process elevated (admin)? = TRUE
 Is token restricted = FALSE

 [*] Has privilege? SeAssignPrimaryTokenPrivilege = FALSE

 [*] Has privilege? SeBackupPrivilege = FALSE

 [*] Has privilege? SeDebugPrivilege = FALSE

 [*] Has privilege? SeIncreaseQuotaPrivilege = FALSE

 [*] Has privilege? SeTcbPrivilege = FALSE

 [*] Has privilege? SeImpersonatePrivilege = TRUE

 [*] Has privilege? SeLoadDriverPrivilege = FALSE

 [*] Has privilege? SeSystemtimePrivilege = FALSE

 [*] Has privilege? SeCreateGlobalPrivilege = TRUE

 [*] Has privilege? SeCreateSymbolicLinkPrivilege = FALSE

 [*] Has privilege? SeSecurityPrivilege = FALSE
</pre>
</div>

<p>
Check user privileges with command <span class="underline">whoami</span>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                            Description                                                        State
========================================= ================================================================== ========
SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Disabled
SeSecurityPrivilege                       Manage auditing and security log                                   Disabled
SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Disabled
SeLoadDriverPrivilege                     Load and unload device drivers                                     Disabled
SeSystemProfilePrivilege                  Profile system performance                                         Disabled
SeSystemtimePrivilege                     Change the system time                                             Disabled
SeProfileSingleProcessPrivilege           Profile single process                                             Disabled
SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Disabled
SeCreatePagefilePrivilege                 Create a pagefile                                                  Disabled
SeBackupPrivilege                         Back up files and directories                                      Disabled
SeRestorePrivilege                        Restore files and directories                                      Disabled
SeShutdownPrivilege                       Shut down the system                                               Disabled
SeDebugPrivilege                          Debug programs                                                     Disabled
SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled
SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Disabled
SeUndockPrivilege                         Remove computer from docking station                               Disabled
SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Disabled
SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
SeCreateGlobalPrivilege                   Create global objects                                              Enabled
SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Disabled
SeTimeZonePrivilege                       Change the time zone                                               Disabled
SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Disabled
SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user<span class="org-keyword"> in</span> the same session Disabled

</pre>
</div>

<p>
<b>Experiment 3</b> - Enable debug, backup and load driver privileges
checking whether they are enabled. 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Note: Executed as administrator. </span>
$ .\tokeninfo.exe priv
 Is process elevated (admin)? = TRUE

 [*] Has privilege? SeDebugPrivilege = TRUE

 [*] Has privilege? SeBackupPrivilege = TRUE

 [*] Has privilege? SeCreateGlobalPrivilege = TRUE

 [*] Has privilege? SeLoadDriverPrivilege = TRUE
</pre>
</div>

<p>
<b>Experiment 4</b> 
</p>

<p>
List system services and their PIDs (Process unique identifiers): 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ sc queryex  

<span class="org-function-name">SERVICE_NAME</span>: WSearch
<span class="org-function-name">DISPLAY_NAME</span>: Windows Search
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 5508
        FLAGS              :

<span class="org-function-name">SERVICE_NAME</span>: cbdhsvc_3c648
<span class="org-function-name">DISPLAY_NAME</span>: Clipboard User Service_3c648
        TYPE               : f0   ERROR
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 4120
        FLAGS              :

<span class="org-function-name">SERVICE_NAME</span>: CDPUserSvc_3c648
<span class="org-function-name">DISPLAY_NAME</span>: Connected Devices Platform User Service_3c648
        TYPE               : f0   ERROR
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 4388
        FLAGS              :
  ...   ...   ...   ...   ...   ...   ...   ...   ...   ...   ... 
  ...   ...   ...   ...   ...   ...   ...   ...   ...   ...   ... 
</pre>
</div>

<p>
Inspect token information of process (PID = 2664)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ .\tokeninfo.exe proc 2664
 [TOKEN] &gt;&gt; Pid = 2664 ; EXE = C:\Program Files (x86)\SPICE Guest Tools\drivers\Balloon\w10\amd64\blnsvr.exe
 User account = SYSTEM
 User domain  = NT AUTHORITY
 SID          = S-1-5-18
 Is process critical = FALSE
 Is process elevated (admin)? = TRUE
 Is token restricted = FALSE

 [*] Has privilege? SeAssignPrimaryTokenPrivilege = FALSE

 [*] Has privilege? SeBackupPrivilege = FALSE

 [*] Has privilege? SeDebugPrivilege = TRUE

 [*] Has privilege? SeIncreaseQuotaPrivilege = FALSE

 [*] Has privilege? SeTcbPrivilege = TRUE

 [*] Has privilege? SeImpersonatePrivilege = TRUE

 [*] Has privilege? SeLoadDriverPrivilege = FALSE

 [*] Has privilege? SeSystemtimePrivilege = FALSE

 [*] Has privilege? SeCreateGlobalPrivilege = TRUE

 [*] Has privilege? SeCreateSymbolicLinkPrivilege = TRUE

 [*] Has privilege? SeSecurityPrivilege = FALSE
</pre>
</div>

<p>
Inspect token information of process (PID = 636)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ .\tokeninfo.exe proc 636
 [TOKEN] &gt;&gt; Pid = 636 ; EXE = C:\Windows\System32\lsass.exe
 User account = SYSTEM
 User domain  = NT AUTHORITY
 SID          = S-1-5-18
 Is process critical = FALSE
 Is process elevated (admin)? = TRUE
 Is token restricted = FALSE

 [*] Has privilege? SeAssignPrimaryTokenPrivilege = FALSE

 [*] Has privilege? SeBackupPrivilege = FALSE

 [*] Has privilege? SeDebugPrivilege = TRUE

 [*] Has privilege? SeIncreaseQuotaPrivilege = FALSE

 [*] Has privilege? SeTcbPrivilege = TRUE

 [*] Has privilege? SeImpersonatePrivilege = TRUE

 [*] Has privilege? SeLoadDriverPrivilege = FALSE

 [*] Has privilege? SeSystemtimePrivilege = FALSE

 [*] Has privilege? SeCreateGlobalPrivilege = TRUE

 [*] Has privilege? SeCreateSymbolicLinkPrivilege = TRUE

 [*] Has privilege? SeSecurityPrivilege = FALSE

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9b8222a" class="outline-3">
<h3 id="org9b8222a"><span class="section-number-3">1.18</span> Reading and writing process memory</h3>
<div class="outline-text-3" id="text-1-18">
</div>
<div id="outline-container-orga03e314" class="outline-4">
<h4 id="orga03e314"><span class="section-number-4">1.18.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-18-1">
<p>
Windows NT family operating systems provide APIs OpenProcess(),
ReadProcessMemory() and WriteProcessMemory() which allow the calling
code to manipulate the memory of other processes. Those functions are
meant to support the implementation of debuggers such as Visual Studio
Debugger, Windb or GDB (GNU Debugger), which need to be able to read,
write and inspect the virtual memory of any process. 
</p>

<p>
Note: Debug privilege is required for inspecting the memory of
processes not created by the user of the calling code. 
</p>

<p>
Documentation of APIs used:
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess">OpenProcess()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle">CloseHandle()</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocessid">GetCurrentProcessId()</a>
<ul class="org-ul">
<li>Brief: "Retrieves the process identifier of the calling process."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocess">GetCurrentProcess()</a>
<ul class="org-ul">
<li>Brief: "Retrieves a pseudo handle for the current process."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-readprocessmemory">ReadProcessMemory()</a>
<ul class="org-ul">
<li>Brief: "ReadProcessMemory copies the data in the specified
address range from the address space of the specified process
into the specified buffer of the current process. Any process
that has a handle with PROCESS_VM_READ access can call the
function."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory">WriteProcessMemory()</a>
<ul class="org-ul">
<li>Brief: "Writes data to an area of memory in a specified
process. The entire area to be written to must be accessible or
the operation fails."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/psapi/nf-psapi-getmodulebasenamea">GetModuleBaseName()</a>
<ul class="org-ul">
<li>Brief: "Retrieves the base name of the specified module."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/wow64apiset/nf-wow64apiset-iswow64process">IsWow64Process()</a>
<ul class="org-ul">
<li>Brief: "Determines whether the specified process is running
under WOW64 or an Intel64 of x64 processor."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess">NtQueryInformationProcess()</a> [INTERNAL-API] [UNDOCUMENTED-API]
<ul class="org-ul">
<li>Brief: "Retrieves information about the specified process."</li>
<li>Note: It is unstable internal Windows API, as a result, it may
removed without notice on future Windows releases. This API is
not supposed to be used by any application code. However, there
is no way to get a process full command line path without this
"undocumented function".</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb">PEB structure</a>  [INTERNAL-API] [UNDOCUMENTED-API]
<ul class="org-ul">
<li>Brief: Process Enviroment Block data structure.</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb_ldr_data">PEB_LDR_DATA structure</a> [INTERNAL-API] [UNDOCUMENTED-API]
<ul class="org-ul">
<li>Brief: Contains information about the loaded modules for the process.</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-rtl_user_process_parameters">RTL_USER_PROCESS_PARAMETERS structure</a> [INTERNAL-API] [UNDOCUMENTED-API]
<ul class="org-ul">
<li>Brief: Contains process parameter information.</li>
<li>Note: Contains process command line arguments.</li>
</ul></li>
</ul>

<p>
Structs: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">_PEB</span> <span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-type">BYTE</span>                          <span class="org-variable-name">Reserved1</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-type">BYTE</span>                          <span class="org-variable-name">BeingDebugged</span>;
   <span class="org-type">BYTE</span>                          <span class="org-variable-name">Reserved2</span><span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-type">PVOID</span>                         <span class="org-variable-name">Reserved3</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-type">PPEB_LDR_DATA</span>                 <span class="org-variable-name">Ldr</span>;
   <span class="org-type">PRTL_USER_PROCESS_PARAMETERS</span>  <span class="org-variable-name">ProcessParameters</span>;
   <span class="org-type">PVOID</span>                         <span class="org-variable-name">Reserved4</span><span class="org-rainbow-delimiters-depth-2">[</span>3<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-type">PVOID</span>                         <span class="org-variable-name">AtlThunkSListPtr</span>;
   <span class="org-type">PVOID</span>                         <span class="org-variable-name">Reserved5</span>;
   <span class="org-type">ULONG</span>                         <span class="org-variable-name">Reserved6</span>;
   <span class="org-type">PVOID</span>                         <span class="org-variable-name">Reserved7</span>;
   <span class="org-type">ULONG</span>                         <span class="org-variable-name">Reserved8</span>;
   <span class="org-type">ULONG</span>                         <span class="org-variable-name">AtlThunkSListPtr32</span>;
   <span class="org-type">PVOID</span>                         <span class="org-variable-name">Reserved9</span><span class="org-rainbow-delimiters-depth-2">[</span>45<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-type">BYTE</span>                          <span class="org-variable-name">Reserved10</span><span class="org-rainbow-delimiters-depth-2">[</span>96<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-type">PPS_POST_PROCESS_INIT_ROUTINE</span> <span class="org-variable-name">PostProcessInitRoutine</span>;
   <span class="org-type">BYTE</span>                          <span class="org-variable-name">Reserved11</span><span class="org-rainbow-delimiters-depth-2">[</span>128<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-type">PVOID</span>                         <span class="org-variable-name">Reserved12</span><span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-type">ULONG</span>                         <span class="org-variable-name">SessionId</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">PEB</span>, *<span class="org-type">PPEB</span>;

 <span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">_RTL_USER_PROCESS_PARAMETERS</span> <span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-type">BYTE</span>           <span class="org-variable-name">Reserved1</span><span class="org-rainbow-delimiters-depth-2">[</span>16<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-type">PVOID</span>          <span class="org-variable-name">Reserved2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-type">UNICODE_STRING</span> <span class="org-variable-name">ImagePathName</span>;
   <span class="org-type">UNICODE_STRING</span> <span class="org-variable-name">CommandLine</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">RTL_USER_PROCESS_PARAMETERS</span>, *<span class="org-type">PRTL_USER_PROCESS_PARAMETERS</span>;

<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">_PEB_LDR_DATA</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">BYTE</span>       <span class="org-variable-name">Reserved1</span><span class="org-rainbow-delimiters-depth-2">[</span>8<span class="org-rainbow-delimiters-depth-2">]</span>;
  <span class="org-type">PVOID</span>      <span class="org-variable-name">Reserved2</span><span class="org-rainbow-delimiters-depth-2">[</span>3<span class="org-rainbow-delimiters-depth-2">]</span>;
  <span class="org-type">LIST_ENTRY</span> <span class="org-variable-name">InMemoryOrderModuleList</span>;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">PEB_LDR_DATA</span>, *<span class="org-type">PPEB_LDR_DATA</span>;

<span class="org-keyword">struct</span> <span class="org-type">UNICODE_STRING</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">USHORT</span> <span class="org-variable-name">Length</span>;         <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned short (16 bits)</span>
  <span class="org-type">USHORT</span> <span class="org-variable-name">MaximumLength</span>;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned short (16 bits)</span>
  <span class="org-type">PWSTR</span>  <span class="org-variable-name">Buffer</span>;         <span class="org-comment-delimiter">// </span><span class="org-comment">type WCHAR* </span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org50b186a" class="outline-4">
<h4 id="org50b186a"><span class="section-number-4">1.18.2</span> Sample code</h4>
<div class="outline-text-4" id="text-1-18-2">
<p>
This sample code uses memory inspection APIs for manipulating the
virtual memory of a target process and also for obtaining the full
command line used for instantiating a given process. 
</p>

<p>
<b>Project files</b>
</p>

<p>
File: <span class="underline">target.cpp</span> =&gt; Sample target process. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">char</span> <span class="org-variable-name">static_allocated_buffer</span><span class="org-rainbow-delimiters-depth-1">[</span>300<span class="org-rainbow-delimiters-depth-1">]</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  <span class="org-type">int</span> <span class="org-variable-name">number</span> = 300;
  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">cppstr</span> = <span class="org-string">"Hallo Welt"</span>;

  strcpy<span class="org-rainbow-delimiters-depth-2">(</span>static_allocated_buffer, <span class="org-string">"Strcpy is an unsafe C function! BE AWARE!"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">pid</span> = GetCurrentProcessId<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*]          Number = %d  \n"</span>, number <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*]        cppstr   = %s  \n"</span>, cppstr.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Global buffer   = %s  \n"</span>, static_allocated_buffer<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*]     Current process PID = %ld \n"</span>, pid<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*]          Number address = %p  \n"</span>, &amp;number <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*]        cppstr address   = %p  \n"</span>, cppstr.data<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Global buffer address   = %p  \n"</span>, static_allocated_buffer<span class="org-rainbow-delimiters-depth-2">)</span>;  

  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n =&gt;&gt; Type RETURN to resume execution \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::cin.ignore<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*]          Number = %d  \n"</span>, number <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*]        cppstr   = %s  \n"</span>, cppstr.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Global buffer   = %s  \n"</span>, static_allocated_buffer<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n =&gt;&gt; Type RETURN to resume execution \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;  
  <span class="org-constant">std</span>::cin.ignore<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
File: <span class="underline">memorydump.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">psapi.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">winternl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Declare linkage to C symbol only when using on MING (GCC) compiler.</span>
<span class="org-preprocessor">#if</span> <span class="org-negation-char">!</span><span class="org-preprocessor">defined</span><span class="org-rainbow-delimiters-depth-1">(</span>__MINGW64__<span class="org-rainbow-delimiters-depth-1">)</span> || <span class="org-preprocessor">defined</span><span class="org-rainbow-delimiters-depth-1">(</span>__MINGW32__<span class="org-rainbow-delimiters-depth-1">)</span>
  <span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-type">BOOL</span> <span class="org-function-name">QueryFullProcessImageNameA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProcess</span>, <span class="org-type">DWORD</span>  <span class="org-variable-name">dwFlags</span>
                                             , <span class="org-type">LPSTR</span>  <span class="org-variable-name">lpExeName</span>, <span class="org-type">PDWORD</span> <span class="org-variable-name">lpdwSize</span> <span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-preprocessor">#endif</span>

<span class="org-function-name">std</span>::string process_basename<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::string process_full_path<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span>        <span class="org-function-name">enableDebugPrivilege</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">BOOL</span> <span class="org-variable-name">enable</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">BOOL</span>        <span class="org-function-name">setPrivilege</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span>, <span class="org-type">LPCTSTR</span> <span class="org-variable-name">privilege</span>, <span class="org-type">BOOL</span> <span class="org-variable-name">enable_privilege</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Type alias to Windows API function pointer. </span>
<span class="org-keyword">using</span> <span class="org-type">NtQueryInformationProcess_t</span> = NTSTATUS <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span>
                                              <span class="org-type">HANDLE</span>           <span class="org-variable-name">ProcessHandle</span>,
                                              <span class="org-type">PROCESSINFOCLASS</span> <span class="org-variable-name">ProcessInformationClass</span>,
                                              <span class="org-type">PVOID</span>            <span class="org-variable-name">ProcessInformation</span>,
                                              <span class="org-type">ULONG</span>            <span class="org-variable-name">ProcessInformationLength</span>,
                                              <span class="org-type">PULONG</span>           <span class="org-variable-name">ReturnLength</span>
                                            <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Show process command line arguments by reading its virtual memory.</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Note: This function requires debug privilege enabled if the process</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">does not belong to the current user.</span>
<span class="org-type">void</span> <span class="org-function-name">show_process_cli</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">DWORD</span> <span class="org-variable-name">pid</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: expected process PID \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-keyword">return</span> -1;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">Set debug privilege for current process token</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">Note: It only works if this application is run with</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">administrative privilege.</span>
  <span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------</span>
  enableDebugPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> TRUE <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">auto</span> <span class="org-variable-name">command</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-rainbow-delimiters-depth-2">}</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Obains information about commmand line used to start the process.</span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> command == <span class="org-string">"cli"</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>

    <span class="org-type">int</span> <span class="org-variable-name">pid</span> = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    show_process_cli<span class="org-rainbow-delimiters-depth-3">(</span>pid<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-keyword">return</span> 0;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">Dump a buffer from target process memory.</span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> command == <span class="org-string">"read-str"</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Pid of target process .</span>
    <span class="org-type">int</span> <span class="org-variable-name">pid</span>     = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer memory address to be read from target process</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">(in hexadecimal base, base 16)</span>
    <span class="org-type">int</span> <span class="org-variable-name">address</span> = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>3<span class="org-rainbow-delimiters-depth-4">]</span>, 0, 16 <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer Lenght</span>
    <span class="org-type">int</span> <span class="org-variable-name">lenght</span> = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>4<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = OpenProcess<span class="org-rainbow-delimiters-depth-3">(</span> PROCESS_QUERY_INFORMATION  | PROCESS_VM_READ, FALSE, pid<span class="org-rainbow-delimiters-depth-3">)</span>;
    assert<span class="org-rainbow-delimiters-depth-3">(</span> hProc != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Create heap-allocated string buffer with length characters</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">set as '\0' null characters.</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">buffer</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span>lenght, <span class="org-string">'\0'</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    ReadProcessMemory<span class="org-rainbow-delimiters-depth-3">(</span> hProc, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">LPVOID</span><span class="org-rainbow-delimiters-depth-4">)</span> address, buffer.data<span class="org-rainbow-delimiters-depth-4">()</span>, lenght, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" Buffer value = %s \n"</span>, buffer.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" Address      = %x \n"</span>, address<span class="org-rainbow-delimiters-depth-3">)</span>;    

    CloseHandle<span class="org-rainbow-delimiters-depth-3">(</span> hProc <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-keyword">return</span> 0;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">Write to buffer from target process </span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> command == <span class="org-string">"write-str"</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Pid of target process .</span>
    <span class="org-type">int</span> <span class="org-variable-name">pid</span>     = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer memory address to be read from target process</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">(in hexadecimal base, base 16)</span>
    <span class="org-type">int</span> <span class="org-variable-name">address</span> = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>3<span class="org-rainbow-delimiters-depth-4">]</span>, 0, 16 <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Data to be written to buffer process memory</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">str</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">{</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>4<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">}</span>;

    <span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">flags</span> = PROCESS_QUERY_INFORMATION  | PROCESS_VM_READ | PROCESS_VM_WRITE;
    <span class="org-keyword">const</span> <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = OpenProcess<span class="org-rainbow-delimiters-depth-3">(</span> flags, FALSE, pid<span class="org-rainbow-delimiters-depth-3">)</span>;
    assert<span class="org-rainbow-delimiters-depth-3">(</span> hProc != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    WriteProcessMemory<span class="org-rainbow-delimiters-depth-3">(</span> hProc, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">LPVOID</span><span class="org-rainbow-delimiters-depth-4">)</span> address, str.data<span class="org-rainbow-delimiters-depth-4">()</span>, str.length<span class="org-rainbow-delimiters-depth-4">()</span>, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">buffer</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span>str.length<span class="org-rainbow-delimiters-depth-4">()</span>, <span class="org-string">'\0'</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    ReadProcessMemory<span class="org-rainbow-delimiters-depth-3">(</span> hProc, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">LPVOID</span><span class="org-rainbow-delimiters-depth-4">)</span> address, buffer.data<span class="org-rainbow-delimiters-depth-4">()</span>, str.length<span class="org-rainbow-delimiters-depth-4">()</span>, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" Buffer value = %s \n"</span>, buffer.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" Address      = %x \n"</span>, address<span class="org-rainbow-delimiters-depth-3">)</span>;    

    CloseHandle<span class="org-rainbow-delimiters-depth-3">(</span> hProc <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-keyword">return</span> 0;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">Read number from target process memory.</span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> command == <span class="org-string">"read-num"</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Pid of target process .</span>
    <span class="org-type">int</span> <span class="org-variable-name">pid</span>     = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer memory address to be read from target process</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">(in hexadecimal base, base 16)</span>
    <span class="org-type">int</span> <span class="org-variable-name">address</span> = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>3<span class="org-rainbow-delimiters-depth-4">]</span>, 0, 16 <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = OpenProcess<span class="org-rainbow-delimiters-depth-3">(</span> PROCESS_QUERY_INFORMATION  | PROCESS_VM_READ, FALSE, pid<span class="org-rainbow-delimiters-depth-3">)</span>;
    assert<span class="org-rainbow-delimiters-depth-3">(</span> hProc != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-type">int</span> <span class="org-variable-name">buffer</span> = 0;
    ReadProcessMemory<span class="org-rainbow-delimiters-depth-3">(</span> hProc, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">LPVOID</span><span class="org-rainbow-delimiters-depth-4">)</span> address, &amp;buffer, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>buffer<span class="org-rainbow-delimiters-depth-4">)</span>, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [*] Number value = %d \n"</span>, buffer<span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-keyword">return</span> 0;
  <span class="org-rainbow-delimiters-depth-2">}</span>


  <span class="org-comment-delimiter">// </span><span class="org-comment">Write number to target process memory.</span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> command == <span class="org-string">"write-num"</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Pid of target process .</span>
    <span class="org-type">int</span> <span class="org-variable-name">pid</span>     = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer memory address to be read from target process</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">(in hexadecimal base, base 16)</span>
    <span class="org-type">int</span> <span class="org-variable-name">address</span> = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>3<span class="org-rainbow-delimiters-depth-4">]</span>, 0, 16 <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-type">int</span> <span class="org-variable-name">number</span>  = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span> argv<span class="org-rainbow-delimiters-depth-4">[</span>4<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">flags</span> = PROCESS_QUERY_INFORMATION  | PROCESS_VM_READ | PROCESS_VM_WRITE;
    <span class="org-keyword">const</span> <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = OpenProcess<span class="org-rainbow-delimiters-depth-3">(</span> flags, FALSE, pid<span class="org-rainbow-delimiters-depth-3">)</span>;
    assert<span class="org-rainbow-delimiters-depth-3">(</span> hProc != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>;

    WriteProcessMemory<span class="org-rainbow-delimiters-depth-3">(</span> hProc, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">LPVOID</span><span class="org-rainbow-delimiters-depth-4">)</span> address, &amp;number, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>number<span class="org-rainbow-delimiters-depth-4">)</span>, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-type">int</span> <span class="org-variable-name">buffer</span> = 0;
    ReadProcessMemory<span class="org-rainbow-delimiters-depth-3">(</span> hProc, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">LPVOID</span><span class="org-rainbow-delimiters-depth-4">)</span> address, &amp;buffer, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>buffer<span class="org-rainbow-delimiters-depth-4">)</span>, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [*] Number value = %d \n"</span>, buffer<span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-keyword">return</span> 0;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Error =&gt; Unable to find command."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">return</span> -1;
<span class="org-rainbow-delimiters-depth-1">}</span>

   <span class="org-comment-delimiter">// </span><span class="org-comment">============= I M P L E M E N T A T I O N S ================= //</span>

<span class="org-function-name">std</span>::string process_basename<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">Note: This function fails if the process executable uses non aciii characters</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">such as Japanese Kanji, Hiragrama or Katakana. But this function was </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">chosen due to it be easier to deal with than GetModuleBaseNameW().</span>
  <span class="org-type">size_t</span> <span class="org-variable-name">size</span> = 260;
  <span class="org-keyword">auto</span> <span class="org-variable-name">buffer</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">'0'</span>, size<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> GetModuleBaseNameA<span class="org-rainbow-delimiters-depth-3">(</span>hProc, <span class="org-constant">nullptr</span>, buffer.data<span class="org-rainbow-delimiters-depth-4">()</span>, size<span class="org-rainbow-delimiters-depth-3">)</span> != 0 <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> buffer;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">std</span>::string process_full_path<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-type">DWORD</span> <span class="org-variable-name">size</span> = MAX_PATH;
      <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>MAX_PATH<span class="org-rainbow-delimiters-depth-2">]</span>;
      QueryFullProcessImageNameA<span class="org-rainbow-delimiters-depth-2">(</span>hProc, 0, buffer, &amp;size<span class="org-rainbow-delimiters-depth-2">)</span>;
      CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hProc<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-keyword">return</span> <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span>buffer<span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">BOOL</span> <span class="org-function-name">setPrivilege</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span>, <span class="org-type">LPCTSTR</span> <span class="org-variable-name">privilege</span>, <span class="org-type">BOOL</span> <span class="org-variable-name">enable_privilege</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">TOKEN_PRIVILEGES</span> <span class="org-variable-name">tp</span>;
    <span class="org-type">LUID</span> <span class="org-variable-name">luid</span>;

    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>LookupPrivilegeValue<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">NULL</span>, privilege, &amp;luid <span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"LookupPrivilegeValue error: %ld\n"</span>, GetLastError<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> FALSE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    tp.PrivilegeCount = 1;
    tp.Privileges<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>.Luid = luid;
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>enable_privilege<span class="org-rainbow-delimiters-depth-2">)</span>
        tp.Privileges<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>.Attributes = SE_PRIVILEGE_ENABLED;
    <span class="org-keyword">else</span>
        tp.Privileges<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>.Attributes = 0;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Enable the privilege or disable all privileges.</span>

    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>AdjustTokenPrivileges<span class="org-rainbow-delimiters-depth-3">(</span>
           hToken,
           FALSE,
           &amp;tp,
           <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>TOKEN_PRIVILEGES<span class="org-rainbow-delimiters-depth-4">)</span>,
           <span class="org-rainbow-delimiters-depth-4">(</span>PTOKEN_PRIVILEGES<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-constant">NULL</span>,
           <span class="org-rainbow-delimiters-depth-4">(</span>PDWORD<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"AdjustTokenPrivileges error: %ld\n"</span>, GetLastError<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> FALSE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>GetLastError<span class="org-rainbow-delimiters-depth-3">()</span> == ERROR_NOT_ALL_ASSIGNED<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
       printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"The token does not have the specified privilege. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">return</span> FALSE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">return</span> TRUE;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Enable Debug privilege for current process</span>
<span class="org-type">void</span> <span class="org-function-name">enableDebugPrivilege</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">BOOL</span> <span class="org-variable-name">enable</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Current process' hProc handle</span>
   <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = GetCurrentProcess<span class="org-rainbow-delimiters-depth-2">()</span>;
   <span class="org-comment-delimiter">// </span><span class="org-comment">Current process' token</span>
   <span class="org-type">HANDLE</span> <span class="org-variable-name">hToken</span> = <span class="org-constant">nullptr</span>;

   <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>OpenProcessToken<span class="org-rainbow-delimiters-depth-3">(</span>hProc, TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
   <span class="org-rainbow-delimiters-depth-2">{</span>
     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error - unable to open process Token. =&gt; Check GetLastError() error code. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-constant">std</span>::abort<span class="org-rainbow-delimiters-depth-3">()</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>

   setPrivilege<span class="org-rainbow-delimiters-depth-2">(</span> hToken, <span class="org-string">"SeDebugPrivilege"</span> , enable<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Enable debug privilege Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">show_process_cli</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">DWORD</span> <span class="org-variable-name">pid</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = OpenProcess<span class="org-rainbow-delimiters-depth-2">(</span> PROCESS_QUERY_INFORMATION  | PROCESS_VM_READ, FALSE, pid<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> hProc == <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to open process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-constant">std</span>::exit<span class="org-rainbow-delimiters-depth-3">(</span>-1<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-comment-delimiter">// </span><span class="org-comment">Check whether proces is wow64 (32 bits)</span>
    <span class="org-type">BOOL</span> <span class="org-variable-name">is_wow64</span>;
    IsWow64Process<span class="org-rainbow-delimiters-depth-2">(</span> hProc, &amp;is_wow64<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Is Wow64 (32 bits) process = %s \n"</span>, is_wow64 == TRUE ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Check whether current process is 32 bits (wow64)</span>
    <span class="org-type">HANDLE</span> <span class="org-variable-name">hThisProc</span> = GetCurrentProcess<span class="org-rainbow-delimiters-depth-2">()</span>;
    IsWow64Process<span class="org-rainbow-delimiters-depth-2">(</span> hThisProc, &amp;is_wow64<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Is this process Wow64 (32 bits) process = %s \n"</span>, is_wow64 == TRUE ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;    

    <span class="org-comment-delimiter">// </span><span class="org-comment">Load function native function NtQueryInformationProcess from Ntdll.dll</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-----------------------------------------</span>
    <span class="org-type">HMODULE</span> <span class="org-variable-name">hnd</span> = LoadLibraryA<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Ntdll.dll"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> hnd != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">FARPROC</span> <span class="org-variable-name">hnd_fun</span> =  GetProcAddress<span class="org-rainbow-delimiters-depth-2">(</span>hnd, <span class="org-string">"NtQueryInformationProcess"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> hnd_fun != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">func_NtQueryInformationProcess</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">NtQueryInformationProcess_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd_fun<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">PROCESS_BASIC_INFORMATION</span> <span class="org-variable-name">pinfo</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">pinfo_size</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>PROCESS_BASIC_INFORMATION<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">needed</span> = 0;
    <span class="org-type">NTSTATUS</span> <span class="org-variable-name">result</span> = func_NtQueryInformationProcess<span class="org-rainbow-delimiters-depth-2">(</span>  hProc
                                                     , ProcessBasicInformation
                                                     , &amp;pinfo
                                                     , pinfo_size
                                                     , &amp;needed
                                                     <span class="org-rainbow-delimiters-depth-2">)</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> result &gt;= 0 &amp;&amp; <span class="org-string">"NtQuery failed."</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">DWORD</span> <span class="org-variable-name">res</span> = 0;
    <span class="org-comment-delimiter">// </span><span class="org-comment">PEB - Process Environment Block data structure.    </span>
    <span class="org-type">_PEB</span> <span class="org-variable-name">peb</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Proces parameter - field of PEB.</span>
    <span class="org-type">RTL_USER_PROCESS_PARAMETERS</span> <span class="org-variable-name">param</span>;


    <span class="org-comment-delimiter">// </span><span class="org-comment">Read PEB from target process' memory.    </span>
    res = ReadProcessMemory<span class="org-rainbow-delimiters-depth-2">(</span> hProc
                          , pinfo.PebBaseAddress
                          , &amp;peb
                          , <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>_PEB<span class="org-rainbow-delimiters-depth-3">)</span>
                          , <span class="org-constant">nullptr</span>
                          <span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> res != 0 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Read RTL_USER_PROCESS_PARAMETERS from process' memory.</span>
    res = ReadProcessMemory<span class="org-rainbow-delimiters-depth-2">(</span> hProc
                           , peb.ProcessParameters 
                           , &amp;param
                           , <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>param<span class="org-rainbow-delimiters-depth-3">)</span>
                           , <span class="org-constant">nullptr</span>
                           <span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> res != 0 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">cmdline</span> = param.CommandLine;
    <span class="org-keyword">auto</span> <span class="org-variable-name">buffer</span> = <span class="org-constant">std</span>::wstring<span class="org-rainbow-delimiters-depth-2">(</span>cmdline.Length, 0<span class="org-rainbow-delimiters-depth-2">)</span>;

    res = ReadProcessMemory<span class="org-rainbow-delimiters-depth-2">(</span> hProc, cmdline.Buffer, buffer.data<span class="org-rainbow-delimiters-depth-3">()</span>, cmdline.Length, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> res != 0 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [*] Process base name = %s "</span>, process_basename<span class="org-rainbow-delimiters-depth-3">(</span>hProc<span class="org-rainbow-delimiters-depth-3">)</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span>  <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [*] Process full path = %s \n"</span>, process_full_path<span class="org-rainbow-delimiters-depth-3">(</span>hProc<span class="org-rainbow-delimiters-depth-3">)</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">)</span>;        
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Unique process ID (PID)  = %d \n"</span>, pinfo.UniqueProcessId <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Parent process ID (PPID) = %d \n"</span>, pinfo.InheritedFromUniqueProcessId <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Process PEB address      = 0x%X \n"</span>, pinfo.PebBaseAddress  <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Display process command line arguments </span>
    <span class="org-constant">std</span>::wcout &lt;&lt; L<span class="org-string">"\n Cmdline = "</span> &lt;&lt; buffer &lt;&lt; L<span class="org-string">"\n"</span>;    

    <span class="org-comment-delimiter">// </span><span class="org-comment">Dispose library handle</span>
    FreeLibrary<span class="org-rainbow-delimiters-depth-2">(</span> hnd <span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building</b> 
</p>

<p>
Building target.exe:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ target.cpp -o <span class="org-keyword">target.exe</span> -std=c++1z -Wall -Wextra -g -O3
</pre>
</div>

<p>
Building memdump.exe:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ memdump.cpp -o <span class="org-keyword">memdump.exe</span> -std=c++1z -Wall -Wextra -g -pedantic-errors -lpsapi
</pre>
</div>

<p>
<b>Experiment 1 =&gt; Obtain process full command line arguments</b> 
</p>

<p>
STEP 1 - List all processes with tasklist. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ tasklist

Image Name                     PID Session Name        Session#    Mem Usage
========================= ======== ================ =========== ============
  ...   ...   ...   ...   ...   ...   ...   ...   ...   ...   ... 
  ...   ...   ...   ...   ...   ...   ...   ...   ...   ...   ... 

LockApp.exe                   7632 Console                    1      8,456 K
RuntimeBroker.exe             2024 Console                    1      3,372 K
dllhost.exe                   1244 Console                    1      3,220 K
svchost.exe                   7096 Services                   0      1,548 K
svchost.exe                   6528 Services                   0      1,000 K
YourPhone.exe                 5376 Console                    1     12,340 K
RuntimeBroker.exe             2168 Console                    1      2,672 K
svchost.exe                   1416 Services                   0      4,120 K
dllhost.exe                    684 Console                    1        860 K
DataExchangeHost.exe          8012 Console                    1        672 K
svchost.exe                   1992 Services                   0      2,356 K
SecurityHealthHost.exe        3880 Console                    1        616 K
SearchUI.exe                  5136 Console                    1     98,284 K
RuntimeBroker.exe             6352 Console                    1     11,000 K
smartscreen.exe               5716 Console                    1     17,440 K
MicrosoftEdge.exe             1412 Console                    1        540 K
browser_broker.exe            7924 Console                    1        392 K
Windows.WARP.JITService.e     7508 Services                   0        348 K
MicrosoftEdgeSH.exe           2324 Console                    1        208 K
MicrosoftEdgeCP.exe           5080 Console                    1        476 K
Windows.WARP.JITService.e     3472 Services                   0        340 K
svchost.exe                   1336 Services                   0      3,064 K
svchost.exe                   8424 Services                   0      7,484 K
  ....   ....   ....   ....   ....   ....   ....   ....   ....   .... 
  ....   ....   ....   ....   ....   ....   ....   ....   ....   .... 
  ....   ....   ....   ....   ....   ....   ....   ....   ....   .... 
</pre>
</div>

<p>
STEP 2 - Show process information. Note: This procedure requires
running a terminal with elevated privilege.
</p>

<div class="org-src-container">
<pre class="src src-sh">$ .\memdump.exe cli 1992
 [INFO] Enable debug privilege Ok.
 [*] Is Wow64 (32 bits) process = FALSE
 [*] Is this process Wow64 (32 bits) process = FALSE

 [*] Process base name = svchost.exe
 [*] Process full path = C:\Windows\System32\svchost.exe
 [*] Unique process ID (PID)  = 1992
 [*] Parent process ID (PPID) = 628
 [*] Process PEB address      = 0x244F2000

 Cmdline = C:\Windows\system32\svchost.exe -k netsvcs -p -s lfsvc

$ .\memdump.exe cli 5080
 [INFO] Enable debug privilege Ok.
 [*] Is Wow64 (32 bits) process = FALSE
 [*] Is this process Wow64 (32 bits) process = FALSE

 [*] Process base name = MicrosoftEdgeCP.exe
 [*] Process full path = C:\Windows\System32\MicrosoftEdgeCP.exe
 [*] Unique process ID (PID)  = 5080
 [*] Parent process ID (PPID) = 828
 [*] Process PEB address      = 0x88D6000

 Cmdline = <span class="org-string">"C:\Windows\System32\MicrosoftEdgeCP.exe"</span> -ServerName:Windows.Internal.WebRuntime.ContentProcessServer

$ .\memdump.exe cli 1208
 [INFO] Enable debug privilege Ok.
 [*] Is Wow64 (32 bits) process = TRUE
 [*] Is this process Wow64 (32 bits) process = FALSE

 [*] Process base name = OneDrive.exe
 [*] Process full path = C:\Users\unix\AppData\Local\Microsoft\OneDrive\OneDrive.exe
 [*] Unique process ID (PID)  = 1208
 [*] Parent process ID (PPID) = 4220
 [*] Process PEB address      = 0x68D000

 Cmdline =  /updateInstalled /background


$ .\memdump.exe cli 5376
 [INFO] Enable debug privilege Ok.
 [*] Is Wow64 (32 bits) process = FALSE
 [*] Is this process Wow64 (32 bits) process = FALSE

 [*] Process base name = YourPhone.exe
 [*] Process full path = C:\Program Files\WindowsApps\Microsoft.YourPhone_1.21042.137.0_x64__8wekyb3d8bbwe\YourPhone.exe
 [*] Unique process ID (PID)  = 5376
 [*] Parent process ID (PPID) = 828
 [*] Process PEB address      = 0xD05D8000

 Cmdline = <span class="org-string">"C:\Program Files\WindowsApps\Microsoft.YourPhone_1.21042.137.0_x64__8wekyb3d8bbwe\YourPhone.exe"</span> -ServerName:App.AppX9yct9q388jvt4h7y0gn06smzkxcsnt8m.mca

</pre>
</div>

<p>
<b>Experiment 2 - Manipulate target process virtula memory</b> 
</p>

<p>
STEP 1 =&gt; Run target.exe executable.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-function-name">C</span>:\Users\unix\Desktop&gt;.\target.exe
 [*]          Number = 300
 [*]        cppstr   = Hallo Welt
 [*] Global buffer   = Strcpy is an unsafe C <span class="org-keyword">function</span>! BE AWARE!
 [*]     Current process PID = 1536
 [*]          Number address = 000000000063fdec
 [*]        cppstr address   = 000000000063fe00
 [*] Global buffer address   = 000000000040c040

 =&gt;&gt; Type RETURN to resume execution

 [*]          Number = 98164
 [*]        cppstr   = Windows NT
 [*] Global buffer   = Replace strcpy with strncpy! NOWBE AWARE!

 =&gt;&gt; Type RETURN to resume execution
</pre>
</div>

<p>
STEP 2 =&gt; Run the following commands from another terminal. 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">## </span><span class="org-comment">========= Read process memory ================//</span>

$ .\memdump.exe read-num 1536 0x63fdec
 [INFO] Enable debug privilege Ok.
 [*] Number value = 300

$ .\memdump.exe read-str 1536 0x63fe00 20
 [INFO] Enable debug privilege Ok.
 Buffer value = Hallo Welt
 Address      = 63fe00

$ .\memdump.exe read-str 1536 0x40c040 50
 [INFO] Enable debug privilege Ok.
 Buffer value = Strcpy is an unsafe C <span class="org-keyword">function</span>! BE AWARE!
 Address      = 40c040

<span class="org-comment-delimiter">## </span><span class="org-comment">========= Write to process memory ================//</span>

$ .\memdump.exe write-num 1536 0x63fdec 98164
 [INFO] Enable debug privilege Ok.
 [*] Number value = 98164


$ .\memdump.exe write-str 1536 0x63fe00 <span class="org-string">"Windows NT"</span>
 [INFO] Enable debug privilege Ok.
 Buffer value = Windows NT
 Address      = 63fe00

$ .\memdump.exe write-str 1536 0x40c040 <span class="org-string">"Replace strcpy with strncpy! NOW"</span>
 [INFO] Enable debug privilege Ok.
 Buffer value = Replace strcpy with strncpy! NOW
 Address      = 40c040

</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org18f7d8b" class="outline-3">
<h3 id="org18f7d8b"><span class="section-number-3">1.19</span> Running machine code at runtime</h3>
<div class="outline-text-3" id="text-1-19">
<p>
This code uses the windows APIs VirtuaAlloc, for allocating memory for
the machine code payload which is copied to the allocated memory, and
VirtualProtect for making the allocated memory executable allowing the
machine code to be run. This technique is used by JIT compilers from
interpreted languages, such as C# or Java, for speeding up
computations and reduce the byte code interpretation overhead.
</p>

<p>
Documentation: 
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc()</a>
<ul class="org-ul">
<li>"Reserves, commits, or changes the state of a region of pages in
the virtual address space of the calling process. Memory
allocated by this function is automatically initialized to
zero."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">VirtualProtect()</a>
<ul class="org-ul">
<li>"Changes the protection on a region of committed pages in the
virtual address space of the calling process. To change the
access protection of any process, use the VirtualProtectEx
function."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualfree">VirtualFree()</a>
<ul class="org-ul">
<li>Brief: "Releases, decommits, or releases and decommits a region
of pages within the virtual address space of the calling
process.To free memory allocated in another process by the
VirtualAllocEx function, use the VirtualFreeEx function."</li>
</ul></li>
</ul>

<p>
<b>Sample code</b> 
</p>

<p>
File: <span class="underline">winmmap.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">std::memcpy() </span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span>* <span class="org-function-name">load_machine_code</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">uint8_t</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">void</span>* <span class="org-variable-name">pmap</span> = VirtualAlloc<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-comment-delimiter">// </span><span class="org-comment">lpAddress</span>
                                <span class="org-constant">nullptr</span>                        
                               <span class="org-comment-delimiter">// </span><span class="org-comment">dwSize - Size of memory to be allocated.</span>
                              , size 
                               <span class="org-comment-delimiter">// </span>
                              , MEM_COMMIT | MEM_RESERVE
                                <span class="org-comment-delimiter">// </span><span class="org-comment">Memory is writeable, readable, but not executable.       </span>
                              , PAGE_READWRITE 
                             <span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> pmap != <span class="org-constant">nullptr</span> &amp;&amp; <span class="org-string">"Allocation failed."</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Copy machine code to allocated memory</span>
    <span class="org-constant">std</span>::memcpy<span class="org-rainbow-delimiters-depth-2">(</span>pmap, buffer, size<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Set memory permission to executable.</span>
    <span class="org-type">BOOL</span> <span class="org-variable-name">result</span> = FALSE;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Sto9res previous memory protection flags.</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">prev_protection</span> = 0;
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Set the allocated memory only as readable and executable (code is data!)</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">,but not writeable.</span>
    result = VirtualProtect<span class="org-rainbow-delimiters-depth-2">(</span>  pmap, size, PAGE_EXECUTE_READ , &amp;prev_protection <span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> result == TRUE &amp;&amp; <span class="org-string">"Failed to change memory protection flags."</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> pmap;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">/** </span>
<span class="org-comment">    0000000000401550 &lt;factorial&gt;:</span>
<span class="org-comment">    401550:       55                      push   rbp</span>
<span class="org-comment">    401551:       48 89 e5                mov    rbp,rsp</span>
<span class="org-comment">    401554:       48 83 ec 10             sub    rsp,0x10</span>
<span class="org-comment">    401558:       89 4d 10                mov    DWORD PTR [rbp+0x10],ecx</span>
<span class="org-comment">    40155b:       c7 45 fc 01 00 00 00    mov    DWORD PTR [rbp-0x4],0x1</span>
<span class="org-comment">    401562:       c7 45 f8 01 00 00 00    mov    DWORD PTR [rbp-0x8],0x1</span>
<span class="org-comment">    401569:       eb 0e                   jmp    401579 &lt;factorial+0x29&gt;</span>
<span class="org-comment">    40156b:       8b 45 fc                mov    eax,DWORD PTR [rbp-0x4]</span>
<span class="org-comment">    40156e:       0f af 45 f8             imul   eax,DWORD PTR [rbp-0x8]</span>
<span class="org-comment">    401572:       89 45 fc                mov    DWORD PTR [rbp-0x4],eax</span>
<span class="org-comment">    401575:       83 45 f8 01             add    DWORD PTR [rbp-0x8],0x1</span>
<span class="org-comment">    401579:       8b 45 f8                mov    eax,DWORD PTR [rbp-0x8]</span>
<span class="org-comment">    40157c:       3b 45 10                cmp    eax,DWORD PTR [rbp+0x10]</span>
<span class="org-comment">    40157f:       7c ea                   jl     40156b &lt;factorial+0x1b&gt;</span>
<span class="org-comment">    401581:       8b 45 fc                mov    eax,DWORD PTR [rbp-0x4]</span>
<span class="org-comment">    401584:       48 83 c4 10             add    rsp,0x10</span>
<span class="org-comment">    401588:       5d                      pop    rbp</span>
<span class="org-comment">    401589:       c3                      ret</span>
<span class="org-comment"> */</span>
<span class="org-function-name">std</span>::uint8_t asm_factorialA<span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-rainbow-delimiters-depth-1">{</span>
      0x55                      
     ,0x48, 0x89, 0xe5                
     ,0x48, 0x83, 0xec, 0x10             
     ,0x89, 0x4d, 0x10                
     ,0xc7, 0x45, 0xfc, 0x01, 0x00, 0x00, 0x00    
     ,0xc7, 0x45, 0xf8, 0x01, 0x00, 0x00, 0x00    
     ,0xeb, 0x0e                   
     ,0x8b, 0x45, 0xfc                
     ,0x0f, 0xaf, 0x45, 0xf8             
     ,0x89, 0x45, 0xfc                
     ,0x83, 0x45, 0xf8, 0x01             
     ,0x8b, 0x45, 0xf8                
     ,0x3b, 0x45, 0x10                
     ,0x7c, 0xea                   
     ,0x8b, 0x45, 0xfc                
     ,0x48, 0x83, 0xc4, 0x10             
     ,0x5d
     ,0xc3
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-comment-delimiter">// </span><span class="org-comment">Same as asm_factorialA but encoded as hexadecimal.</span>
<span class="org-function-name">std</span>::uint8_t asm_factorialB<span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-string">"\x55\x48\x89\xe5\x48\x83\xec\x10\x89\x4d\x10\xc7"</span>
                               <span class="org-string">"\x45\xfc\x01\x00\x00\x00\xc7\x45\xf8\x01\x00\x00"</span>
                               <span class="org-string">"\x00\xeb\x0e\x8b\x45\xfc\x0f\xaf\x45\xf8\x89\x45"</span>
                               <span class="org-string">"\xfc\x83\x45\xf8\x01\x8b\x45\xf8\x3b\x45\x10\x7c"</span>
                               <span class="org-string">"\xea\x8b\x45\xfc\x48\x83\xc4\x10\x5d\xc3"</span>
                              ;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>


  <span class="org-keyword">auto</span> <span class="org-variable-name">data_size</span> = <span class="org-constant">std</span>::size<span class="org-rainbow-delimiters-depth-2">(</span>asm_factorialA<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Data size in bytes = %d \n"</span>, data_size<span class="org-rainbow-delimiters-depth-2">)</span>;


  <span class="org-comment-delimiter">// </span><span class="org-comment">Function pointer alias.</span>
  <span class="org-keyword">using</span> <span class="org-type">funptr_factorial</span> = <span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">auto</span> <span class="org-variable-name">factorialA</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">funptr_factorial</span><span class="org-rainbow-delimiters-depth-2">)</span> load_machine_code<span class="org-rainbow-delimiters-depth-2">(</span> asm_factorialA
                                                        , <span class="org-constant">std</span>::size<span class="org-rainbow-delimiters-depth-3">(</span>asm_factorialA<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Factorial(4)(A) = %d  \n"</span>, factorialA<span class="org-rainbow-delimiters-depth-3">(</span>4<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;  
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Factorial(5)(A) = %d  \n"</span>, factorialA<span class="org-rainbow-delimiters-depth-3">(</span>5<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Factorial(6)(A) = %d  \n"</span>, factorialA<span class="org-rainbow-delimiters-depth-3">(</span>6<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Factorial(7)(A) = %d  \n"</span>, factorialA<span class="org-rainbow-delimiters-depth-3">(</span>7<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;  
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Factorial(8)(A) = %d  \n"</span>, factorialA<span class="org-rainbow-delimiters-depth-3">(</span>8<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;


  <span class="org-keyword">auto</span> <span class="org-variable-name">factorialB</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">funptr_factorial</span><span class="org-rainbow-delimiters-depth-2">)</span> load_machine_code<span class="org-rainbow-delimiters-depth-2">(</span> asm_factorialB
                                                        , <span class="org-constant">std</span>::size<span class="org-rainbow-delimiters-depth-3">(</span>asm_factorialB<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Factorial(4)(B) = %d  \n"</span>, factorialB<span class="org-rainbow-delimiters-depth-3">(</span>4<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;  
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Factorial(5)(B) = %d  \n"</span>, factorialB<span class="org-rainbow-delimiters-depth-3">(</span>5<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Factorial(6)(B) = %d  \n"</span>, factorialB<span class="org-rainbow-delimiters-depth-3">(</span>6<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Factorial(7)(B) = %d  \n"</span>, factorialB<span class="org-rainbow-delimiters-depth-3">(</span>7<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;  
  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [*] Factorial(8)(B) = %d  \n"</span>, factorialB<span class="org-rainbow-delimiters-depth-3">(</span>8<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ====== Finish Execution Ok. [ PART 1 ] =======\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building and running</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ winmmap.cpp -o <span class="org-keyword">winmmap.exe</span> -std=c++1z -Wall -Wextra -g

$ .\winmmap.exe
 Data size<span class="org-keyword"> in</span> bytes = 58
 [*] Factorial(4)(A) = 6
 [*] Factorial(5)(A) = 24
 [*] Factorial(6)(A) = 120
 [*] Factorial(7)(A) = 720
 [*] Factorial(8)(A) = 5040
 [*] Factorial(4)(B) = 6
 [*] Factorial(5)(B) = 24
 [*] Factorial(6)(B) = 120
 [*] Factorial(7)(B) = 720
 [*] Factorial(8)(B) = 5040

<span class="org-comment-delimiter"># </span><span class="org-comment">Display message box containing 'Hast la vista' text.</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8c3a48f" class="outline-3">
<h3 id="org8c3a48f"><span class="section-number-3">1.20</span> CODE - Display information about current process</h3>
<div class="outline-text-3" id="text-1-20">
<p>
Print information about current process and copy itself to desktop
directory. 
</p>

<p>
File: <a href="src/windows/currentProcess.cpp">file:src/windows/currentProcess.cpp</a> 
</p>

<p>
<b>Files</b> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Return true if program was launched by clicking on it, </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">return false if this program was launched from command line.</span>
<span class="org-keyword">auto</span> <span class="org-function-name">isInOwnConsole</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-type">DWORD</span> <span class="org-variable-name">procIDs</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span>;
      <span class="org-type">DWORD</span> <span class="org-variable-name">maxCount</span> = 2;
      <span class="org-type">DWORD</span> <span class="org-variable-name">result</span> = GetConsoleProcessList<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">LPDWORD</span><span class="org-rainbow-delimiters-depth-3">)</span>procIDs, maxCount<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-keyword">return</span> result != 1;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-variable-name">ExecutablePath</span> = <span class="org-rainbow-delimiters-depth-1">[](</span><span class="org-type">int</span> <span class="org-variable-name">pid</span><span class="org-rainbow-delimiters-depth-1">){</span>
      <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = OpenProcess<span class="org-rainbow-delimiters-depth-2">(</span> PROCESS_QUERY_INFORMATION
                                                              | PROCESS_VM_READ, FALSE, pid <span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">Get process file path </span>
      <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">process_path</span><span class="org-rainbow-delimiters-depth-2">(</span>MAX_PATH, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-type">DWORD</span> <span class="org-variable-name">size</span> = MAX_PATH; 
      QueryFullProcessImageNameA<span class="org-rainbow-delimiters-depth-2">(</span>hProc, 0, &amp;process_path<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, &amp;size<span class="org-rainbow-delimiters-depth-2">)</span>;
      process_path.resize<span class="org-rainbow-delimiters-depth-2">(</span>size<span class="org-rainbow-delimiters-depth-2">)</span>;    
      CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hProc<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-keyword">return</span> process_path;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">auto</span> <span class="org-variable-name">CurrentDirectory</span> = <span class="org-rainbow-delimiters-depth-1">[]{</span>
      DWORD size = ::GetCurrentDirectory<span class="org-rainbow-delimiters-depth-2">(</span>0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      assert<span class="org-rainbow-delimiters-depth-2">(</span>size != 0<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-2">(</span>size + 1, 0x00<span class="org-rainbow-delimiters-depth-2">)</span>;
      size = ::GetCurrentDirectory<span class="org-rainbow-delimiters-depth-2">(</span>path.size<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;path<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      path.resize<span class="org-rainbow-delimiters-depth-2">(</span>size<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-keyword">return</span> path;
<span class="org-rainbow-delimiters-depth-1">}</span>;  

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Get current process ID </span>
      <span class="org-type">DWORD</span>    <span class="org-variable-name">pid</span>   = GetCurrentProcessId<span class="org-rainbow-delimiters-depth-2">()</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">Return module handle of current process </span>
      <span class="org-type">HMODULE</span>  <span class="org-variable-name">hProc</span> = GetModuleHandleA<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">Get process module</span>
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"=========== Current Process Info ========"</span>  &lt;&lt; <span class="org-constant">std</span>::endl;
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"PID              = "</span>   &lt;&lt; pid                 &lt;&lt; <span class="org-constant">std</span>::endl;
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"hProc            = 0x"</span> &lt;&lt; hProc               &lt;&lt; <span class="org-constant">std</span>::endl;
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Executable path  = "</span>   &lt;&lt; ExecutablePath<span class="org-rainbow-delimiters-depth-2">(</span>pid<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Current path     = "</span>   &lt;&lt; CurrentDirectory<span class="org-rainbow-delimiters-depth-2">()</span>  &lt;&lt; <span class="org-constant">std</span>::endl;

      <span class="org-comment-delimiter">// </span><span class="org-comment">Copy itself to Desktop</span>
      CopyFile<span class="org-rainbow-delimiters-depth-2">(</span>ExecutablePath<span class="org-rainbow-delimiters-depth-3">(</span>pid<span class="org-rainbow-delimiters-depth-3">)</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-string">"C:\\Users\\archbox\\Desktop\\appinfo.exe"</span>, <span class="org-constant">false</span><span class="org-rainbow-delimiters-depth-2">)</span> ;

      <span class="org-comment-delimiter">// </span><span class="org-comment">Stop program from exiting if it was launched by clicking on it.</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>isInOwnConsole<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">){</span>
              <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ==&gt; Type RETURN to exit."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
              <span class="org-constant">std</span>::cin.get<span class="org-rainbow-delimiters-depth-3">()</span>;
      <span class="org-rainbow-delimiters-depth-2">}</span> 
      <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building</b> 
</p>

<p>
Compile: MSVC
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe currentProcess.cpp /EHsc /Zi /nologo /Fe:currentProcess.exe &amp;&amp; currentProcess.exe
</pre>
</div>

<p>
Running on console (from cmd.exe or cmder terminal): 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ currentProcess.exe 
=========== Current Process Info ========
PID              = 5712
hProc            = 0x00007FF65D890000
Executable path  = C:\Users\archbox\Desktop\experiments\currentProcess.exe
Current path     = c:\Users\archbox\Desktop\experiments
</pre>
</div>

<p>
Running program by clicking on it: 
</p>
<ul class="org-ul">
<li>If program checks whether it was launched by click, it waits for
the user to type RETURN before terminating.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">=========== Current Process Info ========
PID              = 6916
hProc            = 0x00007FF72C300000
Executable path  = C:\Users\archbox\Desktop\experiments\currentProcess.exe
Current path     = C:\Users\archbox\Desktop\experiments

 ==&gt; Type RETURN to exit.
</pre>
</div>

<p>
Code: 
</p>

<ul class="org-ul">
<li>Function: isInOwnConsole - returns true if program was launched by
click. Returns false if it was launched from any type console such
as cmd.exe or cmder.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Return true if program was launched by clicking on it, </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">return false if this program was launched from command line.</span>
<span class="org-keyword">auto</span> <span class="org-function-name">isInOwnConsole</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">DWORD</span> <span class="org-variable-name">procIDs</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span>;
     <span class="org-type">DWORD</span> <span class="org-variable-name">maxCount</span> = 2;
     <span class="org-type">DWORD</span> <span class="org-variable-name">result</span> = GetConsoleProcessList<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">LPDWORD</span><span class="org-rainbow-delimiters-depth-3">)</span>procIDs, maxCount<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> result != 1;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li>Lambda function ExecutablePath - Returns the path of some process
executable given its PID (Process ID).</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">auto</span> <span class="org-variable-name">ExecutablePath</span> = <span class="org-rainbow-delimiters-depth-1">[](</span><span class="org-type">int</span> <span class="org-variable-name">pid</span><span class="org-rainbow-delimiters-depth-1">){</span>
     <span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span> = OpenProcess<span class="org-rainbow-delimiters-depth-2">(</span> PROCESS_QUERY_INFORMATION
                                | PROCESS_VM_READ, FALSE, pid <span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Get process file path </span>
     <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">process_path</span><span class="org-rainbow-delimiters-depth-2">(</span>MAX_PATH, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-type">DWORD</span> <span class="org-variable-name">size</span> = MAX_PATH; 
     QueryFullProcessImageNameA<span class="org-rainbow-delimiters-depth-2">(</span>hProc, 0, &amp;process_path<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, &amp;size<span class="org-rainbow-delimiters-depth-2">)</span>;
     process_path.resize<span class="org-rainbow-delimiters-depth-2">(</span>size<span class="org-rainbow-delimiters-depth-2">)</span>; 
     CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hProc<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> process_path;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>Lambda function CurrentDirectory - returns current directory.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">auto</span> <span class="org-variable-name">CurrentDirectory</span> = <span class="org-rainbow-delimiters-depth-1">[]{</span>
     DWORD size = ::GetCurrentDirectory<span class="org-rainbow-delimiters-depth-2">(</span>0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     assert<span class="org-rainbow-delimiters-depth-2">(</span>size != 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-2">(</span>size + 1, 0x00<span class="org-rainbow-delimiters-depth-2">)</span>;
     size = ::GetCurrentDirectory<span class="org-rainbow-delimiters-depth-2">(</span>path.size<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;path<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     path.resize<span class="org-rainbow-delimiters-depth-2">(</span>size<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> path;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>Main function:</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Get current process ID </span>
<span class="org-type">DWORD</span>    <span class="org-variable-name">pid</span>   = GetCurrentProcessId<span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Return module handle of current process </span>
<span class="org-type">HMODULE</span>  <span class="org-variable-name">hProc</span> = GetModuleHandleA<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Get process module</span>
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"=========== Current Process Info ========"</span>  &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"PID              = "</span> &lt;&lt; pid                 &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"hProc            = 0x"</span> &lt;&lt; hProc             &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"Executable path  = "</span> &lt;&lt; ExecutablePath<span class="org-rainbow-delimiters-depth-1">(</span>pid<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"Current path     = "</span> &lt;&lt; CurrentDirectory<span class="org-rainbow-delimiters-depth-1">()</span>  &lt;&lt; <span class="org-constant">std</span>::endl;

<span class="org-comment-delimiter">// </span><span class="org-comment">Copy itself to Desktop</span>
CopyFile<span class="org-rainbow-delimiters-depth-1">(</span>ExecutablePath<span class="org-rainbow-delimiters-depth-2">(</span>pid<span class="org-rainbow-delimiters-depth-2">)</span>.c_str<span class="org-rainbow-delimiters-depth-2">()</span>, <span class="org-string">"C:\\Users\\archbox\\Desktop\\appinfo.exe"</span>, <span class="org-constant">false</span><span class="org-rainbow-delimiters-depth-1">)</span> ;

<span class="org-comment-delimiter">// </span><span class="org-comment">Stop program from exiting if it was launched by clicking on it.</span>
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-negation-char">!</span>isInOwnConsole<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ==&gt; Type RETURN to exit."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-constant">std</span>::cin.get<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>   
<span class="org-keyword">return</span> EXIT_SUCCESS;
</pre>
</div>
</div>
</div>

<div id="outline-container-org7e7a27a" class="outline-3">
<h3 id="org7e7a27a"><span class="section-number-3">1.21</span> CODE - List processes</h3>
<div class="outline-text-3" id="text-1-21">
<p>
This code prints to stdout (console) and to a file the list of running
processes in current machine:
</p>

<p>
Source: 
</p>
<ul class="org-ul">
<li><p>
<a href="src/windows/showProcesses.cpp">file:src/windows/showProcesses.cpp</a>
</p>

<p>
<b>Files</b> 
</p></li>
</ul>

<p>
FIle: <span class="underline">showProcesses.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Windows Headers </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">tlhelp32.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">auto</span> <span class="org-function-name">showProcessInfo</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">ostream</span>&amp; <span class="org-variable-name">os</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">int</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Log file </span>
   <span class="org-keyword">auto</span> <span class="org-variable-name">plog</span> = <span class="org-constant">std</span>::ofstream<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"process-log.txt"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-comment-delimiter">// </span><span class="org-comment">Print all processes to stdout. </span>
   showProcessInfo<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::cout<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-comment-delimiter">// </span><span class="org-comment">Write all processes to file </span>
   showProcessInfo<span class="org-rainbow-delimiters-depth-2">(</span>plog<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-comment-delimiter">// </span><span class="org-comment">Flush buffer - force data to be written to file.</span>
   plog.flush<span class="org-rainbow-delimiters-depth-2">()</span>;

   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ==&gt; Type return to exit."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
   <span class="org-constant">std</span>::cin.get<span class="org-rainbow-delimiters-depth-2">()</span>;
  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">//</span><span class="org-comment">=======================///</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Show all processes in current machine </span>
<span class="org-keyword">auto</span> <span class="org-function-name">showProcessInfo</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">ostream</span>&amp; <span class="org-variable-name">os</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">int</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Get snapshot with process listing.</span>
     <span class="org-type">HANDLE</span> <span class="org-variable-name">hProcessSnapShot</span> =
       CreateToolhelp32Snapshot<span class="org-rainbow-delimiters-depth-2">(</span>TH32CS_SNAPPROCESS, 0<span class="org-rainbow-delimiters-depth-2">)</span>;  
     <span class="org-comment-delimiter">// </span><span class="org-comment">Instnatiate process' entry structure.</span>
     <span class="org-type">PROCESSENTRY32</span> <span class="org-variable-name">ProcessEntry</span> = <span class="org-rainbow-delimiters-depth-2">{</span> 0 <span class="org-rainbow-delimiters-depth-2">}</span>;
     ProcessEntry.dwSize = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span> ProcessEntry <span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-type">BOOL</span> <span class="org-variable-name">Return</span> = FALSE;
     Return = Process32First<span class="org-rainbow-delimiters-depth-2">(</span> hProcessSnapShot, &amp;ProcessEntry <span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Returns -1 if process failed </span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>Return <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>  <span class="org-keyword">return</span> -1;<span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-comment-delimiter">// </span><span class="org-comment">print process' data</span>
         os &lt;&lt; <span class="org-string">"EXE File     = "</span> &lt;&lt; ProcessEntry.szExeFile      &lt;&lt; <span class="org-string">"\n"</span>
            &lt;&lt; <span class="org-string">"PID          = "</span> &lt;&lt; ProcessEntry.th32ProcessID  &lt;&lt; <span class="org-string">"\n"</span>
            &lt;&lt; <span class="org-string">"References   = "</span> &lt;&lt; ProcessEntry.cntUsage       &lt;&lt; <span class="org-string">"\n"</span>
            &lt;&lt; <span class="org-string">"Thread Count = "</span> &lt;&lt; ProcessEntry.cntThreads     &lt;&lt; <span class="org-string">"\n"</span>  
            &lt;&lt; <span class="org-string">"-----------------------------------------------\n"</span>;
       <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> Process32Next<span class="org-rainbow-delimiters-depth-3">(</span> hProcessSnapShot, &amp;ProcessEntry <span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Close handle releasing resource.</span>
     CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span> hProcessSnapShot <span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> 1;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Analysis</b> 
</p>

<p>
Parts:
</p>

<ul class="org-ul">
<li>Function which prints all processes to any output stream:</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Show all processes in current machine</span>
<span class="org-keyword">auto</span> <span class="org-function-name">showProcessInfo</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">ostream</span>&amp; <span class="org-variable-name">os</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">Get snapshot with process listing.</span>
  <span class="org-type">HANDLE</span> <span class="org-variable-name">hProcessSnapShot</span> =
    CreateToolhelp32Snapshot<span class="org-rainbow-delimiters-depth-2">(</span>TH32CS_SNAPPROCESS, 0<span class="org-rainbow-delimiters-depth-2">)</span>;  
  <span class="org-comment-delimiter">// </span><span class="org-comment">Instnatiate process' entry structure.</span>
  <span class="org-type">PROCESSENTRY32</span> <span class="org-variable-name">ProcessEntry</span> = <span class="org-rainbow-delimiters-depth-2">{</span> 0 <span class="org-rainbow-delimiters-depth-2">}</span>;
  ProcessEntry.dwSize = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span> ProcessEntry <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-type">BOOL</span> <span class="org-variable-name">Return</span> = FALSE;
  Return = Process32First<span class="org-rainbow-delimiters-depth-2">(</span> hProcessSnapShot, &amp;ProcessEntry <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Returns -1 if process failed </span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>Return <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>  <span class="org-keyword">return</span> -1;<span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-comment-delimiter">// </span><span class="org-comment">print process' data</span>
      os &lt;&lt; <span class="org-string">"EXE File     = "</span> &lt;&lt; ProcessEntry.szExeFile      &lt;&lt; <span class="org-string">"\n"</span>
         &lt;&lt; <span class="org-string">"PID          = "</span> &lt;&lt; ProcessEntry.th32ProcessID  &lt;&lt; <span class="org-string">"\n"</span>
         &lt;&lt; <span class="org-string">"References   = "</span> &lt;&lt; ProcessEntry.cntUsage       &lt;&lt; <span class="org-string">"\n"</span>
         &lt;&lt; <span class="org-string">"Thread Count = "</span> &lt;&lt; ProcessEntry.cntThreads     &lt;&lt; <span class="org-string">"\n"</span>  
         &lt;&lt; <span class="org-string">"-----------------------------------------------\n"</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> Process32Next<span class="org-rainbow-delimiters-depth-3">(</span> hProcessSnapShot, &amp;ProcessEntry <span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Close handle releasing resource.</span>
  CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span> hProcessSnapShot <span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> 1;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<ul class="org-ul">
<li>Main function:</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Log file </span>
<span class="org-keyword">auto</span> <span class="org-variable-name">plog</span> = <span class="org-constant">std</span>::ofstream<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"process-log.txt"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Print all processes to stdout. </span>
showProcessInfo<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::cout<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Write all processes to file </span>
showProcessInfo<span class="org-rainbow-delimiters-depth-1">(</span>plog<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Flush buffer - force data to be written to file.</span>
plog.flush<span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"\n ==&gt; Type return to exit."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-function-name">std</span>::cin.get<span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-keyword">return</span> 0;
</pre>
</div>

<ul class="org-ul">
<li>Compiling and running:</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor"># Build</span> 
$ cl.exe showProcesses.cpp /EHsc /Zi /nologo /Fe:showProcesses.exe  

<span class="org-preprocessor"># Run</span>: 
$ showProcesses 
<span class="org-preprocessor"># Run</span> 
$ showProcesses.exe 
</pre>
</div>

<ul class="org-ul">
<li>Output:</li>
</ul>

<div class="org-src-container">
<pre class="src src-text">   $ showProcesses.exe
  ... ... ... ... 
-----------------------------------------------
EXE File     = Registry
PID          = 68
References   = 0
Thread Count = 3
-----------------------------------------------
EXE File     = smss.exe
PID          = 308
References   = 0
Thread Count = 2
-----------------------------------------------
EXE File     = csrss.exe
PID          = 412
References   = 0
Thread Count = 10
-----------------------------------------------
EXE File     = wininit.exe
PID          = 484
References   = 0
Thread Count = 1
-----------------------------------------------
  ... ... ... 
</pre>
</div>

<p>
API DOCS:
</p>
<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot">CreateToolhelp32Snapshot function | Microsoft Docs</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/tlhelp32/nf-tlhelp32-process32first">Process32First function | Microsoft Docs</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/tlhelp32/nf-tlhelp32-process32firstw">Process32FirstW function | Microsoft Docs</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgbee611b" class="outline-3">
<h3 id="orgbee611b"><span class="section-number-3">1.22</span> CODE - Show all DLLs or modules load by a process</h3>
<div class="outline-text-3" id="text-1-22">
<p>
This example program shows all modules, aka DLLs (Dynamic Linked
Libraries) loaded by some process given its PID.
</p>

<ul class="org-ul">
<li>Source:  <a href="src/windows/showModulesDLL.cpp">file:src/windows/showModulesDLL.cpp</a></li>
<li><p>
Gist:    <a href="https://gist.github.com/caiorss/300a734093430bb8a66cd204526edbf6">showModulesDLL.cpp</a>
</p>

<p>
<b>Files</b> 
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">//</span><span class="org-comment">- Windows Headers ---</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">psapi.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">RAAI for managing Handler </span>
<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">HANDLER</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">class</span> <span class="org-type">ResourceHandler</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
        <span class="org-keyword">using</span> <span class="org-type">Disposer</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">HANDLER</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>;
        <span class="org-function-name">ResourceHandler</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLER</span> <span class="org-variable-name">hnd</span>, <span class="org-type">Disposer</span> <span class="org-variable-name">disposer</span><span class="org-rainbow-delimiters-depth-2">)</span>
                : m_hnd<span class="org-rainbow-delimiters-depth-2">(</span>hnd<span class="org-rainbow-delimiters-depth-2">)</span>, m_fndisp<span class="org-rainbow-delimiters-depth-2">(</span>disposer<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-2">{</span>  <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-keyword">auto</span> <span class="org-function-name">get</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">HANDLER</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-keyword">return</span> m_hnd;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        ~<span class="org-function-name">ResourceHandler</span><span class="org-rainbow-delimiters-depth-2">(){</span>
                m_fndisp<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy-constructor and copy-assignment operator </span>
        <span class="org-function-name">ResourceHandler</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">ResourceHandler</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
        <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">ResourceHandler</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; ResourceHandler&amp; = <span class="org-keyword">delete</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Move member functios</span>
        <span class="org-function-name">ResourceHandler</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ResourceHandler</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span>
                : m_hnd<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_hnd<span class="org-rainbow-delimiters-depth-2">)</span>,
                  m_fndisp<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_fndisp<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ResourceHandler</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">this</span>-&gt;m_hnd, rhs.m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-keyword">this</span>-&gt;m_fndisp = rhs-&gt;m_fndisp;     
        <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-function-name">private</span>:
        <span class="org-type">HANDLER</span> <span class="org-variable-name">m_hnd</span>;
        <span class="org-type">Disposer</span> <span class="org-variable-name">m_fndisp</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">auto</span> <span class="org-function-name">utf8_encode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">wstring</span>&amp; <span class="org-variable-name">wstr</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;
<span class="org-keyword">auto</span> <span class="org-function-name">utf8_decode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp;  <span class="org-variable-name">str</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">wstring</span>;

<span class="org-keyword">namespace</span> <span class="org-constant">WProcess</span><span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-keyword">using</span> <span class="org-type">ModuleConsumer</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">auto</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">HMODULE</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp;<span class="org-rainbow-delimiters-depth-3">)</span> -&gt; <span class="org-type">void</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>;   
        <span class="org-keyword">auto</span> <span class="org-function-name">GetName</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;
        <span class="org-keyword">auto</span> <span class="org-function-name">GetExecutablePath</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;
        <span class="org-keyword">auto</span> <span class="org-function-name">ForEachModule</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span>, <span class="org-type">ModuleConsumer</span> <span class="org-variable-name">FunIterator</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span> **<span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">){</span>  
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: missing Process ID &lt;PID&gt;."</span>;
    <span class="org-keyword">return</span> EXIT_FAILURE;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">DWORD</span> <span class="org-variable-name">pid</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">flags</span> = PROCESS_QUERY_INFORMATION | PROCESS_VM_READ;

  <span class="org-keyword">try</span><span class="org-rainbow-delimiters-depth-2">{</span>
          pid  = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">invalid_argument</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-2">){</span>
          <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error invalid PID"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
          <span class="org-keyword">return</span> EXIT_FAILURE;
  <span class="org-rainbow-delimiters-depth-2">}</span>  

  <span class="org-keyword">auto</span> <span class="org-variable-name">hProc</span> = <span class="org-type">ResourceHandler</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">HANDLE</span><span class="org-rainbow-delimiters-depth-2">&gt;{</span>
          ::OpenProcess<span class="org-rainbow-delimiters-depth-3">(</span>flags, FALSE, pid<span class="org-rainbow-delimiters-depth-3">)</span>,
          ::CloseHandle
  <span class="org-rainbow-delimiters-depth-2">}</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hProc.get<span class="org-rainbow-delimiters-depth-3">()</span> == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">){</span>
          <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: process of pid = &lt;"</span> &lt;&lt; pid &lt;&lt; <span class="org-string">"&gt; not found."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
          <span class="org-keyword">return</span> EXIT_FAILURE;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Process base name = "</span>
                        &lt;&lt; <span class="org-constant">WProcess</span>::GetName<span class="org-rainbow-delimiters-depth-2">(</span>hProc.get<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>
                        &lt;&lt; <span class="org-constant">std</span>::endl; 
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Process path      = "</span>
                        &lt;&lt; <span class="org-constant">WProcess</span>::GetExecutablePath<span class="org-rainbow-delimiters-depth-2">(</span>hProc.get<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>
                        &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Print all DLLs used by some process </span>
  <span class="org-constant">WProcess</span>::ForEachModule<span class="org-rainbow-delimiters-depth-2">(</span>
          hProc.get<span class="org-rainbow-delimiters-depth-3">()</span>,
          <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-type">HMODULE</span> <span class="org-variable-name">hmod</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-3">)</span> -&gt; <span class="org-type">void</span>
          <span class="org-rainbow-delimiters-depth-3">{</span>
                  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>10<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; hmod
                                        &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>5<span class="org-rainbow-delimiters-depth-4">)</span>  &lt;&lt; <span class="org-string">" "</span>
                                        &lt;&lt; <span class="org-constant">std</span>::left     &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>45<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; path
                                        &lt;&lt; <span class="org-string">"\n"</span>;                    
          <span class="org-rainbow-delimiters-depth-3">}</span>
          <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">================= End of Main =================//</span>

<span class="org-keyword">auto</span> <span class="org-function-name">utf8_encode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">wstring</span> &amp;<span class="org-variable-name">wstr</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">size_needed</span> = WideCharToMultiByte<span class="org-rainbow-delimiters-depth-2">(</span>
            CP_UTF8, 0, &amp;wstr<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>,
            <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span>wstr.size<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-constant">NULL</span>, 0, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">strTo</span><span class="org-rainbow-delimiters-depth-2">(</span>size_needed, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    WideCharToMultiByte<span class="org-rainbow-delimiters-depth-2">(</span>
            CP_UTF8, 0, &amp;wstr<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>,
            <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span>wstr.size<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;strTo<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, size_needed, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> strTo;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-function-name">utf8_decode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> &amp;<span class="org-variable-name">str</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">wstring</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">int</span> <span class="org-variable-name">size_needed</span> = MultiByteToWideChar<span class="org-rainbow-delimiters-depth-2">(</span>
             CP_UTF8, 0,
             &amp;str<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span>str.size<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-constant">NULL</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">wstrTo</span><span class="org-rainbow-delimiters-depth-2">(</span>size_needed, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     MultiByteToWideChar<span class="org-rainbow-delimiters-depth-2">(</span>
             CP_UTF8, 0, &amp;str<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>,
             <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span> str.size<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;wstrTo<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, size_needed<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> wstrTo;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-keyword">namespace</span> <span class="org-constant">WProcess</span><span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-keyword">using</span> <span class="org-type">ModuleConsumer</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">auto</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">HMODULE</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp;<span class="org-rainbow-delimiters-depth-3">)</span> -&gt; <span class="org-type">void</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>;

        <span class="org-keyword">auto</span> <span class="org-function-name">GetName</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">basename</span><span class="org-rainbow-delimiters-depth-3">(</span>MAX_PATH, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-type">int</span> <span class="org-variable-name">n1</span> = ::GetModuleBaseNameW<span class="org-rainbow-delimiters-depth-3">(</span>hProc, <span class="org-constant">NULL</span>, &amp;basename<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>, MAX_PATH<span class="org-rainbow-delimiters-depth-3">)</span>;
                basename.resize<span class="org-rainbow-delimiters-depth-3">(</span>n1<span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-keyword">return</span> utf8_encode<span class="org-rainbow-delimiters-depth-3">(</span>basename<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-keyword">auto</span> <span class="org-function-name">GetExecutablePath</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-3">(</span>MAX_PATH, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-type">int</span> <span class="org-variable-name">n2</span> = ::GetModuleFileNameExW<span class="org-rainbow-delimiters-depth-3">(</span>hProc, <span class="org-constant">NULL</span>, &amp;path<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>, MAX_PATH<span class="org-rainbow-delimiters-depth-3">)</span>;
                path.resize<span class="org-rainbow-delimiters-depth-3">(</span>n2<span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-keyword">return</span> utf8_encode<span class="org-rainbow-delimiters-depth-3">(</span>path<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-keyword">auto</span> <span class="org-function-name">ForEachModule</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span>, <span class="org-type">ModuleConsumer</span> <span class="org-variable-name">FunIterator</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-type">HMODULE</span> <span class="org-variable-name">hMods</span><span class="org-rainbow-delimiters-depth-3">[</span>1024<span class="org-rainbow-delimiters-depth-3">]</span>;
                <span class="org-type">DWORD</span>   <span class="org-variable-name">cbNeeded</span>;
                <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>::EnumProcessModules<span class="org-rainbow-delimiters-depth-4">(</span>hProc, hMods, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-5">(</span>hMods<span class="org-rainbow-delimiters-depth-5">)</span>, &amp;cbNeeded<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">){</span>
                        <span class="org-type">int</span> <span class="org-variable-name">n</span> = cbNeeded / <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>HMODULE<span class="org-rainbow-delimiters-depth-4">)</span>;
                        <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-4">(</span>MAX_PATH, 0<span class="org-rainbow-delimiters-depth-4">)</span>;
                        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; n; i++<span class="org-rainbow-delimiters-depth-4">){</span>
                                <span class="org-type">DWORD</span> <span class="org-variable-name">nread</span> = ::GetModuleFileNameExW<span class="org-rainbow-delimiters-depth-5">(</span>hProc, hMods<span class="org-rainbow-delimiters-depth-6">[</span>i<span class="org-rainbow-delimiters-depth-6">]</span>, &amp;path<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span>, MAX_PATH<span class="org-rainbow-delimiters-depth-5">)</span>;
                                path.resize<span class="org-rainbow-delimiters-depth-5">(</span>nread<span class="org-rainbow-delimiters-depth-5">)</span>;     
                                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span>nread<span class="org-rainbow-delimiters-depth-5">)</span> FunIterator<span class="org-rainbow-delimiters-depth-5">(</span>hMods<span class="org-rainbow-delimiters-depth-6">[</span>i<span class="org-rainbow-delimiters-depth-6">]</span>, utf8_encode<span class="org-rainbow-delimiters-depth-6">(</span>path<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                        <span class="org-rainbow-delimiters-depth-4">}</span>
                <span class="org-rainbow-delimiters-depth-3">}</span>   
        <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of namespace WProcess ---- //</span>
</pre>
</div>

<p>
<b>Building</b> 
</p>

<p>
Compile with MSVC (cl.exe)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe showModulesDLL.cpp /EHsc /Zi /nologo /Fe:showModulesDLL.exe 
</pre>
</div>

<p>
Compile with MingW/GCC:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ showModulesDLL.cpp -o <span class="org-keyword">showModulesDLL.exe</span> -std=c++14 -lpsapi 
</pre>
</div>

<p>
Running: 
</p>

<ul class="org-ul">
<li>List PID of all processes</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Get PID of all processes </span>
$ tasklist 
  ... ... ... ... ... ... ... ... ... ... ... ... 
svchost.exe                     88 Services                   0      5,920 K
dllhost.exe                   4572 Console                    1      9,520 K
notepad.exe                   5272 Console                    1     14,048 K
vctip.exe                     3564 Console                    1     10,920 K
svchost.exe                   1112 Services                   0      5,572 K
svchost.exe                   2996 Services                   0      7,140 K
SearchProtocolHost.exe        5636 Services                   0     11,964 K
SearchFilterHost.exe          1832 Services                   0      6,104 K
mspdbsrv.exe                  3416 Console                    1      5,888 K
... ... ... ... ... ... ... ... ... ... ... ... ... ... 
</pre>
</div>

<ul class="org-ul">
<li>Show DLLs loaded by process dllhost.exe  (PID 4572)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ showModulesDLL.exe 4572
Process base name = DllHost.exe
Process path      = C:\Windows\System32\dllhost.exe

00007FF734720000     C:\WINDOWS\system32\DllHost.exe
00007FFBFA8C0000     C:\WINDOWS\SYSTEM32\ntdll.dll
00007FFBF98C0000     C:\WINDOWS\System32\KERNEL32.
00007FFBF78C0000     C:\WINDOWS\System32\KERNELBASE.d
00007FFBF6C90000     C:\WINDOWS\System32\ucrtbase.dll
00007FFBF7EE0000     C:\WINDOWS\System32\combase.dll
... ... ... ...   ... ... ... ...   ... ... ... ... 
00007FFBEDBA0000     C:\WINDOWS\SYSTEM32\iertutil.
00007FFBF65C0000     C:\WINDOWS\SYSTEM32\CRYPTBASE.DL

</pre>
</div>

<p>
Parts: 
</p>

<ul class="org-ul">
<li>Class ResourceHandler&lt;HANDLER&gt; is a RAII (Resource Aquisition Is
Initialization) for any generic resource which may not be a
pointer such as an integer for a file descriptor.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">HANDLER</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">class</span> <span class="org-type">ResourceHandler</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-keyword">using</span> <span class="org-type">Disposer</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">HANDLER</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>;
    <span class="org-function-name">ResourceHandler</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLER</span> <span class="org-variable-name">hnd</span>, <span class="org-type">Disposer</span> <span class="org-variable-name">disposer</span><span class="org-rainbow-delimiters-depth-2">)</span>
       : m_hnd<span class="org-rainbow-delimiters-depth-2">(</span>hnd<span class="org-rainbow-delimiters-depth-2">)</span>, m_fndisp<span class="org-rainbow-delimiters-depth-2">(</span>disposer<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>  <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">get</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">HANDLER</span> <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">return</span> m_hnd;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    ~<span class="org-function-name">ResourceHandler</span><span class="org-rainbow-delimiters-depth-2">(){</span>
       m_fndisp<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy-constructor and copy-assignment operator </span>
    <span class="org-function-name">ResourceHandler</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">ResourceHandler</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
    <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">ResourceHandler</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; ResourceHandler&amp; = <span class="org-keyword">delete</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Move member functios</span>
    <span class="org-function-name">ResourceHandler</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ResourceHandler</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span>
     : m_hnd<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_hnd<span class="org-rainbow-delimiters-depth-2">)</span>,
       m_fndisp<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_fndisp<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ResourceHandler</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">this</span>-&gt;m_hnd, rhs.m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">this</span>-&gt;m_fndisp = rhs-&gt;m_fndisp;     
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-function-name">private</span>:
    <span class="org-type">HANDLER</span> <span class="org-variable-name">m_hnd</span>;
    <span class="org-type">Disposer</span> <span class="org-variable-name">m_fndisp</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Namespace WProcess contains functions for querying processes:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">namespace</span> <span class="org-constant">WProcess</span><span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">using</span> <span class="org-type">ModuleConsumer</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">auto</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">HMODULE</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp;<span class="org-rainbow-delimiters-depth-3">)</span> -&gt; <span class="org-type">void</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>;  
     <span class="org-keyword">auto</span> <span class="org-function-name">GetName</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;
     <span class="org-keyword">auto</span> <span class="org-function-name">GetExecutablePath</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;
     <span class="org-keyword">auto</span> <span class="org-function-name">ForEachModule</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span>, <span class="org-type">ModuleConsumer</span> <span class="org-variable-name">FunIterator</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Main function</b>
</p>

<ul class="org-ul">
<li>Get PID (Process ID) as program argument.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">DWORD</span> <span class="org-variable-name">pid</span>;
<span class="org-type">DWORD</span>  <span class="org-variable-name">flags</span> = PROCESS_QUERY_INFORMATION | PROCESS_VM_READ;

<span class="org-keyword">try</span><span class="org-rainbow-delimiters-depth-1">{</span>
    pid  = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">invalid_argument</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error invalid PID"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-keyword">return</span> EXIT_FAILURE;
<span class="org-rainbow-delimiters-depth-1">}</span>  

<span class="org-comment-delimiter">// </span><span class="org-comment">Automatically closes this handle when it goes out of scope.</span>
<span class="org-keyword">auto</span> <span class="org-variable-name">hProc</span> = <span class="org-type">ResourceHandler</span><span class="org-rainbow-delimiters-depth-1">&lt;</span>HANDLE<span class="org-rainbow-delimiters-depth-1">&gt;{</span>
    ::OpenProcess<span class="org-rainbow-delimiters-depth-2">(</span>flags, FALSE, pid<span class="org-rainbow-delimiters-depth-2">)</span>,
    ::CloseHandle
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Print process name: 
</p>

<div class="org-src-container">
<pre class="src src-cpp">
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"Process base name = "</span>
          &lt;&lt; <span class="org-constant">WProcess</span>::GetName<span class="org-rainbow-delimiters-depth-1">(</span>hProc.get<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
          &lt;&lt; <span class="org-constant">std</span>::endl; 
</pre>
</div>

<p>
Print path to executable: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"Process path      = "</span>
          &lt;&lt; <span class="org-constant">WProcess</span>::GetExecutablePath<span class="org-rainbow-delimiters-depth-1">(</span>hProc.get<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
          &lt;&lt; <span class="org-constant">std</span>::endl;
</pre>
</div>

<p>
Print all DLLs used by the process:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">using</span> <span class="org-type">ModuleConsumer</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">auto</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-variable-name">HMODULE</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>;  

<span class="org-comment-delimiter">// </span><span class="org-comment">Print all DLLs used by some process </span>
<span class="org-function-name">WProcess</span>::ForEachModule<span class="org-rainbow-delimiters-depth-1">(</span>
    hProc.get<span class="org-rainbow-delimiters-depth-2">()</span>,
    <span class="org-rainbow-delimiters-depth-2">[](</span><span class="org-type">HMODULE</span> <span class="org-variable-name">hmod</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-3">(</span>10<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; hmod
                     &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-3">(</span>5<span class="org-rainbow-delimiters-depth-3">)</span>  &lt;&lt; <span class="org-string">" "</span>
                     &lt;&lt; <span class="org-constant">std</span>::left     &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-3">(</span>45<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; path
                     &lt;&lt; <span class="org-string">"\n"</span>;                   
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Functions in namespace WProcess</b>
</p>

<ul class="org-ul">
<li>WProcess::GetName</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">auto</span> <span class="org-function-name">GetName</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">basename</span><span class="org-rainbow-delimiters-depth-2">(</span>MAX_PATH, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-type">int</span> <span class="org-variable-name">n1</span> = ::GetModuleBaseNameW<span class="org-rainbow-delimiters-depth-2">(</span>hProc, <span class="org-constant">NULL</span>, &amp;basename<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, MAX_PATH<span class="org-rainbow-delimiters-depth-2">)</span>;
      basename.resize<span class="org-rainbow-delimiters-depth-2">(</span>n1<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-keyword">return</span> utf8_encode<span class="org-rainbow-delimiters-depth-2">(</span>basename<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li>WProcess::GetExecutablePath</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">auto</span> <span class="org-function-name">GetExecutablePath</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-2">(</span>MAX_PATH, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-type">int</span> <span class="org-variable-name">n2</span> = ::GetModuleFileNameExW<span class="org-rainbow-delimiters-depth-2">(</span>hProc, <span class="org-constant">NULL</span>, &amp;path<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, MAX_PATH<span class="org-rainbow-delimiters-depth-2">)</span>;
     path.resize<span class="org-rainbow-delimiters-depth-2">(</span>n2<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> utf8_encode<span class="org-rainbow-delimiters-depth-2">(</span>path<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li>WProcess::ForEachModule</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">auto</span> <span class="org-function-name">ForEachModule</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hProc</span>, <span class="org-type">ModuleConsumer</span> <span class="org-variable-name">FunIterator</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">HMODULE</span> <span class="org-variable-name">hMods</span><span class="org-rainbow-delimiters-depth-2">[</span>1024<span class="org-rainbow-delimiters-depth-2">]</span>;
     <span class="org-type">DWORD</span>   <span class="org-variable-name">cbNeeded</span>;
     <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>::EnumProcessModules<span class="org-rainbow-delimiters-depth-3">(</span>hProc, hMods, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>hMods<span class="org-rainbow-delimiters-depth-4">)</span>, &amp;cbNeeded<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">){</span>
            <span class="org-type">int</span> <span class="org-variable-name">n</span> = cbNeeded / <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>HMODULE<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-3">(</span>MAX_PATH, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; n; i++<span class="org-rainbow-delimiters-depth-3">){</span>
                <span class="org-type">DWORD</span> <span class="org-variable-name">nread</span> = ::GetModuleFileNameExW<span class="org-rainbow-delimiters-depth-4">(</span>hProc, hMods<span class="org-rainbow-delimiters-depth-5">[</span>i<span class="org-rainbow-delimiters-depth-5">]</span>, &amp;path<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>, MAX_PATH<span class="org-rainbow-delimiters-depth-4">)</span>;
                path.resize<span class="org-rainbow-delimiters-depth-4">(</span>nread<span class="org-rainbow-delimiters-depth-4">)</span>;     
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>nread<span class="org-rainbow-delimiters-depth-4">)</span> FunIterator<span class="org-rainbow-delimiters-depth-4">(</span>hMods<span class="org-rainbow-delimiters-depth-5">[</span>i<span class="org-rainbow-delimiters-depth-5">]</span>, utf8_encode<span class="org-rainbow-delimiters-depth-5">(</span>path<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-rainbow-delimiters-depth-3">}</span>
     <span class="org-rainbow-delimiters-depth-2">}</span>  
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org13b6906" class="outline-3">
<h3 id="org13b6906"><span class="section-number-3">1.23</span> CODE - Show files and directories attributes&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cmake">cmake</span>&#xa0;<span class="build">build</span>&#xa0;<span class="demo">demo</span>&#xa0;<span class="code">code</span></span></h3>
<div class="outline-text-3" id="text-1-23">
<p>
Gist: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/bad57134dd6e95e394a04b8b727a825f">https://gist.github.com/bad57134dd6e95e394a04b8b727a825f</a></li>
</ul>

<p>
File: <span class="underline">attrib.cpp</span>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#define</span> <span class="org-function-name">disp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-constant">std</span>::boolalpha &lt;&lt; __FILE__ &lt;&lt; <span class="org-string">":"</span> &lt;&lt; __LINE__ &lt;&lt; <span class="org-string">":"</span> \
                                                         &lt;&lt; <span class="org-string">" ; "</span> &lt;&lt; #expr &lt;&lt; <span class="org-string">" = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-1">(</span>expr<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-constant">std</span>::endl

<span class="org-type">void</span> <span class="org-function-name">showFileAttributes</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">DWORD</span> <span class="org-variable-name">attr</span> = GetFileAttributesA<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     disp<span class="org-rainbow-delimiters-depth-2">(</span>attr<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-type">bool</span> <span class="org-variable-name">isInvalid</span> = attr == INVALID_FILE_ATTRIBUTES;
     <span class="org-type">bool</span> <span class="org-variable-name">exists</span> = <span class="org-negation-char">!</span>isInvalid;
     <span class="org-type">bool</span> <span class="org-variable-name">isDirectory</span> = exists &amp;&amp; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>attr &amp; FILE_ATTRIBUTE_DIRECTORY<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-type">bool</span> <span class="org-variable-name">isFile</span> = exists &amp;&amp; <span class="org-negation-char">!</span><span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>attr &amp; FILE_ATTRIBUTE_DIRECTORY<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"File attributes for path = "</span> &lt;&lt; path &lt;&lt; <span class="org-constant">std</span>::endl;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha
               &lt;&lt; <span class="org-string">"Is invalid file attribute = "</span> &lt;&lt; isInvalid &lt;&lt; <span class="org-constant">std</span>::endl
               &lt;&lt; <span class="org-string">"File exists               = "</span> &lt;&lt; exists &lt;&lt; <span class="org-constant">std</span>::endl
               &lt;&lt; <span class="org-string">"Is directory              = "</span> &lt;&lt; isDirectory &lt;&lt; <span class="org-constant">std</span>::endl
               &lt;&lt; <span class="org-string">"Is file                   = "</span> &lt;&lt; isFile &lt;&lt; <span class="org-constant">std</span>::endl;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"--------------------------------"</span> &lt;&lt; <span class="org-constant">std</span>::endl
               &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">bool</span> <span class="org-function-name">fileExists</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-type">DWORD</span> <span class="org-variable-name">attr</span> = GetFileAttributesA<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">return</span> <span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span>attr == INVALID_FILE_ATTRIBUTES<span class="org-rainbow-delimiters-depth-2">)</span> &amp;&amp; <span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span>attr &amp; FILE_ATTRIBUTE_DIRECTORY<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">bool</span> <span class="org-function-name">dirExists</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">attr</span> = GetFileAttributesA<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> <span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span>attr == INVALID_FILE_ATTRIBUTES<span class="org-rainbow-delimiters-depth-2">)</span> &amp;&amp; <span class="org-rainbow-delimiters-depth-2">(</span>attr &amp; FILE_ATTRIBUTE_DIRECTORY<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Get Path to current program / Application </span>
<span class="org-function-name">std</span>::string pathToThisProgram<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">result</span><span class="org-rainbow-delimiters-depth-2">(</span>MAX_PATH, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">int</span> <span class="org-variable-name">n</span> = GetModuleFileNameA<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span>, &amp;result<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, MAX_PATH<span class="org-rainbow-delimiters-depth-2">)</span>;
    result.resize<span class="org-rainbow-delimiters-depth-2">(</span>n<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> result;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">std</span>::string getEnvironment<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">varname</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-variable-name">size</span> = 32767;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">result</span><span class="org-rainbow-delimiters-depth-2">(</span>size, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">n</span> = GetEnvironmentVariableA<span class="org-rainbow-delimiters-depth-2">(</span>varname.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;result<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, size<span class="org-rainbow-delimiters-depth-2">)</span>;
    result.resize<span class="org-rainbow-delimiters-depth-2">(</span>n<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> result;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Path to this program = "</span>
              &lt;&lt; pathToThisProgram<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Evironment variable =&gt; %USERPROFILE% = "</span>
              &lt;&lt; getEnvironment<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERPROFILE"</span><span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Evironment variable =&gt; %SYSTEMROOT% = "</span>
              &lt;&lt; getEnvironment<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"SYSTEMROOT"</span><span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Evironment variable =&gt; %WRONGVAR% = "</span>
              &lt;&lt; getEnvironment<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"WRONGVAR"</span><span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;

    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">thisprog</span> = pathToThisProgram<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">dest</span> = getEnvironment<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERPROFILE"</span><span class="org-rainbow-delimiters-depth-2">)</span> + <span class="org-string">"\\Desktop\\app.exe"</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Copy file to Desktop</span>
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>fileExists<span class="org-rainbow-delimiters-depth-3">(</span>dest<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ==&gt; File "</span> &lt;&lt; dest &lt;&lt; <span class="org-string">" exists - removing it ... "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        DeleteFileA<span class="org-rainbow-delimiters-depth-3">(</span>dest.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span> <span class="org-variable-name">result</span> = CopyFileA<span class="org-rainbow-delimiters-depth-2">(</span>thisprog.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, dest.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, TRUE<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Copy successful? = "</span> &lt;&lt; <span class="org-constant">std</span>::boolalpha &lt;&lt; result &lt;&lt; <span class="org-constant">std</span>::endl;

    <span class="org-comment-delimiter">//</span><span class="org-comment">Delete this executable</span>
    <span class="org-type">bool</span> <span class="org-variable-name">result2</span> = DeleteFileA<span class="org-rainbow-delimiters-depth-2">(</span>thisprog.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Delete successful? = "</span> &lt;&lt; <span class="org-constant">std</span>::boolalpha &lt;&lt; result2 &lt;&lt; <span class="org-constant">std</span>::endl;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"-------------------------------"</span> &lt;&lt; <span class="org-constant">std</span>::endl;

    showFileAttributes<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"C:\\Windows\\System32"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    showFileAttributes<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"C:/Windows/System32"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    showFileAttributes<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"C:\\Windows\\System32\\cmd.exe"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    showFileAttributes<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"C:\\Windows\\System32DONOT_EXISTS"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    disp<span class="org-rainbow-delimiters-depth-2">(</span>fileExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\Windows\\System32"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    disp<span class="org-rainbow-delimiters-depth-2">(</span>fileExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:/Windows/System32"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Windows file system is case insensitive!</span>
    disp<span class="org-rainbow-delimiters-depth-2">(</span>fileExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\Windows\\System32\\cmd.exe"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    disp<span class="org-rainbow-delimiters-depth-2">(</span>fileExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\Windows\\System32\\CMD.EXE"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    disp<span class="org-rainbow-delimiters-depth-2">(</span>fileExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\Windows\\System32\\kernel32.dll"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    disp<span class="org-rainbow-delimiters-depth-2">(</span>fileExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\Windows\\System32DONOT_EXISTS"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::endl;

    disp<span class="org-rainbow-delimiters-depth-2">(</span>dirExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\Windows\\System32"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    disp<span class="org-rainbow-delimiters-depth-2">(</span>dirExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:/Windows/System32"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    disp<span class="org-rainbow-delimiters-depth-2">(</span>dirExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\Windows\\System32\\cmd.exe"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    disp<span class="org-rainbow-delimiters-depth-2">(</span>dirExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\Windows\\System32\\CMD.EXE"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    disp<span class="org-rainbow-delimiters-depth-2">(</span>dirExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\Windows\\System32\\kernel32.dll"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    disp<span class="org-rainbow-delimiters-depth-2">(</span>dirExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\Windows\\System32DONOT_EXISTS"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    disp<span class="org-rainbow-delimiters-depth-2">(</span>dirExists<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\$Recycle.bin"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(WindowsExploration)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>
<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment">#========== Targets Configurations ============#</span>
<span class="org-function-name">add_executable</span>(attrib attrib.cpp)
</pre>
</div>

<p>
Download sources: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/bad57134dd6e95e394a04b8b727a825f attrib
$ cd attrib

$ ls
CMakeLists.txt  Makefile  attrib.cpp  build_msvc.bat
</pre>
</div>

<p>
Building manually with MINGW (GCC ported to Windows): 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ attrib.cpp -o <span class="org-keyword">attrib.exe</span> -std=c++1z -ggdb -Wall -Wextra
$ g++ attrib.cpp -o <span class="org-keyword">attrib.scr</span> -std=c++1z -ggdb -Wall -Wextra

$ file attrib.exe
<span class="org-function-name">attrib.exe</span>: PE32+ executable (console) x86-64, for MS Windows
</pre>
</div>

<p>
Building manually with MSVC-2019 (cl.exe) via developer command prompt
at start menu. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe attrib.cpp /out:attrib.exe /ZI /std:c++latest
</pre>
</div>

<p>
Building via CMake and Visual Studio Code Vscode: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Open the directory with source files in Vscode, Select the toolchain (called KIT)</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">,then build the application. </span>
$ cd attrib 
$ vscode . 
</pre>
</div>

<p>
Building with CMake and "Visual" Studio Compiler (MSVC-15) from command
line: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug -G <span class="org-string">"Visual Studio 14 2015 Win64"</span>
$ cmake --build _build --target all

<span class="org-comment-delimiter"># </span><span class="org-comment">Command file comes from GIT installation that provides some Linux/UNIX tools</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">for Windows. </span>
$ file _build/Debug/atrib.exe
<span class="org-function-name">_build/Debug/atrib.exe</span>: PE32+ executable (console) x86-64, for MS Windows
</pre>
</div>

<p>
Building with CMake and MSVC 2019 (Only works if this compiler is
already installed.)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake -B_build -H. -DCMAKE_BUILD_TYPE=Debug
$ cmake --build _build --target all
</pre>
</div>

<p>
Building with CMake and Mingw: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake -H. -B_build_mingw -G <span class="org-string">"MinGW Makefiles"</span> -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=TRUE
$ cmake --build _build_mingw --target

$ dir _build_mingw/
CMakeCache.txt  CMakeFiles  Makefile  cmake_install.cmake  compile_commands.json
</pre>
</div>

<p>
Program output: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build\Debug\attrib.exe

Path to this program = Z:\windows-experiments\build\attrib.exe
Evironment variable =&gt; %USERPROFILE% = C:\Users\myuser 
Evironment variable =&gt; %SYSTEMROOT% = C:\Windows
Evironment variable =&gt; %WRONGVAR% =
 ==&gt; File C:\Users\myuser\Desktop\app.exe exists - removing it ...
Copy successful? = true
Delete successful? = false
-------------------------------
..\application1.cpp:11: ; attr = 16
File attributes for path = C:\Windows\System32
Is invalid file attribute = false
File exists               = true
Is directory              = true
Is file                   = false
--------------------------------

..\application1.cpp:11: ; attr = 16
File attributes for path = C:/Windows/System32
Is invalid file attribute = false
File exists               = true
Is directory              = true
Is file                   = false
--------------------------------

..\application1.cpp:11: ; attr = 32
File attributes for path = C:\Windows\System32\cmd.exe
Is invalid file attribute = false
File exists               = true
Is directory              = false
Is file                   = true
--------------------------------

..\application1.cpp:11: ; attr = 4294967295
File attributes for path = C:\Windows\System32DONOT_EXISTS
Is invalid file attribute = true
File exists               = false
Is directory              = false
Is file                   = false
--------------------------------

..\application1.cpp:90: ; fileExists(<span class="org-string">"C:\\Windows\\System32"</span>) = false
..\application1.cpp:91: ; fileExists(<span class="org-string">"C:/Windows/System32"</span>) = false
..\application1.cpp:93: ; fileExists(<span class="org-string">"C:\\Windows\\System32\\cmd.exe"</span>) = true
..\application1.cpp:94: ; fileExists(<span class="org-string">"C:\\Windows\\System32\\CMD.EXE"</span>) = true
..\application1.cpp:95: ; fileExists(<span class="org-string">"C:\\Windows\\System32\\kernel32.dll"</span>) = true
..\application1.cpp:96: ; fileExists(<span class="org-string">"C:\\Windows\\System32DONOT_EXISTS"</span>) = false

..\application1.cpp:100: ; dirExists(<span class="org-string">"C:\\Windows\\System32"</span>) = true
..\application1.cpp:101: ; dirExists(<span class="org-string">"C:/Windows/System32"</span>) = true
..\application1.cpp:102: ; dirExists(<span class="org-string">"C:\\Windows\\System32\\cmd.exe"</span>) = false
..\application1.cpp:103: ; dirExists(<span class="org-string">"C:\\Windows\\System32\\CMD.EXE"</span>) = false
..\application1.cpp:104: ; dirExists(<span class="org-string">"C:\\Windows\\System32\\kernel32.dll"</span>) = false
..\application1.cpp:105: ; dirExists(<span class="org-string">"C:\\Windows\\System32DONOT_EXISTS"</span>) = false
..\application1.cpp:106: ; dirExists(<span class="org-string">"C:\\$Recycle.bin"</span>) = true
</pre>
</div>
</div>
</div>
<div id="outline-container-orge83cfbc" class="outline-3">
<h3 id="orge83cfbc"><span class="section-number-3">1.24</span> CODE - List directory files</h3>
<div class="outline-text-3" id="text-1-24">
<p>
Program for listing directories, similar to U*nix's ls or Windows' dir
usign Win32 API.
</p>

<p>
Source:
</p>
<ul class="org-ul">
<li>File: <a href="src/windows/listFiles.cpp">file:src/windows/listFiles.cpp</a></li>
<li>Gist: <a href="https://gist.github.com/caiorss/17e9f2d79566b58b1ba65820c26bc1aa">listFiles.cpp</a></li>
</ul>

<p>
<b>Files</b> 
</p>

<p>
File: <span class="underline">listFiles.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">//</span><span class="org-comment">- Windows Headers ---</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">//</span><span class="org-comment">----------------------------------------------//</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Uses RAII for setting console to UTF8</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">and restoring its previous settings.</span>
<span class="org-keyword">class</span> <span class="org-type">ConsoleUTF8</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
   <span class="org-comment-delimiter">// </span><span class="org-comment">Constructor saves context </span>
   <span class="org-function-name">ConsoleUTF8</span><span class="org-rainbow-delimiters-depth-2">(){</span>
       m_config = ::GetConsoleOutputCP<span class="org-rainbow-delimiters-depth-3">()</span>;
       ::SetConsoleOutputCP<span class="org-rainbow-delimiters-depth-3">(</span>CP_UTF8<span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [TRACE] Console set to UTF8"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
   <span class="org-rainbow-delimiters-depth-2">}</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Destructor restores context </span>
   ~<span class="org-function-name">ConsoleUTF8</span><span class="org-rainbow-delimiters-depth-2">(){</span>
           <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [TRACE] Console restored."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
      ::SetConsoleOutputCP<span class="org-rainbow-delimiters-depth-3">(</span>m_config<span class="org-rainbow-delimiters-depth-3">)</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-function-name">private</span>:
   <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">m_config</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">CloseHandleRAAI</span><span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-keyword">using</span> <span class="org-type">Disposer</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>;
        <span class="org-type">Disposer</span> <span class="org-variable-name">m_dispose</span>;
        <span class="org-function-name">CloseHandleRAAI</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">Disposer</span> <span class="org-variable-name">dispose</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">m_dispose</span><span class="org-rainbow-delimiters-depth-2">(</span>dispose<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>
        ~<span class="org-function-name">CloseHandleRAAI</span><span class="org-rainbow-delimiters-depth-2">(){</span> m_dispose<span class="org-rainbow-delimiters-depth-3">()</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">void</span> <span class="org-function-name">CloseHandleLog</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">h</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">){</span>
        ::CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>h<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [LOG] Handler &lt;"</span> &lt;&lt; name &lt;&lt; <span class="org-string">"&gt; closed OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl; 
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-function-name">utf8_encode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">wstring</span> &amp;<span class="org-variable-name">wstr</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;
<span class="org-keyword">auto</span> <span class="org-function-name">utf8_decode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> &amp;<span class="org-variable-name">str</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">wstring</span>;

<span class="org-keyword">using</span> <span class="org-type">FileEnumerator</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>;

<span class="org-keyword">auto</span> <span class="org-function-name">getLastErrorAsString</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;
<span class="org-keyword">auto</span> <span class="org-function-name">EnumerateFiles</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span>, <span class="org-type">FileEnumerator</span> <span class="org-variable-name">Enumerator</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">int</span>;


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Usage: "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" "</span> &lt;&lt; <span class="org-string">"[PATH]"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-keyword">return</span> EXIT_FAILURE;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">utf8Console</span> = ConsoleUTF8<span class="org-rainbow-delimiters-depth-2">()</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">directoryPath</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">}</span>;

        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"directoryPath = "</span> &lt;&lt; directoryPath &lt;&lt; <span class="org-string">"\n"</span>;

        <span class="org-type">int</span> <span class="org-variable-name">count</span> = 0;  
        <span class="org-comment-delimiter">// </span><span class="org-comment">Show 50 first files. </span>
        <span class="org-type">int</span> <span class="org-variable-name">status</span> = EnumerateFiles<span class="org-rainbow-delimiters-depth-2">(</span>
                directoryPath,
                <span class="org-rainbow-delimiters-depth-3">[</span>&amp;<span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-3">){</span>
                        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; "</span> &lt;&lt; file &lt;&lt; <span class="org-string">"\n"</span>;
                        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>count++ &lt; 50<span class="org-rainbow-delimiters-depth-4">)</span>
                                <span class="org-keyword">return</span> <span class="org-constant">true</span>;
                        <span class="org-keyword">else</span>
                                <span class="org-keyword">return</span> <span class="org-constant">false</span>;
                <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>status != ERROR_SUCCESS<span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; Error code    = "</span> &lt;&lt; ::GetLastError<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; Error message = "</span> &lt;&lt; getLastErrorAsString<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-keyword">return</span> EXIT_FAILURE;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [LOG] End sucessfully"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">FindClose(hFile);</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">CloseHandle(hFind);</span>
        <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------------//</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Enumerate files of some directory util enumerator function (callback) returns false. </span>
<span class="org-comment">  * - path       - Directory path to be listed </span>
<span class="org-comment">  * - Enumerator - Functions which consumes a string (file listed) and returns bool.</span>
<span class="org-comment">  *                this function returns false when it is no longer interested in </span>
<span class="org-comment">  *                being called. When it returns false the iteration stops. </span>
<span class="org-comment">  *</span>
<span class="org-comment">  * - Return    - Returns error code from GetLastError(). If it is successful, </span>
<span class="org-comment">  *               the function returns ERROR_SUCCESS.</span>
<span class="org-comment">  */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">EnumerateFiles</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span>, <span class="org-type">FileEnumerator</span> <span class="org-variable-name">Enumerator</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-type">WIN32_FIND_DATAW</span> <span class="org-variable-name">fdata</span>;
        <span class="org-type">HANDLE</span> <span class="org-variable-name">hFind</span> = INVALID_HANDLE_VALUE;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Ensure that resource hFind is always disposed. </span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">close_hFind</span> = CloseHandleRAAI<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::bind<span class="org-rainbow-delimiters-depth-3">(</span>CloseHandleLog, hFind, <span class="org-string">"hFile"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        hFind = FindFirstFileW<span class="org-rainbow-delimiters-depth-2">(</span>utf8_decode<span class="org-rainbow-delimiters-depth-3">(</span>path<span class="org-rainbow-delimiters-depth-3">)</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;fdata<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hFind == INVALID_HANDLE_VALUE<span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-keyword">return</span> GetLastError<span class="org-rainbow-delimiters-depth-2">()</span>;
        <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-comment-delimiter">//</span><span class="org-comment">Consumer function </span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span>Enumerator<span class="org-rainbow-delimiters-depth-4">(</span>utf8_encode<span class="org-rainbow-delimiters-depth-5">(</span>fdata.cFileName<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">break</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>FindNextFileW<span class="org-rainbow-delimiters-depth-3">(</span>hFind, &amp;fdata<span class="org-rainbow-delimiters-depth-3">)</span> != 0<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">return</span> ERROR_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Print human-readable description of GetLastError() - Error Code </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Source: https://stackoverflow.com/questions/1387064</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Requires: &lt;string&gt;, &lt;sstream&gt;, &lt;windows.h&gt;, </span>
<span class="org-keyword">auto</span> <span class="org-function-name">getLastErrorAsString</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">Get the error message, if any.</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">errorMessageID</span> = ::GetLastError<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>errorMessageID == 0<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-type">LPSTR</span> <span class="org-variable-name">messageBuffer</span> = <span class="org-constant">nullptr</span>;
    <span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">flags</span>  =
      FORMAT_MESSAGE_ALLOCATE_BUFFER
      | FORMAT_MESSAGE_FROM_SYSTEM
      | FORMAT_MESSAGE_IGNORE_INSERTS;
    <span class="org-type">size_t</span> <span class="org-variable-name">size</span> = FormatMessageA<span class="org-rainbow-delimiters-depth-2">(</span>
                flags,
                <span class="org-constant">NULL</span>,
                errorMessageID,
                MAKELANGID<span class="org-rainbow-delimiters-depth-3">(</span>LANG_NEUTRAL, SUBLANG_DEFAULT<span class="org-rainbow-delimiters-depth-3">)</span>,
                <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">LPSTR</span><span class="org-rainbow-delimiters-depth-3">)</span>&amp;messageBuffer, 0, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">message</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>messageBuffer, size<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">ss</span> = <span class="org-constant">std</span>::stringstream<span class="org-rainbow-delimiters-depth-2">(</span>message<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">line</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{}</span>;
        <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-2">(</span>ss, line, <span class="org-string">'\r'</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">//</span><span class="org-comment">Free the buffer.</span>
    LocalFree<span class="org-rainbow-delimiters-depth-2">(</span>messageBuffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> line;  
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-keyword">auto</span> <span class="org-function-name">utf8_encode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">wstring</span> &amp;<span class="org-variable-name">wstr</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">size_needed</span> = WideCharToMultiByte<span class="org-rainbow-delimiters-depth-2">(</span>
            CP_UTF8, 0, &amp;wstr<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>,
            <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span>wstr.size<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-constant">NULL</span>, 0, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">strTo</span><span class="org-rainbow-delimiters-depth-2">(</span>size_needed, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    WideCharToMultiByte<span class="org-rainbow-delimiters-depth-2">(</span>
            CP_UTF8, 0, &amp;wstr<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>,
            <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span>wstr.size<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;strTo<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, size_needed, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> strTo;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Credits: https://gist.github.com/pezy/8571764</span>
<span class="org-keyword">auto</span> <span class="org-function-name">utf8_decode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> &amp;<span class="org-variable-name">str</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">wstring</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">int</span> <span class="org-variable-name">size_needed</span> = MultiByteToWideChar<span class="org-rainbow-delimiters-depth-2">(</span>
             CP_UTF8, 0,
             &amp;str<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span>str.size<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-constant">NULL</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">wstrTo</span><span class="org-rainbow-delimiters-depth-2">(</span>size_needed, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     MultiByteToWideChar<span class="org-rainbow-delimiters-depth-2">(</span>
             CP_UTF8, 0, &amp;str<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>,
             <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span> str.size<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;wstrTo<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, size_needed<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> wstrTo;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
<b>Building</b> 
</p>

<ul class="org-ul">
<li>MSVC</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">$ cl.exe listFiles.cpp /EHsc /Zi /nologo /Fe:listFiles.exe 
</pre>
</div>

<ul class="org-ul">
<li>Mingw/GCC</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">$ g++ listFiles.cpp -o <span class="org-keyword">listFiles.exe</span> -std=c++14 
</pre>
</div>

<p>
Usage: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ listFiles.exe <span class="org-string">"C:\*"</span>
 [TRACE] Console set to UTF8
directoryPath = C:<span class="org-string">\*</span>
 =&gt; $<span class="org-variable-name">GetCurrent</span>
 =&gt; $<span class="org-variable-name">Recycle</span>.Bin
 ... . ... ... .... .. .. ... 
 =&gt; pagefile.sys
 =&gt; PerfLogs
 =&gt; Program Files
 =&gt; Program Files (x86)
 ... ... ... ... 
 =&gt; Users
 =&gt; Windows
 =&gt; Windows10Upgrade
 [LOG] Handler &lt;hFile&gt; closed OK.
 [LOG] End sucessfully
 [TRACE] Console restored.

$ listFiles.exe <span class="org-string">"E:\*"</span>
 [TRACE] Console set to UTF8
directoryPath = E:<span class="org-string">\*</span>
 [LOG] Handler &lt;hFile&gt; closed OK.
 =&gt; Error code    = 3
 =&gt; Error message = The system cannot find the path specified.
 [TRACE] Console restored.


$ listFiles.exe <span class="org-string">"C:\windows\system32\*.dll"</span> 2&gt; log
directoryPath = C:\windows\system32<span class="org-string">\*</span>.dll
 =&gt; aadauthhelper.dll
 =&gt; aadcloudap.dll
 =&gt; aadjcsp.dll
 =&gt; aadtb.dll
 =&gt; aadWamExtension.dll
 =&gt; AboutSettingsHandlers.dll
 =&gt; AboveLockAppHost.dll
 ...    ...    ...    ... 
 [LOG] End sucessfully
</pre>
</div>

<p>
<b>Parts</b> 
</p>

<ul class="org-ul">
<li>Function: getLastErrorAsString - Returns a human readable
std::string description of GetLastError().</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Print human-readable description of GetLastError() - Error Code</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Source: https://stackoverflow.com/questions/1387064 Requires:</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&lt;string&gt;, &lt;sstream&gt;, &lt;windows.h&gt;,</span>
<span class="org-keyword">auto</span> <span class="org-function-name">getLastErrorAsString</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">Get the error message, if any.</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">errorMessageID</span> = ::GetLastError<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>errorMessageID == 0<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-type">LPSTR</span> <span class="org-variable-name">messageBuffer</span> = <span class="org-constant">nullptr</span>;
    <span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">flags</span>  =
      FORMAT_MESSAGE_ALLOCATE_BUFFER
      | FORMAT_MESSAGE_FROM_SYSTEM
      | FORMAT_MESSAGE_IGNORE_INSERTS;
    <span class="org-type">size_t</span> <span class="org-variable-name">size</span> = FormatMessageA<span class="org-rainbow-delimiters-depth-2">(</span>
                flags,
                <span class="org-constant">NULL</span>,
                errorMessageID,
                MAKELANGID<span class="org-rainbow-delimiters-depth-3">(</span>LANG_NEUTRAL, SUBLANG_DEFAULT<span class="org-rainbow-delimiters-depth-3">)</span>,
                <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">LPSTR</span><span class="org-rainbow-delimiters-depth-3">)</span>&amp;messageBuffer, 0, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">message</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>messageBuffer, size<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">ss</span> = <span class="org-constant">std</span>::stringstream<span class="org-rainbow-delimiters-depth-2">(</span>message<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">line</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{}</span>;
        <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-2">(</span>ss, line, <span class="org-string">'\r'</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">//</span><span class="org-comment">Free the buffer.</span>
    LocalFree<span class="org-rainbow-delimiters-depth-2">(</span>messageBuffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> line;  
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li>Function <span class="underline">EnumereFiles</span> encapsulates the WinAPIs <a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-findfirstfilew">FindFileFirstW</a> and
<a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-findnextfilew">FindNextFileW</a>. This function iterate over files of some directory
and applies an Enumerator function taking a string (file name) and
returning a boolean. The iteration continues until the enumerator
function returns false.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-keyword">using</span> <span class="org-type">FileEnumerator</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>;

<span class="org-comment-delimiter">/** </span><span class="org-comment">Enumerate files of some directory util enumerator function (callback) returns false. </span>
<span class="org-comment">  * - path       - Directory path to be listed </span>
<span class="org-comment">  * - Enumerator - Functions which consumes a string (file listed) and returns bool.</span>
<span class="org-comment">  *                this function returns false when it is no longer interested in </span>
<span class="org-comment">  *                being called. When it returns false the iteration stops. </span>
<span class="org-comment">  *</span>
<span class="org-comment">  * - Return    - Returns error code from GetLastError(). If it is successful, </span>
<span class="org-comment">  *               the function returns ERROR_SUCCESS.</span>
<span class="org-comment">  */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">EnumerateFiles</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span>, <span class="org-type">FileEnumerator</span> <span class="org-variable-name">Enumerator</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">WIN32_FIND_DATAW</span> <span class="org-variable-name">fdata</span>;
     <span class="org-type">HANDLE</span> <span class="org-variable-name">hFind</span> = INVALID_HANDLE_VALUE;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Ensure that resource hFind is always disposed. </span>
     <span class="org-keyword">auto</span> <span class="org-variable-name">close_hFind</span> = CloseHandleRAAI<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::bind<span class="org-rainbow-delimiters-depth-3">(</span>CloseHandleLog, hFind, <span class="org-string">"hFile"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     hFind = FindFirstFileW<span class="org-rainbow-delimiters-depth-2">(</span>utf8_decode<span class="org-rainbow-delimiters-depth-3">(</span>path<span class="org-rainbow-delimiters-depth-3">)</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;fdata<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hFind == INVALID_HANDLE_VALUE<span class="org-rainbow-delimiters-depth-2">)</span>
             <span class="org-keyword">return</span> GetLastError<span class="org-rainbow-delimiters-depth-2">()</span>;
     <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-comment-delimiter">//</span><span class="org-comment">Consumer function </span>
             <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span>Enumerator<span class="org-rainbow-delimiters-depth-4">(</span>utf8_encode<span class="org-rainbow-delimiters-depth-5">(</span>fdata.cFileName<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">break</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>FindNextFileW<span class="org-rainbow-delimiters-depth-3">(</span>hFind, &amp;fdata<span class="org-rainbow-delimiters-depth-3">)</span> != 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> ERROR_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Main function: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Usage: "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span> &lt;&lt; <span class="org-string">" "</span> &lt;&lt; <span class="org-string">"[PATH]"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-keyword">return</span> EXIT_FAILURE;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-keyword">auto</span> <span class="org-variable-name">utf8Console</span> = ConsoleUTF8<span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-keyword">auto</span> <span class="org-variable-name">directoryPath</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-1">{</span>argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">}</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"directoryPath = "</span> &lt;&lt; directoryPath &lt;&lt; <span class="org-string">"\n"</span>;
<span class="org-type">int</span> <span class="org-variable-name">count</span> = 0;  
<span class="org-comment-delimiter">// </span><span class="org-comment">Show 50 first files. </span>
<span class="org-type">int</span> <span class="org-variable-name">status</span> = EnumerateFiles<span class="org-rainbow-delimiters-depth-1">(</span>
    directoryPath,
    <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-2">](</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-2">){</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; "</span> &lt;&lt; file &lt;&lt; <span class="org-string">"\n"</span>;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>count++ &lt; 50<span class="org-rainbow-delimiters-depth-3">)</span>
                    <span class="org-keyword">return</span> <span class="org-constant">true</span>;
            <span class="org-keyword">else</span>
                    <span class="org-keyword">return</span> <span class="org-constant">false</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>status != ERROR_SUCCESS<span class="org-rainbow-delimiters-depth-1">){</span>
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; Error code    = "</span> &lt;&lt; ::GetLastError<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; Error message = "</span> &lt;&lt; getLastErrorAsString<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
     <span class="org-keyword">return</span> EXIT_FAILURE;
<span class="org-rainbow-delimiters-depth-1">}</span>   
<span class="org-function-name">std</span>::puts<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" [LOG] End sucessfully"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">return</span> EXIT_SUCCESS;
</pre>
</div>

<p>
WinAPIs used: 
</p>
<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-findfirstfilew">FindFileFirstW</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-findnextfilew">FindNextFileW</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms679360(v=vs.85).aspx">GetLastError</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/winbase/nf-winbase-formatmessage">FormatMessage</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgc683efc" class="outline-3">
<h3 id="orgc683efc"><span class="section-number-3">1.25</span> CODE - Enumerate Logical Drivers</h3>
<div class="outline-text-3" id="text-1-25">
<p>
This code enumerates all logical drivers in the current Windows
machine, for instance, C:, D:, E: &#x2026; and so on.
</p>

<p>
Source:
</p>
<ul class="org-ul">
<li>File: <a href="src/windows/GetLogicalDrivers.cpp">file:src/windows/GetLogicalDrivers.cpp</a></li>
<li>Gist: <a href="https://gist.github.com/caiorss/dc13ea333ce57a3fc9bc08579645d9f2">GetLogicalDrivers.cpp</a></li>
</ul>


<p>
<b>Files:</b> 
</p>

<p>
File: <span class="underline">GetLogicalDrivers.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">deque</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">Windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">using</span> <span class="org-type">DriverEnumerator</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">auto</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-variable-name">string</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>;
<span class="org-keyword">auto</span> <span class="org-function-name">EnumerateLogicalDriver</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">DriverEnumerator</span> <span class="org-variable-name">Consumer</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">void</span>;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">class</span>, <span class="org-keyword">class</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-keyword">class</span> <span class="org-type">Container</span> = <span class="org-constant">std</span>::vector<span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">LogicalDriverList</span><span class="org-rainbow-delimiters-depth-1">()</span>
        -&gt; <span class="org-type">Container</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-constant">std</span>::string, <span class="org-constant">std</span>::<span class="org-type">allocator</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">&gt;</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Logical Drivers or Disks found in the current installation"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"------------------------------------------------"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        EnumerateLogicalDriver<span class="org-rainbow-delimiters-depth-2">(</span>
                <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-3">){</span>
                        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Driver = "</span> &lt;&lt; name &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">auto</span> <span class="org-variable-name">driverList1</span> = LogicalDriverList<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::deque<span class="org-rainbow-delimiters-depth-2">&gt;()</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" *=&gt; Driver list in STL container std::deque  = "</span>;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">d</span>: driverList1<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-constant">std</span>::cout &lt;&lt; d &lt;&lt; <span class="org-string">", "</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::endl;;

        <span class="org-keyword">auto</span> <span class="org-variable-name">driverList2</span> = LogicalDriverList<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::vector<span class="org-rainbow-delimiters-depth-2">&gt;()</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" *=&gt; Driver list in STL container std::vector = "</span>;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">d</span>: driverList2<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-constant">std</span>::cout &lt;&lt; d &lt;&lt; <span class="org-string">", "</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::endl;;

        <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------// </span>

<span class="org-keyword">using</span> <span class="org-type">DriverEnumerator</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">auto</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>;

<span class="org-keyword">auto</span> <span class="org-function-name">EnumerateLogicalDriver</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">DriverEnumerator</span> <span class="org-variable-name">Consumer</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">void</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-type">size_t</span> <span class="org-variable-name">size</span> = ::GetLogicalDriveStringsA<span class="org-rainbow-delimiters-depth-2">(</span>0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>size, 0x00<span class="org-rainbow-delimiters-depth-2">)</span>;
        ::GetLogicalDriveStringsA<span class="org-rainbow-delimiters-depth-2">(</span>buffer.size<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span><span class="org-rainbow-delimiters-depth-2">{</span>buffer<span class="org-rainbow-delimiters-depth-2">}</span>;
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-3">(</span>ss, buffer, <span class="org-string">'\0'</span><span class="org-rainbow-delimiters-depth-3">)</span> &amp;&amp; <span class="org-negation-char">!</span>buffer.empty<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>
                Consumer<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Remember: Template always in header files </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">The user can choose the type of container used to return</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">the computer drivers. </span>
<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">class</span>, <span class="org-keyword">class</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-keyword">class</span> <span class="org-type">Container</span> = <span class="org-constant">std</span>::vector<span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">LogicalDriverList</span><span class="org-rainbow-delimiters-depth-1">()</span>
        -&gt; <span class="org-type">Container</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">allocator</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
        <span class="org-type">Container</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">allocator</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">&gt;</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">list</span><span class="org-rainbow-delimiters-depth-2">{}</span>;
        EnumerateLogicalDriver<span class="org-rainbow-delimiters-depth-2">(</span>
                <span class="org-rainbow-delimiters-depth-3">[</span>&amp;<span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-3">){</span>
                        list.push_back<span class="org-rainbow-delimiters-depth-4">(</span>name<span class="org-rainbow-delimiters-depth-4">)</span>;
                <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">return</span> list;    
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Analysis</b> 
</p>

<p>
Main Function: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-function-name">std</span>::puts<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Logical Drivers or Disks found in the current installation"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::puts<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"------------------------------------------------"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

EnumerateLogicalDriver<span class="org-rainbow-delimiters-depth-1">(</span>
        <span class="org-rainbow-delimiters-depth-2">[](</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Driver = "</span> &lt;&lt; name &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">auto</span> <span class="org-variable-name">driverList1</span> = LogicalDriverList<span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-constant">std</span>::deque<span class="org-rainbow-delimiters-depth-1">&gt;()</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">" *=&gt; Driver list in STL container std::deque  = "</span>;
<span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">d</span>: driverList1<span class="org-rainbow-delimiters-depth-1">){</span> <span class="org-constant">std</span>::cout &lt;&lt; d &lt;&lt; <span class="org-string">", "</span>; <span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::endl;;

<span class="org-keyword">auto</span> <span class="org-variable-name">driverList2</span> = LogicalDriverList<span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-constant">std</span>::vector<span class="org-rainbow-delimiters-depth-1">&gt;()</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">" *=&gt; Driver list in STL container std::vector = "</span>;
<span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">d</span>: driverList2<span class="org-rainbow-delimiters-depth-1">){</span> <span class="org-constant">std</span>::cout &lt;&lt; d &lt;&lt; <span class="org-string">", "</span>; <span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::endl;;

<span class="org-keyword">return</span> 0;
</pre>
</div>

<p>
Function EnumerateDriver: 
</p>

<ul class="org-ul">
<li>Takes a function as argument which consumes the logical driver
names passed as string.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">using</span> <span class="org-type">DriverEnumerator</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">auto</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-variable-name">string</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>;

<span class="org-keyword">auto</span> <span class="org-function-name">EnumerateLogicalDriver</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">DriverEnumerator</span> <span class="org-variable-name">Consumer</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">void</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">size_t</span> <span class="org-variable-name">size</span> = ::GetLogicalDriveStringsA<span class="org-rainbow-delimiters-depth-2">(</span>0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>size, 0x00<span class="org-rainbow-delimiters-depth-2">)</span>;
    ::GetLogicalDriveStringsA<span class="org-rainbow-delimiters-depth-2">(</span>buffer.size<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span><span class="org-rainbow-delimiters-depth-2">{</span>buffer<span class="org-rainbow-delimiters-depth-2">}</span>;
    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-3">(</span>ss, buffer, <span class="org-string">'\0'</span><span class="org-rainbow-delimiters-depth-3">)</span> &amp;&amp; <span class="org-negation-char">!</span>buffer.empty<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>
         Consumer<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Function LogicalDriverList;
</p>

<ul class="org-ul">
<li>Templated functions which takes an STL container as type
argument. It allows choosing the type of stl container which will
be returned.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Remember: Template always in header files The user can choose the</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">type of container used to return the computer drivers.</span>
<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">class</span>, <span class="org-keyword">class</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-keyword">class</span> <span class="org-type">Container</span> = <span class="org-constant">std</span>::vector<span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">LogicalDriverList</span><span class="org-rainbow-delimiters-depth-1">()</span>
        -&gt; <span class="org-type">Container</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-constant">std</span>::string, <span class="org-constant">std</span>::<span class="org-type">allocator</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">&gt;</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-type">Container</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::string, <span class="org-constant">std</span>::<span class="org-type">allocator</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">&gt;</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">list</span><span class="org-rainbow-delimiters-depth-2">{}</span>;
    EnumerateLogicalDriver<span class="org-rainbow-delimiters-depth-2">(</span>
            <span class="org-rainbow-delimiters-depth-3">[</span>&amp;<span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-3">){</span>
                    list.push_back<span class="org-rainbow-delimiters-depth-4">(</span>name<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> list;    
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Program output:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Compiling and running with MingW/GCC </span>
$ g++ GetLogicalDrivers.cpp -std=c++1z -o <span class="org-keyword">out.exe</span> &amp;&amp; out.exe

Logical Drivers or Disks found<span class="org-keyword"> in</span> the current installation
------------------------------------------------
Driver = C:<span class="org-sh-escaped-newline">\</span>
Driver = D:<span class="org-sh-escaped-newline">\</span>
 *=&gt; Driver list<span class="org-keyword"> in</span> STL container std::deque  = C:<span class="org-string">\,</span> D:<span class="org-string">\,</span> 
 *=&gt; Driver list<span class="org-keyword"> in</span> STL container std::vector = C:<span class="org-string">\,</span> D:<span class="org-string">\,</span> 
</pre>
</div>
</div>
</div>

<div id="outline-container-org0579ae0" class="outline-3">
<h3 id="org0579ae0"><span class="section-number-3">1.26</span> CODE - Launching and controlling sub-processes</h3>
<div class="outline-text-3" id="text-1-26">
<p>
This sample program contains a class process builder which
encapsulates the complexity of Windows API process. It can be used for
launching processes, streaming process output line by line, wait for
process execution, get PID and also terminate the subprocess.
</p>

<p>
Source:
</p>
<ul class="org-ul">
<li>File: <a href="src/windows/winprocess.cpp">file:src/windows/winprocess.cpp</a></li>
<li>GIST: <a href="https://gist.github.com/caiorss/7af874c24f9340e3148329896efc7dfd">winprocess.cpp</a></li>
</ul>


<p>
<b>Files</b> 
</p>

<p>
File: <span class="underline">winprocess.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdio</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">//</span><span class="org-comment">========= File: ProcessBuilder.hpp - Header ===================//</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Requires: &lt;iostream&gt; &lt;string&gt;, &lt;functional&gt; &lt;vector&gt; &lt;windows.h&gt; */</span>
<span class="org-keyword">class</span> <span class="org-type">ProcessBuilder</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
        <span class="org-comment-delimiter">// </span><span class="org-comment">Program to be run </span>
        <span class="org-constant">std</span>::<span class="org-type">string</span>              <span class="org-variable-name">m_program</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Arguments passed to the program </span>
        <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">m_args</span> = <span class="org-rainbow-delimiters-depth-2">{}</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">If this flag is true, the program is launched on console </span>
        <span class="org-type">bool</span>                     <span class="org-variable-name">m_console</span> = <span class="org-constant">true</span>;
        <span class="org-constant">std</span>::<span class="org-type">string</span>              <span class="org-variable-name">m_cwd</span>; 
        <span class="org-type">STARTUPINFO</span>              <span class="org-variable-name">m_si</span> = <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">STARTUPINFO</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">}</span>;
        <span class="org-type">PROCESS_INFORMATION</span>      <span class="org-variable-name">m_pi</span>;
<span class="org-function-name">public</span>: 
        <span class="org-keyword">using</span> <span class="org-type">SELF</span> = ProcessBuilder&amp;;
        <span class="org-keyword">using</span> <span class="org-type">LineConsumer</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>;

        <span class="org-function-name">ProcessBuilder</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
        <span class="org-function-name">ProcessBuilder</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">program</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">args</span> = <span class="org-rainbow-delimiters-depth-3">{}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-function-name">ProcessBuilder</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">ProcessBuilder</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
        <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">ProcessBuilder</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span>  = <span class="org-keyword">delete</span>;    
        ~<span class="org-function-name">ProcessBuilder</span><span class="org-rainbow-delimiters-depth-2">()</span>;
        <span class="org-function-name">ProcessBuilder</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ProcessBuilder</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ProcessBuilder</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; SELF;
        <span class="org-keyword">auto</span> <span class="org-function-name">SetProgram</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">program</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">SELF</span>;    
        <span class="org-keyword">auto</span> <span class="org-function-name">SetConsole</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">bool</span> <span class="org-variable-name">flag</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">SELF</span>;
        <span class="org-comment-delimiter">/** </span><span class="org-comment">Set process directory.</span>
<span class="org-comment">         * @param path - Process directory path.</span>
<span class="org-comment">         */</span>
        <span class="org-keyword">auto</span> <span class="org-function-name">SetCWD</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">SELF</span>;   
        <span class="org-comment-delimiter">/** </span><span class="org-comment">Start process without waiting for its termination.  */</span>
        <span class="org-keyword">auto</span> <span class="org-function-name">Run</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">bool</span>;
        <span class="org-keyword">auto</span> <span class="org-function-name">Wait</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Start process and wait for its termination. </span>
        <span class="org-keyword">auto</span> <span class="org-function-name">RunWait</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">bool</span>;
        <span class="org-keyword">auto</span> <span class="org-function-name">GetPID</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">DWORD</span>;
        <span class="org-keyword">auto</span> <span class="org-function-name">Terminate</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">bool</span>;
        <span class="org-keyword">auto</span> <span class="org-function-name">isRunning</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">bool</span>;   
        <span class="org-keyword">auto</span> <span class="org-function-name">StreamLines</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">LineConsumer</span> <span class="org-variable-name">consumer</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">bool</span>; 
        <span class="org-keyword">auto</span> <span class="org-function-name">GetOutput</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;    
<span class="org-function-name">private</span>:
        <span class="org-keyword">auto</span> <span class="org-function-name">ReadLineFromHandle</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hFile</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">pair</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span>, <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>;  
<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">//</span><span class="org-comment">========= End of Class ProcessBuilder ===== // </span>


<span class="org-comment-delimiter">//</span><span class="org-comment">========= File:  main.cpp ===================//</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Usage: "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" [test0 | test1 | test2 | test3 | test4 ]"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
           <span class="org-keyword">return</span> EXIT_FAILURE;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">auto</span> <span class="org-variable-name">tryExit</span> = <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-variable-name">argc</span>, &amp;<span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-2">](</span><span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-variable-name">Action</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
              <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-3">{</span>
                   <span class="org-comment-delimiter">// </span><span class="org-comment">End current process with exit code returned</span>
                   <span class="org-comment-delimiter">// </span><span class="org-comment">from function</span>
                   <span class="org-type">int</span> <span class="org-variable-name">status</span> = Action<span class="org-rainbow-delimiters-depth-4">()</span>;           
                   <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[SUCCESS] End gracefully"</span>;
                   <span class="org-constant">std</span>::exit<span class="org-rainbow-delimiters-depth-4">(</span>status<span class="org-rainbow-delimiters-depth-4">)</span>;
              <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">runtime_error</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-3">)</span>
              <span class="org-rainbow-delimiters-depth-3">{</span>
                  <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[ERROR  ] "</span> &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-4">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                  <span class="org-constant">std</span>::exit<span class="org-rainbow-delimiters-depth-4">(</span>1<span class="org-rainbow-delimiters-depth-4">)</span>;
              <span class="org-rainbow-delimiters-depth-3">}</span>     
      <span class="org-rainbow-delimiters-depth-2">}</span>;


      <span class="org-comment-delimiter">/** </span><span class="org-comment">Stream process output to stdout line by line. Print line read form subprocess </span>
<span class="org-comment">       * output as soon as it arrives. */</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-string">"test0"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              tryExit<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[]{</span>
                            <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = ProcessBuilder<span class="org-rainbow-delimiters-depth-4">()</span>;
                            p.SetProgram<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"ping 8.8.8.8"</span><span class="org-rainbow-delimiters-depth-4">)</span>;               
                            <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Stream output of process ping to stdout."</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                            p.StreamLines<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">[](</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span><span class="org-rainbow-delimiters-depth-5">){</span>
                                            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" line = "</span> &lt;&lt; line &lt;&lt; <span class="org-constant">std</span>::endl;
                                            <span class="org-keyword">return</span> <span class="org-constant">true</span>;
                                    <span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                            <span class="org-keyword">return</span> EXIT_SUCCESS;
                      <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

      <span class="org-comment-delimiter">/** </span><span class="org-comment">Read whole process output and then print it to console and to a file. </span>
<span class="org-comment">    * run $ dir . at path C:\\windows\\system32, read the whole process output </span>
<span class="org-comment">    * as string printing it and saving it to a log file. (output.log)</span>
<span class="org-comment">    */</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-string">"test1"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              tryExit<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[]{</span>
                              <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Get output of tasklist."</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                              <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = ProcessBuilder<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"dir ."</span><span class="org-rainbow-delimiters-depth-4">)</span>;     
                              p.SetCWD<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"C:\\windows\\system32"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                              <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Process output = "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                              <span class="org-keyword">auto</span> <span class="org-variable-name">out</span> = p.GetOutput<span class="org-rainbow-delimiters-depth-4">()</span>;
                              <span class="org-constant">std</span>::cout &lt;&lt; out &lt;&lt; <span class="org-constant">std</span>::endl;

                              <span class="org-constant">std</span>::<span class="org-type">ofstream</span> <span class="org-variable-name">fs</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"output.log"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                              fs &lt;&lt; <span class="org-string">" ==&gt;&gt;&gt; Process output = "</span> &lt;&lt; <span class="org-string">"\n"</span>;
                              fs &lt;&lt; <span class="org-string">" +=================+ "</span> &lt;&lt; <span class="org-string">"\n"</span>;
                              fs &lt;&lt; out;    
                              <span class="org-keyword">return</span> EXIT_SUCCESS;
                      <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

      <span class="org-comment-delimiter">/** </span><span class="org-comment">Launch a process (for window subsystem) and wait for its termination. */</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-string">"test2"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              tryExit<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[]{</span>
                           <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Launch process and wait for its termination"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                           <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = ProcessBuilder<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"notepad"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                           p.Run<span class="org-rainbow-delimiters-depth-4">()</span>;
                           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Waiting for process termination"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                           p.Wait<span class="org-rainbow-delimiters-depth-4">()</span>;
                           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Process terminated. OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                           <span class="org-keyword">return</span> EXIT_SUCCESS;
                      <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;               

      <span class="org-comment-delimiter">/** </span><span class="org-comment">Launch a process and terminate it when user hit RETURN. */</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-string">"test3"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              tryExit<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[]{</span>
                          <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Launch process and wait for its termination"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                          <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = ProcessBuilder<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"notepad"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                          p.Run<span class="org-rainbow-delimiters-depth-4">()</span>;
                          <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Enter RETURN to terminate process =&gt; PID = "</span> &lt;&lt; p.GetPID<span class="org-rainbow-delimiters-depth-4">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                          <span class="org-constant">std</span>::cin.get<span class="org-rainbow-delimiters-depth-4">()</span>;
                          p.Terminate<span class="org-rainbow-delimiters-depth-4">()</span>;
                          <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Process terminated OK."</span>;
                          <span class="org-keyword">return</span> EXIT_SUCCESS;
                      <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

      <span class="org-comment-delimiter">/** </span><span class="org-comment">Simulate failure. */</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-string">"test4"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              tryExit<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[]{</span>
                          <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Launch process and wait for its termination"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                          <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = ProcessBuilder<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"notepad-error-failure"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                          p.Run<span class="org-rainbow-delimiters-depth-4">()</span>;
                          <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Enter RETURN to terminate process =&gt; PID = "</span> &lt;&lt; p.GetPID<span class="org-rainbow-delimiters-depth-4">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                          <span class="org-constant">std</span>::cin.get<span class="org-rainbow-delimiters-depth-4">()</span>;
                          p.Terminate<span class="org-rainbow-delimiters-depth-4">()</span>;
                          <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Process terminated OK."</span>;
                          <span class="org-keyword">return</span> EXIT_SUCCESS;
                      <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

      <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: invalid option "</span> &lt;&lt; <span class="org-constant">std</span>::endl;   
      <span class="org-keyword">return</span> EXIT_FAILURE;;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">//</span><span class="org-comment">========= File: ProcessBuilder.cpp - Implementation ===================//</span>

<span class="org-function-name">ProcessBuilder</span>::ProcessBuilder<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">program</span>,
                                                           <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>
        : m_program<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>program<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
        , m_args<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>args<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
        , m_si<span class="org-rainbow-delimiters-depth-1">()</span>

<span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">ProcessBuilder</span>::~ProcessBuilder<span class="org-rainbow-delimiters-depth-1">(){</span>
        ::CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span> m_pi.hProcess <span class="org-rainbow-delimiters-depth-2">)</span>;
        ::CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span> m_pi.hThread <span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">ProcessBuilder</span>::ProcessBuilder<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">ProcessBuilder</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
        m_program = <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_program<span class="org-rainbow-delimiters-depth-2">)</span>;
        m_args    = <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_args<span class="org-rainbow-delimiters-depth-2">)</span>;
        m_console = <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_console<span class="org-rainbow-delimiters-depth-2">)</span>;
        m_cwd     = <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>m_cwd<span class="org-rainbow-delimiters-depth-2">)</span>;
        m_si      = <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>m_si<span class="org-rainbow-delimiters-depth-2">)</span>;
        m_pi      = <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>m_pi<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">ProcessBuilder</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; SELF
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-2">(</span>m_program, rhs.m_program<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-2">(</span>m_args,    rhs.m_args<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-2">(</span>m_console, rhs.m_console<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-2">(</span>m_cwd,     rhs.m_cwd<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-2">(</span>m_si,      rhs.m_si<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-2">(</span>m_pi,      rhs.m_pi<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">SetProgram</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">program</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">ProcessBuilder</span>&amp; <span class="org-rainbow-delimiters-depth-1">{</span>
        m_program = program;
        <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">SetConsole</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">bool</span> <span class="org-variable-name">flag</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">ProcessBuilder</span>&amp;
<span class="org-rainbow-delimiters-depth-1">{</span>
        m_console = flag;
        <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-comment-delimiter">/** </span><span class="org-comment">Set process directory.</span>
<span class="org-comment"> * @param path - Process directory path.</span>
<span class="org-comment"> */</span>
<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">SetCWD</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">ProcessBuilder</span>&amp;
<span class="org-rainbow-delimiters-depth-1">{</span>
        m_cwd = path;
        <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Start process without waiting for its termination.  */</span>
<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">Run</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">cmdline</span> = m_program;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">s</span>: m_args<span class="org-rainbow-delimiters-depth-2">)</span>
                cmdline = cmdline + <span class="org-string">" "</span> + s;

        <span class="org-type">bool</span> <span class="org-variable-name">status</span> = ::CreateProcessA<span class="org-rainbow-delimiters-depth-2">(</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">lpApplicationName</span>
                <span class="org-constant">nullptr</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">lpCommandLine</span>
                ,&amp;cmdline<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">lpProcessAttributes</span>
                ,<span class="org-constant">nullptr</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">lpThreadAttributes</span>
                ,<span class="org-constant">nullptr</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">bInheritHandles</span>
                ,m_console ? <span class="org-constant">true</span> : <span class="org-constant">false</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">dwCreationFlags</span>
                ,m_console ? 0  : CREATE_NO_WINDOW
                <span class="org-comment-delimiter">// </span><span class="org-comment">lpEnvironment - Pointer to environment variables</span>
                ,<span class="org-constant">nullptr</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">lpCurrentDirectory - Pointer to current directory</span>
                ,m_cwd.empty<span class="org-rainbow-delimiters-depth-3">()</span> ? <span class="org-constant">nullptr</span> : &amp;m_cwd<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">lpStartupInfo</span>
                ,&amp;m_si
                <span class="org-comment-delimiter">// </span><span class="org-comment">lpProcessInformation</span>
                ,&amp;m_pi
                <span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-type">DWORD</span> <span class="org-variable-name">code</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Wait 10 milliseconds </span>
        ::WaitForSingleObject<span class="org-rainbow-delimiters-depth-2">(</span>m_pi.hProcess, 10<span class="org-rainbow-delimiters-depth-2">)</span>;
                  ::GetExitCodeProcess<span class="org-rainbow-delimiters-depth-2">(</span>m_pi.hProcess, &amp;code<span class="org-rainbow-delimiters-depth-2">)</span>;  
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>code != STILL_ACTIVE<span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Failed to create process = "</span><span class="org-rainbow-delimiters-depth-3">)</span> + m_program<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">return</span> status;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">Wait</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        ::WaitForSingleObject<span class="org-rainbow-delimiters-depth-2">(</span> m_pi.hProcess, INFINITE <span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Start process and wait for its termination. </span>
<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">RunWait</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-type">bool</span> <span class="org-variable-name">status</span> = <span class="org-keyword">this</span>-&gt;Run<span class="org-rainbow-delimiters-depth-2">()</span>;
        <span class="org-keyword">this</span>-&gt;Wait<span class="org-rainbow-delimiters-depth-2">()</span>;
        <span class="org-keyword">return</span> status;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">GetPID</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">DWORD</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-keyword">return</span> m_pi.dwProcessId;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">Terminate</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-keyword">return</span> ::TerminateProcess<span class="org-rainbow-delimiters-depth-2">(</span>m_pi.hProcess, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">isRunning</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-type">DWORD</span> <span class="org-variable-name">code</span>;
        ::GetExitCodeProcess<span class="org-rainbow-delimiters-depth-2">(</span>m_pi.hProcess, &amp;code<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">return</span> code == STILL_ACTIVE;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">StreamLines</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">ProcessBuilder</span>::<span class="org-type">LineConsumer</span> <span class="org-variable-name">consumer</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-type">HANDLE</span> <span class="org-variable-name">hProcStdoutRead</span> = INVALID_HANDLE_VALUE;
        <span class="org-type">HANDLE</span> <span class="org-variable-name">hProcStdoutWrite</span> = INVALID_HANDLE_VALUE;
        <span class="org-type">SECURITY_ATTRIBUTES</span> <span class="org-variable-name">sattr</span>;
        sattr.nLength              = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>SECURITY_ATTRIBUTES<span class="org-rainbow-delimiters-depth-2">)</span>;
        sattr.bInheritHandle       = <span class="org-constant">true</span>;
        sattr.lpSecurityDescriptor = <span class="org-constant">nullptr</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>::CreatePipe<span class="org-rainbow-delimiters-depth-3">(</span>&amp;hProcStdoutRead, &amp;hProcStdoutWrite, &amp;sattr, 0<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: failed to create pipe"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>::SetHandleInformation<span class="org-rainbow-delimiters-depth-3">(</span>hProcStdoutRead, HANDLE_FLAG_INHERIT, 0<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: failed to set handle information"</span><span class="org-rainbow-delimiters-depth-2">)</span>;        

        m_si.hStdOutput = hProcStdoutWrite;
        m_si.dwFlags   |= STARTF_USESTDHANDLES;
        <span class="org-type">bool</span> <span class="org-variable-name">status</span> = <span class="org-keyword">this</span>-&gt;Run<span class="org-rainbow-delimiters-depth-2">()</span>;     
        <span class="org-comment-delimiter">// </span><span class="org-comment">The writing handler must be closed befored reading the </span>
        ::CloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hProcStdoutWrite<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">lin</span> = <span class="org-constant">std</span>::<span class="org-type">pair</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span>, <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;{}</span>;
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>lin = ReadLineFromHandle<span class="org-rainbow-delimiters-depth-3">(</span>hProcStdoutRead<span class="org-rainbow-delimiters-depth-3">)</span>, lin.first<span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>consumer<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-4">(</span>lin.second<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">break</span>;
        <span class="org-keyword">return</span> status;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">//</span><span class="org-comment">--- EOf ReadOutput --- //</span>

<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">GetOutput</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
        StreamLines<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[</span>&amp;<span class="org-variable-name">ss</span><span class="org-rainbow-delimiters-depth-3">](</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span><span class="org-rainbow-delimiters-depth-3">){</span>
                        ss &lt;&lt; line &lt;&lt; <span class="org-string">'\n'</span>;
                        <span class="org-keyword">return</span> <span class="org-constant">true</span>;
                <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">return</span> ss.str<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">ProcessBuilder</span>::<span class="org-function-name">ReadLineFromHandle</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hFile</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">pair</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">bool</span>, <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>; 
        <span class="org-type">DWORD</span> <span class="org-variable-name">bytesRead</span>;
        <span class="org-type">char</span> <span class="org-variable-name">c</span>;
        <span class="org-type">bool</span> <span class="org-variable-name">result</span>;
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-2">){</span>
                result = ::ReadFile<span class="org-rainbow-delimiters-depth-3">(</span>hFile, &amp;c, 1, &amp;bytesRead, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-comment-delimiter">//</span><span class="org-comment">, result</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>GetLastError<span class="org-rainbow-delimiters-depth-4">()</span> == ERROR_HANDLE_EOF || GetLastError<span class="org-rainbow-delimiters-depth-4">()</span> == ERROR_BROKEN_PIPE<span class="org-rainbow-delimiters-depth-3">){</span>
                        <span class="org-comment-delimiter">// </span><span class="org-comment">std::cerr &lt;&lt; " [TRACE] Reach END OF FILE." &lt;&lt; std::endl;</span>
                        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_pair<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">false</span>, <span class="org-string">""</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                <span class="org-rainbow-delimiters-depth-3">}</span>               
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>c == <span class="org-string">'\n'</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">break</span>;    
                ss &lt;&lt; c;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Return (NOTEOF?, string) =&gt; Flag returns false while end of file is not reached.</span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span> = ss.str<span class="org-rainbow-delimiters-depth-2">()</span>;
        <span class="org-type">char</span> <span class="org-variable-name">last</span> = line<span class="org-rainbow-delimiters-depth-2">[</span>line.size<span class="org-rainbow-delimiters-depth-3">()</span>-1<span class="org-rainbow-delimiters-depth-2">]</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>last == <span class="org-string">'\r'</span> || last == <span class="org-string">'\n'</span><span class="org-rainbow-delimiters-depth-2">)</span>
                line = line.substr<span class="org-rainbow-delimiters-depth-2">(</span>0, line.size<span class="org-rainbow-delimiters-depth-3">()</span> - 2<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_pair<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-3">(</span>bytesRead == 0 &amp;&amp; result<span class="org-rainbow-delimiters-depth-3">)</span>, ss.str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;  
</pre>
</div>


<p>
<b>Building</b> 
</p>


<p>
Compiling MSVC:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe winprocess.cpp /EHsc /Zi /nologo /Fe:winprocess.exe 
</pre>
</div>

<p>
Compiling Mingw/GCC:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ winprocess.cpp -o <span class="org-keyword">winprocess.exe</span> -Wall -Wextra -std=c++14
</pre>
</div>


<p>
<b>Main function</b>
</p>

<p>
The main function accepts a single argument which can be test0, test1,
test2, test3 and test4. Each argument tests a different action. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Usage: "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" [test0 | test1 | test2 | test3 | test4 ]"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">tryExit</span> = <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-variable-name">argc</span>, &amp;<span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-2">](</span><span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-variable-name">Action</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-3">{</span>
             <span class="org-comment-delimiter">// </span><span class="org-comment">End current process with exit code returned</span>
             <span class="org-comment-delimiter">// </span><span class="org-comment">from function</span>
             <span class="org-type">int</span> <span class="org-variable-name">status</span> = Action<span class="org-rainbow-delimiters-depth-4">()</span>;         
             <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[SUCCESS] End gracefully"</span>;
             <span class="org-constant">std</span>::exit<span class="org-rainbow-delimiters-depth-4">(</span>status<span class="org-rainbow-delimiters-depth-4">)</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">runtime_error</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-rainbow-delimiters-depth-3">{</span>
              <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[ERROR  ] "</span> &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-4">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
              <span class="org-constant">std</span>::exit<span class="org-rainbow-delimiters-depth-4">(</span>1<span class="org-rainbow-delimiters-depth-4">)</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>      
    <span class="org-rainbow-delimiters-depth-2">}</span>;

   <span class="org-comment-delimiter">/** </span><span class="org-comment">Stream process output to stdout line by line. Print line read form subprocess </span>
<span class="org-comment">    * output as soon as it arrives. */</span>
   <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-string">"test0"</span><span class="org-rainbow-delimiters-depth-2">)</span>
       tryExit<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[]{</span>
               <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = ProcessBuilder<span class="org-rainbow-delimiters-depth-4">()</span>;
               p.SetProgram<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"ping 8.8.8.8"</span><span class="org-rainbow-delimiters-depth-4">)</span>;                
               <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Stream output of process ping to stdout."</span><span class="org-rainbow-delimiters-depth-4">)</span>;
               p.StreamLines<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-rainbow-delimiters-depth-5">[](</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span><span class="org-rainbow-delimiters-depth-5">){</span>
                      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" line = "</span> &lt;&lt; line &lt;&lt; <span class="org-constant">std</span>::endl;
                      <span class="org-keyword">return</span> <span class="org-constant">true</span>;
                   <span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">)</span>;
               <span class="org-keyword">return</span> EXIT_SUCCESS;
           <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;     

  <span class="org-comment-delimiter">/** </span><span class="org-comment">Read whole process output and then print it to console and to a file. </span>
<span class="org-comment">     * run $ dir . at path C:\\windows\\system32, read the whole process output </span>
<span class="org-comment">     * as string printing it and saving it to a log file. (output.log)</span>
<span class="org-comment">     */</span>
   <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-string">"test1"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     ... ... ... ... 
  
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: invalid option "</span> &lt;&lt; <span class="org-constant">std</span>::endl; 
    <span class="org-keyword">return</span> EXIT_FAILURE;
   <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Command test0</b>
</p>

<p>
The command test0 stream process (ping.exe) output line by line read
from the sub-process as soon as the process prints the line.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span> == <span class="org-string">"test0"</span><span class="org-rainbow-delimiters-depth-1">)</span>
    tryExit<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[]{</span>
       <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = ProcessBuilder<span class="org-rainbow-delimiters-depth-3">()</span>;
       p.SetProgram<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"ping 8.8.8.8"</span><span class="org-rainbow-delimiters-depth-3">)</span>;                
       <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Stream output of process ping to stdout."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
       p.StreamLines<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">[](</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span><span class="org-rainbow-delimiters-depth-4">){</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" line = "</span> &lt;&lt; line &lt;&lt; <span class="org-constant">std</span>::endl;
            <span class="org-keyword">return</span> <span class="org-constant">true</span>;
         <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">return</span> EXIT_SUCCESS;
       <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Output: $ winprocess.exe test0
</p>

<div class="org-src-container">
<pre class="src src-text">$ winprocess.exe test0

Stream output of process ping to stdout.
 line =
 line = Pinging 8.8.8.8 with 32 bytes of data:
 line = Reply from 8.8.8.8: bytes=32 time=105ms TTL=127
 line = Reply from 8.8.8.8: bytes=32 time=106ms TTL=127
 line = Reply from 8.8.8.8: bytes=32 time=105ms TTL=127
 line = Reply from 8.8.8.8: bytes=32 time=106ms TTL=127
 line =
 line = Ping statistics for 8.8.8.8:
 line =     Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),
 line = Approximate round trip times in milli-seconds:
 line =     Minimum = 105ms, Maximum = 106ms, Average = 105ms
[SUCCESS] End gracefully
</pre>
</div>

<p>
<b>Command test1</b> 
</p>

<p>
Runs the process <span class="underline">$ dir .</span> (dir.exe) at the directory
<code>C::\Windows\\System32\\</code>, reads the whole process output containing the
directory listening saving it to a string and writing it to a file named
output.log.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span> == <span class="org-string">"test1"</span><span class="org-rainbow-delimiters-depth-1">)</span>
    tryExit<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[]{</span>
        <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Get output of tasklist."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = ProcessBuilder<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"dir ."</span><span class="org-rainbow-delimiters-depth-3">)</span>;      
         p.SetCWD<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"C:\\windows\\system32"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Process output = "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
         <span class="org-keyword">auto</span> <span class="org-variable-name">out</span> = p.GetOutput<span class="org-rainbow-delimiters-depth-3">()</span>;
         <span class="org-constant">std</span>::cout &lt;&lt; out &lt;&lt; <span class="org-constant">std</span>::endl;

         <span class="org-constant">std</span>::<span class="org-type">ofstream</span> <span class="org-variable-name">fs</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"output.log"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         fs &lt;&lt; <span class="org-string">" ==&gt;&gt;&gt; Process output = "</span> &lt;&lt; <span class="org-string">"\n"</span>;
         fs &lt;&lt; <span class="org-string">" +=================+ "</span> &lt;&lt; <span class="org-string">"\n"</span>;
         fs &lt;&lt; out; 
         <span class="org-keyword">return</span> EXIT_SUCCESS;
   <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Output: $ winprocess.exe test1 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ winprocess.exe test1 

 ... ... ... ... 
wwanprotdim.dll
wwansvc.dll
wwapi.dll
xbgmengine.dll
xbgmsvc.exe
xboxgipsvc.dll
xboxgipsynthetic.dll
xcopy.exe
xh-ZA
xmlfilter.dll
xmllite.dll
... .... ... .... ... .... 
</pre>
</div>

<p>
<b>Command test2</b> 
</p>

<p>
Launch a process (for window subsystem), notepad.exe and wait for its
termination.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span> == <span class="org-string">"test2"</span><span class="org-rainbow-delimiters-depth-1">)</span>
   tryExit<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[]{</span>
          <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Launch process and wait for its termination"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = ProcessBuilder<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"notepad"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          p.Run<span class="org-rainbow-delimiters-depth-3">()</span>;
          <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Waiting for process termination"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
          p.Wait<span class="org-rainbow-delimiters-depth-3">()</span>;
          <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Process terminated. OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
          <span class="org-keyword">return</span> EXIT_SUCCESS;
    <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>; 
</pre>
</div>

<p>
Output: $ winprocess.exe test2
</p>

<ul class="org-ul">
<li>The sub-process notepad.exe (window subsystem) is launched and then
the program waits for its termination.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ winprocess.exe test2
Launch process and wait for its termination
Waiting for process termination
Process terminated. OK.
[SUCCESS] End gracefully
</pre>
</div>

<p>
<b>Command test3</b> 
</p>

<p>
Launch sub-process notepad.exe without waiting and waits for user to
type RETURN. When user types this key, the process is terminated. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span> == <span class="org-string">"test3"</span><span class="org-rainbow-delimiters-depth-1">)</span>
        tryExit<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[]{</span>
            <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Launch process and wait for its termination"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = ProcessBuilder<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"notepad"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            p.Run<span class="org-rainbow-delimiters-depth-3">()</span>;
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Enter RETURN to terminate process =&gt; PID = "</span> &lt;&lt; p.GetPID<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
            <span class="org-constant">std</span>::cin.get<span class="org-rainbow-delimiters-depth-3">()</span>;
            p.Terminate<span class="org-rainbow-delimiters-depth-3">()</span>;
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Process terminated OK."</span>;
            <span class="org-keyword">return</span> EXIT_SUCCESS;
        <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Output: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ winprocess.exe test3
Launch process and wait for its termination
Enter RETURN to terminate process =&gt; PID = 2324

 Process terminated OK.[SUCCESS] End gracefully
</pre>
</div>

<p>
<b>Class ProcessBuilder</b> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">//</span><span class="org-comment">========= File: ProcessBuilder.hpp - Header ===================//</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Requires: &lt;iostream&gt; &lt;string&gt;, &lt;functional&gt; &lt;vector&gt; &lt;windows.h&gt; */</span>
<span class="org-keyword">class</span> <span class="org-type">ProcessBuilder</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">Program to be run </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span>              <span class="org-variable-name">m_program</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Arguments passed to the program </span>
    <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">m_args</span> = <span class="org-rainbow-delimiters-depth-2">{}</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">If this flag is true, the program is launched on console </span>
    <span class="org-type">bool</span>                     <span class="org-variable-name">m_console</span> = <span class="org-constant">true</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span>              <span class="org-variable-name">m_cwd</span>; 
    <span class="org-type">STARTUPINFO</span>              <span class="org-variable-name">m_si</span> = <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">STARTUPINFO</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">}</span>;
    <span class="org-type">PROCESS_INFORMATION</span>      <span class="org-variable-name">m_pi</span>;
<span class="org-function-name">public</span>: 
    <span class="org-keyword">using</span> <span class="org-type">SELF</span> = ProcessBuilder&amp;;
    <span class="org-keyword">using</span> <span class="org-type">LineConsumer</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>;

    <span class="org-function-name">ProcessBuilder</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
    <span class="org-function-name">ProcessBuilder</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">program</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">args</span> = <span class="org-rainbow-delimiters-depth-3">{}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-function-name">ProcessBuilder</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">ProcessBuilder</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
    <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">ProcessBuilder</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span>  = <span class="org-keyword">delete</span>;    
    ~<span class="org-function-name">ProcessBuilder</span><span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-function-name">ProcessBuilder</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ProcessBuilder</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ProcessBuilder</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; SELF;
    <span class="org-keyword">auto</span> <span class="org-function-name">SetProgram</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">program</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">SELF</span>;    
    <span class="org-keyword">auto</span> <span class="org-function-name">SetConsole</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">bool</span> <span class="org-variable-name">flag</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">SELF</span>;
    <span class="org-comment-delimiter">/** </span><span class="org-comment">Set process directory.</span>
<span class="org-comment">     * @param path - Process directory path.</span>
<span class="org-comment">     */</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">SetCWD</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">SELF</span>;   
    <span class="org-comment-delimiter">/** </span><span class="org-comment">Start process without waiting for its termination.  */</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">Run</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">bool</span>;
    <span class="org-keyword">auto</span> <span class="org-function-name">Wait</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Start process and wait for its termination. </span>
    <span class="org-keyword">auto</span> <span class="org-function-name">RunWait</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">bool</span>;
    <span class="org-keyword">auto</span> <span class="org-function-name">GetPID</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">DWORD</span>;
    <span class="org-keyword">auto</span> <span class="org-function-name">Terminate</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">bool</span>;
    <span class="org-keyword">auto</span> <span class="org-function-name">isRunning</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">bool</span>;   
    <span class="org-keyword">auto</span> <span class="org-function-name">StreamLines</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">LineConsumer</span> <span class="org-variable-name">consumer</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">bool</span>; 
    <span class="org-keyword">auto</span> <span class="org-function-name">GetOutput</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;    
<span class="org-function-name">private</span>:
    <span class="org-keyword">auto</span> <span class="org-function-name">ReadLineFromHandle</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HANDLE</span> <span class="org-variable-name">hFile</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">pair</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span>, <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>;  
<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">//</span><span class="org-comment">========= End of Class ProcessBuilder ===== // </span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb834bb" class="outline-3">
<h3 id="orgbb834bb"><span class="section-number-3">1.27</span> Windows Socket - Winsock</h3>
<div class="outline-text-3" id="text-1-27">
</div>
<div id="outline-container-orgbed4c02" class="outline-4">
<h4 id="orgbed4c02"><span class="section-number-4">1.27.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-27-1">
<p>
<b>Winsock API</b> 
</p>

<ul class="org-ul">
<li>Winsock 1.x - Adapation from BSD Berkley Socket API used by most
Unix-like operating systems.</li>
<li>Winsock 2.x - Provides new features:
<ul class="org-ul">
<li>Overlapped IO</li>
<li>Asynchrnous calls and callbacks</li>
<li>Layered service provided - LSP architechture.</li>
</ul></li>

<li>Note: Unlike Unix implementation of sockets - BSD sockets, Winsocks
API doesn't allow read/write operations with sockets as they where
files, as a result, casting to file pointer from &lt;stdio.h&gt; doesn't
work and leads to the program crashing at runtime. However, socket
can be casted to Windows HANDLES and manipulated with Win32 File IO
functions.</li>

<li>Note: Windows Sockets are not portable and specific to only
Windows, so in order to write an operating system agnostic network
code, it is necessary to use an high level network library such as
Boost-ASIO library or POCO frameworks.1</li>
</ul>

<p>
<b>Headers and Libraries</b>
</p>

<ul class="org-ul">
<li>&lt;windows.h&gt;</li>
<li>&lt;winsock2.h&gt;</li>
</ul>

<p>
Library: 
</p>

<ul class="org-ul">
<li><code>Ws2_32.lib</code></li>
<li><code>Ws2_32.dll</code></li>
</ul>

<p>
<b>Main System Calls</b> 
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">System Call</th>
<th scope="col" class="org-left">Target</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">socket()</td>
<td class="org-left">client or server socket</td>
<td class="org-left">Create a socket</td>
</tr>

<tr>
<td class="org-left">listen()</td>
<td class="org-left">server socket</td>
<td class="org-left">Server socket listen for incoming connections.</td>
</tr>

<tr>
<td class="org-left">accept()</td>
<td class="org-left">server socket</td>
<td class="org-left">Make a server socket ccept a connection from a client socket.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">connect()</td>
<td class="org-left">client socket</td>
<td class="org-left">Stablish a connection from a client socket to a server socket.</td>
</tr>

<tr>
<td class="org-left">send()</td>
<td class="org-left">client or server socket</td>
<td class="org-left">Send data to socket</td>
</tr>

<tr>
<td class="org-left">sednto()</td>
<td class="org-left">client or server socket</td>
<td class="org-left">Send data to non connected socket</td>
</tr>

<tr>
<td class="org-left">recev()</td>
<td class="org-left">client or server socket</td>
<td class="org-left">Receives data/bytes from connected socket</td>
</tr>

<tr>
<td class="org-left">recevfrom()</td>
<td class="org-left">client or server socket</td>
<td class="org-left">Receives data from non connected socket</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">shutdown()</td>
<td class="org-left">client or server socket</td>
<td class="org-left">Disables send and receive on socket</td>
</tr>

<tr>
<td class="org-left">closesocket()</td>
<td class="org-left">client or server socket</td>
<td class="org-left">Close a socket, closing the connection.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
<b>Creating a socket:</b>
</p>

<ul class="org-ul">
<li>af : Address familty
<ul class="org-ul">
<li><code>PF_INET</code></li>
<li><code>AF_INET</code> - IP Protocol</li>
</ul></li>
<li>type: Connection-oriented (TCP) or Datagra-oriented (UDP)
<ul class="org-ul">
<li><code>SOCK_STREAM</code> - (TCP) Connection-Oriented.</li>
<li><code>SOCK_DGRAM</code>  - (UDP) Datagram-Oriented.</li>
</ul></li>
<li>protocol: Unecessary when the af is <code>AF_INET</code> and can be set to 0.</li>
<li>Return: Socket handler and returns the constant <code>INVALID_SOCKET</code> on
failure.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">SOCKET</span> <span class="org-function-name">socket</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">af</span>, <span class="org-type">int</span> <span class="org-variable-name">type</span>, <span class="org-type">int</span> <span class="org-variable-name">protocol</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
<b>Socket-Client Function</b> 
</p>

<ul class="org-ul">
<li>s - socket object created with the function socket.</li>
<li>lpName - Hostname of machine to be connected, IP address.</li>
<li>nNameLen - <code>sizeof(struct sockaddr_in)</code></li>
<li>RETURN: Returns 0 to indicate a successfull connection and
<code>SOCKET_ERROR</code> for connection failure.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">connect</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">SOCKET</span> <span class="org-variable-name">s</span>, <span class="org-type">LPSOCKADDR</span> <span class="org-variable-name">lpName</span>, <span class="org-type">int</span> <span class="org-variable-name">nNameLen</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Byte Ordering Functions</b>  &#x2013; <a href="http://beej.us/guide/bgnet/html/single/bgnet.html#htonsman">Beej's Guide to Network Programming</a>
</p>

<ul class="org-ul">
<li>htons() - Host to network short</li>
<li>htonl() - Host ot network long</li>
<li>ntohs() - Network to Host Short</li>
<li>ntohl() - Network to host long</li>
</ul>

<p>
<b>Data Structure hostent</b>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">hostent</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Official name of the host (PC).</span>
    <span class="org-type">char</span> <span class="org-variable-name">FAR</span> *  h_name;           
    <span class="org-comment-delimiter">// </span><span class="org-comment">A NULL -terminated array of alternate names.</span>
    <span class="org-type">char</span> <span class="org-variable-name">FAR</span> * FAR *h_aliases;    
    <span class="org-comment-delimiter">// </span><span class="org-comment">The type of address being returned; for Windows Sockets this is always PF_INET.</span>
    <span class="org-type">short</span>       <span class="org-variable-name">h_addrtype</span>;       
    <span class="org-comment-delimiter">// </span><span class="org-comment">The length, in bytes, of each address; for PF_INET, this is always 4.</span>
    <span class="org-type">short</span>       <span class="org-variable-name">h_length</span>;         
    <span class="org-comment-delimiter">// </span><span class="org-comment">A NULL-terminated list of addresses for the host. Addresses are returned in network byte order.</span>
    <span class="org-type">char</span> <span class="org-variable-name">FAR</span> * FAR *h_addr_list;  
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
<b>Data Structure in_addr</b>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * Internet address (old style... should be updated)</span>
<span class="org-comment"> */</span>
<span class="org-keyword">struct</span> <span class="org-type">in_addr</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-keyword">union</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-keyword">struct</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-type">u_char</span> <span class="org-variable-name">s_b1</span>,<span class="org-variable-name">s_b2</span>,<span class="org-variable-name">s_b3</span>,<span class="org-variable-name">s_b4</span>; <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-variable-name">S_un_b</span>;
                <span class="org-keyword">struct</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-type">u_short</span> <span class="org-variable-name">s_w1</span>,<span class="org-variable-name">s_w2</span>; <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-variable-name">S_un_w</span>;
                <span class="org-type">u_long</span> <span class="org-variable-name">S_addr</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-variable-name">S_un</span>;
</pre>
</div>

<p>
<b>Data structures - sockaddr and sockaddr_6</b>
</p>

<p>
See: <a href="https://www.tenouk.com/Winsock/Winsock2example7.html">https://www.tenouk.com/Winsock/Winsock2example7.html</a>
</p>

<ul class="org-ul">
<li>IPv4</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">sockaddr</span> <span class="org-rainbow-delimiters-depth-1">{</span>
 <span class="org-type">ushort</span> <span class="org-variable-name">sa_family</span>;
 <span class="org-type">char</span> <span class="org-variable-name">sa_data</span><span class="org-rainbow-delimiters-depth-2">[</span>14<span class="org-rainbow-delimiters-depth-2">]</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-type">short</span>   <span class="org-variable-name">sin_family</span>;
        <span class="org-type">u_short</span> <span class="org-variable-name">sin_port</span>;
        <span class="org-keyword">struct</span>  <span class="org-type">in_addr</span> <span class="org-variable-name">sin_addr</span>;
        <span class="org-type">char</span>    <span class="org-variable-name">sin_zero</span><span class="org-rainbow-delimiters-depth-2">[</span>8<span class="org-rainbow-delimiters-depth-2">]</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>IPv6</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">sockaddr_in6</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-type">short</span>   <span class="org-variable-name">sin6_family</span>;
        <span class="org-type">u_short</span> <span class="org-variable-name">sin6_port</span>;
        <span class="org-type">u_long</span>  <span class="org-variable-name">sin6_flowinfo</span>;
        <span class="org-keyword">struct</span>  <span class="org-type">in6_addr</span> <span class="org-variable-name">sin6_addr</span>;
        <span class="org-type">u_long</span>  <span class="org-variable-name">sin6_scope_id</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in6</span> <span class="org-type">SOCKADDR_IN6</span>;
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in6</span> *<span class="org-type">PSOCKADDR_IN6</span>;
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in6</span> <span class="org-type">FAR</span> *<span class="org-type">LPSOCKADDR_IN6</span>;
</pre>
</div>

<p>
<b>Data Structure WSAData</b>
</p>

<p>
Before using Winsocks, it is necessary to initialize the library with
the function WSAStartup and the data structure WSDATA. After the
program has finished its execution, it necessary to run WSACleanup
function. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">WSAData</span> <span class="org-rainbow-delimiters-depth-1">{</span>
 <span class="org-type">WORD</span> <span class="org-variable-name">wVersion</span>;
 <span class="org-type">WORD</span> <span class="org-variable-name">wHighVersion</span>;
 <span class="org-type">char</span> <span class="org-variable-name">szDescription</span><span class="org-rainbow-delimiters-depth-2">[</span>WSADESCRIPTION_LEN+1<span class="org-rainbow-delimiters-depth-2">]</span>;
 <span class="org-type">char</span> <span class="org-variable-name">szSystemStatus</span><span class="org-rainbow-delimiters-depth-2">[</span>WSASYS_STATUS_LEN+1<span class="org-rainbow-delimiters-depth-2">]</span>;
 <span class="org-type">unsigned</span> <span class="org-type">short</span> <span class="org-variable-name">iMaxSockets</span>;
 <span class="org-type">unsigned</span> <span class="org-type">short</span> <span class="org-variable-name">iMaxUdpDg</span>;
 <span class="org-type">char</span> <span class="org-variable-name">FAR</span>* lpVendorInfo;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">WSADATA</span>, *<span class="org-type">LPWSADATA</span>; 
</pre>
</div>

<p>
Example: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">WSADATA</span> <span class="org-variable-name">wd</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Intialize with Winsocks 1.0 </span>
WSAStartup<span class="org-rainbow-delimiters-depth-1">(</span>MAKEWORD<span class="org-rainbow-delimiters-depth-2">(</span>1, 0<span class="org-rainbow-delimiters-depth-2">)</span>, &amp;wd<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Intialize with Winsocks 2.0 </span>
WSAStartup<span class="org-rainbow-delimiters-depth-1">(</span>MAKEWORD<span class="org-rainbow-delimiters-depth-2">(</span>2, 2<span class="org-rainbow-delimiters-depth-2">)</span>, &amp;wd<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Intialize with Winsocks 2.0 </span>
WSAStartup<span class="org-rainbow-delimiters-depth-1">(</span>MAKEWORD<span class="org-rainbow-delimiters-depth-2">(</span>2, 0<span class="org-rainbow-delimiters-depth-2">)</span>, &amp;wd<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
References: 
</p>

<ul class="org-ul">
<li><a href="https://en.wikibooks.org/wiki/Windows_Programming/Winsock">Windows Programming/Winsock - Wikibooks, open books for an open world</a></li>

<li><a href="https://www.tenouk.com/Winsock/Winsock2example.html">An introduction to Windows socket/Winsock 2/Windows network programming tutorial with practical C program examples</a></li>

<li><a href="https://www.binarytides.com/receive-full-data-with-recv-socket-function-in-c/">Receive full data with recv socket function in C – BinaryTides</a></li>

<li><a href="http://beej.us/guide/bgnet/html/single/bgnet.html">Beej's Guide to Network Programming</a></li>

<li><a href="http://space.wccnet.edu/~chasselb/linux275/ClassNotes/sockets/ms_winsock.htm">Winsock Socket Programming</a></li>
</ul>
</div>
</div>

<div id="outline-container-orge8a20ed" class="outline-4">
<h4 id="orge8a20ed"><span class="section-number-4">1.27.2</span> CODE - Show IPv4 address of a hostname</h4>
<div class="outline-text-4" id="text-1-27-2">
<p>
File: <span class="underline">showIP.cpp</span>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">/* </span><span class="org-comment">Show IPV4 Address of a given hostname</span>
<span class="org-comment"> *===================================*/</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span> *<span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-2">[]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc != 2<span class="org-rainbow-delimiters-depth-2">){</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Usage: "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" &lt;hostname&gt; "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-keyword">return</span> EXIT_FAILURE;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">Initialize Winsock 2.2 </span>
  <span class="org-type">WSADATA</span> <span class="org-variable-name">wsaData</span>;
  WSAStartup<span class="org-rainbow-delimiters-depth-2">(</span>MAKEWORD<span class="org-rainbow-delimiters-depth-3">(</span>2, 2<span class="org-rainbow-delimiters-depth-3">)</span>, &amp;wsaData<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">hostent</span>* <span class="org-variable-name">host</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-type">char</span> *<span class="org-variable-name">ip</span> = inet_ntoa<span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">in_addr</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>*host-&gt;h_addr_list<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ipv4 Address = "</span> &lt;&lt; ip                &lt;&lt; <span class="org-constant">std</span>::endl;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" hostname     = "</span> &lt;&lt; host-&gt;h_name      &lt;&lt; <span class="org-constant">std</span>::endl;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Address type = "</span> &lt;&lt; host-&gt;h_addrtype  &lt;&lt; <span class="org-constant">std</span>::endl;

  WSACleanup<span class="org-rainbow-delimiters-depth-2">()</span>;
  <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Compiling and runnign with MSVC: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe showIP.cpp /EHsc /Zi /nologo /Fe:out.exe ws2_32.lib &amp;&amp; showip.exe 
</pre>
</div>

<p>
Compiling and runnign with Mingw/GCC:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ showIP.cpp -o <span class="org-keyword">showip.exe</span> -std=c++11 -lws2_32 &amp;&amp; showip.exe 
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ showip.exe
<span class="org-function-name">Usage</span>: showip.exe &lt;hostname&gt;

$ showip.exe www.google.co
 ipv4 Address = 172.217.29.110
 hostname     = www3.l.google.com
 Address type = 2

$ showip.exe www.yandex.com
 ipv4 Address = 213.180.204.62
 hostname     = www.yandex.com
 Address type = 2

$ showip.exe www.bing.ca
 ipv4 Address = 204.79.197.219
 hostname     = a-0016.a-msedge.net
 Address type = 2
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc4f4900" class="outline-4">
<h4 id="orgc4f4900"><span class="section-number-4">1.27.3</span> CODE - Basic Socket Client</h4>
<div class="outline-text-4" id="text-1-27-3">
</div>
<ol class="org-ol">
<li><a id="org0750a73"></a>Setup and usage<br />
<div class="outline-text-5" id="text-1-27-3-1">
<p>
Source: 
</p>
<ul class="org-ul">
<li>File: <a href="src/windows/client-socket-shell1.cpp">file:src/windows/client-socket-shell1.cpp</a></li>
<li>GIST: <a href="https://gist.github.com/caiorss/6f86bd879b339982550064f31b2ea75a">client-socket-shell1.cpp</a></li>
</ul>

<p>
<b>Source Files</b> 
</p>

<p>
FIle: <span class="underline">client-socket-shell1.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#pragma</span> comment <span class="org-rainbow-delimiters-depth-1">(</span>lib, <span class="org-string">"Ws2_32.lib"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">#pragma comment (lib, "Mswsock.lib")</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">#pragma comment (lib, "AdvApi32.lib")</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 3<span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Usage: "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" [HOSTNAME or ADDRESS] [PORT]"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-keyword">return</span> EXIT_FAILURE;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Client configuration </span>
        <span class="org-keyword">const</span> <span class="org-type">char</span>*  <span class="org-variable-name">host</span> = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">port</span> = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-comment-delimiter">//</span><span class="org-comment">Start up Winsock&#8230;</span>
        <span class="org-type">WSADATA</span> <span class="org-variable-name">wsadata</span>;
        <span class="org-type">int</span> <span class="org-variable-name">error</span> = WSAStartup<span class="org-rainbow-delimiters-depth-2">(</span>0x0202, &amp;wsadata<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>error<span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: failed to initialize WinSock."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-keyword">return</span> EXIT_FAILURE;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Create client socket </span>
        <span class="org-type">SOCKET</span> <span class="org-variable-name">client</span> = ::socket<span class="org-rainbow-delimiters-depth-2">(</span>AF_INET, SOCK_STREAM, IPPROTO_TCP<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>client == INVALID_SOCKET<span class="org-rainbow-delimiters-depth-2">){</span>
             <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error, I cannot create socket"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
             <span class="org-keyword">return</span> EXIT_FAILURE;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-type">SOCKADDR_IN</span>  <span class="org-variable-name">addr</span>;
        memset<span class="org-rainbow-delimiters-depth-2">(</span>&amp;addr, 0, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>addr<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        addr.sin_family      = AF_INET;
        addr.sin_addr.s_addr = inet_addr<span class="org-rainbow-delimiters-depth-2">(</span>host<span class="org-rainbow-delimiters-depth-2">)</span>;
        addr.sin_port        = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Attemp to connect to server and exit on failure. </span>
        <span class="org-type">int</span> <span class="org-variable-name">connval</span> = connect<span class="org-rainbow-delimiters-depth-2">(</span>client, <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">sockaddr</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>&amp;addr<span class="org-rainbow-delimiters-depth-3">)</span>, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>addr<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>connval == SOCKET_ERROR<span class="org-rainbow-delimiters-depth-2">){</span>
             <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: cannot connect to server."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
             <span class="org-comment-delimiter">//</span><span class="org-comment">Returns status code other than zero</span>
             <span class="org-keyword">return</span> EXIT_FAILURE;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msgClientConnect</span> = <span class="org-string">" [CLIENT] Connected to server OK.\n"</span>;   
        ::send<span class="org-rainbow-delimiters-depth-2">(</span>client, msgClientConnect.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, msgClientConnect.size<span class="org-rainbow-delimiters-depth-3">()</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-string">" [CLIENT SHELL]&gt;&gt; "</span>;
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">echo</span>;

        <span class="org-type">bool</span> <span class="org-variable-name">flag</span> = <span class="org-constant">true</span>;
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>flag<span class="org-rainbow-delimiters-depth-2">){</span>    
            ::send<span class="org-rainbow-delimiters-depth-3">(</span>client, msg.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, msg.size<span class="org-rainbow-delimiters-depth-4">()</span>, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Create a buffer with 2024 bytes or 2kb</span>
            <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-3">(</span>2024, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-comment-delimiter">//</span><span class="org-comment">Returns the number of received bytes </span>
            <span class="org-type">int</span> <span class="org-variable-name">n</span> = ::recv<span class="org-rainbow-delimiters-depth-3">(</span>client, &amp;buffer<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>, buffer.size<span class="org-rainbow-delimiters-depth-4">()</span>-1, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
            echo = <span class="org-string">" =&gt; [ECHO] "</span> + buffer + <span class="org-string">"\n"</span>;
            ::send<span class="org-rainbow-delimiters-depth-3">(</span>client, echo.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, echo.size<span class="org-rainbow-delimiters-depth-4">()</span>, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>WSAGetLastError<span class="org-rainbow-delimiters-depth-4">()</span> == SOCKET_ERROR<span class="org-rainbow-delimiters-depth-3">){</span>
                    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Disconnected OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                    flag  = <span class="org-constant">false</span>;
                    <span class="org-keyword">break</span>;
            <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-3">{</span>
                    buffer.resize<span class="org-rainbow-delimiters-depth-4">(</span>n<span class="org-rainbow-delimiters-depth-4">)</span>;
                    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>buffer == <span class="org-string">"exit\n"</span> <span class="org-rainbow-delimiters-depth-4">){</span>
                            <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">exitMessage</span> = <span class="org-string">" [CLIENT] Disconnect gracefully - OK.\n"</span>;
                            ::send<span class="org-rainbow-delimiters-depth-5">(</span>client, exitMessage.c_str<span class="org-rainbow-delimiters-depth-6">()</span>, exitMessage.size<span class="org-rainbow-delimiters-depth-6">()</span>, 0<span class="org-rainbow-delimiters-depth-5">)</span>;             
                            <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[LOG] I got an exit message. Shutdowing socket now!"</span> &lt;&lt; <span class="org-string">"\n"</span>;
                            <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[LOG] Gracifully disconnecting application"</span> &lt;&lt; <span class="org-string">"\n"</span>;
                            <span class="org-constant">std</span>::cerr.flush<span class="org-rainbow-delimiters-depth-5">()</span>;
                            <span class="org-keyword">break</span>;
                    <span class="org-rainbow-delimiters-depth-4">}</span>        
                    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [SERVER SENT] &gt;&gt; "</span> &lt;&lt; buffer ; <span class="org-comment-delimiter">//</span><span class="org-comment">&lt;&lt; std::endl;</span>
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Force writing buffer to the stdout</span>
                    <span class="org-constant">std</span>::cout.flush<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Finished."</span> &lt;&lt; <span class="org-constant">std</span>::endl;   
        ::closesocket<span class="org-rainbow-delimiters-depth-2">(</span>client<span class="org-rainbow-delimiters-depth-2">)</span>;
        ::WSACleanup<span class="org-rainbow-delimiters-depth-2">()</span>;    
        <span class="org-comment-delimiter">// </span><span class="org-comment">Returns status code 0</span>
        <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>


<p>
<b>Build</b> 
</p>

<ul class="org-ul">
<li>MSVC:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe client-socket-shell1.cpp /EHsc /Zi /nologo  
</pre>
</div>

<ul class="org-ul">
<li>Mingw/GCC</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">&#955;  g++ client-socket-shell1.cpp -o <span class="org-keyword">winsock-client-shell1.exe</span> -std=c++1z -lws2_32
</pre>
</div>

<p>
<b>Usage:</b>
</p>

<p>
STEP 1 - Set up a server with netcat from local computer or remote
machine. In this case netcat is set up from a Linux box.
</p>

<ul class="org-ul">
<li>Note: The IP address from the server side can be obtained with the
command <span class="underline">$ ipconfig</span> on Windows NT and <span class="underline">$ ifconfig</span> on Linux, Android,
MacOSX, BSD and so on.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ nc -v -l 9090
<span class="org-function-name">Ncat</span>: Version 7.60 ( https://nmap.org/ncat )
<span class="org-function-name">Ncat</span>: Generating a temporary 1024-bit RSA key. Use --ssl-key and --ssl-cert to use a permanent one.
<span class="org-function-name">Ncat</span>: SHA-1 fingerprint: 00D2 1683 8C75 26DC 74CD 6B3C 52BF D3DE 1FD0 18F5
<span class="org-function-name">Ncat</span>: Listening on :::9090
<span class="org-function-name">Ncat</span>: Listening on 0.0.0.0:9090
</pre>
</div>

<p>
STEP 2 - Connect to server from Windows by runnign the client
program. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">&#955;</span> <span class="org-variable-name">client</span>-socket-shell1.exe
<span class="org-function-name">Usage</span>: client-socket-shell1.exe <span class="org-rainbow-delimiters-depth-1">[</span>HOSTNAME <span class="org-keyword">or</span> ADDRESS<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-rainbow-delimiters-depth-1">[</span>PORT<span class="org-rainbow-delimiters-depth-1">]</span>

&#955; client-socket-shell1.exe 192.168.18.90 9090
 <span class="org-rainbow-delimiters-depth-1">[</span>SERVER SENT<span class="org-rainbow-delimiters-depth-1">]</span> &gt;&gt;
</pre>
</div>

<p>
If the netcat server is running in the same machine, the address is
127.0.0.1 or localhost and the command for connecting to the server
is: 
</p>

<div class="org-src-container">
<pre class="src src-sh">&#955; client-socket-shell1.exe localhost 9090
<span class="org-comment-delimiter"># </span><span class="org-comment">OR: </span>
&#955; client-socket-shell1.exe 127.0.0.1 9090
</pre>
</div>

<p>
STEP 3 - Send commands to client program from server terminal
(netcat). 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nc -v -l 9090
<span class="org-function-name">Ncat</span>: Version 7.60 ( https://nmap.org/ncat )
<span class="org-function-name">Ncat</span>: Generating a temporary 1024-bit RSA key. Use --ssl-key and --ssl-cert to use a permanent one.
<span class="org-function-name">Ncat</span>: SHA-1 fingerprint: 00D2 1683 8C75 26DC 74CD 6B3C 52BF D3DE 1FD0 18F5
<span class="org-function-name">Ncat</span>: Listening on :::9090
<span class="org-function-name">Ncat</span>: Listening on 0.0.0.0:9090

<span class="org-function-name">Ncat</span>: Connection from 192.168.18.161.
<span class="org-function-name">Ncat</span>: Connection from 192.168.18.161:50278.
 [CLIENT] Connected to server OK.
 [CLIENT SHELL]&gt;&gt;  =&gt; [ECHO]

 [CLIENT SHELL]&gt;&gt;

</pre>
</div>

<p>
STEP 4 - Type any commands from server side and they will be to the
client side which will echo it back to the server. 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-function-name">Ncat</span>: Connection from 192.168.18.161.
<span class="org-function-name">Ncat</span>: Connection from 192.168.18.161:50278.
 [CLIENT] Connected to server OK.
 [CLIENT SHELL]&gt;&gt;  =&gt; [ECHO]

 [CLIENT SHELL]&gt;&gt; command arg0 arg1 arg2 arg3
 =&gt; [ECHO] command arg0 arg1 arg2 arg3

 [CLIENT SHELL]&gt;&gt; ls -la
 =&gt; [ECHO] ls -la

 [CLIENT SHELL]&gt;&gt; cd /
 =&gt; [ECHO] cd /

 [CLIENT SHELL]&gt;&gt; uname -a
 =&gt; [ECHO] uname -a

 [CLIENT SHELL]&gt;&gt; reverse shell - echo shell
 =&gt; [ECHO] reverse shell - echo shell

[CLIENT SHELL]&gt;&gt; exit
=&gt; [ECHO] exit

[CLIENT] Disconnect gracefully - OK.
</pre>
</div>

<p>
STEP 5 - Output in the client terminal (Windows): 
</p>

<div class="org-src-container">
<pre class="src src-sh">&#955; client-socket-shell1.exe 192.168.18.90 9090
 [SERVER SENT] &gt;&gt;
 [SERVER SENT] &gt;&gt; command arg0 arg1 arg2 arg3
 [SERVER SENT] &gt;&gt; ls -la
 [SERVER SENT] &gt;&gt; cd /
 [SERVER SENT] &gt;&gt; uname -a
 [SERVER SENT] &gt;&gt; reverse shell - echo shell
</pre>
</div>
</div>
</li>
<li><a id="orge2e4711"></a>Parts<br />
<div class="outline-text-5" id="text-1-27-3-2">
<p>
Get client socket configuration from command line: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 3<span class="org-rainbow-delimiters-depth-2">){</span>
            <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Usage: "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" [HOSTNAME or ADDRESS] [PORT]"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
            <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Client configuration </span>
    <span class="org-keyword">const</span> <span class="org-type">char</span>*  <span class="org-variable-name">host</span> = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;
    <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">port</span> = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    ... ... ...    ... ... ...    ... ... ...
</pre>
</div>

<p>
Start up Winsock data structure: 
</p>

<ul class="org-ul">
<li>Note: WSAStartup(0x0202, &amp;wsadata) =&gt; Intializes Winsock 2.2 API.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">//</span><span class="org-comment">Start up Winsock&#8230;</span>
<span class="org-type">WSADATA</span> <span class="org-variable-name">wsadata</span>;
<span class="org-type">int</span> <span class="org-variable-name">error</span> = WSAStartup<span class="org-rainbow-delimiters-depth-1">(</span>0x0202, &amp;wsadata<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>error<span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: failed to initialize WinSock."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">return</span> EXIT_FAILURE;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Create client socket: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Create client socket </span>
<span class="org-type">SOCKET</span> <span class="org-variable-name">client</span> = ::socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_INET, SOCK_STREAM, IPPROTO_TCP<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>client == INVALID_SOCKET<span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error, I cannot create socket"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">return</span> EXIT_FAILURE;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-type">SOCKADDR_IN</span>  <span class="org-variable-name">addr</span>;
memset<span class="org-rainbow-delimiters-depth-1">(</span>&amp;addr, 0, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>addr<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
addr.sin_family      = AF_INET;
addr.sin_addr.s_addr = inet_addr<span class="org-rainbow-delimiters-depth-1">(</span>host<span class="org-rainbow-delimiters-depth-1">)</span>;
addr.sin_port        = htons<span class="org-rainbow-delimiters-depth-1">(</span>port<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Attemp to connect to server and exit if there is any failure: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Attemp to connect to server and exit on failure. </span>
<span class="org-type">int</span> <span class="org-variable-name">connval</span> = connect<span class="org-rainbow-delimiters-depth-1">(</span>client, <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">sockaddr</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>&amp;addr<span class="org-rainbow-delimiters-depth-2">)</span>, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>addr<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>connval == SOCKET_ERROR<span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: cannot connect to server."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-comment-delimiter">//</span><span class="org-comment">Returns status code other than zero</span>
        <span class="org-keyword">return</span> EXIT_FAILURE;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Send message "[CLIENT] Connected to server OK" to server once
the client is connected:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-function-name">std</span>::string msgClientConnect = <span class="org-string">" [CLIENT] Connected to server OK.\n"</span>;   
::send<span class="org-rainbow-delimiters-depth-1">(</span>client, msgClientConnect.c_str<span class="org-rainbow-delimiters-depth-2">()</span>, msgClientConnect.size<span class="org-rainbow-delimiters-depth-2">()</span>, 0<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::string msg = <span class="org-string">" [CLIENT SHELL]&gt;&gt; "</span>;
<span class="org-function-name">std</span>::string echo;
</pre>
</div>

<p>
Main loop: 
</p>
<ul class="org-ul">
<li>Send prompt string to server "[CLIENT SHELL]&gt;&gt; "</li>
<li>Receive command from server typed in the server terminal by the
user.</li>
<li>Echo command back to server.</li>
<li>If server send command "exit", the client exits the main loop and
diconnets from server sending the message " [CLIENT] Disconnect
gracefully - OK".</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">bool</span> <span class="org-variable-name">flag</span> = <span class="org-constant">true</span>;
<span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-1">(</span>flag<span class="org-rainbow-delimiters-depth-1">){</span>    
   ::send<span class="org-rainbow-delimiters-depth-2">(</span>client, msg.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, msg.size<span class="org-rainbow-delimiters-depth-3">()</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-comment-delimiter">// </span><span class="org-comment">Create a buffer with 2024 bytes or 2kb</span>
   <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>2024, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-comment-delimiter">//</span><span class="org-comment">Returns the number of received bytes </span>
   <span class="org-type">int</span> <span class="org-variable-name">n</span> = ::recv<span class="org-rainbow-delimiters-depth-2">(</span>client, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, buffer.size<span class="org-rainbow-delimiters-depth-3">()</span>-1, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
   echo = <span class="org-string">" =&gt; [ECHO] "</span> + buffer + <span class="org-string">"\n"</span>;
   ::send<span class="org-rainbow-delimiters-depth-2">(</span>client, echo.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, echo.size<span class="org-rainbow-delimiters-depth-3">()</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>WSAGetLastError<span class="org-rainbow-delimiters-depth-3">()</span> == SOCKET_ERROR<span class="org-rainbow-delimiters-depth-2">){</span>
       <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Disconnected OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
       flag  = <span class="org-constant">false</span>;
       <span class="org-keyword">break</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-2">{</span>
       buffer.resize<span class="org-rainbow-delimiters-depth-3">(</span>n<span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>buffer == <span class="org-string">"exit\n"</span> <span class="org-rainbow-delimiters-depth-3">){</span>
               <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">exitMessage</span> = <span class="org-string">" [CLIENT] Disconnect gracefully - OK.\n"</span>;
               ::send<span class="org-rainbow-delimiters-depth-4">(</span>client, exitMessage.c_str<span class="org-rainbow-delimiters-depth-5">()</span>, exitMessage.size<span class="org-rainbow-delimiters-depth-5">()</span>, 0<span class="org-rainbow-delimiters-depth-4">)</span>;              
               <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[LOG] I got an exit message. Shutdowing socket now!"</span> &lt;&lt; <span class="org-string">"\n"</span>;
               <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[LOG] Gracefully disconnecting application"</span> &lt;&lt; <span class="org-string">"\n"</span>;
               <span class="org-constant">std</span>::cerr.flush<span class="org-rainbow-delimiters-depth-4">()</span>;
               <span class="org-keyword">break</span>;
       <span class="org-rainbow-delimiters-depth-3">}</span>        
       <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [SERVER SENT] &gt;&gt; "</span> &lt;&lt; buffer ; <span class="org-comment-delimiter">//</span><span class="org-comment">&lt;&lt; std::endl;</span>
       <span class="org-comment-delimiter">// </span><span class="org-comment">Force writing buffer to the stdout</span>
       <span class="org-constant">std</span>::cout.flush<span class="org-rainbow-delimiters-depth-3">()</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Cleanup Winsock, release resource and exit application.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-function-name">std</span>::cerr &lt;&lt; <span class="org-string">"Finished."</span> &lt;&lt; <span class="org-constant">std</span>::endl;   
::closesocket<span class="org-rainbow-delimiters-depth-1">(</span>client<span class="org-rainbow-delimiters-depth-1">)</span>;
::WSACleanup<span class="org-rainbow-delimiters-depth-1">()</span>;    
<span class="org-comment-delimiter">// </span><span class="org-comment">Returns status code 0</span>
<span class="org-keyword">return</span> EXIT_SUCCESS;
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org3c4e25f" class="outline-3">
<h3 id="org3c4e25f"><span class="section-number-3">1.28</span> WinlNet and UrlMon - APIs for HTTP and FTP protocol</h3>
<div class="outline-text-3" id="text-1-28">
</div>
<div id="outline-container-orgec1e9ab" class="outline-4">
<h4 id="orgec1e9ab"><span class="section-number-4">1.28.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-28-1">
<p>
Windows provides many ready-to-use high level APIs for accessing
most used internet procols such as Http and Ftp, which makes easier to
deal with those protocols without reiventing the whell and caring
about their implementation or low level details. Those APIs are
exposed through the DLLs <span class="underline">wininet.dll</span> and <span class="underline">urlmon.dll</span>.  
</p>

<p>
See: <a href="https://docs.microsoft.com/en-us/windows/desktop/wininet/wininet-functions">WinINet Functions | Microsoft Docs</a>
</p>

<p>
Functions in <span class="underline">wininet.dll</span>
</p>

<ul class="org-ul">
<li>InternetOpen
<ul class="org-ul">
<li>Initializes Winnet environment. This function must be called
before any other Winnet function.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">HINTERNET <span class="org-type">WINAPI</span> <span class="org-function-name">InternetOpen</span><span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpszAgent</span>,
    <span class="org-type">DWORD</span>   <span class="org-variable-name">dwAccessType</span>,
    <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpszProxyName</span>, 
    <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpszProxyBypass</span>, 
    <span class="org-type">DWORD</span>   <span class="org-variable-name">dwFlags</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>InternetConnect
<ul class="org-ul">
<li>Starts new HTTP or FTP session</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HINTERNET</span> <span class="org-function-name">InternetConnect</span><span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-type">HINTERNET</span>       <span class="org-variable-name">hInternet</span>,
    <span class="org-type">LPCTSTR</span>         <span class="org-variable-name">lpszServerName</span>,
    <span class="org-type">INTERNET_PORT</span>   <span class="org-variable-name">nServerPort</span>,
    <span class="org-type">LPCTSTR</span>         <span class="org-variable-name">lpszUsername</span>,
    <span class="org-type">LPCTSTR</span>         <span class="org-variable-name">lpszPassword</span>,
    <span class="org-type">DWORD</span>           <span class="org-variable-name">dwService</span>,
    <span class="org-type">DWORD</span>           <span class="org-variable-name">dwFlags</span>,
    <span class="org-type">DWORD_PTR</span>       <span class="org-variable-name">dwContext</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>HttpOpenRequest</li>

<li>HttpQueryInfo</li>

<li>HttpAddRequestHeaders</li>

<li>HttpSendRequest</li>

<li>HttpSendRequest</li>

<li>InternetReadFile</li>

<li>InternetCloseHandle
<ul class="org-ul">
<li>Close internet connection and ends any ongoing operation.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">InternetCloseHandle</span><span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-type">HINTERNET</span> <span class="org-variable-name">hInternet</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>InternetReadFile</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">InternetReadFile</span><span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-type">HINTERNET</span> <span class="org-variable-name">hFile</span>,
    <span class="org-type">LPVOID</span>    <span class="org-variable-name">lpBuffer</span>,
    <span class="org-type">DWORD</span>     <span class="org-variable-name">dwNumberOfBytesToRead</span>,
    <span class="org-type">LPDWORD</span>   <span class="org-variable-name">lpdwNumberOfBytesRead</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbd0216f" class="outline-4">
<h4 id="orgbd0216f"><span class="section-number-4">1.28.2</span> Example</h4>
<div class="outline-text-4" id="text-1-28-2">
<p>
Source: 
</p>

<ul class="org-ul">
<li>File: <a href="src/windows/client-socket-shell1.cpp">file:src/windows/winlNet-basic.cpp</a></li>
<li>GIST: <a href="https://gist.github.com/caiorss/28cd50c6f3ac08c4b8671e7c7aac515e">winlNet-basic.cpp</a></li>
</ul>

<p>
<b>File</b> 
</p>

<p>
File: <span class="underline">winlNet-basic.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdio</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">urlmon.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    <span class="org-comment-delimiter">//</span><span class="org-comment">Provides URLDownloadToFileW </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">wininet.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>   
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">tchar.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Only for MSVC</span>
<span class="org-preprocessor">#pragma</span> comment<span class="org-rainbow-delimiters-depth-1">(</span>lib, <span class="org-string">"urlmon.lib"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#pragma</span> comment<span class="org-rainbow-delimiters-depth-1">(</span>lib, <span class="org-string">"wininet.lib"</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-keyword">auto</span> <span class="org-function-name">launchedFromConsole</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">bool</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Simple C++ wrapper for the function: URLDownloadToFileA</span>
<span class="org-type">HRESULT</span> <span class="org-function-name">downloadFile</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">url</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">void</span> <span class="org-function-name">testHTTPRequest</span><span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(){</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">==================  File Download  ========================= //</span>
        <span class="org-comment-delimiter">//</span>
        <span class="org-type">HRESULT</span> <span class="org-variable-name">hr</span>;

        hr = downloadFile<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"http://httpbin.org/image/jpeg"</span>, <span class="org-string">"image.jpeg"</span><span class="org-rainbow-delimiters-depth-2">)</span>;   
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hr<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Download successful OK."</span> &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-keyword">else</span>
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Download failed."</span> &lt;&lt; <span class="org-string">'\n'</span>;

        hr = downloadFile<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"httpxpabin.org/image/jpeg-error"</span>, <span class="org-string">"image2.jpeg"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>hr<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Download sucessful OK."</span> &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-keyword">else</span>
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Download failed."</span> &lt;&lt; <span class="org-string">'\n'</span>;

        <span class="org-comment-delimiter">//</span><span class="org-comment">=============== HTTP Protocol ===================================//</span>
        <span class="org-comment-delimiter">//</span>
        testHTTPRequest<span class="org-rainbow-delimiters-depth-2">()</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>launchedFromConsole<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Type RETURN to exit"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-constant">std</span>::cin.get<span class="org-rainbow-delimiters-depth-3">()</span>;     
        <span class="org-rainbow-delimiters-depth-2">}</span>   
        <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-function-name">launchedFromConsole</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-type">DWORD</span> <span class="org-variable-name">procIDs</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span>;
        <span class="org-type">DWORD</span> <span class="org-variable-name">maxCount</span> = 2;
        <span class="org-type">DWORD</span> <span class="org-variable-name">result</span> = GetConsoleProcessList<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">LPDWORD</span><span class="org-rainbow-delimiters-depth-3">)</span>procIDs, maxCount<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">return</span> result != 1;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">HRESULT</span> <span class="org-function-name">downloadFile</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">url</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-type">HRESULT</span> <span class="org-variable-name">hr</span> = URLDownloadToFileA<span class="org-rainbow-delimiters-depth-2">(</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">(pCaller)    Pointer to IUknown instance (not needed)</span>
                <span class="org-constant">NULL</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">(szURL)      URL to the file that will be downloaded</span>
                ,url.c_str<span class="org-rainbow-delimiters-depth-3">()</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">(szFileName) File name that the downloaded file will be saved.</span>
                ,file.c_str<span class="org-rainbow-delimiters-depth-3">()</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">(dwReserved) Reserverd - always 0</span>
                ,0
                <span class="org-comment-delimiter">// </span><span class="org-comment">(lpfnCB)     Status callback</span>
                ,<span class="org-constant">NULL</span>       
                <span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">return</span> hr;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">testHTTPRequest</span><span class="org-rainbow-delimiters-depth-1">(){</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Reference: http://www.cplusplus.com/forum/beginner/75062/</span>
        <span class="org-type">HINTERNET</span> <span class="org-variable-name">hConnect</span> = InternetOpen<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Fake browser"</span>,INTERNET_OPEN_TYPE_PRECONFIG,<span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>hConnect<span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: Connection Failure."</span>;
                <span class="org-keyword">return</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-type">HINTERNET</span> <span class="org-variable-name">hAddr</span> = InternetOpenUrl<span class="org-rainbow-delimiters-depth-2">(</span>
                hConnect
                ,<span class="org-string">"http://www.httpbin.org/get"</span>
                ,<span class="org-constant">NULL</span>
                ,0
                ,INTERNET_FLAG_PRAGMA_NOCACHE | INTERNET_FLAG_KEEP_CONNECTION
                ,0
                <span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>hAddr <span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-type">DWORD</span> <span class="org-variable-name">errorCode</span> = GetLastError<span class="org-rainbow-delimiters-depth-3">()</span>;
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Failed to open URL"</span> &lt;&lt; <span class="org-string">'\n'</span> &lt;&lt; <span class="org-string">"Error Code = "</span> &lt;&lt; errorCode;
                InternetCloseHandle<span class="org-rainbow-delimiters-depth-3">(</span>hConnect<span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-keyword">return</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer size - 4kb or 4096 bytes </span>
        <span class="org-type">char</span>  <span class="org-variable-name">bytesReceived</span><span class="org-rainbow-delimiters-depth-2">[</span>4096<span class="org-rainbow-delimiters-depth-2">]</span>;
        <span class="org-type">DWORD</span> <span class="org-variable-name">NumOfBytesReceived</span> = 0;
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>InternetReadFile<span class="org-rainbow-delimiters-depth-3">(</span>hAddr, bytesReceived, 4096, &amp;NumOfBytesReceived<span class="org-rainbow-delimiters-depth-3">)</span> &amp;&amp; NumOfBytesReceived <span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-constant">std</span>::cout &lt;&lt; bytesReceived;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        InternetCloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hAddr<span class="org-rainbow-delimiters-depth-2">)</span>;
        InternetCloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hConnect<span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">//</span>
</pre>
</div>

<p>
<b>Compiling and running:</b>
</p>

<p>
Compile with MSVC: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe winlNet-basic.cpp /EHsc /Zi /nologo /Fe:winlNet.exe
</pre>
</div>

<p>
Compile with Mingw/GCC: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ winlNet-basic.cpp -o <span class="org-keyword">winlNet-basic.exe</span> -lwininet -lurlmon -std=c++14
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ winlNet-basic.exe 

Download successful OK.
Download failed.
{
  <span class="org-string">"args"</span>: {}, 
  <span class="org-string">"headers"</span>: {
    <span class="org-string">"Cache-Control"</span>: <span class="org-string">"no-cache"</span>, 
    <span class="org-string">"Connection"</span>: <span class="org-string">"close"</span>, 
    <span class="org-string">"Host"</span>: <span class="org-string">"www.httpbin.org"</span>, 
    <span class="org-string">"User-Agent"</span>: <span class="org-string">"Fake browser"</span>
  }, 
  <span class="org-string">"origin"</span>: <span class="org-string">"177.36.10.17"</span>, 
  <span class="org-string">"url"</span>: <span class="org-string">"http://www.httpbin.org/get"</span>
}
&#214;a/&#2;
Compilation <span class="org-compilation-info">finished</span> at Mon Sep  3 09:53:07
</pre>
</div>

<p>
<b>Parts</b> 
</p>

<ul class="org-ul">
<li>Function <span class="underline">downloadFile</span> - Wrappers WinlNet function
URLDownloadToFileA (ANSI version of URLDownloadToFile) to make it
more C++-friendly. This function just downloads a file from a URL.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HRESULT</span> <span class="org-function-name">downloadFile</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">url</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-1">){</span>
   <span class="org-type">HRESULT</span> <span class="org-variable-name">hr</span> = URLDownloadToFileA<span class="org-rainbow-delimiters-depth-2">(</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">(pCaller)    Pointer to IUknown instance (not needed)</span>
        <span class="org-constant">NULL</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">(szURL)      URL to the file that will be downloaded</span>
        ,url.c_str<span class="org-rainbow-delimiters-depth-3">()</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">(szFileName) File name that the downloaded file will be saved.</span>
        ,file.c_str<span class="org-rainbow-delimiters-depth-3">()</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">(dwReserved) Reserverd - always 0</span>
        ,0
        <span class="org-comment-delimiter">// </span><span class="org-comment">(lpfnCB)     Status callback</span>
        ,<span class="org-constant">NULL</span>       
        <span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">return</span> hr;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Tests HTTP GET request to <a href="http:://www.httpbin.org/get">http:://www.httpbin.org/get</a> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">testHTTPRequest</span><span class="org-rainbow-delimiters-depth-1">(){</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Reference: http://www.cplusplus.com/forum/beginner/75062/</span>
     <span class="org-type">HINTERNET</span> <span class="org-variable-name">hConnect</span> = InternetOpen<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Fake browser"</span>,INTERNET_OPEN_TYPE_PRECONFIG,<span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>hConnect<span class="org-rainbow-delimiters-depth-2">){</span>
             <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: Connection Failure."</span>;
             <span class="org-keyword">return</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-type">HINTERNET</span> <span class="org-variable-name">hAddr</span> = InternetOpenUrl<span class="org-rainbow-delimiters-depth-2">(</span>
          hConnect
          ,<span class="org-string">"http://www.httpbin.org/get"</span>
          ,<span class="org-constant">NULL</span>
          ,0
          ,INTERNET_FLAG_PRAGMA_NOCACHE | INTERNET_FLAG_KEEP_CONNECTION
          ,0
          <span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>hAddr <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-type">DWORD</span> <span class="org-variable-name">errorCode</span> = GetLastError<span class="org-rainbow-delimiters-depth-3">()</span>;
          <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Failed to open URL"</span> &lt;&lt; <span class="org-string">'\n'</span> &lt;&lt; <span class="org-string">"Error Code = "</span> &lt;&lt; errorCode;
          InternetCloseHandle<span class="org-rainbow-delimiters-depth-3">(</span>hConnect<span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-keyword">return</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer size - 4kb or 4096 bytes </span>
     <span class="org-type">char</span>  <span class="org-variable-name">bytesReceived</span><span class="org-rainbow-delimiters-depth-2">[</span>4096<span class="org-rainbow-delimiters-depth-2">]</span>;
     <span class="org-type">DWORD</span> <span class="org-variable-name">NumOfBytesReceived</span> = 0;
     <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>InternetReadFile<span class="org-rainbow-delimiters-depth-3">(</span>hAddr, bytesReceived, 4096, &amp;NumOfBytesReceived<span class="org-rainbow-delimiters-depth-3">)</span> &amp;&amp; NumOfBytesReceived <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
             <span class="org-constant">std</span>::cout &lt;&lt; bytesReceived;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     InternetCloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hAddr<span class="org-rainbow-delimiters-depth-2">)</span>;
     InternetCloseHandle<span class="org-rainbow-delimiters-depth-2">(</span>hConnect<span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- EoF testHTTPRequest() --- // </span>

</pre>
</div>

<p>
Main function: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">==================  File Download  ========================= //</span>
<span class="org-comment-delimiter">//</span>
<span class="org-type">HRESULT</span> <span class="org-variable-name">hr</span>;

hr = downloadFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"http://httpbin.org/image/jpeg"</span>, <span class="org-string">"image.jpeg"</span><span class="org-rainbow-delimiters-depth-1">)</span>;   
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-2">(</span>hr<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Download successful OK."</span> &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-keyword">else</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Download failed."</span> &lt;&lt; <span class="org-string">'\n'</span>;

hr = downloadFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"httpxpabin.org/image/jpeg-error"</span>, <span class="org-string">"image2.jpeg"</span><span class="org-rainbow-delimiters-depth-1">)</span>;    
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-2">(</span>hr<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Download sucessful OK."</span> &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-keyword">else</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Download failed."</span> &lt;&lt; <span class="org-string">'\n'</span>;

<span class="org-comment-delimiter">//</span><span class="org-comment">=============== HTTP Protocol ===================================//</span>
<span class="org-comment-delimiter">//</span>
testHTTPRequest<span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-negation-char">!</span>launchedFromConsole<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Type RETURN to exit"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-constant">std</span>::cin.get<span class="org-rainbow-delimiters-depth-2">()</span>;     
<span class="org-rainbow-delimiters-depth-1">}</span>   
<span class="org-keyword">return</span> 0;
</pre>
</div>
</div>
</div>

<div id="outline-container-org99cd734" class="outline-4">
<h4 id="org99cd734"><span class="section-number-4">1.28.3</span> Reference</h4>
<div class="outline-text-4" id="text-1-28-3">
<ul class="org-ul">
<li><a href="https://codereview.stackexchange.com/questions/69801/wininet-c-wrapper">http - WinInet C++ Wrapper - Code Review Stack Exchange</a></li>

<li><a href="https://www.mql5.com/en/articles/73">Using WinInet.dll for Data Exchange between Terminals via the Internet - MQL5 Articles</a></li>

<li><a href="http://blog.lekevin.com/computer/using-the-wininet-api-to-access-the-internet-from-visual-basic-6/">Using the WinInet API to access the internet from Visual Basic 6 - Le Kevin</a></li>

<li><a href="http://www.devx.com/getHelpOn/10MinuteSolution/20373">WinInet
API Programming</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgdaeac3a" class="outline-3">
<h3 id="orgdaeac3a"><span class="section-number-3">1.29</span> Remote repl - telnet-like application</h3>
<div class="outline-text-3" id="text-1-29">
<p>
The following remote repl (Read-Eval-Print-Loop) application allows
accessing Windows shells, such as Powershell or cmd.exe, from remote
machines, including Linux or MacOSX machines. The application can work
in server-mode, which the programs waits for remote client to connect,
or in client-mode, which the program connects to an already running
netcat server. The sample application was used for remotely accessing
a Windows 10 virtual machine from Linux through a NAT (Network Address
Translator) network interface.
</p>

<p>
<b>Project Files</b>
</p>

<p>
File: <span class="underline">CMakeLists.txt</span> 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.0)
<span class="org-function-name">project</span>(cpp-windows)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)
<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD_REQUIRED ON)
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

       <span class="org-function-name">add_executable</span>(remote-repl remote-repl.cpp)
<span class="org-function-name">target_link_libraries</span>(remote-repl ws2_32)
</pre>
</div>

<p>
File: <span class="underline">remote-repl.cpp</span>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor"> #include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-comment-delimiter">// </span><span class="org-comment">#include &lt;exception&gt;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">#include &lt;new&gt;</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">winsock2.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-keyword">class</span> <span class="org-type">Socket</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_host</span>;
  <span class="org-type">bool</span>        <span class="org-variable-name">m_cleanup</span>;
  <span class="org-type">int</span>         <span class="org-variable-name">m_port</span>;
  <span class="org-type">SOCKET</span>      <span class="org-variable-name">m_socket</span>;
  <span class="org-type">SOCKADDR_IN</span> <span class="org-variable-name">m_addr</span>;
  <span class="org-keyword">static</span> <span class="org-type">bool</span> <span class="org-variable-name">isInitialized</span>;

<span class="org-function-name">public</span>:

  <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy contructor</span>
  <span class="org-function-name">Socket</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">Socket</span>&amp; <span class="org-variable-name">sock</span><span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;

  <span class="org-function-name">Socket</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">Socket</span>&amp;&amp; <span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">default</span>;

  <span class="org-function-name">Socket</span><span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Set up client 2.2</span>
    <span class="org-type">WSADATA</span> <span class="org-variable-name">wsaData</span>;
    WSAStartup<span class="org-rainbow-delimiters-depth-3">(</span>MAKEWORD<span class="org-rainbow-delimiters-depth-4">(</span>2,2<span class="org-rainbow-delimiters-depth-4">)</span>, &amp;wsaData<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">m_socket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span>
    m_socket = WSASocket<span class="org-rainbow-delimiters-depth-3">(</span> AF_INET
                          ,SOCK_STREAM
                          ,IPPROTO_TCP
                          ,<span class="org-constant">NULL</span>
                          ,<span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">unsigned</span> <span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span><span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-4">)</span>
                          ,<span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">unsigned</span> <span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span><span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-4">)</span>
                          <span class="org-rainbow-delimiters-depth-3">)</span>; 

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_socket == INVALID_SOCKET<span class="org-rainbow-delimiters-depth-3">){</span>
      <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error, I cannot create socket"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>
    memset<span class="org-rainbow-delimiters-depth-3">(</span>&amp;m_addr, 0, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>m_addr<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>


  <span class="org-function-name">Socket</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SOCKET</span> <span class="org-variable-name">sock</span>, <span class="org-type">SOCKADDR_IN</span> <span class="org-variable-name">addr</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    m_socket = sock;
    m_addr = addr;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  ~<span class="org-function-name">Socket</span><span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_cleanup<span class="org-rainbow-delimiters-depth-3">){</span>
      <span class="org-constant">std</span>::cerr  &lt;&lt; <span class="org-string">" [INFO ] Cleanup OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
      closesocket<span class="org-rainbow-delimiters-depth-4">(</span>m_socket<span class="org-rainbow-delimiters-depth-4">)</span>;
      WSACleanup<span class="org-rainbow-delimiters-depth-4">()</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">bool</span> <span class="org-function-name">isValid</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> 
  <span class="org-rainbow-delimiters-depth-2">{</span>
     <span class="org-keyword">return</span> m_socket != -1;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">void</span> <span class="org-function-name">setNotCleanup</span><span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    m_cleanup = <span class="org-constant">false</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">For client-socket only </span>
  <span class="org-type">void</span> <span class="org-function-name">connect</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">hostname</span>, <span class="org-type">int</span> <span class="org-variable-name">port</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Connecting to server"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-comment-delimiter">// </span><span class="org-comment">throw std::runtime_error("Connection failure.");</span>
    m_host                 = hostname;
    m_port                 = port;    
    m_addr.sin_family      = AF_INET;
    m_addr.sin_addr.s_addr = inet_addr<span class="org-rainbow-delimiters-depth-3">(</span>hostname.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    m_addr.sin_port        = htons<span class="org-rainbow-delimiters-depth-3">(</span>port<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-type">int</span> <span class="org-variable-name">connval</span> = WSAConnect<span class="org-rainbow-delimiters-depth-3">(</span>m_socket,
                             <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">SOCKADDR</span>*<span class="org-rainbow-delimiters-depth-4">&gt;(</span>&amp;m_addr<span class="org-rainbow-delimiters-depth-4">)</span>,
                             <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>m_addr<span class="org-rainbow-delimiters-depth-4">)</span>, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>
                             <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>connval == SOCKET_ERROR<span class="org-rainbow-delimiters-depth-3">){</span>
      <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: cannot connect to server &lt;"</span> + m_host + <span class="org-string">":"</span> + <span class="org-constant">std</span>::to_string<span class="org-rainbow-delimiters-depth-5">(</span>m_port<span class="org-rainbow-delimiters-depth-5">)</span> + <span class="org-string">"&gt;"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">throw std::runtime_error("Error: cannot connect to server");</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"I am connected. OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;    
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">For server-socket (aka listening socket only)</span>
  <span class="org-type">void</span> <span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">hostname</span>, <span class="org-type">int</span> <span class="org-variable-name">port</span>, <span class="org-type">int</span> <span class="org-variable-name">backlog</span> = 5<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    m_host                 = hostname;
    m_port                 = port;    
    m_addr.sin_family      = AF_INET;
    m_addr.sin_addr.s_addr = inet_addr<span class="org-rainbow-delimiters-depth-3">(</span>hostname.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    m_addr.sin_port        = htons<span class="org-rainbow-delimiters-depth-3">(</span>port<span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">TODO =&gt; Implement error handler</span>
    assert<span class="org-rainbow-delimiters-depth-3">(</span> ::bind<span class="org-rainbow-delimiters-depth-4">(</span> m_socket, <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">SOCKADDR</span>*<span class="org-rainbow-delimiters-depth-5">)</span> &amp;m_addr , <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-5">(</span>m_addr<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span> != -1 <span class="org-rainbow-delimiters-depth-3">)</span>;

    assert<span class="org-rainbow-delimiters-depth-3">(</span> listen<span class="org-rainbow-delimiters-depth-4">(</span>m_socket, backlog<span class="org-rainbow-delimiters-depth-4">)</span> != -1 <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">int enable = 1;  </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">int result =  setsockopt( m_socket, SOL_SOCKET, SO_REUSEADDR, &amp;enable, sizeof(int) ); </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">assert( resutl != -1);</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">For server socket only =&gt;&gt; </span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">Block current thread and wait for new client connection. </span>
  <span class="org-type">Socket</span> <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-type">SOCKET</span> <span class="org-variable-name">client</span> ;
    <span class="org-type">SOCKADDR_IN</span> <span class="org-variable-name">addr</span>;
    <span class="org-type">int</span> <span class="org-variable-name">len</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>addr<span class="org-rainbow-delimiters-depth-3">)</span>;
    client = ::accept<span class="org-rainbow-delimiters-depth-3">(</span>m_socket, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">SOCKADDR</span>*<span class="org-rainbow-delimiters-depth-4">)</span> &amp;addr, &amp;len<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">assert( client != -1);</span>
    <span class="org-keyword">return</span> Socket<span class="org-rainbow-delimiters-depth-3">(</span>client, addr<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">void</span> <span class="org-function-name">disconnect</span><span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    closesocket<span class="org-rainbow-delimiters-depth-3">(</span>m_socket<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">void</span> <span class="org-function-name">send</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">len</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span> = 0<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
  <span class="org-rainbow-delimiters-depth-2">{</span>
    ::send<span class="org-rainbow-delimiters-depth-3">(</span>m_socket, buffer, len, flags<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span> 

  <span class="org-type">int</span> <span class="org-function-name">recev</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">char</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">len</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span>  = 0<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> ::recv<span class="org-rainbow-delimiters-depth-3">(</span>m_socket, buffer, len , flags<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">void</span> <span class="org-function-name">sendText</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    ::send<span class="org-rainbow-delimiters-depth-3">(</span>m_socket, text.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, text.size<span class="org-rainbow-delimiters-depth-4">()</span>, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">void</span> <span class="org-function-name">sendLine</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">line</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">this</span>-&gt;sendText<span class="org-rainbow-delimiters-depth-3">(</span>line + <span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>  

  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">recevText</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-3">(</span>size, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-type">int</span> <span class="org-variable-name">n</span> = ::recv<span class="org-rainbow-delimiters-depth-3">(</span>m_socket, &amp;buffer<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>, size , 0<span class="org-rainbow-delimiters-depth-3">)</span>;
    buffer.resize<span class="org-rainbow-delimiters-depth-3">(</span>n<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-keyword">return</span> buffer;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">HANDLE</span> <span class="org-function-name">handle</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> 
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">HANDLE</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>m_socket<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">//</span><span class="org-comment">---- EoF class ClientSocket ---- //</span>


<span class="org-type">void</span> <span class="org-function-name">makeRemoteRepl</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">Socket</span>&amp; <span class="org-variable-name">sock</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">cmdline</span>, <span class="org-type">bool</span> <span class="org-variable-name">waitFlag</span> = <span class="org-constant">false</span><span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> argc &lt; 5 <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Usage "</span> 
              &lt;&lt; <span class="org-string">" \n $ client "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" &lt;HOSTNAME&gt; &lt;PORT&gt; &lt;PROGRAM&gt; "</span>
              &lt;&lt; <span class="org-string">" \n $ server "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" &lt;HOSTNAME&gt; &lt;PORT&gt; &lt;PROGRAM&gt; "</span>
              &lt;&lt; <span class="org-constant">std</span>::endl;

    <span class="org-keyword">return</span> EXIT_FAILURE;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">command</span>  = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;  
  <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">address</span>  = argv<span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span>; 
  <span class="org-keyword">const</span> <span class="org-type">DWORD</span>       <span class="org-variable-name">port</span>     = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">shell</span>    = argv<span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;

  <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Running main"</span> &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> command == <span class="org-string">"server"</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-type">Socket</span> <span class="org-variable-name">server</span>;
    server.bind<span class="org-rainbow-delimiters-depth-3">(</span>address, port, 5<span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Socket server infinite loop  </span>
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span>;;<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Waiting client connection. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-type">Socket</span> <span class="org-variable-name">client</span> = server.accept<span class="org-rainbow-delimiters-depth-4">()</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-negation-char">!</span> client.isValid<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
        makeRemoteRepl<span class="org-rainbow-delimiters-depth-4">(</span>client, shell, <span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> command == <span class="org-string">"client"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">for</span> <span class="org-rainbow-delimiters-depth-3">(</span>;;<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-type">Socket</span> <span class="org-variable-name">client</span>;
      client.setNotCleanup<span class="org-rainbow-delimiters-depth-4">()</span>;

      <span class="org-keyword">while</span> <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">try</span>
        <span class="org-rainbow-delimiters-depth-5">{</span>
          <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Trying to connect to server"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
          client.connect<span class="org-rainbow-delimiters-depth-6">(</span>address, port<span class="org-rainbow-delimiters-depth-6">)</span>;
          <span class="org-keyword">break</span>;
        <span class="org-rainbow-delimiters-depth-5">}</span>
        <span class="org-keyword">catch</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">exception</span> &amp;<span class="org-variable-name">e</span><span class="org-rainbow-delimiters-depth-5">)</span>
        <span class="org-rainbow-delimiters-depth-5">{</span>
          <span class="org-constant">std</span>::cerr &lt;&lt; e.what<span class="org-rainbow-delimiters-depth-6">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
          <span class="org-comment-delimiter">//</span><span class="org-comment">exit(EXIT_FAILURE);</span>
        <span class="org-rainbow-delimiters-depth-5">}</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Socket connected OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
      client.sendLine<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">" [LOG] Client socket running OK!"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
      makeRemoteRepl<span class="org-rainbow-delimiters-depth-4">(</span>client, shell, <span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">Connection loop - </span>
  <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"End successfully"</span> &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Returns status code 0</span>
  <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----------------------------------------------------- // </span>


<span class="org-type">void</span> <span class="org-function-name">makeRemoteRepl</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-keyword">const</span> <span class="org-type">Socket</span>&amp; <span class="org-variable-name">sock</span>
                    , <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">cmdline</span>
                    , <span class="org-type">bool</span> <span class="org-variable-name">waitFlag</span> 
                    <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">Create process </span>
  <span class="org-type">PROCESS_INFORMATION</span> <span class="org-variable-name">pi</span>;
  <span class="org-type">STARTUPINFO</span> <span class="org-variable-name">sui</span>;
  memset<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sui, 0, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>sui<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;  
  sui.cb          = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>sui<span class="org-rainbow-delimiters-depth-2">)</span>;
  sui.dwFlags     = STARTF_USESTDHANDLES ; <span class="org-comment-delimiter">// </span><span class="org-comment">| STARTF_USESHOWWINDOW;</span>
  sui.wShowWindow = SW_HIDE;
  sui.hStdInput   = sock.handle<span class="org-rainbow-delimiters-depth-2">()</span>;
  sui.hStdOutput  = sock.handle<span class="org-rainbow-delimiters-depth-2">()</span>; 
  sui.hStdError   = sock.handle<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-type">int</span> <span class="org-variable-name">bSuccess</span> = CreateProcessA<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">NULL</span>, <span class="org-keyword">const_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span>LPSTR<span class="org-rainbow-delimiters-depth-3">&gt;(</span>cmdline.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>
                , <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>, TRUE, CREATE_NO_WINDOW, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>, &amp;sui, &amp;pi<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>bSuccess<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    sock.sendLine<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO ] Remote repl session started OK.!"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    sock.sendLine<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO ] Success code    = "</span> + <span class="org-constant">std</span>::to_string<span class="org-rainbow-delimiters-depth-4">(</span>bSuccess<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">pid</span> = GetProcessId<span class="org-rainbow-delimiters-depth-3">(</span>pi.hProcess<span class="org-rainbow-delimiters-depth-3">)</span>;
    sock.sendLine<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO ] Process ID &lt;PID&gt; = "</span> + <span class="org-constant">std</span>::to_string<span class="org-rainbow-delimiters-depth-4">(</span>pid<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    sock.sendLine<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [ERROR] Failed to create process."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>waitFlag<span class="org-rainbow-delimiters-depth-2">){</span>
    WaitForSingleObject<span class="org-rainbow-delimiters-depth-3">(</span> pi.hProcess, INFINITE <span class="org-rainbow-delimiters-depth-3">)</span>;
    CloseHandle<span class="org-rainbow-delimiters-depth-3">(</span> pi.hProcess <span class="org-rainbow-delimiters-depth-3">)</span>;
    CloseHandle<span class="org-rainbow-delimiters-depth-3">(</span> pi.hThread <span class="org-rainbow-delimiters-depth-3">)</span>;
    sock.sendLine<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [LOG] Process finished."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake -B_build -G <span class="org-string">"MinGW Makefiles"</span> -DCMAKE_BUILD_TYPE=Debug
$ cmake --build --target all
</pre>
</div>


<p>
<b>Running application in client mode</b> 
</p>

<p>
Linux Remote terminal: (netcat server)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">User types commands here that are sent to Windows machine.</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Run netcat as server </span>
$ rlwrap nc -nlvp 9010
Listening on 0.0.0.0 9010
Connection received on 192.168.1.105 53950
[LOG] Client socket running OK!
[INFO ] Remote repl session started OK.!
[INFO ] Success code    = 1
[INFO ] Process ID &lt;PID&gt; = 1552
Windows PowerShell
<span class="org-function-name">Copyright</span> (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:<span class="org-string">\&gt;</span> whoami
whoami

desktop-36ar81f\nixuserp


PS C:<span class="org-string">\&gt;</span> netstat -a
netstat -a

Active Connections

Proto  Local Address          Foreign Address        State
TCP    0.0.0.0:135            184-86-53-99:0         LISTENING
TCP    0.0.0.0:445            184-86-53-99:0         LISTENING
TCP    0.0.0.0:5357           184-86-53-99:0         LISTENING
TCP    0.0.0.0:5985           184-86-53-99:0         LISTENING
TCP    0.0.0.0:47001          184-86-53-99:0         LISTENING
TCP    0.0.0.0:49664          184-86-53-99:0         LISTENING

... ...     ... ...   ... ...   ... ...   ... ...   ... ...   ... ... 
... ...   ... ...   ... ...   ... ...   ... ...   ... ...   ... ... 

PS C:<span class="org-string">\&gt;</span> exit
<span class="org-keyword">exit</span>
[LOG] Process finished.
</pre>
</div>

<p>
Windows terminal: (client)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ remote-repl.exe client 192.168.1.115 9010 powershell

Running main
Trying to connect to server
Connecting to server
I am connected. OK.
Socket connected OK.

</pre>
</div>

<p>
<b>Running application in server mode</b> 
</p>

<p>
Windows terminal: (server)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ remote-repl.exe server 0.0.0.0 9010 powershell
Running main
[TRACE] Waiting client connection.

</pre>
</div>

<p>
Linux remote terminal (client)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">User types commands here that are sent to Windows machine.</span>

$ rlwrap nc 192.168.1.105 9010
[INFO ] Remote repl session started OK.!
[INFO ] Success code    = 1
[INFO ] Process ID &lt;PID&gt; = 4912
Windows PowerShell
<span class="org-function-name">Copyright</span> (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:<span class="org-string">\&gt;</span> whoami
whoami

desktop-36ar81f\nixuserp
PS C:<span class="org-string">\&gt;</span> 


PS C:<span class="org-string">\&gt;</span> ls -Force /
ls -Force /


    Directory: C:<span class="org-sh-escaped-newline">\</span>


Mode                LastWriteTime         Length Name                                                                  
----                -------------         ------ ----                                                                  
d--hs-        9/19/2021   9:47 AM                $<span class="org-variable-name">Recycle</span>.Bin                                                          
d--hs-        9/27/2021  11:53 AM                Config.Msi                                                            
d--hsl        9/19/2021   9:40 AM                Documents and Settings                                                
d-----        3/18/2019   9:52 PM                PerfLogs                                                              
d-r---        9/27/2021  11:53 AM                Program Files                                                         
d-r---        9/27/2021  11:53 AM                Program Files (x86)                                                   
d--h--        9/27/2021  11:53 AM                ProgramData                                                           
d--hs-        9/19/2021   9:41 AM                Recovery                                                              
d--hs-        9/27/2021  11:46 AM                System Volume Information                                             
d-r---        9/19/2021   6:02 AM                Users                                                                 
d-----        9/19/2021   9:48 AM                Windows                                                               
-a-hs-        9/27/2021   5:58 PM      872415232 pagefile.sys                                                          
-a-hs-        9/27/2021   5:58 PM      268435456 swapfile.sys                                                          

</pre>
</div>
</div>
</div>
<div id="outline-container-org539fc36" class="outline-3">
<h3 id="org539fc36"><span class="section-number-3">1.30</span> Embed Resources into Executables</h3>
<div class="outline-text-3" id="text-1-30">
<p>
The Windows API has several facilities for loading embedded resource,
such data such as strings, icon, menus and any arbitrary data from
PE32 executables and dynamic linked libraries DLLs. Cross platform
applications should avoid using the Windows APIs be listed in this
section, since they are specific to Windows, therefore they not
portable to other operatingss systems. Applications aiming portability
should libraries such as <a href="https://github.com/graphitemaster/incbin/">incbin</a> libraries <a href="https://github.com/vector-of-bool/cmrc">cmrc</a> (CMake-Resource
Compiler) and also resource compilers from frameworks such as Qt and
WxWidgets.
</p>

<p>
Windows APIs for dealing with resources:
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/menurc/resources">Menus and Other Resources</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-findresourcea">FindResourceA()</a>
<ul class="org-ul">
<li>"Determines the location of a resource with the specified type
and name in the specified module."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-lockresource">LockResource</a>
<ul class="org-ul">
<li>"Retrieves a pointer to the specified resource in memory."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadresource">LoadResource()</a>
<ul class="org-ul">
<li>"Retrieves a handle that can be used to obtain a pointer to the
first byte of the specified resource in memory."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-sizeofresource">SizeofResource()</a>
<ul class="org-ul">
<li>"Retrieves the size, in bytes, of the specified resource."</li>
</ul></li>
</ul>


<p>
<b>Project Files</b>
</p>

<p>
File: <span class="underline">CMakeLists.txt</span>
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.0)
<span class="org-function-name">project</span>(cpp-windows)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)
<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD_REQUIRED ON)
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-function-name">add_executable</span>(winapp app.cpp myresource.rc VERSIONINFO.rc)
</pre>
</div>

<p>
File: <span class="underline">app.cpp</span>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">struct</span> <span class="org-type">Buffer</span><span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">char</span>*  <span class="org-variable-name">ptr</span>;
  <span class="org-type">size_t</span> <span class="org-variable-name">size</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">Buffer</span> 
<span class="org-function-name">find_resouce</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HMODULE</span> <span class="org-variable-name">hMod</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">name</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  <span class="org-type">HRSRC</span> <span class="org-variable-name">rsrc</span> = FindResourceA<span class="org-rainbow-delimiters-depth-2">(</span>hMod, name, type<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> rsrc != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">HGLOBAL</span> <span class="org-variable-name">hGlobal</span> = LoadResource<span class="org-rainbow-delimiters-depth-2">(</span>hMod, rsrc<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> hGlobal != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to first byte of resource in memory</span>
  <span class="org-type">LPVOID</span> <span class="org-variable-name">pRes</span> = LockResource<span class="org-rainbow-delimiters-depth-2">(</span>hGlobal<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> pRes != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Size of resource in bytes </span>
  <span class="org-type">DWORD</span> <span class="org-variable-name">size</span> = SizeofResource<span class="org-rainbow-delimiters-depth-2">(</span>hMod, rsrc<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>pRes<span class="org-rainbow-delimiters-depth-3">)</span>, size <span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">std</span>::string
find_resouce_text<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HMODULE</span> <span class="org-variable-name">hMod</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">name</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  <span class="org-type">Buffer</span> <span class="org-variable-name">b</span> = find_resouce<span class="org-rainbow-delimiters-depth-2">(</span>hMod, name, type<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">auto</span> <span class="org-variable-name">data</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>b.ptr, b.ptr + b.size<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> data;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">enumerate_resources</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HMODULE</span> <span class="org-variable-name">hMod</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">auto</span> <span class="org-variable-name">callback</span> = <span class="org-rainbow-delimiters-depth-2">[](</span><span class="org-type">HMODULE</span> <span class="org-variable-name">hMod</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span>, <span class="org-type">char</span>* <span class="org-variable-name">name</span>, <span class="org-type">LONG_PTR</span> <span class="org-variable-name">param</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Resource type = "</span> &lt;&lt; type
              &lt;&lt; <span class="org-string">" ; name = "</span> &lt;&lt; name &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-keyword">return</span> TRUE;
  <span class="org-rainbow-delimiters-depth-2">}</span>;

  <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">status</span> = 0;
  <span class="org-type">BOOL</span> <span class="org-variable-name">result</span> = EnumResourceNamesA<span class="org-rainbow-delimiters-depth-2">(</span>hMod, type, callback, status<span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">HMODULE</span> <span class="org-variable-name">hMod</span> = GetModuleHandleA<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> hMod != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  enumerate_resources<span class="org-rainbow-delimiters-depth-2">(</span>hMod, RT_RCDATA<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ----- Display ASCII Art Resource -----"</span> &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-keyword">auto</span> <span class="org-variable-name">data</span> = find_resouce_text<span class="org-rainbow-delimiters-depth-2">(</span>hMod, <span class="org-string">"MYRESOURCE"</span>, RT_RCDATA<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] Resource data = \n"</span> &lt;&lt; data &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-constant">std</span>::cin.get<span class="org-rainbow-delimiters-depth-2">()</span>;
  <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
File: <span class="underline">myresource.rc</span> (Resource script - processed by the resource compiler)
</p>

<div class="org-src-container">
<pre class="src src-txt">MYRESOURCE RCDATA "myresource.txt"
</pre>
</div>

<p>
File: <span class="underline">myresource.txt</span> (resource to be embedded).
</p>

<div class="org-src-container">
<pre class="src src-txt">File with this resource.

"At vero eos et accusamus et iusto odio dignissimos ducimus qui
blanditiis praesentium voluptatum deleniti atque corrupti quos dolores
et quas molestias excepturi sint occaecati cupiditate non provident,
similique sunt in culpa qui officia deserunt mollitia animi, id est
laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita
distinctio. Nam libero tempore, cum soluta nobis est eligendi optio
cumque nihil impedit quo minus id quod maxime placeat facere possimus,
omnis voluptas assumenda est, omnis dolor repellendus. Temporibus
autem quibusdam et aut officiis debitis aut rerum necessitatibus saepe
eveniet ut et voluptates repudiandae sint et molestiae non
recusandae. Itaque earum rerum hic tenetur a sapiente delectus, ut aut
reiciendis voluptatibus maiores alias consequatur aut perferendis
doloribus asperiores repellat."
</pre>
</div>

<p>
File: <span class="underline">VERSIONINFO.rc</span> (Contains metadata indicating version, vendor, product name and so on.)
</p>

<div class="org-src-container">
<pre class="src src-conf"><span class="org-comment-delimiter">#</span><span class="org-comment">include &lt;winver.h&gt;</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">include &lt;ntdef.h&gt;</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">ifdef RC_INVOKED</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">if DBG</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">define VER_DBG VS_FF_DEBUG</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">else</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">define VER_DBG 0</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">endif</span>

VS_VERSION_INFO VERSIONINFO
FILEVERSION             1,0,0,0                 // 1.0.0.0 - Application version 
PRODUCTVERSION          1,0,0,0                 // 1.0.0.0 - Produce version     
FILEFLAGSMASK           VS_FFI_FILEFLAGSMASK
FILEFLAGS               VER_DBG
FILEOS                  VOS_NT
FILETYPE                VFT_DRV
FILESUBTYPE             VFT2_DRV_SYSTEM
BEGIN
        BLOCK <span class="org-string">"StringFileInfo"</span>
        BEGIN
                BLOCK <span class="org-string">"040904b0"</span>
        BEGIN
                VALUE <span class="org-string">"Comments"</span>,         <span class="org-string">"SomeProduct awesome"</span>
                VALUE <span class="org-string">"CompanyName"</span>,      <span class="org-string">"Some company XYZWK, Inc."</span>
                VALUE <span class="org-string">"FileDescription"</span>,  <span class="org-string">"MyProduct"</span>
                VALUE <span class="org-string">"FileVersion"</span>,      <span class="org-string">"V1.0.0.0"</span>
                VALUE <span class="org-string">"InternalName"</span>,     <span class="org-string">"Some super product"</span>
                VALUE <span class="org-string">"LegalCopyright"</span>,   <span class="org-string">"(C)2018 Some company XYZWK .Incorporated."</span>
                VALUE <span class="org-string">"OriginalFilename"</span>, <span class="org-string">"winapp.exe"</span>
                VALUE <span class="org-string">"ProductName"</span>,      <span class="org-string">"SomeProduct"</span>
                VALUE <span class="org-string">"ProductVersion"</span>,   <span class="org-string">"V1.2.3.0"</span>
        END
        END
        BLOCK <span class="org-string">"VarFileInfo"</span>
        BEGIN
                VALUE <span class="org-string">"Translation"</span>, 0x0409,1200
        END
END
<span class="org-comment-delimiter">#</span><span class="org-comment">endif</span>
</pre>
</div>



<p>
<b>Building and running</b>
</p>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake -B_build -G <span class="org-string">"MinGW Makefiles"</span>
$ cmake --build _build --target all 
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build\winapp.exe

[*] Resource type =
----- Display ASCII Art Resource -----
[*] Resource data =
File with this resource.

<span class="org-string">"At vero eos et accusamus et iusto odio dignissimos ducimus qui</span>
<span class="org-string">blanditiis praesentium voluptatum deleniti atque corrupti quos dolores</span>
<span class="org-string">et quas molestias excepturi sint occaecati cupiditate non provident,</span>
<span class="org-string">similique sunt in culpa qui officia deserunt mollitia animi, id est</span>
<span class="org-string">laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita</span>
<span class="org-string">distinctio. Nam libero tempore, cum soluta nobis est eligendi optio</span>
<span class="org-string">cumque nihil impedit quo minus id quod maxime placeat facere possimus,</span>
<span class="org-string">omnis voluptas assumenda est, omnis dolor repellendus. Temporibus</span>
<span class="org-string">autem quibusdam et aut officiis debitis aut rerum necessitatibus saepe</span>
<span class="org-string">eveniet ut et voluptates repudiandae sint et molestiae non</span>
<span class="org-string">recusandae. Itaque earum rerum hic tenetur a sapiente delectus, ut aut</span>
<span class="org-string">reiciendis voluptatibus maiores alias consequatur aut perferendis</span>
<span class="org-string">doloribus asperiores repellat."</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org902305e" class="outline-3">
<h3 id="org902305e"><span class="section-number-3">1.31</span> Graphical User Interfaces - WinAPI</h3>
<div class="outline-text-3" id="text-1-31">
</div>
<div id="outline-container-org8d403cf" class="outline-4">
<h4 id="org8d403cf"><span class="section-number-4">1.31.1</span> Minimal GUI Program - "hello world"</h4>
<div class="outline-text-4" id="text-1-31-1">
</div>
<ol class="org-ol">
<li><a id="orgd6229cd"></a>Overview<br />
<div class="outline-text-5" id="text-1-31-1-1">
<p>
This code contains a minimal graphical user interface with Windows
API.
</p>

<p>
Source:
</p>
<ul class="org-ul">
<li>File: <a href="src/windows/gui-basic1.cpp">file:src/windows/gui-basic1.cpp</a></li>
<li>GIST: <a href="https://gist.github.com/caiorss/cab14ba11e207bbc7beed9a2f0b4ebc4">gui-basic1.cpp</a></li>
</ul>

<p>
<b>Full Code</b> 
</p>

<p>
File: <span class="underline">gui-basic1.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">map</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">set</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

LRESULT <span class="org-type">CALLBACK</span> <span class="org-function-name">windowProcedure</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HWND</span> <span class="org-variable-name">hwnd</span>, <span class="org-type">UINT</span> <span class="org-variable-name">msg</span>, <span class="org-type">WPARAM</span> <span class="org-variable-name">wParam</span>, <span class="org-type">LPARAM</span> <span class="org-variable-name">lParam</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">auto</span> <span class="org-function-name">WinMessageToString</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">UINT</span> <span class="org-variable-name">msg</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;

<span class="org-type">int</span> <span class="org-function-name">WINAPI</span> WinMain<span class="org-rainbow-delimiters-depth-1">(</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Handle to current application isntance </span>
        <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span>,
        <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hPrevInstance</span>,
        <span class="org-comment-delimiter">// </span><span class="org-comment">Command line </span>
        <span class="org-type">LPSTR</span>     <span class="org-variable-name">lpCmdLine</span>,
        <span class="org-type">int</span>       <span class="org-variable-name">nCmdShow</span>
        <span class="org-rainbow-delimiters-depth-1">){</span>

        OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Starting WinMain Application"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"It will not print to Console - Starting WinMain Application"</span><span class="org-rainbow-delimiters-depth-2">)</span>;   

        <span class="org-comment-delimiter">//</span><span class="org-comment">Window class name must be unique </span>
        <span class="org-keyword">const</span> <span class="org-type">char</span> <span class="org-variable-name">wincClassName</span> <span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-string">"NameOfWindow"</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Win32 Window class structure</span>
        <span class="org-type">WNDCLASSEX</span> <span class="org-variable-name">wc</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Win32 message structure </span>
        <span class="org-type">MSG</span> <span class="org-variable-name">Msg</span>;            

       <span class="org-comment-delimiter">// </span><span class="org-comment">Name to identify the class with. </span>
        wc.lpszClassName = wincClassName;
        <span class="org-comment-delimiter">//</span><span class="org-comment">Pointer to the window procedure for this window class. </span>
        wc.lpfnWndProc = windowProcedure;   
        <span class="org-comment-delimiter">// </span><span class="org-comment">1 - Register Windows Size</span>
        wc.cbSize = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>WNDCLASSEX<span class="org-rainbow-delimiters-depth-2">)</span>;

        wc.style  = 0;
        <span class="org-comment-delimiter">//</span><span class="org-comment">Amount of extra data allocated for this class in memory. Usually 0</span>
        wc.cbClsExtra = 0;
        <span class="org-comment-delimiter">//</span><span class="org-comment">Amount of extra data allocated in memory per window of this type. Usually 0. </span>
        wc.cbWndExtra = 0;
        <span class="org-comment-delimiter">//</span><span class="org-comment">Handle to application instance (that we got in the first parameter of WinMain()). </span>
        wc.hInstance = hInstance;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Large (usually 32x32) icon shown when the user presses Alt+Tab. </span>
        wc.hIcon = LoadIcon<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span>, IDI_APPLICATION<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Cursor that will be displayed over our window. </span>
        wc.hCursor = LoadCursor<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span>, IDC_ARROW<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Background Brush to set the color of our window. </span>
        wc.hbrBackground = <span class="org-rainbow-delimiters-depth-2">(</span>HBRUSH<span class="org-rainbow-delimiters-depth-2">)(</span>COLOR_WINDOW+1<span class="org-rainbow-delimiters-depth-2">)</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">(HBRUSH) CreateSolidBrush(RGB(10, 20, 30)); // </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Background Brush to set the color of our window. </span>
        wc.lpszMenuName = <span class="org-constant">NULL</span>; 
        <span class="org-comment-delimiter">// </span><span class="org-comment">Small (usually 16x16) icon to show in the taskbar and in the top left corner of the window. </span>
        wc.hIconSm = LoadIcon<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span>, IDI_APPLICATION<span class="org-rainbow-delimiters-depth-2">)</span>;  

        OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Registered Window Class OK."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>RegisterClassEx<span class="org-rainbow-delimiters-depth-3">(</span>&amp;wc<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> 
        <span class="org-rainbow-delimiters-depth-2">{</span>
                MessageBox<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">NULL</span>,
                           <span class="org-string">"Window Registration Failed!"</span>,
                           <span class="org-string">"Error!"</span>,
                           MB_ICONEXCLAMATION | MB_OK<span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-comment-delimiter">//</span><span class="org-comment">Error status code </span>
                <span class="org-keyword">return</span> -1;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Class Registered"</span> &lt;&lt; <span class="org-constant">std</span>::endl;

        <span class="org-type">int</span> <span class="org-variable-name">width</span> = 500, <span class="org-variable-name">height</span> = 400;
        <span class="org-type">int</span> <span class="org-variable-name">pos_left</span> = 400, <span class="org-variable-name">pos_top</span> = 100;

        <span class="org-type">HWND</span> <span class="org-variable-name">hwnd</span> = CreateWindowA<span class="org-rainbow-delimiters-depth-2">(</span>
                wc.lpszClassName,
                <span class="org-string">"Title of Window"</span>,
                WS_OVERLAPPEDWINDOW,
                pos_left,
                pos_top,
                width,
                height,
                <span class="org-constant">nullptr</span>,
                <span class="org-constant">nullptr</span>,
                hInstance,
                <span class="org-constant">nullptr</span>
                <span class="org-rainbow-delimiters-depth-2">)</span>;  
        OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Window created OK"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hwnd == <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">){</span>
                MessageBox<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">NULL</span>,
                                   <span class="org-string">"Error: Failure to create Window"</span>,
                                   <span class="org-string">"Error Report"</span>,
                                   MB_ICONEXCLAMATION | MB_OK<span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-keyword">return</span> -1;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        ShowWindow<span class="org-rainbow-delimiters-depth-2">(</span>hwnd, nCmdShow<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"nCmdShow = "</span> &lt;&lt; nCmdShow &lt;&lt; <span class="org-constant">std</span>::endl;
        UpdateWindow<span class="org-rainbow-delimiters-depth-2">(</span>hwnd<span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-comment-delimiter">//</span><span class="org-comment">---- Message Loop ----------//</span>
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>GetMessage<span class="org-rainbow-delimiters-depth-3">(</span>&amp;Msg, <span class="org-constant">NULL</span>, 0, 0<span class="org-rainbow-delimiters-depth-3">)</span> &gt; 0 <span class="org-rainbow-delimiters-depth-2">){</span>
                TranslateMessage<span class="org-rainbow-delimiters-depth-3">(</span>&amp;Msg<span class="org-rainbow-delimiters-depth-3">)</span>;
                DispatchMessage<span class="org-rainbow-delimiters-depth-3">(</span>&amp;Msg<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Exiting application. OK."</span><span class="org-rainbow-delimiters-depth-2">)</span>;  
        <span class="org-comment-delimiter">// </span><span class="org-comment">Success status code </span>
        <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">------------ End of Main ------------------------- //</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Window Procedure - Process window messages or events </span>
LRESULT <span class="org-type">CALLBACK</span> <span class="org-function-name">windowProcedure</span> <span class="org-rainbow-delimiters-depth-1">(</span>
         <span class="org-type">HWND</span>   <span class="org-variable-name">hwnd</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Window Handle (Window object)</span>
        ,<span class="org-type">UINT</span>   <span class="org-variable-name">msg</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Window Message  </span>
        ,<span class="org-type">WPARAM</span> <span class="org-variable-name">wParam</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Additional message information</span>
        ,<span class="org-type">LPARAM</span> <span class="org-variable-name">lParam</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Additional message information</span>
        <span class="org-rainbow-delimiters-depth-1">){</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Variable initialized one. </span>
        <span class="org-keyword">static</span> <span class="org-keyword">auto</span> <span class="org-variable-name">ignored_messages</span> = <span class="org-constant">std</span>::<span class="org-type">set</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">UINT</span><span class="org-rainbow-delimiters-depth-2">&gt;{</span>
                WM_MOUSEMOVE, WM_NCHITTEST, WM_SETCURSOR, WM_IME_NOTIFY
        <span class="org-rainbow-delimiters-depth-2">}</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Ignore messages which can flood the logging </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">if(msg != WM_MOUSEMOVE &amp;&amp; msg != WM_NCMOUSEMOVE</span>
        <span class="org-comment-delimiter">//    </span><span class="org-comment">&amp;&amp; msg != WM_QUIT &amp;&amp; msg != WM_NCHITTEST )</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ignored_messages.find<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span> == ignored_messages.end<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>
                OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span>WinMessageToString<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>; 

        <span class="org-comment-delimiter">// </span><span class="org-comment">Process messages </span>
        <span class="org-keyword">switch</span><span class="org-rainbow-delimiters-depth-2">(</span>msg<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-2">{</span>
            <span class="org-keyword">case</span> WM_CREATE:
                    SetWindowTextA<span class="org-rainbow-delimiters-depth-3">(</span>hwnd, <span class="org-string">"Change Window Title"</span><span class="org-rainbow-delimiters-depth-3">)</span>;        
                    OutputDebugString<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO] Window created. OK."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
                    <span class="org-keyword">break</span>;
            <span class="org-keyword">case</span> WM_CLOSE:
                        OutputDebugString<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO] Window closed. OK."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
                        DestroyWindow<span class="org-rainbow-delimiters-depth-3">(</span>hwnd<span class="org-rainbow-delimiters-depth-3">)</span>;
                        <span class="org-keyword">break</span>;
            <span class="org-keyword">case</span> WM_DESTROY:
                        OutputDebugString<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO] Exiting application. OK."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
                        PostQuitMessage<span class="org-rainbow-delimiters-depth-3">(</span>0<span class="org-rainbow-delimiters-depth-3">)</span>;
                        <span class="org-keyword">break</span>;
            <span class="org-keyword">case</span> WM_MOVE:
                    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Move window."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                    <span class="org-keyword">break</span>; 
            <span class="org-keyword">case</span> WM_PAINT:
            <span class="org-rainbow-delimiters-depth-3">{</span>
                    <span class="org-comment-delimiter">// </span><span class="org-comment">GDI - Graphics Devices Interface Here</span>
                    <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------</span>
                    <span class="org-type">PAINTSTRUCT</span> <span class="org-variable-name">ps</span>;
                    <span class="org-type">HDC</span> <span class="org-variable-name">hdc</span>;
                    <span class="org-comment-delimiter">// </span><span class="org-comment">std::cerr &lt;&lt; " [INFO] Windown painting" &lt;&lt; std::endl;</span>
                    hdc = BeginPaint<span class="org-rainbow-delimiters-depth-4">(</span>hwnd, &amp;ps<span class="org-rainbow-delimiters-depth-4">)</span>;
                    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">text</span> = <span class="org-string">"Hello world Window!"</span>;       
                    TextOutA<span class="org-rainbow-delimiters-depth-4">(</span>hdc, 125, 200, text.c_str<span class="org-rainbow-delimiters-depth-5">()</span>, text.size<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                    Ellipse<span class="org-rainbow-delimiters-depth-4">(</span>hdc, 100, 100, 160, 160<span class="org-rainbow-delimiters-depth-4">)</span>;
                    Rectangle<span class="org-rainbow-delimiters-depth-4">(</span>hdc, 100, 100, 160, 160<span class="org-rainbow-delimiters-depth-4">)</span>;
                    EndPaint<span class="org-rainbow-delimiters-depth-4">(</span>hwnd, &amp;ps<span class="org-rainbow-delimiters-depth-4">)</span>;        
            <span class="org-rainbow-delimiters-depth-3">}</span>
            <span class="org-keyword">break</span>;
          <span class="org-keyword">default</span>:
                    <span class="org-keyword">return</span> DefWindowProc<span class="org-rainbow-delimiters-depth-3">(</span>hwnd, msg, wParam, lParam<span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Get a human-readable description of a Windows message as a string */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">WinMessageToString</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">UINT</span> <span class="org-variable-name">msg</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-comment-delimiter">/** </span><span class="org-comment">Database of Windows messages - full list of messages here: </span>
<span class="org-comment">         *   https://wiki.winehq.org/List_Of_Windows_Messages</span>
<span class="org-comment">         */</span>
        <span class="org-keyword">static</span> <span class="org-keyword">auto</span> <span class="org-variable-name">WindowMessages</span> = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">UINT</span>, <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;{</span>
                <span class="org-rainbow-delimiters-depth-3">{</span>1, <span class="org-string">"WM_CREATE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>2, <span class="org-string">"WM_DESTROY"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>5, <span class="org-string">"WM_SIZE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>6, <span class="org-string">"WM_ACTIVATE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>13, <span class="org-string">"WM_SIZE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>22, <span class="org-string">"WM_SETVISIBLE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>23, <span class="org-string">"WM_ENABLE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,  <span class="org-rainbow-delimiters-depth-3">{</span>29, <span class="org-string">"WM_PAINT"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>3, <span class="org-string">"WM_MOVE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>30, <span class="org-string">"WM_CLOSE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>32, <span class="org-string">"WM_SETCURSOR"</span><span class="org-rainbow-delimiters-depth-3">}</span>,  <span class="org-rainbow-delimiters-depth-3">{</span>72, <span class="org-string">"WM_FULLSCREEN"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>85, <span class="org-string">"WM_COPYDATA"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>512, <span class="org-string">"WM_MOUSEMOVE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,<span class="org-rainbow-delimiters-depth-3">{</span>132, <span class="org-string">"WM_NCHITTEST"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>641, <span class="org-string">"WM_IME_SETCONTEXT"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>8, <span class="org-string">"WM_KILLFOCUS"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>134, <span class="org-string">"WM_NCACTIVATE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>28, <span class="org-string">"WM_ACTIVATEAPP"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>160, <span class="org-string">"WM_NCMOUSEMOVE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>161, <span class="org-string">"WM_NCLBUTTONDOWN"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>36, <span class="org-string">"WM_GETMINMAXINFO"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>642, <span class="org-string">"WM_IME_NOTIFY"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>433, <span class="org-string">"WM_CAPTURECHANGED"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>534, <span class="org-string">"WM_MOVING"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>674, <span class="org-string">"WM_NCMOUSELEAVE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>675, <span class="org-string">"WM_MOUSELEAVE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>532, <span class="org-string">"WM_SIZING"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>533, <span class="org-string">"WM_CAPTURECHANGED"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>127, <span class="org-string">"WM_GETICON"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>20, <span class="org-string">"WM_ERASEBKGND"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>70, <span class="org-string">"WM_WINDOWPOSCHANGING"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>71, <span class="org-string">"WM_WINDOWPOSCHANGED"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>273, <span class="org-string">"WM_COMMAND"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>274, <span class="org-string">"WM_SYSCOMMAND"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>275, <span class="org-string">"WM_TIMER"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>513, <span class="org-string">"WM_LBUTTONDOWN"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
                <span class="org-rainbow-delimiters-depth-3">{</span>514, <span class="org-string">"WM_LBUTTONUP"</span><span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-rainbow-delimiters-depth-2">}</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Code for debugging messages sent to Window</span>
        <span class="org-keyword">static</span> <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
        ss.str<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">""</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        ss &lt;&lt; <span class="org-string">" [TRACE] WNPROC Message =&gt;  "</span>
           &lt;&lt; <span class="org-string">" Code = "</span> &lt;&lt; msg;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>WindowMessages.find<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span> != WindowMessages.end<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>
                ss &lt;&lt; <span class="org-string">" ; Message = "</span> &lt;&lt; WindowMessages<span class="org-rainbow-delimiters-depth-2">[</span>msg<span class="org-rainbow-delimiters-depth-2">]</span>;
        <span class="org-keyword">else</span>
                ss &lt;&lt; <span class="org-string">" ; Message = Unknown "</span>; 
        <span class="org-keyword">return</span> ss.str<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Compiling:</b>
</p>

<ul class="org-ul">
<li>MSVC</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Build </span>
$ cl.exe gui-basic1.cpp /EHsc /Zi /nologo /Fe:gui-basic1.exe user32.lib gdi32.lib 
</pre>
</div>

<ul class="org-ul">
<li>Mingw/GCC:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ g++ gui-basic1.cpp -o <span class="org-keyword">gui-basic1.exe</span> -std=c++1z -g -lgdi32 -luser32
</pre>
</div>

<p>
<b>Running:</b>
</p>

<p>
The executable gui-basic1.exe can be run by clicking on it or by
launching it from console (cmd.exe). However, it will not open any
console and program statements for printing to stdout will have no
effect since the program was compiled for the Windows subsystem rather
than for the console subsystem.
</p>


<div class="figure">
<p><a href="images/gui-program-basic1.png"><img src="images/gui-program-basic1.png" alt="gui-program-basic1.png" /></a>   
</p>
<p><span class="figure-number">Figure 3: </span>Basic GUI Program</p>
</div>
</div>
</li>
<li><a id="orgf5ac526"></a>Parts<br />
<ol class="org-ol">
<li><a id="org64e988a"></a>Main Function<br />
<div class="outline-text-6" id="text-1-31-1-2-1">
<ul class="org-ul">
<li><b>Window subsystem entry point</b></li>
</ul>

<p>
The entry point of a GUI program is no longer the main function, it is now
the <span class="underline">WinMain</span> function which is the entry point of the <span class="underline">window
subsystem</span>. The name 'WINAPI' is just a macro which is expanded to
<code>__stdcall</code>, a calling convention qualifier. 
</p>

<p>
Parameters: 
</p>

<ul class="org-ul">
<li>hInstance     =&gt; Handler to current program.</li>
<li>hPrevInstance =&gt; Legacy and used for backward compatibility reasons.</li>
<li>lpCmdLine     =&gt; Command line</li>
<li>nCmdShow      =&gt;</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">WINAPI</span> WinMain<span class="org-rainbow-delimiters-depth-1">(</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Handle to current application isntance </span>
        <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span>,
        <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hPrevInstance</span>,
        <span class="org-comment-delimiter">// </span><span class="org-comment">Command line </span>
        <span class="org-type">LPSTR</span>     <span class="org-variable-name">lpCmdLine</span>,
        <span class="org-type">int</span>       <span class="org-variable-name">nCmdShow</span>
        <span class="org-rainbow-delimiters-depth-1">){</span>
   ... .... ... 
     <span class="org-keyword">return</span> 0;
 <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li><b>Logging with OutputDebugString</b></li>
</ul>

<p>
It is not possible to visualize the output printed to stdout or
stderr of a program compiled for the Window subystem since no terminal
is opened and even launching the program in the console (cmd.exe or
cmder) does not print anything. A workaround to this hurdle is to
print to a file or redirect stdout or stderr to a file stream. Another
better solution is to use the API <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa363362(v=vs.85).aspx">OutputDebugString</a> as its output is
sent to shared memory and can be captured with the <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/debugview">DebugView</a> (download)
<span class="underline">sysinternals tool</span>. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-variable-name">WINAPI</span> WinMain<span class="org-rainbow-delimiters-depth-1">(</span> ... <span class="org-rainbow-delimiters-depth-1">){</span>

    OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Starting WinMain Application"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"It will not print to Console - Starting WinMain Application"</span><span class="org-rainbow-delimiters-depth-2">)</span>;   
    ... ... ... 
    OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Registered Window Class OK."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    ... ... 
    OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Exiting application. OK."</span><span class="org-rainbow-delimiters-depth-2">)</span>;  
    <span class="org-comment-delimiter">// </span><span class="org-comment">Success status code</span>
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
The sysinternal tool <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/debugview">DebugView</a> is useful for debugging and visualizing
logging of any program not able to print to console such as graphical
programs compiled to <span class="underline">window subsystem</span>, DLL (Dynamic Linked Libraries),
services (aka daemons), servers and etc.
</p>


<div class="figure">
<p><a href="images/DebugView-systinternals1.png"><img src="images/DebugView-systinternals1.png" alt="DebugView-systinternals1.png" /></a>
</p>
<p><span class="figure-number">Figure 4: </span>Output of OutputDebugString caputred by DebugView (sysinternals)</p>
</div>


<p>
Intialize Window class structure: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-comment-delimiter">// </span><span class="org-comment">---------- Within WinMain function ----------// </span>

 <span class="org-comment-delimiter">//</span><span class="org-comment">Window class name must be unique </span>
 <span class="org-keyword">const</span> <span class="org-type">char</span> <span class="org-variable-name">wincClassName</span> <span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-string">"NameOfWindow"</span>;

 <span class="org-comment-delimiter">// </span><span class="org-comment">Win32 Window class structure</span>
 <span class="org-type">WNDCLASSEX</span> <span class="org-variable-name">wc</span>;
 <span class="org-comment-delimiter">// </span><span class="org-comment">Win32 message structure </span>
 <span class="org-type">MSG</span> <span class="org-variable-name">Msg</span>;           

<span class="org-comment-delimiter">// </span><span class="org-comment">Name to identify the class with. </span>
 wc.lpszClassName = wincClassName;
 <span class="org-comment-delimiter">//</span><span class="org-comment">Pointer to the window procedure for this window class. </span>
 wc.lpfnWndProc = windowProcedure;  
 <span class="org-comment-delimiter">// </span><span class="org-comment">1 - Register Windows Size</span>
 wc.cbSize = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-1">(</span>WNDCLASSEX<span class="org-rainbow-delimiters-depth-1">)</span>;

 wc.style  = 0;
 <span class="org-comment-delimiter">//</span><span class="org-comment">Amount of extra data allocated for this class in memory. Usually 0</span>
 wc.cbClsExtra = 0;
 <span class="org-comment-delimiter">//</span><span class="org-comment">Amount of extra data allocated in memory per window of this type. Usually 0. </span>
 wc.cbWndExtra = 0;
 <span class="org-comment-delimiter">//</span><span class="org-comment">Handle to application instance (that we got in the first parameter of WinMain()). </span>
 wc.hInstance = hInstance;
 <span class="org-comment-delimiter">// </span><span class="org-comment">Large (usually 32x32) icon shown when the user presses Alt+Tab. </span>
 wc.hIcon = LoadIcon<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">NULL</span>, IDI_APPLICATION<span class="org-rainbow-delimiters-depth-1">)</span>;
 <span class="org-comment-delimiter">// </span><span class="org-comment">Cursor that will be displayed over our window. </span>
 wc.hCursor = LoadCursor<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">NULL</span>, IDC_ARROW<span class="org-rainbow-delimiters-depth-1">)</span>;
 <span class="org-comment-delimiter">// </span><span class="org-comment">Background Brush to set the color of our window. </span>
 wc.hbrBackground = <span class="org-rainbow-delimiters-depth-1">(</span>HBRUSH<span class="org-rainbow-delimiters-depth-1">)(</span>COLOR_WINDOW+1<span class="org-rainbow-delimiters-depth-1">)</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">(HBRUSH) CreateSolidBrush(RGB(10, 20, 30)); // </span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">Background Brush to set the color of our window. </span>
 wc.lpszMenuName = <span class="org-constant">NULL</span>;    
 <span class="org-comment-delimiter">// </span><span class="org-comment">Small (usually 16x16) icon to show in the taskbar and in the top left corner of the window. </span>
 wc.hIconSm = LoadIcon<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">NULL</span>, IDI_APPLICATION<span class="org-rainbow-delimiters-depth-1">)</span>;  
 OutputDebugString<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Registered Window Class OK."</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Register Window Class: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-negation-char">!</span>RegisterClassEx<span class="org-rainbow-delimiters-depth-2">(</span>&amp;wc<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        MessageBox<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span>,
        <span class="org-string">"Window Registration Failed!"</span>,
        <span class="org-string">"Error!"</span>,
        MB_ICONEXCLAMATION | MB_OK<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-comment-delimiter">//</span><span class="org-comment">Error status code </span>
        <span class="org-keyword">return</span> -1;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"Class Registered"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
</pre>
</div>

<p>
Create Window object (hwnd - which is a handler to window object)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-variable-name">width</span> = 500, <span class="org-variable-name">height</span> = 400;
<span class="org-type">int</span> <span class="org-variable-name">pos_left</span> = 400, <span class="org-variable-name">pos_top</span> = 100;

<span class="org-type">HWND</span> <span class="org-variable-name">hwnd</span> = CreateWindowA<span class="org-rainbow-delimiters-depth-1">(</span>
        wc.lpszClassName,
        <span class="org-string">"Title of Window"</span>,
        WS_OVERLAPPEDWINDOW,
        pos_left,
        pos_top,
        width,
        height,
        <span class="org-constant">nullptr</span>,
        <span class="org-constant">nullptr</span>,
        hInstance,
        <span class="org-constant">nullptr</span>
        <span class="org-rainbow-delimiters-depth-1">)</span>;  
OutputDebugString<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" [INFO] Window created OK"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Display Window: 
</p>

<div class="org-src-container">
<pre class="src src-cpp">ShowWindow<span class="org-rainbow-delimiters-depth-1">(</span>hwnd, nCmdShow<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"nCmdShow = "</span> &lt;&lt; nCmdShow &lt;&lt; <span class="org-constant">std</span>::endl;
UpdateWindow<span class="org-rainbow-delimiters-depth-1">(</span>hwnd<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Start message loop and processing events: 
</p>

<ul class="org-ul">
<li>The message loops receives messages (akas event) from the operating
systems and relays them to the <span class="underline">window procedure function</span> or
callback which processes the message. In most graphical programs,
the program is not in control of the control flow, instead the
operating system or window system which calls the program by
sending events to it.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">//</span><span class="org-comment">---- Message Loop ----------//</span>
<span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-1">(</span>GetMessage<span class="org-rainbow-delimiters-depth-2">(</span>&amp;Msg, <span class="org-constant">NULL</span>, 0, 0<span class="org-rainbow-delimiters-depth-2">)</span> &gt; 0 <span class="org-rainbow-delimiters-depth-1">){</span>
     TranslateMessage<span class="org-rainbow-delimiters-depth-2">(</span>&amp;Msg<span class="org-rainbow-delimiters-depth-2">)</span>;
     DispatchMessage<span class="org-rainbow-delimiters-depth-2">(</span>&amp;Msg<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Print message when program ends: 
</p>

<div class="org-src-container">
<pre class="src src-cpp">OutputDebugString<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" [INFO] Exiting application. OK."</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</li>
<li><a id="org6ad673a"></a>Windows Procedure and WinMessageToString<br />
<div class="outline-text-6" id="text-1-31-1-2-2">
<p>
Whenever the window is minimized, moved or resized or dragged, the
operating system sends messages to the program by calling the
registered <span class="underline">window procedure</span> (callback), in this case the function
windowProcedure is called whenever an event happens. 
</p>

<p>
In this type of <span class="underline">event-driven program</span>, the program does not manage the
control the control flow, instead is the operating system which
determines the controls by sending events and the program only
responds the events. 
</p>

<p>
Notes:
</p>

<ul class="org-ul">
<li>The name 'CALLBACK' is just a macro for <code>__stdcall</code> calling
convention.</li>

<li>The parameter <span class="underline">hwnd</span> is the Window handler and is the Window
registered in the WinMain function.</li>

<li>The parameter <span class="underline">msg</span> is the message sent by the operating system
whenever an event happens, when the Window is created, it sends a
<code>WM_CREATE</code> message; when the user clicks at the close button at top
right corner, the operating system sends a message <code>WM_CLOSE</code>.</li>

<li>As in any <span class="underline">event-driven GUI API</span>, no blocking function calls or any
function call which can take any significant dealay should be
executed inside the Window Procedure or callback as it is supposed
to return as fast as possible. Otherwise, the GUI will freeze and
become unresponsive while the blocking call is being
executed. Those blocking calls such as read line from console,
download file, process a huge file and so on should be carried out
in another thread or that will compromise the GUI usability.</li>

<li>The full list of messages that the operating sytem can sed can be
found at:

<ul class="org-ul">
<li>List Of Windows Messages -
<a href="https://wiki.winehq.org/List_Of_Windows_Messages">https://wiki.winehq.org/List_Of_Windows_Messages</a></li>

<li>List of Windows Messages -
<a href="https://autohotkey.com/docs/misc/SendMessageList.htm">https://autohotkey.com/docs/misc/SendMessageList.htm</a></li>

<li>List of windows messages with their description WM
<ul class="org-ul">
<li><a href="https://www.gamedev.net/forums/topic/552982-list-of-windows-messages-with-their-description-wm_/">https://www.gamedev.net/forums/topic/552982-list-of-windows-messages-with-their-description-wm_/</a></li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Window Procedure - Process window messages or events</span>
LRESULT <span class="org-type">CALLBACK</span> <span class="org-function-name">windowProcedure</span> <span class="org-rainbow-delimiters-depth-1">(</span>
     <span class="org-type">HWND</span>   <span class="org-variable-name">hwnd</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Window Handle (Window object)</span>
    ,<span class="org-type">UINT</span>   <span class="org-variable-name">msg</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Window Message  </span>
    ,<span class="org-type">WPARAM</span> <span class="org-variable-name">wParam</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Additional message information</span>
    ,<span class="org-type">LPARAM</span> <span class="org-variable-name">lParam</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Additional message information</span>
    <span class="org-rainbow-delimiters-depth-1">){</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Variable initialized one. </span>
     <span class="org-keyword">static</span> <span class="org-keyword">auto</span> <span class="org-variable-name">ignored_messages</span> = <span class="org-constant">std</span>::<span class="org-type">set</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">UINT</span><span class="org-rainbow-delimiters-depth-2">&gt;{</span>
             WM_MOUSEMOVE, WM_NCHITTEST, WM_SETCURSOR, WM_IME_NOTIFY
     <span class="org-rainbow-delimiters-depth-2">}</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Ignore messages which can flood the logging </span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">if(msg != WM_MOUSEMOVE &amp;&amp; msg != WM_NCMOUSEMOVE</span>
     <span class="org-comment-delimiter">//    </span><span class="org-comment">&amp;&amp; msg != WM_QUIT &amp;&amp; msg != WM_NCHITTEST )</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ignored_messages.find<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span> == ignored_messages.end<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>
          OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span>WinMessageToString<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;   
     ... ... ...    ... ... ...     ... ... ...     ... ... ...      

   <span class="org-comment-delimiter">// </span><span class="org-comment">Process messages </span>
   <span class="org-keyword">switch</span><span class="org-rainbow-delimiters-depth-2">(</span>msg<span class="org-rainbow-delimiters-depth-2">)</span>
   <span class="org-rainbow-delimiters-depth-2">{</span>
   <span class="org-keyword">case</span> WM_CREATE:
        SetWindowTextA<span class="org-rainbow-delimiters-depth-3">(</span>hwnd, <span class="org-string">"Change Window Title"</span><span class="org-rainbow-delimiters-depth-3">)</span>;        
        OutputDebugString<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO] Window created. OK."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">break</span>;
   <span class="org-keyword">case</span> WM_CLOSE:
        OutputDebugString<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO] Window closed. OK."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        DestroyWindow<span class="org-rainbow-delimiters-depth-3">(</span>hwnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">break</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>
  ... 
  <span class="org-keyword">return</span> 0;
  <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Full message (events) processing: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Process messages </span>
<span class="org-keyword">switch</span><span class="org-rainbow-delimiters-depth-1">(</span>msg<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-keyword">case</span> WM_CREATE:
      SetWindowTextA<span class="org-rainbow-delimiters-depth-2">(</span>hwnd, <span class="org-string">"Change Window Title"</span><span class="org-rainbow-delimiters-depth-2">)</span>;      
      OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Window created. OK."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-keyword">break</span>;
<span class="org-keyword">case</span> WM_CLOSE:
      OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Window closed. OK."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      DestroyWindow<span class="org-rainbow-delimiters-depth-2">(</span>hwnd<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-keyword">break</span>;
<span class="org-keyword">case</span> WM_DESTROY:
      OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Exiting application. OK."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      PostQuitMessage<span class="org-rainbow-delimiters-depth-2">(</span>0<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-keyword">break</span>;
<span class="org-keyword">case</span> WM_MOVE:
      <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Move window."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
      <span class="org-keyword">break</span>; 
<span class="org-keyword">case</span> WM_PAINT:
  <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">GDI - Graphics Devices Interface Here</span>
      <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------</span>
      <span class="org-type">PAINTSTRUCT</span> <span class="org-variable-name">ps</span>;
      <span class="org-type">HDC</span> <span class="org-variable-name">hdc</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">std::cerr &lt;&lt; " [INFO] Windown painting" &lt;&lt; std::endl;</span>
      hdc = BeginPaint<span class="org-rainbow-delimiters-depth-3">(</span>hwnd, &amp;ps<span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">text</span> = <span class="org-string">"Hello world Window!"</span>;     
      TextOutA<span class="org-rainbow-delimiters-depth-3">(</span>hdc, 125, 200, text.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, text.size<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      Ellipse<span class="org-rainbow-delimiters-depth-3">(</span>hdc, 100, 100, 160, 160<span class="org-rainbow-delimiters-depth-3">)</span>;
      Rectangle<span class="org-rainbow-delimiters-depth-3">(</span>hdc, 100, 100, 160, 160<span class="org-rainbow-delimiters-depth-3">)</span>;
      EndPaint<span class="org-rainbow-delimiters-depth-3">(</span>hwnd, &amp;ps<span class="org-rainbow-delimiters-depth-3">)</span>;      
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">break</span>;
  <span class="org-keyword">default</span>:
     <span class="org-keyword">return</span> DefWindowProc<span class="org-rainbow-delimiters-depth-2">(</span>hwnd, msg, wParam, lParam<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Paint message and <a href="https://en.wikipedia.org/wiki/Graphics_Device_Interface">GDI - Graphics Device Interface</a> 
</p>

<ul class="org-ul">
<li>The paint message is sent to the program whenever the window is
moved, resized, minimized, maximized, overlaped and so on. This
<span class="underline">case WM_PAINT</span> statement uses GDI for drawing a text and square to
the screen.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">case</span> WM_PAINT:
  <span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">GDI - Graphics Devices Interface Here</span>
      <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------</span>
      <span class="org-type">PAINTSTRUCT</span> <span class="org-variable-name">ps</span>;
      <span class="org-type">HDC</span> <span class="org-variable-name">hdc</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">std::cerr &lt;&lt; " [INFO] Windown painting" &lt;&lt; std::endl;</span>
      hdc = BeginPaint<span class="org-rainbow-delimiters-depth-2">(</span>hwnd, &amp;ps<span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">text</span> = <span class="org-string">"Hello world Window!"</span>;     
      TextOutA<span class="org-rainbow-delimiters-depth-2">(</span>hdc, 125, 200, text.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, text.size<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      Ellipse<span class="org-rainbow-delimiters-depth-2">(</span>hdc, 100, 100, 160, 160<span class="org-rainbow-delimiters-depth-2">)</span>;
      Rectangle<span class="org-rainbow-delimiters-depth-2">(</span>hdc, 100, 100, 160, 160<span class="org-rainbow-delimiters-depth-2">)</span>;
      EndPaint<span class="org-rainbow-delimiters-depth-2">(</span>hwnd, &amp;ps<span class="org-rainbow-delimiters-depth-2">)</span>;      
  <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Function <span class="underline">WinMessageToString</span> - this function called in the beggining of
the window procedure takes a WM message as parameter and returns a
human-readable description of the message code as parameter. The
window procedure uses this function and the WinAPI function
OutputDebugString to log the received messages (events) which can
visualized with the DebugView sysinteral tool. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Window Procedure - Process window messages or events </span>
LRESULT CALLBACK <span class="org-type">windowProcedure</span> <span class="org-rainbow-delimiters-depth-1">(</span> ... <span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Variable initialized one. </span>
    <span class="org-keyword">static</span> <span class="org-keyword">auto</span> <span class="org-variable-name">ignored_messages</span> = <span class="org-constant">std</span>::<span class="org-type">set</span><span class="org-rainbow-delimiters-depth-2">&lt;</span>UINT<span class="org-rainbow-delimiters-depth-2">&gt;{</span>
       WM_MOUSEMOVE, WM_NCHITTEST, WM_SETCURSOR, WM_IME_NOTIFY
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Ignore messages which can flood the logging </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">if(msg != WM_MOUSEMOVE &amp;&amp; msg != WM_NCMOUSEMOVE</span>
    <span class="org-comment-delimiter">//    </span><span class="org-comment">&amp;&amp; msg != WM_QUIT &amp;&amp; msg != WM_NCHITTEST )</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ignored_messages.find<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span> == ignored_messages.end<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>
        OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span>WinMessageToString<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>; 
... ... ... 
</pre>
</div>


<div class="figure">
<p><a href="images/DebugView-window-messages-events.png"><img src="images/DebugView-window-messages-events.png" alt="DebugView-window-messages-events.png" /></a>
</p>
<p><span class="figure-number">Figure 5: </span>Message logging displayed by DebugView sysinternals tool.</p>
</div>

<p>
Function <b>WinMessageToString</b>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">/** </span><span class="org-comment">Get a human-readable description of a Windows message as a</span>
<span class="org-comment"> * string */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">WinMessageToString</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">UINT</span> <span class="org-variable-name">msg</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-comment-delimiter">/** </span><span class="org-comment">Database of Windows messages - full list of messages here: </span>
<span class="org-comment">      *   https://wiki.winehq.org/List_Of_Windows_Messages</span>
<span class="org-comment">      */</span>
     <span class="org-keyword">static</span> <span class="org-keyword">auto</span> <span class="org-variable-name">WindowMessages</span> = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">UINT</span>, <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;{</span>
             <span class="org-rainbow-delimiters-depth-3">{</span>1, <span class="org-string">"WM_CREATE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>2, <span class="org-string">"WM_DESTROY"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>5, <span class="org-string">"WM_SIZE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>6, <span class="org-string">"WM_ACTIVATE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>13, <span class="org-string">"WM_SIZE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>22, <span class="org-string">"WM_SETVISIBLE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>23, <span class="org-string">"WM_ENABLE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,  <span class="org-rainbow-delimiters-depth-3">{</span>29, <span class="org-string">"WM_PAINT"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>3, <span class="org-string">"WM_MOVE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>30, <span class="org-string">"WM_CLOSE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>32, <span class="org-string">"WM_SETCURSOR"</span><span class="org-rainbow-delimiters-depth-3">}</span>,  <span class="org-rainbow-delimiters-depth-3">{</span>72, <span class="org-string">"WM_FULLSCREEN"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>85, <span class="org-string">"WM_COPYDATA"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>512, <span class="org-string">"WM_MOUSEMOVE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,<span class="org-rainbow-delimiters-depth-3">{</span>132, <span class="org-string">"WM_NCHITTEST"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>641, <span class="org-string">"WM_IME_SETCONTEXT"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>8, <span class="org-string">"WM_KILLFOCUS"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>134, <span class="org-string">"WM_NCACTIVATE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>28, <span class="org-string">"WM_ACTIVATEAPP"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>160, <span class="org-string">"WM_NCMOUSEMOVE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>161, <span class="org-string">"WM_NCLBUTTONDOWN"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>36, <span class="org-string">"WM_GETMINMAXINFO"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>642, <span class="org-string">"WM_IME_NOTIFY"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>433, <span class="org-string">"WM_CAPTURECHANGED"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>534, <span class="org-string">"WM_MOVING"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>674, <span class="org-string">"WM_NCMOUSELEAVE"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>675, <span class="org-string">"WM_MOUSELEAVE"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>532, <span class="org-string">"WM_SIZING"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>533, <span class="org-string">"WM_CAPTURECHANGED"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>127, <span class="org-string">"WM_GETICON"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>20, <span class="org-string">"WM_ERASEBKGND"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>70, <span class="org-string">"WM_WINDOWPOSCHANGING"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>71, <span class="org-string">"WM_WINDOWPOSCHANGED"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>273, <span class="org-string">"WM_COMMAND"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>274, <span class="org-string">"WM_SYSCOMMAND"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>275, <span class="org-string">"WM_TIMER"</span><span class="org-rainbow-delimiters-depth-3">}</span>, <span class="org-rainbow-delimiters-depth-3">{</span>513, <span class="org-string">"WM_LBUTTONDOWN"</span><span class="org-rainbow-delimiters-depth-3">}</span>,
             <span class="org-rainbow-delimiters-depth-3">{</span>514, <span class="org-string">"WM_LBUTTONUP"</span><span class="org-rainbow-delimiters-depth-3">}</span>
     <span class="org-rainbow-delimiters-depth-2">}</span>;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Code for debugging messages sent to Window</span>
     <span class="org-keyword">static</span> <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
     ss.str<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">""</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     ss &lt;&lt; <span class="org-string">" [TRACE] WNPROC Message =&gt;  "</span>
        &lt;&lt; <span class="org-string">" Code = "</span> &lt;&lt; msg;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>WindowMessages.find<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span> != WindowMessages.end<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>
         ss &lt;&lt; <span class="org-string">" ; Message = "</span> &lt;&lt; WindowMessages<span class="org-rainbow-delimiters-depth-2">[</span>msg<span class="org-rainbow-delimiters-depth-2">]</span>;
     <span class="org-keyword">else</span>
         ss &lt;&lt; <span class="org-string">" ; Message = Unknown "</span>; 
     <span class="org-keyword">return</span> ss.str<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-orgb100170" class="outline-4">
<h4 id="orgb100170"><span class="section-number-4">1.31.2</span> GUI without WinMain</h4>
<div class="outline-text-4" id="text-1-31-2">
<p>
This code presents a minimal Win32 GUI graphical user interface
without the WinMain function entry point. 
</p>

<p>
Source: 
</p>
<ul class="org-ul">
<li>File: <a href="src/windows/gui-without-winmain.cpp">file:src/windows/gui-without-winmain.cpp</a></li>
<li>GIST: <a href="https://gist.github.com/caiorss/e8967d4d3dad522c82aab18ccd8f8304">gui-without-winmain.cpp</a></li>
</ul>

<p>
This code is similar to the previous example, the difference is the
changing of the entry point function from non-standard WinMain to
main. 
</p>

<ul class="org-ul">
<li>Before - <a href="https://gist.github.com/caiorss/cab14ba11e207bbc7beed9a2f0b4ebc4">gui-basic1.cpp</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">WINAPI</span> WinMain<span class="org-rainbow-delimiters-depth-1">(</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Handle to current application isntance </span>
        <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span>,
        <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hPrevInstance</span>,
        <span class="org-comment-delimiter">// </span><span class="org-comment">Command line </span>
        <span class="org-type">LPSTR</span>     <span class="org-variable-name">lpCmdLine</span>,
        <span class="org-type">int</span>       <span class="org-variable-name">nCmdShow</span>
        <span class="org-rainbow-delimiters-depth-1">){</span>
   ... .... ... 
     <span class="org-keyword">return</span> 0;
 <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li>After - <a href="https://gist.github.com/caiorss/e8967d4d3dad522c82aab18ccd8f8304">gui-without-winmain.cpp</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">---- Get WinMain Parameters ----//</span>
    <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span> = GetModuleHandle<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">STARTUPINFO</span> <span class="org-variable-name">si</span>;
    GetStartupInfo<span class="org-rainbow-delimiters-depth-2">(</span>&amp;si<span class="org-rainbow-delimiters-depth-2">)</span>;  
    <span class="org-type">int</span> <span class="org-variable-name">nCmdShow</span> = si.wShowWindow;
    ... ... ... ... 

   <span class="org-keyword">return</span> 0
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Files</b> 
</p>

<p>
File: <span class="underline">CMakeLists.txt</span> 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.0)
<span class="org-function-name">project</span>(WindowsGUI_WINAPI)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD     17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-function-name">add_executable</span>( mygui WIN32 gui-without-winmain.cpp )

<span class="org-keyword">IF</span>(MSVC)   
  <span class="org-function-name">target_link_options</span>( mygui PUBLIC <span class="org-string">"/ENTRY:mainCRTStartup"</span> )
<span class="org-keyword">ENDIF</span>()       
</pre>
</div>

<p>
File: <span class="underline">gui-without-winmain.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">LRESULT</span> <span class="org-function-name">windowProcedure</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HWND</span> <span class="org-variable-name">hwnd</span>, <span class="org-type">UINT</span> <span class="org-variable-name">msg</span>, <span class="org-type">WPARAM</span> <span class="org-variable-name">wParam</span>, <span class="org-type">LPARAM</span> <span class="org-variable-name">lParam</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">){</span>
     <span class="org-comment-delimiter">//</span><span class="org-comment">---- Get WinMain Parameters ----//</span>

    <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span> = GetModuleHandle<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">STARTUPINFO</span> <span class="org-variable-name">si</span>;
    GetStartupInfo<span class="org-rainbow-delimiters-depth-2">(</span>&amp;si<span class="org-rainbow-delimiters-depth-2">)</span>;  
    <span class="org-type">int</span> <span class="org-variable-name">nCmdShow</span> = si.wShowWindow;

    <span class="org-comment-delimiter">// </span><span class="org-comment">-------------------------//</span>
    OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Starting WinMain Application"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Starting WinMain Application"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">//</span><span class="org-comment">Window class name must be unique </span>
    <span class="org-keyword">const</span> <span class="org-type">char</span> <span class="org-variable-name">wincClassName</span> <span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-string">"NameOfWindow"</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Win32 Window class structure</span>
    <span class="org-type">WNDCLASSEX</span> <span class="org-variable-name">wc</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Win32 message structure </span>
    <span class="org-type">MSG</span> <span class="org-variable-name">Msg</span>;            

    wc.lpszClassName = wincClassName;
    wc.lpfnWndProc = windowProcedure;   
    wc.cbSize = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>WNDCLASSEX<span class="org-rainbow-delimiters-depth-2">)</span>;
    wc.style  = 0;
    wc.cbClsExtra = 0;
    wc.cbWndExtra = 0;
    wc.hInstance = hInstance;
    wc.hIcon = LoadIcon<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span>, IDI_APPLICATION<span class="org-rainbow-delimiters-depth-2">)</span>;
    wc.hCursor = LoadCursor<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span>, IDC_ARROW<span class="org-rainbow-delimiters-depth-2">)</span>;
    wc.hbrBackground = <span class="org-rainbow-delimiters-depth-2">(</span>HBRUSH<span class="org-rainbow-delimiters-depth-2">)(</span>COLOR_WINDOW+1<span class="org-rainbow-delimiters-depth-2">)</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">(HBRUSH) CreateSolidBrush(RGB(10, 20, 30)); // </span>
    wc.lpszMenuName = <span class="org-constant">nullptr</span>;  
    wc.hIconSm = LoadIcon<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, IDI_APPLICATION<span class="org-rainbow-delimiters-depth-2">)</span>;  

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>RegisterClassEx<span class="org-rainbow-delimiters-depth-3">(</span>&amp;wc<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
            MessageBox<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">nullptr</span>,
                       <span class="org-string">"Window Registration Failed!"</span>,
                       <span class="org-string">"Error!"</span>,
                       MB_ICONEXCLAMATION | MB_OK<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-comment-delimiter">//</span><span class="org-comment">Error status code </span>
            <span class="org-keyword">return</span> -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Class Registered"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-type">int</span> <span class="org-variable-name">width</span> = 500, <span class="org-variable-name">height</span> = 400;
    <span class="org-type">int</span> <span class="org-variable-name">pos_left</span> = 400, <span class="org-variable-name">pos_top</span> = 100;

    <span class="org-type">HWND</span> <span class="org-variable-name">hwnd</span> = CreateWindowA<span class="org-rainbow-delimiters-depth-2">(</span>
            wc.lpszClassName,
            <span class="org-string">"Title of Window"</span>,
            WS_OVERLAPPEDWINDOW,
            pos_left,
            pos_top,
            width,
            height,
            <span class="org-constant">nullptr</span>,
            <span class="org-constant">nullptr</span>,
            hInstance,
            <span class="org-constant">nullptr</span>
            <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">buttonID</span> = 1001;

    OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Window created OK"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hwnd == <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">){</span>
         MessageBox<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">NULL</span>,
                    <span class="org-string">"Error: Failure to create Window"</span>,
                    <span class="org-string">"Error Report"</span>,
                    MB_ICONEXCLAMATION | MB_OK<span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    ShowWindow<span class="org-rainbow-delimiters-depth-2">(</span>hwnd, nCmdShow<span class="org-rainbow-delimiters-depth-2">)</span>;
    UpdateWindow<span class="org-rainbow-delimiters-depth-2">(</span>hwnd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">//</span><span class="org-comment">---- Message Loop ----------//</span>
    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>GetMessage<span class="org-rainbow-delimiters-depth-3">(</span>&amp;Msg, <span class="org-constant">NULL</span>, 0, 0<span class="org-rainbow-delimiters-depth-3">)</span> &gt; 0 <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        TranslateMessage<span class="org-rainbow-delimiters-depth-3">(</span>&amp;Msg<span class="org-rainbow-delimiters-depth-3">)</span>;
        DispatchMessage<span class="org-rainbow-delimiters-depth-3">(</span>&amp;Msg<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>   
    <span class="org-comment-delimiter">// </span><span class="org-comment">Success status code </span>
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">------------ End of Main ------------------------- //</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Window Procedure - Process window messages or events </span>
<span class="org-type">LRESULT</span> <span class="org-function-name">windowProcedure</span> <span class="org-rainbow-delimiters-depth-1">(</span>
          <span class="org-type">HWND</span>   <span class="org-variable-name">hwnd</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Window Handle (Window object)</span>
         ,<span class="org-type">UINT</span>   <span class="org-variable-name">msg</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Window Message  </span>
         ,<span class="org-type">WPARAM</span> <span class="org-variable-name">wParam</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Additional message information</span>
         ,<span class="org-type">LPARAM</span> <span class="org-variable-name">lParam</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Additional message information</span>
      <span class="org-rainbow-delimiters-depth-1">){</span>

      <span class="org-comment-delimiter">// </span><span class="org-comment">Process messages </span>
      <span class="org-keyword">switch</span><span class="org-rainbow-delimiters-depth-2">(</span>msg<span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-keyword">case</span> WM_CREATE:
                 <span class="org-keyword">break</span>;
         <span class="org-keyword">case</span> WM_CLOSE:     
                 DestroyWindow<span class="org-rainbow-delimiters-depth-3">(</span>hwnd<span class="org-rainbow-delimiters-depth-3">)</span>;
                 <span class="org-keyword">break</span>;
         <span class="org-keyword">case</span> WM_DESTROY:
                 PostQuitMessage<span class="org-rainbow-delimiters-depth-3">(</span>0<span class="org-rainbow-delimiters-depth-3">)</span>;
                 <span class="org-keyword">break</span>;
         <span class="org-keyword">case</span> WM_MOVE:
                 <span class="org-keyword">break</span>; 
         <span class="org-keyword">case</span> WM_PAINT:
         <span class="org-rainbow-delimiters-depth-3">{</span>
                 <span class="org-comment-delimiter">// </span><span class="org-comment">GDI - Graphics Devices Interface Here</span>
                 <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------</span>
                 <span class="org-type">PAINTSTRUCT</span> <span class="org-variable-name">ps</span>;
                 <span class="org-type">HDC</span> <span class="org-variable-name">hdc</span>;
                 <span class="org-comment-delimiter">// </span><span class="org-comment">std::cerr &lt;&lt; " [INFO] Windown painting" &lt;&lt; std::endl;</span>
                 hdc = BeginPaint<span class="org-rainbow-delimiters-depth-4">(</span>hwnd, &amp;ps<span class="org-rainbow-delimiters-depth-4">)</span>;
                 <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">text</span> = <span class="org-string">"Hello world Window!"</span>;      
                 TextOutA<span class="org-rainbow-delimiters-depth-4">(</span>hdc, 125, 200, text.c_str<span class="org-rainbow-delimiters-depth-5">()</span>, text.size<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                 Ellipse<span class="org-rainbow-delimiters-depth-4">(</span>hdc, 100, 100, 160, 160<span class="org-rainbow-delimiters-depth-4">)</span>;
                 Rectangle<span class="org-rainbow-delimiters-depth-4">(</span>hdc, 100, 100, 160, 160<span class="org-rainbow-delimiters-depth-4">)</span>;
                 EndPaint<span class="org-rainbow-delimiters-depth-4">(</span>hwnd, &amp;ps<span class="org-rainbow-delimiters-depth-4">)</span>;       
         <span class="org-rainbow-delimiters-depth-3">}</span>
         <span class="org-keyword">break</span>;
         <span class="org-keyword">default</span>:
                 <span class="org-keyword">return</span> DefWindowProc<span class="org-rainbow-delimiters-depth-3">(</span>hwnd, msg, wParam, lParam<span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
<b>Building with CMake and MSVC Compiler</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">---- Build -------------#</span>
$ cmake -H. -B_build_msvc -G <span class="org-string">"Visual Studio 16 2019"</span> -A x64 -DCMAKE_BUILD_TYPE=Debug
$ cmake --build _build_msvc --target 

<span class="org-comment-delimiter"># </span><span class="org-comment">---- Run --------------#</span>
$ _build_msvc\Debug\mygui.exe
</pre>
</div>

<p>
<b>Building with CMake and MINGW Compiler</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">----- Build --------------#</span>
$ cmake -B_build_mingw -G <span class="org-string">"MinGW Makefiles"</span> -DCMAKE_BUILD_TYPE=Debug
$ cmake --build _build_mingw --target 

<span class="org-comment-delimiter">#</span><span class="org-comment">------ Run ---------------# </span>
$ _build_mingw\mygui.exe
</pre>
</div>

<p>
<b>Compiling with MSVC for console subsystem</b>
</p>

<p>
Produces: gui-without-winmain.exe 
</p>

<p>
When the user clicks at the application's executable file, a terminal
is opened alongside the window where it is possible to view the
printed messages. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe gui-without-winmain.cpp /EHsc /Zi /nologo user32.lib gdi32.lib 
</pre>
</div>

<p>
By clicking at the program the Window is opened with a terminal: 
</p>


<div class="figure">
<p><a href="images/gui-program-console-subsystem.png"><img src="images/gui-program-console-subsystem.png" alt="gui-program-console-subsystem.png" /></a>
</p>
<p><span class="figure-number">Figure 6: </span>Program compiled for the console subystem.</p>
</div>

<p>
<b>Compiling with MSVC for window subsystem</b>
</p>

<p>
When the program is compiled for the <span class="underline">window subsystem</span>, no terminal is
opened as any Window's GUI application. 
</p>

<div class="org-src-container">
<pre class="src src-cpp">$ cl.exe gui-without-winmain.cpp /EHsc /Zi /nologo /link /subsystem:windows /entry:mainCRTStartup user32.lib gdi32.lib 
</pre>
</div>

<p>
Note: the compiler flags.
</p>

<ul class="org-ul">
<li>/subsystem:windows     =&gt; Compiles for Windows subsystem no
terminal is opened. It actually, just changes a flag in the PE32
executable file.</li>

<li>/entry:mainCRTStartup  =&gt; Changes program entry-point</li>
</ul>


<p>
<b>Compiling with Mingw/GCC for console subsystem</b>
</p>

<p>
Any program is compiled for the console subystem by default. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ gui-without-winmain.cpp -o <span class="org-keyword">gui-without-winmain.exe</span> -std=c++1z -g -lgdi32 -luser32
</pre>
</div>

<p>
<b>Compiling with Mingw/GCC for window subsystem</b>
</p>

<p>
The flag (-Wl,-subsystem,windows) is required for compiling sources to
the windows subsystem. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ gui-without-winmain.cpp -o <span class="org-keyword">gui-without-winmain.exe</span> -std=c++1z -g -lgdi32 -luser32 -Wl,-subsystem,windows
</pre>
</div>
</div>
</div>
<div id="outline-container-org3c2c081" class="outline-4">
<h4 id="org3c2c081"><span class="section-number-4">1.31.3</span> GUI without WinMain in DLang (D)</h4>
<div class="outline-text-4" id="text-1-31-3">
<p>
Note: In this rewrite, the D language version of the code became
longer than the C++ version because it is not possible to use include
statements as in C or C++, as a result, all declaration of structs and
functions from Windows API must to be rewritten in D. 
</p>

<p>
<b>Documentation of Windows APIs used:</b> 
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/win32/winprog/windows-data-types">Windows Data Types</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-createwindowexa">CreateWindowExA()</a> function (winuser.h)</li>

<li><a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/ms633573(v=vs.85)">WindowProc callback function</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/ns-processthreadsapi-startupinfoa">STARTUPINFOA structure</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/ns-winuser-wndclassexa">WNDCLASSEXA structure</a></li>

<li>Note: In order to view messages sent by the OutputDebugString
subroutine, it is necessary the tool <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/debugview">DebugView</a> from sysinternal.</li>

<li>React OS header file: <a href="https://github.com/reactos/reactos/blob/master/sdk/include/psdk/winuser.h">winuser.h</a> contains all constants WM_MOVE,
WM_CLOSE, &#x2026; and the source of many macros.
<ul class="org-ul">
<li>Note: The operating system vendor does not provide the header
file <span class="underline">winuser.h</span> on the internet. The only way to view this file
other than the accessing React OS source, is to install the
Windows SDK (Software Development Kit).</li>
</ul></li>
</ul>

<p>
<b>Files:</b>
</p>

<p>
File: <span class="underline">wingui.d</span>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">import</span> <span class="org-variable-name">std</span>.stdio;
<span class="org-type">import</span> <span class="org-variable-name">core</span>.stdc.stdio;
<span class="org-type">import</span> <span class="org-variable-name">std</span>.range: empty;
<span class="org-type">import</span> <span class="org-variable-name">std</span>.string;
<span class="org-type">import</span> <span class="org-variable-name">core</span>.stdc.string: strlen;
<span class="org-type">import</span> <span class="org-variable-name">std</span>.conv : to;

<span class="org-type">void</span> <span class="org-function-name">message_box_error</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">string</span> <span class="org-variable-name">message</span>, <span class="org-type">string</span> <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  MessageBoxA<span class="org-rainbow-delimiters-depth-2">(</span>  null
              , std.string.toStringz<span class="org-rainbow-delimiters-depth-3">(</span>message<span class="org-rainbow-delimiters-depth-3">)</span>
              , std.string.toStringz<span class="org-rainbow-delimiters-depth-3">(</span>title<span class="org-rainbow-delimiters-depth-3">)</span>
              , MB_ICONEXCLAMATION | MB_OK
             <span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-type">LRESULT</span> <span class="org-function-name">window_message_callback</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HWND</span> <span class="org-variable-name">hwnd</span>, <span class="org-type">UINT</span> <span class="org-variable-name">msg</span>, <span class="org-type">WPARAM</span> <span class="org-variable-name">wParam</span>, <span class="org-type">LPARAM</span> <span class="org-variable-name">lParam</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Process messages </span>
      <span class="org-keyword">switch</span><span class="org-rainbow-delimiters-depth-2">(</span>msg<span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-keyword">case</span> WM_CREATE:
                 <span class="org-keyword">break</span>;
         <span class="org-keyword">case</span> WM_CLOSE:     
                 DestroyWindow<span class="org-rainbow-delimiters-depth-3">(</span>hwnd<span class="org-rainbow-delimiters-depth-3">)</span>;
                 <span class="org-keyword">break</span>;
         <span class="org-keyword">case</span> WM_DESTROY:
                 PostQuitMessage<span class="org-rainbow-delimiters-depth-3">(</span>0<span class="org-rainbow-delimiters-depth-3">)</span>;
                 <span class="org-keyword">break</span>;
         <span class="org-keyword">case</span> WM_MOVE:
                 <span class="org-keyword">break</span>; 
         <span class="org-keyword">case</span> WM_PAINT:
         <span class="org-rainbow-delimiters-depth-3">{</span>
           <span class="org-comment-delimiter">// </span><span class="org-comment">GDI - Graphics Devices Interface Here</span>
           <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------</span>

           <span class="org-type">PAINTSTRUCT</span> <span class="org-variable-name">ps</span>;
           <span class="org-type">HDC</span> <span class="org-variable-name">hdc</span>;
           <span class="org-comment-delimiter">// </span><span class="org-comment">std::cerr &lt;&lt; " [INFO] Windown painting" &lt;&lt; std::endl;</span>
           hdc = BeginPaint<span class="org-rainbow-delimiters-depth-4">(</span>hwnd, &amp;ps<span class="org-rainbow-delimiters-depth-4">)</span>;
           <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">text</span> = std.string.toStringz<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Hello world Window!"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
           TextOutA<span class="org-rainbow-delimiters-depth-4">(</span>hdc, 125, 200, text, cast<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-5">)</span> strlen<span class="org-rainbow-delimiters-depth-5">(</span>text<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">)</span>;
           Ellipse<span class="org-rainbow-delimiters-depth-4">(</span>hdc, 100, 100, 160, 160<span class="org-rainbow-delimiters-depth-4">)</span>;
           Rectangle<span class="org-rainbow-delimiters-depth-4">(</span>hdc, 100, 100, 160, 160<span class="org-rainbow-delimiters-depth-4">)</span>;
           EndPaint<span class="org-rainbow-delimiters-depth-4">(</span>hwnd, &amp;ps<span class="org-rainbow-delimiters-depth-4">)</span>;

         <span class="org-rainbow-delimiters-depth-3">}</span>
         <span class="org-keyword">break</span>;
         <span class="org-keyword">default</span>:
           <span class="org-keyword">return</span> DefWindowProcA<span class="org-rainbow-delimiters-depth-3">(</span>hwnd, msg, wParam, lParam<span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">return</span> null;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Started D application. Ok \n\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span> = GetModuleHandleA<span class="org-rainbow-delimiters-depth-2">(</span>null<span class="org-rainbow-delimiters-depth-2">)</span>;
  assert<span class="org-rainbow-delimiters-depth-2">(</span> hInstance != null <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-type">STARTUPINFO_A</span> <span class="org-variable-name">si</span>;
  GetStartupInfoA<span class="org-rainbow-delimiters-depth-2">(</span>&amp;si<span class="org-rainbow-delimiters-depth-2">)</span>;  
  <span class="org-type">int</span> <span class="org-variable-name">nCmdShow</span> = si.wShowWindow;

  <span class="org-comment-delimiter">// </span><span class="org-comment">-------------------------//</span>
  OutputDebugStringA<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Starting WinMain Application"</span><span class="org-rainbow-delimiters-depth-2">)</span>;  

  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">wincClassName</span> = std.string.toStringz<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"NameOfWindow"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Win32 Window class structure</span>
  <span class="org-type">WNDCLASSEXA</span> <span class="org-variable-name">wc</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Win32 message structure </span>
  <span class="org-type">MSG</span> <span class="org-variable-name">Msg</span>;            

  wc.lpszClassName = cast<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">)</span> wincClassName;
  wc.lpfnWndProc   = &amp;window_message_callback;   
  wc.cbSize        = WNDCLASSEXA.<span class="org-keyword">sizeof</span>;
  wc.style         = 0;
  wc.cbClsExtra    = 0;
  wc.cbWndExtra    = 0;
  wc.hInstance     = hInstance;
  wc.hIcon         = LoadIconA<span class="org-rainbow-delimiters-depth-2">(</span>null, cast<span class="org-rainbow-delimiters-depth-3">(</span>LPCSTR<span class="org-rainbow-delimiters-depth-3">)</span> IDI_APPLICATION<span class="org-rainbow-delimiters-depth-2">)</span>;
  wc.hCursor       = LoadCursorA<span class="org-rainbow-delimiters-depth-2">(</span>null, cast<span class="org-rainbow-delimiters-depth-3">(</span>LPCSTR<span class="org-rainbow-delimiters-depth-3">)</span> IDC_ARROW<span class="org-rainbow-delimiters-depth-2">)</span>;
  wc.hbrBackground = cast<span class="org-rainbow-delimiters-depth-2">(</span>HBRUSH<span class="org-rainbow-delimiters-depth-2">)(</span>COLOR_WINDOW+1<span class="org-rainbow-delimiters-depth-2">)</span>;
  wc.hIconSm = LoadIconA<span class="org-rainbow-delimiters-depth-2">(</span>null, cast<span class="org-rainbow-delimiters-depth-3">(</span>LPCSTR<span class="org-rainbow-delimiters-depth-3">)</span> IDI_APPLICATION<span class="org-rainbow-delimiters-depth-2">)</span>;    

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>RegisterClassExA<span class="org-rainbow-delimiters-depth-3">(</span>&amp;wc<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    message_box_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Window Registration Failed!"</span>, <span class="org-string">"Error!"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-comment-delimiter">//</span><span class="org-comment">Error status code </span>
    <span class="org-keyword">return</span> -1;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-type">int</span> <span class="org-variable-name">width</span> = 500, <span class="org-variable-name">height</span> = 400;
  <span class="org-type">int</span> <span class="org-variable-name">pos_left</span> = 400, <span class="org-variable-name">pos_top</span> = 100;

  <span class="org-type">HWND</span> <span class="org-variable-name">hwnd</span> = CreateWindowExA<span class="org-rainbow-delimiters-depth-2">(</span>
                                0
                              , wc.lpszClassName
                              , <span class="org-string">"Title of Window"</span>
                              , WS_OVERLAPPEDWINDOW
                              , pos_left
                              , pos_top
                              , width
                              , height
                              , null
                              , null
                              , hInstance
                              , null
                              <span class="org-rainbow-delimiters-depth-2">)</span>;  
  assert<span class="org-rainbow-delimiters-depth-2">(</span> hwnd != null <span class="org-rainbow-delimiters-depth-2">)</span>;

  OutputDebugStringA<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Window created OK"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hwnd == null<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
       message_box_error<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-string">"Error: Failure to create Window"</span>, <span class="org-string">"Error Report"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">return</span> -1;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  ShowWindow<span class="org-rainbow-delimiters-depth-2">(</span>hwnd, nCmdShow<span class="org-rainbow-delimiters-depth-2">)</span>;
  UpdateWindow<span class="org-rainbow-delimiters-depth-2">(</span>hwnd<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">//</span><span class="org-comment">---- Message Loop ----------//</span>
  <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> GetMessageA<span class="org-rainbow-delimiters-depth-3">(</span>&amp;Msg, null, 0, 0<span class="org-rainbow-delimiters-depth-3">)</span> &gt; 0 <span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
    TranslateMessage<span class="org-rainbow-delimiters-depth-3">(</span>&amp;Msg<span class="org-rainbow-delimiters-depth-3">)</span>;
    DispatchMessageA<span class="org-rainbow-delimiters-depth-3">(</span>&amp;Msg<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>     

  message_box_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Program terminated Ok."</span>, <span class="org-string">"Information:"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">return</span> 0;

<span class="org-rainbow-delimiters-depth-1">}</span>

      <span class="org-comment-delimiter">// </span><span class="org-comment">========== I M P L E M E N T A T I O N S  =================== //</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Useful Type aliases</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">----------------------------------//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Alias for C or C++ void* void pointer (opaque pointer)</span>
<span class="org-type">alias</span> <span class="org-variable-name">LPVOID</span>   = <span class="org-type">void</span>*;
<span class="org-comment-delimiter">// </span><span class="org-comment">Windows handle's alias aliases</span>
<span class="org-type">alias</span> <span class="org-variable-name">HINSTANCE</span> = LPVOID;
<span class="org-type">alias</span> <span class="org-variable-name">HANDLE</span>    = LPVOID;
<span class="org-type">alias</span> <span class="org-variable-name">HWND</span>      = LPVOID;
<span class="org-type">alias</span> <span class="org-variable-name">HDC</span>       = LPVOID;
<span class="org-type">alias</span> <span class="org-variable-name">HMODULE</span>   = LPVOID;
<span class="org-type">alias</span> <span class="org-variable-name">HICON</span>     = LPVOID;
<span class="org-type">alias</span> <span class="org-variable-name">HCURSOR</span>   = LPVOID;
<span class="org-type">alias</span> <span class="org-variable-name">HBRUSH</span>    = LPVOID;
<span class="org-type">alias</span> <span class="org-variable-name">HMENU</span>     = LPVOID;
<span class="org-comment-delimiter">// </span><span class="org-comment">Aliases for string aliass</span>
<span class="org-type">alias</span> <span class="org-variable-name">LPCSTR</span>  = <span class="org-keyword">const</span> <span class="org-type">char</span>*;
<span class="org-type">alias</span> <span class="org-variable-name">LPSTR</span>   = <span class="org-type">char</span>*;
<span class="org-comment-delimiter">// </span><span class="org-comment">Operation status code</span>
<span class="org-type">alias</span> <span class="org-variable-name">HRESULT</span> = <span class="org-type">long</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">Return code of COM interfaces</span>
<span class="org-type">alias</span> <span class="org-variable-name">BOOL</span>    = <span class="org-type">int</span>;  <span class="org-comment-delimiter">// </span><span class="org-comment">Boolean status code (0 - false), (1  or anything else is true)</span>
<span class="org-type">alias</span> <span class="org-variable-name">LPRESULT</span> = <span class="org-keyword">const</span> HRESULT*;

<span class="org-comment-delimiter">// </span><span class="org-comment">Non Categorized aliases</span>
<span class="org-type">alias</span> <span class="org-variable-name">UINT</span>    = uint;
<span class="org-type">alias</span> <span class="org-variable-name">LONG</span>    = <span class="org-type">long</span>;
<span class="org-type">alias</span> <span class="org-variable-name">BYTE</span>    = <span class="org-type">char</span>;
<span class="org-type">alias</span> <span class="org-variable-name">LPBYTE</span>  = <span class="org-type">char</span>*;
<span class="org-type">alias</span> <span class="org-variable-name">WORD</span>    = <span class="org-type">short</span>;
<span class="org-type">alias</span> <span class="org-variable-name">DWORD</span>   = <span class="org-type">int</span>;
<span class="org-type">alias</span> <span class="org-variable-name">WPARAM</span>  = UINT*;
<span class="org-type">alias</span> <span class="org-variable-name">LPARAM</span>  = <span class="org-type">long</span>*;
<span class="org-type">alias</span> <span class="org-variable-name">LRESULT</span> = <span class="org-type">long</span>*;
<span class="org-type">alias</span> <span class="org-variable-name">ATOM</span>    = WORD;


<span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for C function pointer (Function with C linkage)</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">,in other words, function with C-calling convention.</span>
<span class="org-type">alias</span>  <span class="org-variable-name">WNDPROC</span> = <span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-type">LRESULT</span> <span class="org-function-name">function</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">HWND</span> <span class="org-variable-name">hwnd</span>
                                             , <span class="org-type">UINT</span> <span class="org-variable-name">uMsg</span>
                                             , <span class="org-type">WPARAM</span> <span class="org-variable-name">wParam</span>
                                             , <span class="org-type">LPARAM</span> <span class="org-variable-name">lParam</span> <span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-keyword">struct</span> <span class="org-type">RECT</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">LONG</span> <span class="org-variable-name">left</span>;
  <span class="org-type">LONG</span> <span class="org-variable-name">top</span>;
  <span class="org-type">LONG</span> <span class="org-variable-name">right</span>;
  <span class="org-type">LONG</span> <span class="org-variable-name">bottom</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">struct</span> <span class="org-type">POINT</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  LONG x;
  <span class="org-type">LONG</span> <span class="org-variable-name">y</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">MSG</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">HWND</span>   <span class="org-variable-name">hwnd</span>;
  <span class="org-type">UINT</span>   <span class="org-variable-name">message</span>;
  <span class="org-type">WPARAM</span> <span class="org-variable-name">wParam</span>;
  <span class="org-type">LPARAM</span> <span class="org-variable-name">lParam</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">time</span>;
  <span class="org-type">POINT</span>  <span class="org-variable-name">pt</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">lPrivate</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">STARTUPINFO_A</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">DWORD</span>  <span class="org-variable-name">cb</span>;
  <span class="org-type">LPSTR</span>  <span class="org-variable-name">lpReserved</span>;
  <span class="org-type">LPSTR</span>  <span class="org-variable-name">lpDesktop</span>;
  <span class="org-type">LPSTR</span>  <span class="org-variable-name">lpTitle</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">dwX</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">dwY</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">dwXSize</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">dwYSize</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">dwXCountChars</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">dwYCountChars</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">dwFillAttribute</span>;
  <span class="org-type">DWORD</span>  <span class="org-variable-name">dwFlags</span>;
  <span class="org-type">WORD</span>   <span class="org-variable-name">wShowWindow</span>;
  <span class="org-type">WORD</span>   <span class="org-variable-name">cbReserved2</span>;
  <span class="org-type">LPBYTE</span> <span class="org-variable-name">lpReserved2</span>;
  <span class="org-type">HANDLE</span> <span class="org-variable-name">hStdInput</span>;
  <span class="org-type">HANDLE</span> <span class="org-variable-name">hStdOutput</span>;
  <span class="org-type">HANDLE</span> <span class="org-variable-name">hStdError</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">WNDCLASSEXA</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">UINT</span>      <span class="org-variable-name">cbSize</span>;
  <span class="org-type">UINT</span>      <span class="org-variable-name">style</span>;
  <span class="org-type">WNDPROC</span>   <span class="org-variable-name">lpfnWndProc</span>;
  <span class="org-type">int</span>       <span class="org-variable-name">cbClsExtra</span>;
  <span class="org-type">int</span>       <span class="org-variable-name">cbWndExtra</span>;
  <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span>;
  <span class="org-type">HICON</span>     <span class="org-variable-name">hIcon</span>;
  <span class="org-type">HCURSOR</span>   <span class="org-variable-name">hCursor</span>;
  <span class="org-type">HBRUSH</span>    <span class="org-variable-name">hbrBackground</span>;
  <span class="org-type">LPSTR</span>     <span class="org-variable-name">lpszMenuName</span>;
  <span class="org-type">LPSTR</span>     <span class="org-variable-name">lpszClassName</span>;
  <span class="org-type">HICON</span>     <span class="org-variable-name">hIconSm</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">PAINTSTRUCT</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">HDC</span>  <span class="org-variable-name">hdc</span>;
  <span class="org-type">BOOL</span> <span class="org-variable-name">fErase</span>;
  <span class="org-type">RECT</span> <span class="org-variable-name">rcPaint</span>;
  <span class="org-type">BOOL</span> <span class="org-variable-name">fRestore</span>;
  <span class="org-type">BOOL</span> <span class="org-variable-name">fIncUpdate</span>;
  BYTE<span class="org-rainbow-delimiters-depth-2">[</span>32<span class="org-rainbow-delimiters-depth-2">]</span> rgbReserved;
<span class="org-rainbow-delimiters-depth-1">}</span>; 

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">int</span> <span class="org-function-name">MessageBoxA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HWND</span> <span class="org-variable-name">hWnd</span>, <span class="org-type">LPCSTR</span> <span class="org-variable-name">lpText</span>, <span class="org-type">LPCSTR</span> <span class="org-variable-name">lpCaption</span>, <span class="org-type">UINT</span> <span class="org-variable-name">uType</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">void</span> <span class="org-function-name">OutputDebugStringA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPCSTR</span> <span class="org-variable-name">lpOutputString</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">HMODULE</span> <span class="org-function-name">GetModuleHandleA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPCSTR</span> <span class="org-variable-name">lpModuleName</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">ShowWindow</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HWND</span> <span class="org-variable-name">hWnd</span>, <span class="org-type">int</span> <span class="org-variable-name">nCmdShow</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">UpdateWindow</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HWND</span> <span class="org-variable-name">hWnd</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">GetMessageA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">MSG</span>* <span class="org-variable-name">lpMsg</span>, <span class="org-type">HWND</span> <span class="org-variable-name">hWnd</span>, <span class="org-type">UINT</span> <span class="org-variable-name">wMsgFilterMin</span>, <span class="org-type">UINT</span> <span class="org-variable-name">wMsgFilterMax</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">TranslateMessage</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">MSG</span> *<span class="org-variable-name">lpMsg</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">DestroyWindow</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HWND</span> <span class="org-variable-name">hWnd</span><span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">HWND</span> <span class="org-function-name">CreateWindowExA</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwExStyle</span>,
  <span class="org-type">LPCSTR</span>    <span class="org-variable-name">lpClassName</span>,
  <span class="org-type">LPCSTR</span>    <span class="org-variable-name">lpWindowName</span>,
  <span class="org-type">DWORD</span>     <span class="org-variable-name">dwStyle</span>,
  <span class="org-type">int</span>       <span class="org-variable-name">X</span>,
  <span class="org-type">int</span>       <span class="org-variable-name">Y</span>,
  <span class="org-type">int</span>       <span class="org-variable-name">nWidth</span>,
  <span class="org-type">int</span>       <span class="org-variable-name">nHeight</span>,
  <span class="org-type">HWND</span>      <span class="org-variable-name">hWndParent</span>,
  <span class="org-type">HMENU</span>     <span class="org-variable-name">hMenu</span>,
  <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span>,
  <span class="org-type">LPVOID</span>    <span class="org-variable-name">lpParam</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">ATOM</span> <span class="org-function-name">RegisterClassExA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">WNDCLASSEXA</span> *<span class="org-variable-name">unnamedParam1</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">void</span> <span class="org-function-name">GetStartupInfoA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">STARTUPINFO_A</span>* <span class="org-variable-name">lpStartupInfo</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">HICON</span>   <span class="org-function-name">LoadIconA</span>  <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span>, <span class="org-type">LPCSTR</span> <span class="org-variable-name">lpIconName</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">HCURSOR</span> <span class="org-function-name">LoadCursorA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span>, <span class="org-type">LPCSTR</span> <span class="org-variable-name">lpCursorName</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">LRESULT</span> <span class="org-function-name">DispatchMessageA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">MSG</span> *<span class="org-variable-name">lpMsg</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">void</span> <span class="org-function-name">PostQuitMessage</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">nExitCode</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">LRESULT</span> <span class="org-function-name">DefWindowProcA</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">HWND</span> <span class="org-variable-name">hWnd</span>, <span class="org-type">UINT</span> <span class="org-variable-name">Msg</span>
                                 , <span class="org-type">WPARAM</span> <span class="org-variable-name">wParam</span>, <span class="org-type">LPARAM</span> <span class="org-variable-name">lParam</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">HDC</span>  <span class="org-function-name">BeginPaint</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HWND</span> <span class="org-variable-name">hWnd</span>,       <span class="org-type">PAINTSTRUCT</span>* <span class="org-variable-name">lpPaint</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">EndPaint</span>  <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HWND</span> <span class="org-variable-name">hWnd</span>, <span class="org-keyword">const</span> <span class="org-type">PAINTSTRUCT</span>* <span class="org-variable-name">lpPaint</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">TextOutA</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HDC</span> <span class="org-variable-name">hdc</span>, <span class="org-type">int</span> <span class="org-variable-name">x</span>, <span class="org-type">int</span> <span class="org-variable-name">y</span>, <span class="org-type">LPCSTR</span> <span class="org-variable-name">lpString</span>, <span class="org-type">int</span> <span class="org-variable-name">c</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">Ellipse</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HDC</span> <span class="org-variable-name">hdc</span>, <span class="org-type">int</span> <span class="org-variable-name">left</span>, <span class="org-type">int</span> <span class="org-variable-name">top</span>, <span class="org-type">int</span> <span class="org-variable-name">right</span>, <span class="org-type">int</span> <span class="org-variable-name">bottom</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">extern</span><span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">BOOL</span> <span class="org-function-name">Rectangle</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HDC</span> <span class="org-variable-name">hdc</span>, <span class="org-type">int</span> <span class="org-variable-name">left</span>, <span class="org-type">int</span> <span class="org-variable-name">top</span>, <span class="org-type">int</span> <span class="org-variable-name">right</span>, <span class="org-type">int</span> <span class="org-variable-name">bottom</span><span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">IDI_APPLICATION</span>  = 32512;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">IDI_HAND</span>         = 32513;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">IDI_QUESTION</span>     = 32514;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">IDI_EXCLAMATION</span>  = 32515;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">IDI_ASTERISK</span>     = 32516;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">IDI_WINLOGO</span>      = 32517;
<span class="org-keyword">const</span> <span class="org-type">int</span> <span class="org-variable-name">IDC_ARROW</span>        = 32512;

<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">WS_OVERLAPPEDWINDOW</span> = 0xcf0000;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">WM_NULL</span>     = 0;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">WM_CREATE</span>   = 1;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">WM_DESTROY</span>  = 2;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">WM_ENABLE</span>   = 10;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">WM_CLOSE</span>    = 16;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">WM_QUIT</span>     = 18;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">WM_PAINT</span>    = 15;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">WM_MOVE</span>     = 3;


<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">COLOR_WINDOW</span> = 5;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_USERICON</span> = 128;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_ICONASTERISK</span> = 64;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_ICONEXCLAMATION</span> = 0x30;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_ICONWARNING</span> = 0x30;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_ICONERROR</span> = 16;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_ICONHAND</span> = 16;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_ICONQUESTION</span> = 32;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_OK</span> = 0;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_ABORTRETRYIGNORE</span> = 2;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_APPLMODAL</span> = 0;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_DEFAULT_DESKTOP_ONLY</span> = 0x20000;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_HELP</span>              = 0x4000;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_RIGHT</span>            = 0x80000;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_RTLREADING</span>       = 0x100000;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_TOPMOST</span>          = 0x40000;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_DEFBUTTON1</span>       = 0;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_DEFBUTTON2</span>       = 256;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_DEFBUTTON3</span>       = 512;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_DEFBUTTON4</span>       = 0x300;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_ICONINFORMATION</span>  = 64;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_ICONSTOP</span>         = 16;
<span class="org-keyword">const</span> <span class="org-type">DWORD</span> <span class="org-variable-name">MB_OKCANCEL</span>         = 1;
</pre>
</div>

<p>
<b>Building</b> 
</p>

<p>
Building for console subsystem: (default)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ dmd wingui.d -of=wingui_console_subsystem.exe -m64 Kernel32.lib Ntdll.lib User32.lib Gdi32.lib  
</pre>
</div>

<p>
Building for window subsystem: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ dmd wingui.d -of=wingui_window_subsystem.exe -m64 -L/SUBSYSTEM:WINDOWS -L/ENTRY:mainCRTStartup Kernel32.lib Ntdll.lib User32.lib Gdi32.lib 
</pre>
</div>

<p>
<b>Runninng</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Console subsystem =&gt;&gt; Opens a terminal window when user clicks </span>
<span class="org-comment-delimiter"># </span><span class="org-comment">at the executable. </span>
$ .\wingui_console_subsystem.exe

<span class="org-comment-delimiter"># </span><span class="org-comment">Window subsystem version =&gt; Prints nothing in the terminal. </span>
$ .\wingui_window_subsystem.exe
</pre>
</div>
</div>
</div>
<div id="outline-container-org26b50bc" class="outline-4">
<h4 id="org26b50bc"><span class="section-number-4">1.31.4</span> GUI without WinMain in Rust</h4>
<div class="outline-text-4" id="text-1-31-4">
<p>
Note:  This Rust rewrite shows a blank GUI window and a message box
when the window is closed.  This code is still incomplete and still
needs porting the GDI structs for 2D drawing on the window. 
</p>

<p>
<b>Files:</b>
</p>

<p>
File: <span class="underline">rust-wingui.rs</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Build for the "window" subsystem instead of console subsystem.</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Comment the next uncommented line to enable the console subsystem and view</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">the stdout and stderr output.</span>
#<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-variable-name">windows_subsystem</span> = <span class="org-string">"windows"</span><span class="org-rainbow-delimiters-depth-1">]</span> 

use <span class="org-constant">std</span>::<span class="org-constant">os</span>::raw::<span class="org-rainbow-delimiters-depth-1">{</span>c_int, c_char, c_long, c_void, c_uint, c_short<span class="org-rainbow-delimiters-depth-1">}</span>;
<span class="org-type">use</span> <span class="org-constant">std</span>::<span class="org-constant">ffi</span>::<span class="org-variable-name">CString</span>;
<span class="org-type">use</span> <span class="org-constant">std</span>::<span class="org-variable-name">mem</span>;

<span class="org-keyword">const</span> <span class="org-type">IDI_APPLICATION</span>: c_int = 32512;
<span class="org-keyword">const</span> <span class="org-type">IDI_HAND</span>:        c_int = 32513;
<span class="org-keyword">const</span> <span class="org-type">IDI_QUESTION</span>:    c_int = 32514;
<span class="org-keyword">const</span> <span class="org-type">IDI_EXCLAMATION</span>: c_int = 32515;
<span class="org-keyword">const</span> <span class="org-type">IDI_ASTERISK</span>:    c_int = 32516;
<span class="org-keyword">const</span> <span class="org-type">IDI_WINLOGO</span>:     c_int = 32517;
<span class="org-keyword">const</span> <span class="org-type">IDC_ARROW</span>:       c_int = 32512;

<span class="org-keyword">const</span> <span class="org-type">WS_OVERLAPPEDWINDOW</span>: DWORD = 0xcf0000;

<span class="org-keyword">const</span> <span class="org-type">WM_NULL</span>:    UINT = 0;
<span class="org-keyword">const</span> <span class="org-type">WM_CREATE</span>:  UINT = 1;
<span class="org-keyword">const</span> <span class="org-type">WM_DESTROY</span>: UINT = 2;
<span class="org-keyword">const</span> <span class="org-type">WM_ENABLE</span>:  UINT = 10;
<span class="org-keyword">const</span> <span class="org-type">WM_CLOSE</span>:   UINT = 16;
<span class="org-keyword">const</span> <span class="org-type">WM_QUIT</span>:    UINT = 18;
<span class="org-keyword">const</span> <span class="org-type">WM_PAINT</span>:   UINT = 15;
<span class="org-keyword">const</span> <span class="org-type">WM_MOVE</span>:    UINT = 3;

<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-type">fn</span> <span class="org-function-name">window_message_callback</span><span class="org-rainbow-delimiters-depth-1">(</span>  hwnd: HWND, msg: UINT
                                      , wParam: WPARAM, lParam: LPARAM<span class="org-rainbow-delimiters-depth-1">)</span> -&gt; LRESULT
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">let</span> <span class="org-variable-name">zero_ptr</span> = <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-keyword">if</span> msg == WM_CLOSE <span class="org-rainbow-delimiters-depth-2">{</span>
        output_debug_string<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Message WM_CLOSE sent. =&gt; Shutdown application"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        unsafe <span class="org-rainbow-delimiters-depth-3">{</span> DestroyWindow<span class="org-rainbow-delimiters-depth-4">(</span>hwnd<span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> zero_ptr;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span> msg == WM_DESTROY <span class="org-rainbow-delimiters-depth-2">{</span>
        output_debug_string<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Message WM_DESTROY sent."</span><span class="org-rainbow-delimiters-depth-3">)</span>;    
        unsafe<span class="org-rainbow-delimiters-depth-3">{</span>
            PostQuitMessage<span class="org-rainbow-delimiters-depth-4">(</span>0<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> zero_ptr;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span> msg == WM_MOVE <span class="org-rainbow-delimiters-depth-2">{</span>
        output_debug_string<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Message WM_MOVE sent."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> zero_ptr;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span> msg == WM_PAINT <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">TODO - Port the following code for the GDI</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">(GDI - Graphics Device Interface)</span>
        <span class="org-comment-delimiter">/** </span>
<span class="org-comment">        *      PAINTSTRUCT ps;</span>
<span class="org-comment">        *      HDC hdc;</span>
<span class="org-comment">        *      // std::cerr &lt;&lt; " [INFO] Windown painting" &lt;&lt; std::endl;</span>
<span class="org-comment">        *      hdc = BeginPaint(hwnd, &amp;ps);</span>
<span class="org-comment">        *      std::string text = "Hello world Window!";      </span>
<span class="org-comment">        *      TextOutA(hdc, 125, 200, text.c_str(), text.size());</span>
<span class="org-comment">        *      Ellipse(hdc, 100, 100, 160, 160);</span>
<span class="org-comment">        *      Rectangle(hdc, 100, 100, 160, 160);</span>
<span class="org-comment">        *      EndPaint(hwnd, &amp;ps);       </span>
<span class="org-comment">        -------------------------------------------------*/</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">output_debug_string("TODO - Finish the GDI code");</span>
        <span class="org-keyword">return</span> zero_ptr;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">return</span> unsafe<span class="org-rainbow-delimiters-depth-2">{</span> DefWindowProcA<span class="org-rainbow-delimiters-depth-3">(</span>hwnd, msg, wParam, lParam<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">}</span>;
    <span class="org-comment-delimiter">//</span><span class="org-comment">return std::ptr::null_mut();</span>
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">fn</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Hello world Rust! on Windows NT."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    output_debug_string<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Hello world from a Rust process!!"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    output_debug_string<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"You can see those messages using Sysinternals tool"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">let</span> <span class="org-variable-name">c_null_ptr</span> =  <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-type">let</span> <span class="org-variable-name">c_null_ptr_u8</span> = <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-type">as</span> *<span class="org-variable-name">mut</span> u8;


    <span class="org-type">let</span> <span class="org-variable-name">hInstance</span>: HINSTANCE = unsafe <span class="org-rainbow-delimiters-depth-2">{</span>  GetModuleHandleA<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">}</span>;
    assert<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span> hInstance != c_null_ptr <span class="org-rainbow-delimiters-depth-2">)</span>;


    <span class="org-comment-delimiter">// </span><span class="org-comment">Initialize struct</span>
    <span class="org-type">let</span> <span class="org-type">mut</span> <span class="org-variable-name">si</span>: STARTUPINFO_A = STARTUPINFO_A <span class="org-rainbow-delimiters-depth-2">{</span>
              cb: 0
            , lpReserved:      <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-3">()</span>
            , lpDesktop:       c_null_ptr_u8
            , lpTitle:         c_null_ptr_u8
            , dwX:             0
            , dwY:             0
            , dwXSize:         0
            , dwYSize:         0
            , dwXCountChars:   0
            , dwYCountChars:   0
            , dwFillAttribute: 0
            , dwFlags:         0
            , wShowWindow:     0
            , cbReserved2:     0
            , lpReserved2:     <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-3">()</span>
            , hStdInput:       c_null_ptr
            , hStdOutput:      c_null_ptr
            , hStdError:       c_null_ptr
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    unsafe <span class="org-rainbow-delimiters-depth-2">{</span>  GetStartupInfoA<span class="org-rainbow-delimiters-depth-3">(</span> &amp;mut si as *mut _ <span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-type">let</span> <span class="org-variable-name">nCmdShow</span>: WORD = si.wShowWindow;

    <span class="org-type">let</span> <span class="org-variable-name">className</span>: &amp;str = <span class="org-string">"NameOfWIndow"</span>;
    <span class="org-type">let</span> <span class="org-variable-name">className_</span>: CString = <span class="org-constant">CString</span>::<span class="org-keyword">new</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">className</span><span class="org-rainbow-delimiters-depth-2">)</span>.unwrap<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-type">let</span> <span class="org-variable-name">COLOR_WINDOW</span>: c_int = 5;

    <span class="org-type">let</span> <span class="org-type">mut</span> <span class="org-variable-name">wc</span> = WNDCLASSEXA <span class="org-rainbow-delimiters-depth-2">{</span>
              cbSize:        <span class="org-constant">mem</span>::size_of::<span class="org-rainbow-delimiters-depth-3">&lt;</span>WNDCLASSEXA<span class="org-rainbow-delimiters-depth-3">&gt;()</span> <span class="org-type">as</span> <span class="org-variable-name">u32</span>
            , <span class="org-variable-name">style</span>:         0
            , <span class="org-variable-name">lpfnWndProc</span>:   window_message_callback 
            , <span class="org-variable-name">cbClsExtra</span>:    0
            , <span class="org-variable-name">cbWndExtra</span>:    0
            , <span class="org-variable-name">hInstance</span>:     hInstance
            , <span class="org-variable-name">hIcon</span>:         unsafe<span class="org-rainbow-delimiters-depth-3">{</span> LoadIconA<span class="org-rainbow-delimiters-depth-4">(</span> c_null_ptr , IDI_APPLICATION<span class="org-rainbow-delimiters-depth-4">)</span>  <span class="org-rainbow-delimiters-depth-3">}</span>
            , hCursor:       unsafe<span class="org-rainbow-delimiters-depth-3">{</span> LoadCursorA<span class="org-rainbow-delimiters-depth-4">(</span> c_null_ptr, IDC_ARROW<span class="org-rainbow-delimiters-depth-4">)</span>       <span class="org-rainbow-delimiters-depth-3">}</span>
            , hbrBackground: <span class="org-rainbow-delimiters-depth-3">(</span>COLOR_WINDOW + 1<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-type">as</span> *<span class="org-variable-name">mut</span> _
            , <span class="org-variable-name">lpszMenuName</span>:  <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-3">()</span>
            , <span class="org-variable-name">lpszClassName</span>: className_.as_ptr<span class="org-rainbow-delimiters-depth-3">()</span> 
            , <span class="org-variable-name">hIconSm</span>:       <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-3">()</span>
     <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-type">let</span> <span class="org-type">mut</span> <span class="org-variable-name">result</span>: ATOM = 0; <span class="org-comment-delimiter">// </span><span class="org-comment">False</span>

    result = unsafe <span class="org-rainbow-delimiters-depth-2">{</span>  RegisterClassExA<span class="org-rainbow-delimiters-depth-3">(</span>&amp;wc as *<span class="org-keyword">const</span> _<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">}</span>;
    assert<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span> result != 0<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">let</span> <span class="org-variable-name">pos_left</span>: DWORD = 400;
    <span class="org-type">let</span> <span class="org-variable-name">pos_top</span>:  DWORD = 100;
    <span class="org-type">let</span> <span class="org-variable-name">width</span>:    DWORD = 500;
    <span class="org-type">let</span> <span class="org-variable-name">height</span>:   DWORD = 400;

    <span class="org-type">let</span> <span class="org-variable-name">title</span> = <span class="org-constant">CString</span>::<span class="org-keyword">new</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Title of Window"</span><span class="org-rainbow-delimiters-depth-2">)</span>.unwrap<span class="org-rainbow-delimiters-depth-2">()</span> ;

    <span class="org-type">let</span> <span class="org-variable-name">hwnd</span>: HWND = unsafe <span class="org-rainbow-delimiters-depth-2">{</span>
        CreateWindowExA<span class="org-rainbow-delimiters-depth-3">(</span>
              0                             <span class="org-comment-delimiter">// </span><span class="org-comment">dwExStyle</span>
            , wc.lpszClassName              <span class="org-comment-delimiter">// </span><span class="org-comment">lpClassName</span>
            , title.as_ptr<span class="org-rainbow-delimiters-depth-4">()</span>                <span class="org-comment-delimiter">// </span><span class="org-comment">lpWindowName</span>
            , WS_OVERLAPPEDWINDOW           <span class="org-comment-delimiter">// </span><span class="org-comment">dwStyle</span>
            , pos_left, pos_top             <span class="org-comment-delimiter">// </span><span class="org-comment">X, Y </span>
            , width, height                 <span class="org-comment-delimiter">// </span><span class="org-comment">nWidth, nHeight</span>
            , c_null_ptr                    <span class="org-comment-delimiter">// </span><span class="org-comment">hWndParent </span>
            , c_null_ptr                    <span class="org-comment-delimiter">// </span><span class="org-comment">hMenu </span>
            , hInstance                     <span class="org-comment-delimiter">// </span><span class="org-comment">hInstance </span>
            , c_null_ptr                    <span class="org-comment-delimiter">// </span><span class="org-comment">lpParam </span>
        <span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    assert<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span> hwnd != c_null_ptr <span class="org-rainbow-delimiters-depth-2">)</span>;

    unsafe <span class="org-rainbow-delimiters-depth-2">{</span>
        ShowWindow<span class="org-rainbow-delimiters-depth-3">(</span>hwnd, nCmdShow <span class="org-type">as</span> <span class="org-variable-name">i32</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        UpdateWindow<span class="org-rainbow-delimiters-depth-3">(</span>hwnd<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Dummy initialization =&gt; This struct is initialized</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">by GetMessage(), however rust does not provide </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">any means to default initialize this struct.</span>
    <span class="org-type">let</span> <span class="org-type">mut</span> <span class="org-variable-name">msg</span>: MSG = MSG <span class="org-rainbow-delimiters-depth-2">{</span>
              hwnd:     c_null_ptr
            , message:  0
            , wParam:   <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-3">()</span>
            , lParam:   <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-3">()</span>
            , time:     0
            , pt:       POINT<span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-constant">x</span>: 0, y: 0 <span class="org-rainbow-delimiters-depth-3">}</span>
            , lPrivate: 0
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">---- Window event loop ---</span>
    loop <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">let</span> <span class="org-variable-name">cond</span> = unsafe <span class="org-rainbow-delimiters-depth-3">{</span> GetMessageA<span class="org-rainbow-delimiters-depth-4">(</span>&amp;mut msg as *mut _, c_null_ptr, 0, 0<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">}</span>;
        <span class="org-keyword">if</span> cond &lt;= 0 <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">break</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

        unsafe <span class="org-rainbow-delimiters-depth-3">{</span>
            TranslateMessage<span class="org-rainbow-delimiters-depth-4">(</span>&amp;msg<span class="org-rainbow-delimiters-depth-4">)</span>;
            DispatchMessageA<span class="org-rainbow-delimiters-depth-4">(</span>&amp;msg<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">message_box_info("Application terminated Ok", "Notification");    </span>
    println<span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Terminated. Ok!"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() --- //</span>

       <span class="org-comment-delimiter">// </span><span class="org-comment">=====  I M P L E M E N T A T I O N S ============= //</span>
       <span class="org-comment-delimiter">//</span><span class="org-comment">****************************************************//</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Useful Type aliases</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">----------------------------------//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Alias for C or C++ void* void pointer (opaque pointer)</span>
<span class="org-type">type</span> <span class="org-variable-name">LPVOID</span>   = *mut c_void;
<span class="org-comment-delimiter">// </span><span class="org-comment">Windows handle's type aliases</span>
<span class="org-type">type</span> <span class="org-variable-name">HINSTANCE</span> = LPVOID;
<span class="org-type">type</span> <span class="org-variable-name">HANDLE</span>    = LPVOID;
<span class="org-type">type</span> <span class="org-variable-name">HWND</span>      = LPVOID;
<span class="org-type">type</span> <span class="org-variable-name">HMODULE</span>   = LPVOID;
<span class="org-type">type</span> <span class="org-variable-name">HICON</span>     = LPVOID;
<span class="org-type">type</span> <span class="org-variable-name">HCURSOR</span>   = LPVOID;
<span class="org-type">type</span> <span class="org-variable-name">HBRUSH</span>    = LPVOID;
<span class="org-type">type</span> <span class="org-variable-name">HMENU</span>     = LPVOID;
<span class="org-comment-delimiter">// </span><span class="org-comment">Aliases for string types</span>
<span class="org-type">type</span> <span class="org-variable-name">LPCSTR</span>  = *<span class="org-keyword">const</span> c_char;
<span class="org-type">type</span> <span class="org-variable-name">LPSTR</span>   = *mut u8;
<span class="org-comment-delimiter">// </span><span class="org-comment">Operation status code</span>
<span class="org-type">type</span> <span class="org-variable-name">HRESULT</span> = c_long; <span class="org-comment-delimiter">// </span><span class="org-comment">Return code of COM interfaces</span>
<span class="org-type">type</span> <span class="org-variable-name">BOOL</span>    = c_int;  <span class="org-comment-delimiter">// </span><span class="org-comment">Boolean status code (0 - false), (1  or anything else is true)</span>
<span class="org-type">type</span> <span class="org-variable-name">LPRESULT</span> = *<span class="org-keyword">const</span> HRESULT;

<span class="org-comment-delimiter">// </span><span class="org-comment">Non Categorized aliases</span>
<span class="org-type">type</span> <span class="org-variable-name">UINT</span>    = c_uint;
<span class="org-type">type</span> <span class="org-variable-name">LPBYTE</span>  = *mut u8;
<span class="org-type">type</span> <span class="org-variable-name">WORD</span>    = c_short;
<span class="org-type">type</span> <span class="org-variable-name">DWORD</span>   = c_int;
<span class="org-type">type</span> <span class="org-variable-name">WPARAM</span>  = *mut UINT;
<span class="org-type">type</span> <span class="org-variable-name">LPARAM</span>  = *mut c_long;
<span class="org-type">type</span> <span class="org-variable-name">LRESULT</span> = *mut c_long;
<span class="org-type">type</span> <span class="org-variable-name">LONG</span>    = c_long;
<span class="org-type">type</span> <span class="org-variable-name">ATOM</span>    = WORD;

<span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for C function pointer (Function with C linkage)</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">,in other words, function with C-calling convention.</span>
<span class="org-type">type</span>  <span class="org-variable-name">WindowProc</span> = unsafe <span class="org-keyword">extern</span> <span class="org-string">"C"</span> fn<span class="org-rainbow-delimiters-depth-1">(</span>  hwnd:   HWND
                                        , uMsg:   UINT
                                        , wParam: WPARAM
                                        , lParam: LPARAM<span class="org-rainbow-delimiters-depth-1">)</span> -&gt; LRESULT;


#<span class="org-rainbow-delimiters-depth-1">[</span>repr<span class="org-rainbow-delimiters-depth-2">(</span>C<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-keyword">struct</span> STARTUPINFO_A <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">cb</span>:              DWORD
  , lpReserved:      LPSTR
  , lpDesktop:       LPSTR
  , lpTitle:         LPSTR
  , dwX:             DWORD
  , dwY:             DWORD
  , dwXSize:         DWORD
  , dwYSize:         DWORD
  , dwXCountChars:   DWORD
  , dwYCountChars:   DWORD
  , dwFillAttribute: DWORD
  , dwFlags:         DWORD
  , wShowWindow:     WORD
  , cbReserved2:     WORD
  , lpReserved2:     LPBYTE
  , hStdInput:       HANDLE
  , hStdOutput:      HANDLE
  , hStdError:       HANDLE
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">type</span> <span class="org-variable-name">LPSTARTUPINFO_A</span> = *mut STARTUPINFO_A;

#<span class="org-rainbow-delimiters-depth-1">[</span>repr<span class="org-rainbow-delimiters-depth-2">(</span>C<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-keyword">struct</span> WNDCLASSEXA <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">cbSize</span>:        UINT
  , style:         UINT
    <span class="org-comment-delimiter">// </span><span class="org-comment">Callback function 'lpfnWndProc' (function pointer)</span>
  , lpfnWndProc:   WindowProc
  , cbClsExtra:    c_int
  , cbWndExtra:    c_int
  , hInstance:     HINSTANCE
  , hIcon:         HICON
  , hCursor:       HCURSOR
  , hbrBackground: HBRUSH
  , lpszMenuName:  LPCSTR
  , lpszClassName: LPCSTR
  , hIconSm:       HICON
<span class="org-rainbow-delimiters-depth-1">}</span>

#<span class="org-rainbow-delimiters-depth-1">[</span>repr<span class="org-rainbow-delimiters-depth-2">(</span>C<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-keyword">struct</span> POINT <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">x</span>: LONG
  , y: LONG
<span class="org-rainbow-delimiters-depth-1">}</span>

#<span class="org-rainbow-delimiters-depth-1">[</span>repr<span class="org-rainbow-delimiters-depth-2">(</span>C<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-keyword">struct</span> MSG <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">hwnd</span>:     HWND
  , message:  UINT
  , wParam:   WPARAM
  , lParam:   LPARAM
  , time:     DWORD
  , pt:       POINT
  , lPrivate: DWORD
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">type</span> <span class="org-variable-name">LPMSG</span> = *mut MSG;


#<span class="org-rainbow-delimiters-depth-1">[</span>link<span class="org-rainbow-delimiters-depth-2">(</span>name = <span class="org-string">"user32"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">fn</span> <span class="org-function-name">GetModuleHandleA</span><span class="org-rainbow-delimiters-depth-2">(</span>lpModuleName: LPCSTR<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; HMODULE;
    <span class="org-type">fn</span> <span class="org-function-name">RegisterClassExA</span><span class="org-rainbow-delimiters-depth-2">(</span>unnamedParam1: *<span class="org-keyword">const</span> WNDCLASSEXA<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; ATOM;

    <span class="org-type">fn</span> <span class="org-function-name">LoadIconA</span><span class="org-rainbow-delimiters-depth-2">(</span>hInstance: HINSTANCE, lpIconName: c_int<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; HICON;
    <span class="org-comment-delimiter">// </span><span class="org-comment">fn LoadIconA(hInstance: HINSTANCE, lpIconName: LPCSTR) -&gt; HICON;</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">HCURSOR LoadCursorA(HINSTANCE hInstance, LPCSTR lpCursorName);</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">fn LoadCursorA(hInstance: HINSTANCE, lpCursorName: LPCSTR) -&gt; HCURSOR;</span>

    <span class="org-type">fn</span> <span class="org-function-name">LoadCursorA</span><span class="org-rainbow-delimiters-depth-2">(</span>hInstance: HINSTANCE, lpCursorName: c_int<span class="org-rainbow-delimiters-depth-2">)</span> -&gt;  HCURSOR;

    <span class="org-type">fn</span> <span class="org-function-name">ShowWindow</span><span class="org-rainbow-delimiters-depth-2">(</span>hWnd: HWND , nCmdShow: c_int <span class="org-rainbow-delimiters-depth-2">)</span> -&gt; BOOL;
    <span class="org-type">fn</span> <span class="org-function-name">UpdateWindow</span><span class="org-rainbow-delimiters-depth-2">(</span>hWnd: HWND<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; BOOL;

    <span class="org-type">fn</span> <span class="org-function-name">GetMessageA</span><span class="org-rainbow-delimiters-depth-2">(</span> lpMsg: LPMSG ,hWnd: HWND
                  , wMsgFilterMin: UINT , wMsgFilterMax: UINT<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; BOOL;

    <span class="org-type">fn</span> <span class="org-function-name">GetStartupInfoA</span><span class="org-rainbow-delimiters-depth-2">(</span>lpStartupInfo: LPSTARTUPINFO_A <span class="org-rainbow-delimiters-depth-2">)</span> -&gt; c_void;

    <span class="org-type">fn</span> <span class="org-function-name">DefWindowProcA</span><span class="org-rainbow-delimiters-depth-2">(</span>hWnd: HWND, Msg: UINT, wParam: WPARAM, lParam: LPARAM<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; LRESULT;

    <span class="org-type">fn</span> <span class="org-function-name">TranslateMessage</span><span class="org-rainbow-delimiters-depth-2">(</span>lpMsg: *<span class="org-keyword">const</span> MSG<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; BOOL;

    <span class="org-type">fn</span> <span class="org-function-name">DispatchMessageA</span><span class="org-rainbow-delimiters-depth-2">(</span>lpMsg: *<span class="org-keyword">const</span> MSG<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; LRESULT;

    <span class="org-type">fn</span> <span class="org-function-name">DestroyWindow</span><span class="org-rainbow-delimiters-depth-2">(</span>hWnd: HWND<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; BOOL;

    <span class="org-type">fn</span> <span class="org-function-name">PostQuitMessage</span><span class="org-rainbow-delimiters-depth-2">(</span>nExitCode: c_int<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; c_void;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: CreateWindowA is a macro.</span>
    <span class="org-type">fn</span> <span class="org-function-name">CreateWindowExA</span><span class="org-rainbow-delimiters-depth-2">(</span>
          dwExStyle:    DWORD
        , lpClassName:  LPCSTR
        , lpWindowName: LPCSTR
        , dwStyle:      DWORD
        , X:            c_int
        , Y:            c_int
        , nWidth:       c_int
        , nHeight:      c_int
        , hWndParent:   HWND
        , hMenu:        HMENU
        , hInstance:    HINSTANCE
        , lpParam:      LPVOID
    <span class="org-rainbow-delimiters-depth-2">)</span> -&gt; HWND;

    <span class="org-type">fn</span> <span class="org-function-name">OutputDebugStringA</span><span class="org-rainbow-delimiters-depth-2">(</span>message: LPCSTR<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; c_void;
    <span class="org-type">fn</span> <span class="org-function-name">MessageBoxA</span><span class="org-rainbow-delimiters-depth-2">(</span>hWnd: HWND, lpText: LPCSTR, lpCaption: LPCSTR, uType: UINT<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; c_int;

<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">fn</span> <span class="org-function-name">output_debug_string</span><span class="org-rainbow-delimiters-depth-1">(</span>message: &amp;str<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">let</span> <span class="org-variable-name">cstr</span>: CString = <span class="org-constant">CString</span>::<span class="org-keyword">new</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">message</span><span class="org-rainbow-delimiters-depth-2">)</span>.unwrap<span class="org-rainbow-delimiters-depth-2">()</span>;
    unsafe <span class="org-rainbow-delimiters-depth-2">{</span>
        OutputDebugStringA<span class="org-rainbow-delimiters-depth-3">(</span>cstr.as_ptr<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">fn</span> <span class="org-function-name">message_box</span><span class="org-rainbow-delimiters-depth-1">(</span>text: &amp;str, caption: &amp;str, u_type: c_uint<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">let</span> <span class="org-variable-name">text_</span>    = <span class="org-constant">CString</span>::<span class="org-keyword">new</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">text</span><span class="org-rainbow-delimiters-depth-2">)</span>.unwrap<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-type">let</span> <span class="org-variable-name">caption_</span> = <span class="org-constant">CString</span>::<span class="org-keyword">new</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">caption</span><span class="org-rainbow-delimiters-depth-2">)</span>.unwrap<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unsafe functions can only be called from</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">unsafe blocks.</span>
    unsafe <span class="org-rainbow-delimiters-depth-2">{</span>
       MessageBoxA<span class="org-rainbow-delimiters-depth-3">(</span>  <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::null_mut<span class="org-rainbow-delimiters-depth-4">()</span>
                   , text_.as_ptr<span class="org-rainbow-delimiters-depth-4">()</span>
                   , caption_.as_ptr<span class="org-rainbow-delimiters-depth-4">()</span>
                   , u_type<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">fn</span> <span class="org-function-name">message_box_info</span><span class="org-rainbow-delimiters-depth-1">(</span>text: &amp;str, caption: &amp;str<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    message_box<span class="org-rainbow-delimiters-depth-2">(</span>text, caption, 0x00020000 | 0x00000040<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ rustc rust-wingui.rs  
$ rustc rust-wingui.rs  -A warnings <span class="org-comment-delimiter"># </span><span class="org-comment">Build supressing warnings </span>
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ .\rust-wingui.exe 
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9ccc12a" class="outline-3">
<h3 id="org9ccc12a"><span class="section-number-3">1.32</span> Cross-compiling WxWidgets for Windows from Linux</h3>
<div class="outline-text-3" id="text-1-32">
<p>
WxWidget is a C++ full-featured cross-platform platform graphics
interface framework based on MFC - Microsoft Foundations Classes, that
supports native controls and platform-specific look and feel of
several operating systems, including Microsoft Windows NT, Linux and
Mac-OSX. WxWidgets framework also supports many different gaphics
backends, including: Gtk (_wxGtk_); Windows API (win32) controls
(_wxMSW_); MacOSX Cocoa (_wxOSX/Cocoa_); X11 - X Windows Systems (_wX11_);
Qt Framework (_wxQt_) and Motiff (obsolete) <span class="underline">wxMotiff</span>. In addition to
gaphics interfaces features, this framework also provide support for basic C++
containers, sockets, multithreading, clipboard and sound and video
playback. WxWidgets is released under <a href="https://www.wxwidgets.org/about/licence/">wxWindows License</a> (based on
L-GPL) with an <span class="underline">exception clause</span> allowing the application to be either
dynamically or statically linked against WxWidgets libraries without
the need to redistribute application source code. This section
presents how to cross-compile WxWidgets applications from Linux to
Windows (Win32 API) using a <span class="underline">reproducible development environment</span> based
on a docker image.
</p>

<p>
Advatanges: 
</p>

<ul class="org-ul">
<li>Full-featured and cross-platform framework, just-like Qt Framework.</li>
<li>Based on MFC - Microsoft Foundation Classes</li>
<li>Supports many different operating systems and graphics backends</li>
<li>More commercially friendly than Qt</li>
<li>Closed-source and commercial applications can statically link
against WxWidgets without the need to disclose the source code.</li>
<li>Suitable for porting applications based on MFC (Microsoft
Foundation Classes) or Windows Win32 API.</li>
</ul>

<p>
Drawbacks: 
</p>

<ul class="org-ul">
<li>Poor documentation, not as good as Qt documentation.</li>
<li>The library uses lots of macro (C++/C preprocessor) magic</li>
<li>WxWidgets does not use modern C++ features</li>
<li>Library in C++98, C with-classes style</li>
<li>Unlike Qt, this framework don't support embedded plaforms</li>
</ul>


<p>
<b>Building the docker image</b> (Reproducible Development and building environment) 
</p>

<p>
File: <span class="underline">wxwidgets-windows-docker.conf</span>  
</p>

<ul class="org-ul">
<li>Provides a reproducible development environment that allows
cross-compiling WxWidgets applications for Windows NT.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span class="org-comment-delimiter"># </span><span class="org-comment">Command to build this docker image: </span>
<span class="org-comment-delimiter">#  </span><span class="org-comment">$ docker build  . -t wxwidgets-windows -f wxwidgets-windows-docker.conf</span>
<span class="org-comment-delimiter">#</span>
FROM dockcross/windows-static-x64  

<span class="org-comment-delimiter"># </span><span class="org-comment">---------- Install XMake Building System --------------#</span>
<span class="org-comment-delimiter"># </span>
ENV XMAKE_ROOT y
<span class="org-comment-delimiter"># </span><span class="org-comment">Download Xmake installation script  </span>
RUN curl -fsSL https://xmake.io/shget.text &gt; /tmp/install.sh 
<span class="org-comment-delimiter"># </span><span class="org-comment">Execute the installation script</span>
<span class="org-variable-name">RUN env CC</span>= CXX= CPP=   bash /tmp/install.sh 

<span class="org-comment-delimiter"># </span><span class="org-comment">---------- Install WxWidgets Library for Windows Cross-Compilation --------#</span>
<span class="org-comment-delimiter">#</span>

RUN mkdir -p /build  
WORKDIR /build 

RUN git clone --recurse-submodules https://github.com/wxWidgets/wxWidgets.git 

WORKDIR wxWidgets 
RUN mkdir -p build-debug 
WORKDIR build-debug 

<span class="org-comment-delimiter"># </span><span class="org-comment">Create symbolic link to windres </span>
RUN ln -s /usr/src/mxe/usr/bin/x86_64-w64-mingw32.static-windres /bin/windres

<span class="org-comment-delimiter"># </span><span class="org-comment">Run configuration step </span>
<span class="org-variable-name">RUN ../configure --enable-debug --host</span>=x86_64-w64-mingw32 \
          <span class="org-variable-name">--with-msw --disable-shared --enable-monolithic --build</span>=x86_64-linux --disable-xrc \
          --disable-sys-libs --enable-unicode

RUN make -j4 &amp;&amp; make install 

RUN mkdir -p /cwd 
WORKDIR /cwd 
RUN rm -rf /build 
</pre>
</div>

<p>
Build the docker image (Wait a while, drink a coffee &#x2026;):
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker build  . -t wxwidgets-windows -f wxwidgets-windows-docker.conf
</pre>
</div>

<p>
Checking the docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$  docker run --rm -it --user=(id -u):(id -g)  --workdir=/cwd --volume=$<span class="org-variable-name">PWD</span>:/cwd wxwidgets-windows bash
I have no name!@3c84b2b8cb95:/cwd$ 
I have no name!@3c84b2b8cb95:/cwd$ export <span class="org-variable-name">PS1</span>=<span class="org-string">" $ "</span>

 $ echo $<span class="org-variable-name">CC</span>
/usr/src/mxe/usr/bin/x86_64-w64-mingw32.static-gcc

 $ echo $<span class="org-variable-name">CXX</span>
/usr/src/mxe/usr/bin/x86_64-w64-mingw32.static-g++

 $ echo $<span class="org-variable-name">LD</span>
/usr/src/mxe/usr/bin/x86_64-w64-mingw32.static-ld

 $ echo $<span class="org-variable-name">CPP</span>
/usr/src/mxe/usr/bin/x86_64-w64-mingw32.static-cpp

 $ echo $<span class="org-variable-name">DEFAULT_DOCKCROSS_IMAGE</span> 
<span class="org-function-name">dockcross/windows-static-x64</span>:latest

 $ echo $<span class="org-variable-name">CROSS_TRIPLE</span>
x86_64-w64-mingw32.static

 $ echo $<span class="org-variable-name">AR</span>
/usr/src/mxe/usr/bin/x86_64-w64-mingw32.static-ar

 $ echo $<span class="org-variable-name">AS</span>
/usr/src/mxe/usr/bin/x86_64-w64-mingw32.static-as

 $ echo $<span class="org-variable-name">CMAKE_TOOLCHAIN_FILE</span> 
/usr/src/mxe/usr/x86_64-w64-mingw32.static/share/cmake/mxe-conf.cmake

 $ which wx-config   
/usr/local/bin/wx-config

 $ wx-config --cxxflags --libs
-I/usr/local/lib/wx/include/x86_64-w64-mingw32-msw-unicode-static-3.3 -I/usr/local/include/wx-3.3 -D_FILE_OFFSET_BITS=64 -D__WXMSW__ 
-L/usr/local/lib   -Wl,--subsystem,windows -mwindows /usr/local/lib/libwx_mswu-3.3-x86_64-w64-mingw32.a -limm32 -lwxtiff-3.3-x86_64-w64-mingw32 -lwxjpeg-3.3-x86_64-w64-mingw32 -lwxpng-3.3-x86_64-w64-mingw32 -lwxregexu-3.3-x86_64-w64-mingw32 -lwxscintilla-3.3-x86_64-w64-mingw32 -lwxexpat-3.3-x86_64-w64-mingw32 -lwxzlib-3.3-x86_64-w64-mingw32 -lrpcrt4 -loleaut32 -lole32 -luuid -luxtheme -lwinspool -lwinmm -lshell32 -lshlwapi -lcomctl32 -lcomdlg32 -ladvapi32 -lversion -lws2_32 -lgdi32 -loleacc -lwinhttp 

</pre>
</div>

<p>
Output of wx-config version: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ wx-config --version
3.3.0
</pre>
</div>

<p>
Output of command $ wx-config &#x2013;cxxflags &#x2013;libs 
</p>

<div class="org-src-container">
<pre class="src src-text">$  docker run --rm -it --user=(id -u):(id -g)  --workdir=/cwd --volume=$PWD:/cwd \
  wxwidgets-windows wx-config --cxxflags --libs

Output of command: $ wx-config --cxxflags --libs

Include Paths: 
     -I/usr/local/lib/wx/include/x86_64-w64-mingw32-msw-unicode-static-3.3 
     -I/usr/local/include/wx-3.3 

Compiling definitions:  
   -D_FILE_OFFSET_BITS=64 -D__WXMSW__ 

Linking Directories: 
  -L/usr/local/lib   

Linker Commands: 
  -Wl,--subsystem,windows -mwindows 

Libraries to Link against: 
  /usr/local/lib/libwx_mswu-3.3-x86_64-w64-mingw32.a 
  -limm32 -lwxtiff-3.3-x86_64-w64-mingw32 -lwxjpeg-3.3-x86_64-w64-mingw32 -lwxpng-3.3-x86_64-w64-mingw32 
  -lwxregexu-3.3-x86_64-w64-mingw32 -lwxscintilla-3.3-x86_64-w64-mingw32 -lwxexpat-3.3-x86_64-w64-mingw32 
  -lwxzlib-3.3-x86_64-w64-mingw32 -lrpcrt4 -loleaut32 -lole32 -luuid -luxtheme -lwinspool -lwinmm -lshell32 
  -lshlwapi -lcomctl32 -lcomdlg32 -ladvapi32 -lversion -lws2_32 -lgdi32 -loleacc -lwinhttp 
</pre>
</div>

<p>
<b>Files</b> 
</p>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">project</span>(WxProject-Cross-Compile)
<span class="org-function-name">cmake_minimum_required</span>(VERSION 3.0)
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment"># DOES NOT WORK!!: find_package(wxWidgets COMPONENTS core base REQUIRED)</span>

<span class="org-comment"># Note: Obtained from the output of command: $ wx-config --cxxflags --libs </span>
<span class="org-function-name">set</span>(wxWidgets_LIBRARIES  /usr/local/lib/libwx_mswu-3.3-x86_64-w64-mingw32.a 
   imm32 wxtiff-3.3-x86_64-w64-mingw32 wxjpeg-3.3-x86_64-w64-mingw32 wxpng-3.3-x86_64-w64-mingw32 
   wxregexu-3.3-x86_64-w64-mingw32 wxscintilla-3.3-x86_64-w64-mingw32 wxexpat-3.3-x86_64-w64-mingw32 
   wxzlib-3.3-x86_64-w64-mingw32 rpcrt4 oleaut32 ole32 uuid uxtheme winspool winmm shell32 
   shlwapi comctl32 comdlg32 advapi32 version ws2_32 gdi32 oleacc winhttp 
 )

<span class="org-comment"># Note: Obtained from the output of command: $ wx-config --cxxflags --libs </span>
<span class="org-function-name">set</span>(wxWidgets_INCLUDES  
      /usr/local/lib/wx/include/x86_64-w64-mingw32-msw-unicode-static-3.3 
      /usr/local/include/wx-3.3 )

            <span class="org-function-name">add_executable</span>(SimpleWindow SimpleWindow.cpp)
<span class="org-function-name">target_compile_definitions</span>(SimpleWindow PRIVATE _FILE_OFFSET_BITS=64 __WXMSW__ )
<span class="org-function-name">target_include_directories</span>(SimpleWindow PRIVATE ${<span class="org-variable-name">wxWidgets_INCLUDES</span>})
          <span class="org-function-name">link_directories</span>(SimpleWindow PRIVATE /usr/local/lib )
     <span class="org-function-name">target_link_libraries</span>(SimpleWindow PRIVATE ${<span class="org-variable-name">wxWidgets_LIBRARIES</span>})
       <span class="org-function-name">target_link_options</span>(SimpleWindow PRIVATE  -mwindows -Wl,--subsystem,windows) 
</pre>
</div>

<p>
File: <span class="underline">SimpleWindow.cpp</span>  (<a href="https://moritzmolch.com/blog/2510.html">Moritzolch.com</a>)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">wx/wx.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">class</span> <span class="org-type">MyFrame</span> : <span class="org-keyword">public</span> <span class="org-type">wxFrame</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-function-name">MyFrame</span><span class="org-rainbow-delimiters-depth-2">()</span>
        : wxFrame<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span>, wxID_ANY, _<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Test"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">MyApp</span> : <span class="org-keyword">public</span> <span class="org-type">wxApp</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span> <span class="org-function-name">OnInit</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">override</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        myFrame.Show<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">return</span> <span class="org-constant">true</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-function-name">private</span>:
    <span class="org-type">MyFrame</span> <span class="org-variable-name">myFrame</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;
IMPLEMENT_APP<span class="org-rainbow-delimiters-depth-1">(</span>MyApp<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
<b>Building Aproach 1 =&gt; Manual compilation</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run --rm -it --user=(id -u):(id -g)  --workdir=/cwd <span class="org-sh-escaped-newline">\</span>
     --volume=$<span class="org-variable-name">PWD</span>:/cwd wxwidgets-windows bash

I have no name!@4cca88463e97:/cwd$ export <span class="org-variable-name">PS1</span>=<span class="org-string">"$ "</span> 

$ echo $<span class="org-variable-name">CXX</span>
/usr/src/mxe/usr/bin/x86_64-w64-mingw32.static-g++

$ $<span class="org-variable-name">CXX</span> SimpleWindow.cpp -v -o <span class="org-keyword">SimpleWindow.exe</span> <span class="org-sh-quoted-exec">`wx-config --cxxflags --libs`</span>

$ ls
CMakeLists.txt  Dockerfile.conf  SimpleWindow.cpp  SimpleWindow.exe  _build  out.log  winhello.cpp
</pre>
</div>

<p>
<b>Building Aproach 2 =&gt; Using CMake</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Configuration step </span>
$ docker run --rm -it --user=(id -u):(id -g)  --workdir=/cwd --volume=$<span class="org-variable-name">PWD</span>:/cwd <span class="org-sh-escaped-newline">\</span>
    wxwidgets-windows cmake  -B_build -DCMAKE_BUILD_TYPE=Debug 

<span class="org-comment-delimiter"># </span><span class="org-comment">Building step </span>
$  docker run --rm -it --user=(id -u):(id -g)  --workdir=/cwd --volume=$<span class="org-variable-name">PWD</span>:/cwd <span class="org-sh-escaped-newline">\</span>
    wxwidgets-windows cmake  --build _build --target SimpleWindow
</pre>
</div>

<p>
Check CMake output: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ tree _build -L 1
_build
&#9500;&#9472;&#9472; CMakeCache.txt
&#9500;&#9472;&#9472; CMakeFiles
&#9500;&#9472;&#9472; cmake_install.cmake
&#9500;&#9472;&#9472; Makefile
&#9492;&#9472;&#9472; SimpleWindow.exe

1 directory, 4 files

$ file _build/SimpleWindow.exe 
<span class="org-function-name">_build/SimpleWindow.exe</span>: PE32+ executable (GUI) x86-64, for MS Windows

$  du -h _build/SimpleWindow.exe
96M     _build/SimpleWindow.exe
</pre>
</div>

<p>
Run the application using Wine: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ wine _build/SimpleWindow.exe
</pre>
</div>

<p>
Screenshot: 
</p>


<div class="figure">
<p><a href="images/wxwidgets-windows-cross-compilation.png"><img src="images/wxwidgets-windows-cross-compilation.png" alt="wxwidgets-windows-cross-compilation.png" /></a>
</p>
</div>


<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.wxwidgets.org">https://www.wxwidgets.org</a> (Official Website)</li>

<li><a href="https://www.wxwidgets.org/about">https://www.wxwidgets.org/about</a></li>

<li><a href="https://www.wxwidgets.org/about/licence/">https://www.wxwidgets.org/about/licence/</a></li>

<li><a href="https://www.wxwidgets.org/about/history/">https://www.wxwidgets.org/about/history/</a></li>

<li><a href="https://www.codeproject.com/articles/11515/introduction-to-wxwidgets">Introduction to wxWidgets</a>
<ul class="org-ul">
<li>Note: Show the similarity between WxWidgets and MFC</li>
</ul></li>

<li><a href="https://docs.wxwidgets.org/trunk/overview_install.html">https://docs.wxwidgets.org/trunk/overview_install.html</a></li>

<li><a href="https://wiki.wxwidgets.org/Downloading_and_installing_wxWidgets">https://wiki.wxwidgets.org/Downloading_and_installing_wxWidgets</a></li>

<li><a href="https://docs.wxwidgets.org/trunk/overview_install.html">https://docs.wxwidgets.org/trunk/overview_install.html</a></li>

<li><a href="https://wiki.wxwidgets.org/Cross-Compiling_Under_Linux">https://wiki.wxwidgets.org/Cross-Compiling_Under_Linux</a></li>

<li><a href="https://wiki.codeblocks.org/index.php/Cross_Compiling_wxWidgets_Applications_on_Linux">https://wiki.codeblocks.org/index.php/Cross_Compiling_wxWidgets_Applications_on_Linux</a></li>

<li><a href="https://moritzmolch.com/blog/2510.html">Moritzolch.com - A guide to set up wxWidgets with MinGW on Windows</a></li>

<li><a href="https://forums.wxwidgets.org/viewtopic.php?t=49000">Using wxWidgets with MinGW and Code::Blocks</a></li>

<li><a href="https://wiki.wxwidgets.org/Writing_Your_First_Application-Adding_A_Button">https://wiki.wxwidgets.org/Writing_Your_First_Application-Adding_A_Button</a></li>

<li><a href="https://www.codeproject.com/tips/630542/using-wxwidgets-under-windows">Using wxWidgets under Windows</a></li>
</ul>
</div>
</div>



<div id="outline-container-org326a385" class="outline-3">
<h3 id="org326a385"><span class="section-number-3">1.33</span> Loading DLLs - shared libraries at runtime</h3>
<div class="outline-text-3" id="text-1-33">
</div>
<div id="outline-container-orgbabd084" class="outline-4">
<h4 id="orgbabd084"><span class="section-number-4">1.33.1</span> Example 1 - Basic Dynamic Loading DLL</h4>
<div class="outline-text-4" id="text-1-33-1">
<p>
This example demonstrates how to dynamic load functions from a shared
library at runtime with WinAPIs Loadlibrary, GetProcAddress and
FreeLibrary. 
</p>

<p>
Source:
</p>
<ul class="org-ul">
<li>File: <a href="src/windows/dynamic-loading1.cpp">file:src/windows/dynamic-loading1.cpp</a></li>
<li>GIST: <a href="https://gist.github.com/caiorss/5ec138f86b6208214fb8866344f15e77">dynamic-loading1.cpp</a></li>
</ul>


<p>
FIle: <span class="underline">dynamic-loading.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------------------------------</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(){</span>

        <span class="org-comment-delimiter">/** </span><span class="org-comment">Reference: https://msdn.microsoft.com/en-us/ie/ms775123(v=vs.94)</span>
<span class="org-comment">        Function Signature:          </span>
<span class="org-comment">                HRESULT URLDownloadToFile(</span>
<span class="org-comment">                                         LPUNKNOWN            pCaller,</span>
<span class="org-comment">                                         LPCTSTR              szURL,</span>
<span class="org-comment">                                         LPCTSTR              szFileName,</span>
<span class="org-comment">                  _Reserved_ DWORD                dwReserved,</span>
<span class="org-comment">                                         LPBINDSTATUSCALLBACK lpfnCB</span>
<span class="org-comment">                );</span>
<span class="org-comment">      ---------------------------------------------- */</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Wide-unicode strings </span>
        <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">fileURL</span> = L<span class="org-string">"http://httpbin.org/image/jpeg"</span>;
        <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">file1</span>   = L<span class="org-string">"download-file1.jpeg"</span>;
        <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">file2</span>   = L<span class="org-string">"download-file2.jpeg"</span>;  

        <span class="org-comment-delimiter">// </span><span class="org-comment">Wide unicode version for LoadLibrary API</span>
        <span class="org-type">HMODULE</span> <span class="org-variable-name">hLib</span> = ::LoadLibraryW<span class="org-rainbow-delimiters-depth-2">(</span>L<span class="org-string">"urlmon.dll"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hLib == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Error: failed to load shared library"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-comment-delimiter">// </span><span class="org-comment">Early return on Error. </span>
                <span class="org-keyword">return</span> EXIT_FAILURE;        
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] DLL Loaded OK"</span> &lt;&lt; <span class="org-constant">std</span>::endl;

        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"============ EXPERIMENT 1 ==================="</span> &lt;&lt; <span class="org-constant">std</span>::endl;

        <span class="org-comment-delimiter">// </span><span class="org-comment">The function pointer must have the same</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">signature of the function to be dynamically loaded</span>
        <span class="org-comment-delimiter">//</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Note: Windows function pointer should include calling convention </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">If omitted, the default calling convention is __cdcel</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Possible Calling Conventions: __cdcel, __stdcall, __fastcall and so on.</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">C+11 type alias for function pointer </span>
        <span class="org-keyword">using</span> <span class="org-type">FunptrType</span> =
                HRESULT <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">__cdecl</span> *<span class="org-rainbow-delimiters-depth-2">)(</span>LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK<span class="org-rainbow-delimiters-depth-2">)</span>;


        <span class="org-comment-delimiter">// </span><span class="org-comment">Alternative 2 for type alias (C++98/03)</span>
        <span class="org-keyword">typedef</span> <span class="org-type">HRESULT</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">__cdecl</span> * <span class="org-variable-name">FunptrTypeTypedef</span><span class="org-rainbow-delimiters-depth-2">)(</span>LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK<span class="org-rainbow-delimiters-depth-2">)</span>;


        <span class="org-type">FARPROC</span> <span class="org-variable-name">hFunc</span> = ::GetProcAddress<span class="org-rainbow-delimiters-depth-2">(</span>hLib, <span class="org-string">"URLDownloadToFileW"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hFunc == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [Error] Failed to load function from DLL"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-keyword">return</span> EXIT_FAILURE;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Function loaded OK"</span> &lt;&lt; <span class="org-constant">std</span>::endl;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Functin Pointer </span>
        <span class="org-type">FunptrType</span> <span class="org-variable-name">URLDownloadToFileFunPTR</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">FunptrType</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hFunc<span class="org-rainbow-delimiters-depth-2">)</span>;   

        <span class="org-type">HRESULT</span> <span class="org-variable-name">result1</span> = URLDownloadToFileFunPTR<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, fileURL.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, file1.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, 0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>result1<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> 
            <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Download successful OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">else</span>
            <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Download failure. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;


        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"============ EXPERIMENT 2 ==================="</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Same cast as reinterpret_cast </span>
        <span class="org-type">void</span>* <span class="org-variable-name">hFunc2</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">void</span>*<span class="org-rainbow-delimiters-depth-2">)</span> ::GetProcAddress<span class="org-rainbow-delimiters-depth-2">(</span>hLib, <span class="org-string">"URLDownloadToFileW"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Omit error checking if(hFunct2 == nullptr){ ... }</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Note: Calling convention __cdecl can be omitted</span>
        <span class="org-keyword">using</span> <span class="org-type">URLDownloadToFileW_t</span> =
                <span class="org-keyword">auto</span> __cdecl <span class="org-rainbow-delimiters-depth-2">(</span>LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK<span class="org-rainbow-delimiters-depth-2">)</span> -&gt; HRESULT;
        <span class="org-comment-delimiter">//  </span><span class="org-comment">auto (LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK) -&gt; HRESULT;</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">DownloadFile</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">URLDownloadToFileW_t</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>hFunc2<span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-type">HRESULT</span> <span class="org-variable-name">hresult2</span> = DownloadFile<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, fileURL.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, file2.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, 0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>result1<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Download successful OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">else</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Download failure. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;

        <span class="org-comment-delimiter">// </span><span class="org-comment">WARNING: Code NOT Safe - prone to resource leaking</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">in case of exception or forget to call this function. </span>
        ::FreeLibrary<span class="org-rainbow-delimiters-depth-2">(</span>hLib<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Application ended gracefully. OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;

        <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Types of loading:
</p>

<ul class="org-ul">
<li><span class="underline">Implicit loading</span> (static loading) - the DLL is linked at
compile-time and the application doesn't refer to the DLL file
directly.</li>

<li><span class="underline">Explicit loading</span> (dynamic loading) - the DLL is linked at runtime
or loaded at runtime and the application refer to the DLL file and
its function explicitly using the WinAPIs - LoadLibrary,
GetProcAddress and FreeLibrary.</li>
</ul>

<p>
This code loads the function <a href="https://msdn.microsoft.com/en-us/ie/ms775123(v=vs.94)">URLDownloadToFile</a> at runtime from the DLL
(Dynamically Linked Library) or shared library <span class="underline">urlmon.dll</span>. This
function is used to donwload the image file from the URL
<a href="http://httpbin.org/image/jpeg">http://httpbin.org/image/jpeg</a> as file1.jpeg and file2.jpeg.
</p>

<p>
Signature of URLDownloadToFileW (wide unicode version) of
URLDownloadToFile.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HRESULT</span> <span class="org-function-name">URLDownloadToFile</span><span class="org-rainbow-delimiters-depth-1">(</span>
                         <span class="org-type">LPUNKNOWN</span>            <span class="org-variable-name">pCaller</span>,
                         <span class="org-type">LPCTSTR</span>              <span class="org-variable-name">szURL</span>,
                         <span class="org-type">LPCTSTR</span>              <span class="org-variable-name">szFileName</span>,
  _Reserved_             <span class="org-type">DWORD</span>                <span class="org-variable-name">dwReserved</span>,
                         <span class="org-type">LPBINDSTATUSCALLBACK</span> <span class="org-variable-name">lpfnCB</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">HRESULT</span> <span class="org-function-name">URLDownloadToFileW</span><span class="org-rainbow-delimiters-depth-1">(</span>
                         <span class="org-type">LPUNKNOWN</span>            <span class="org-variable-name">pCaller</span>,
                         <span class="org-type">LPCWSTR</span>              <span class="org-variable-name">szURL</span>,
                         <span class="org-type">LPCWSTR</span>              <span class="org-variable-name">szFileName</span>,
  _Reserved_             <span class="org-type">DWORD</span>                <span class="org-variable-name">dwReserved</span>,
                         <span class="org-type">LPBINDSTATUSCALLBACK</span> <span class="org-variable-name">lpfnCB</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Compiling and running with MSVC: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe dynamic-linking1.cpp /EHsc /Zi /nologo /Fe:out.exe &amp;&amp; out.exe

dynamic-linking1.cpp
 [INFO] DLL Loaded OK
============ EXPERIMENT 1 ===================
 [INFO] Function loaded OK
 [INFO] Download successful OK. 
============ EXPERIMENT 2 ===================
 [INFO] Download successful OK. 
 [INFO] Application ended gracefully. OK.
</pre>
</div>

<p>
Compiling and running with Mingw/GCC (GNU C/C++ Compiler): 
</p>

<div class="org-src-container">
<pre class="src src-cpp">$ g++ dynamic-loading1.cpp -o <span class="org-keyword">out2.exe</span> -std=c++1z &amp;&amp; out2.exe

  <span class="org-rainbow-delimiters-depth-1">[</span>INFO<span class="org-rainbow-delimiters-depth-1">]</span> DLL Loaded OK
 ============ EXPERIMENT 1 ===================
  <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-constant">INFO</span><span class="org-rainbow-delimiters-depth-1">]</span> Function loaded OK
  <span class="org-rainbow-delimiters-depth-1">[</span>INFO<span class="org-rainbow-delimiters-depth-1">]</span> Download successful OK. 
 ============ EXPERIMENT 2 ===================
  <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-constant">INFO</span><span class="org-rainbow-delimiters-depth-1">]</span> Download successful OK. 
  <span class="org-rainbow-delimiters-depth-1">[</span>INFO<span class="org-rainbow-delimiters-depth-1">]</span> Application ended gracefully. OK.

</pre>
</div>

<p>
<b>Parts inside the main function</b>
</p>

<ul class="org-ul">
<li>Function parameters that will be used later.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Wide-unicode strings </span>
<span class="org-function-name">std</span>::wstring fileURL = L<span class="org-string">"http://httpbin.org/image/jpeg"</span>;
<span class="org-function-name">std</span>::wstring file1   = L<span class="org-string">"download-file1.jpeg"</span>;
<span class="org-function-name">std</span>::wstring file2   = L<span class="org-string">"download-file2.jpeg"</span>;  
</pre>
</div>

<ul class="org-ul">
<li><b>Load shared library</b> (aka module) <span class="underline">urlmon.dll</span> at runtime using <a href="https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-loadlibraryw">LoadLibraryW</a> API
and perform error checking and exiting the application on
error. The mentioned DLL is loaded into the current process <span class="underline">address space</span>. 

<ul class="org-ul">
<li>Note: If the application is 64 bits, the DLL must be compiled for
64 bits, otherwise it will not work. The same happens if the
application is 32 bits.</li>

<li>Signature: <span class="underline">HMODULE LoadLibraryW (LPCWSTR lpLibFileName);</span></li>

<li>The file urlmon.dll is at <code>C:\Windows\System32\urlmon.dll</code>.</li>

<li>If the extension of the DLL is omitted, the function
automatically appends .dll to the file name, therefore it is also
possible to load the DLL using just "urlmon" instead of
"urlmon.dll".</li>

<li>If the DLL is provided without absolute path as
<code>C:\Windows\System32\urlmon.dll</code>, the DLL is searched in the
following order:
<ol class="org-ol">
<li>Directory where is the underlying application</li>
<li>System directory - <code>%SystemRoot%\system32</code> or  <code>C:\Windows\System32\</code></li>
<li>Current Working Directory (CWD) - Note: The process current
working directory may not be the same as the application.</li>
<li>Directories listed in the $PATH environment variable.</li>
</ol></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Wide unicode version for LoadLibrary API</span>
<span class="org-type">HMODULE</span> <span class="org-variable-name">hLib</span> = ::LoadLibraryW<span class="org-rainbow-delimiters-depth-1">(</span>L<span class="org-string">"urlmon.dll"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>hLib == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-1">){</span>
     <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Error: failed to load shared library"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Early return on Error. </span>
     <span class="org-keyword">return</span> EXIT_FAILURE;       
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-function-name">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] DLL Loaded OK"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
</pre>
</div>

<ul class="org-ul">
<li><b>Loading function</b> - In order to load the function
URLDownloadToFileW, it is necessary to know: the function symbol
and its its exact type signature and calling convention. In
general, the symbol has the same name of the function to be
loaded. Windows Applications and DLLs of 32 bits supports the
calling conventions <code>__cdecl</code> (default), <code>__stdcall</code> and
<code>__fastcall</code>. Windows applications and DLLs of 64 bits have always
the same calling conventions <code>__cdecl</code>. The default calling
convention can be omitted in the function signature.</li>
</ul>

<p>
Function pointer type alias (FunptrType) with must type signature of
the function URLDownloadToFileW:
</p>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-comment-delimiter">// </span><span class="org-comment">C+11 type alias for function pointer </span>
 <span class="org-keyword">using</span> <span class="org-type">FunptrType</span> =
    HRESULT <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">__cdecl</span> *<span class="org-rainbow-delimiters-depth-1">)(</span>LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">//  </span><span class="org-comment">__cdecl can be omited </span>
<span class="org-comment-delimiter">//  </span><span class="org-comment">HRESULT (__cdecl *)(LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK);</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">Alternative 2 for type alias (C++98/03)</span>
 <span class="org-keyword">typedef</span> <span class="org-type">HRESULT</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">__cdecl</span> * <span class="org-variable-name">FunptrTypeTypedef</span><span class="org-rainbow-delimiters-depth-1">)(</span>LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Function is loaded using the WinAPI <a href="https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-getprocaddress">GetProcAddress</a>
</p>
<ul class="org-ul">
<li>Signature: <span class="underline">FARPROC GetProcAddress(HMODULE hModule,  LPCSTR  lpProcName);</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">FARPROC</span> <span class="org-variable-name">hFunc</span> = ::GetProcAddress<span class="org-rainbow-delimiters-depth-1">(</span>hLib, <span class="org-string">"URLDownloadToFileW"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>hFunc == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [Error] Failed to load function from DLL"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-keyword">return</span> EXIT_FAILURE;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-function-name">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Function loaded OK"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
</pre>
</div>

<p>
The value hFunc must be casted to a function type before usage:
</p>

<ul class="org-ul">
<li>Note: It is alos possible to use C-style casting. However, it is not
encouraged as this type of casting is not explicit as
<span class="underline">reinterpret_cast</span> which communicates the that operation is unsafe
and that it can lead to <span class="underline">undefined behavior</span>.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Functin Pointer </span>
<span class="org-type">FunptrType</span> <span class="org-variable-name">URLDownloadToFileFunPTR</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">FunptrType</span><span class="org-rainbow-delimiters-depth-1">&gt;(</span>hFunc<span class="org-rainbow-delimiters-depth-1">)</span>;       
</pre>
</div>

<ul class="org-ul">
<li><b>Perform experiment 1</b> - Use function pointer <span class="underline">URLDownloadToFileFunPTR</span>
,which points to the function <span class="underline">URLDownloadToFileW</span>, to perform a
download of the image <a href="http://httpbin.org/image/jpeg">http://httpbin.org/image/jpeg</a> and save it to
file download-file1.jpeg.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HRESULT</span> <span class="org-variable-name">result1</span> = URLDownloadToFileFunPTR<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">nullptr</span>, fileURL.c_str<span class="org-rainbow-delimiters-depth-2">()</span>, file1.c_str<span class="org-rainbow-delimiters-depth-2">()</span>, 0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-2">(</span>result1<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Download successful OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-keyword">else</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Download failure. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
</pre>
</div>


<ul class="org-ul">
<li><b>Experiment 2</b> - This piece of code is similar to the previous
one. However, it uses a different syntax for the function pointer.

<ul class="org-ul">
<li>Note: The function pointer DownloadFile points to the function
<span class="underline">URLDownloadToFileW</span>.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"============ EXPERIMENT 2 ==================="</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-comment-delimiter">// </span><span class="org-comment">Same cast as reinterpret_cast </span>
<span class="org-type">void</span>* <span class="org-variable-name">hFunc2</span> = <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span>*<span class="org-rainbow-delimiters-depth-1">)</span> ::GetProcAddress<span class="org-rainbow-delimiters-depth-1">(</span>hLib, <span class="org-string">"URLDownloadToFileW"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Omit error checking if(hFunct2 == nullptr){ ... }</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Note: Calling convention __cdecl can be omitted</span>
<span class="org-keyword">using</span> <span class="org-type">URLDownloadToFileW_t</span> =
    <span class="org-keyword">auto</span> __cdecl <span class="org-rainbow-delimiters-depth-1">(</span>LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK<span class="org-rainbow-delimiters-depth-1">)</span> -&gt; HRESULT;
<span class="org-comment-delimiter">//  </span><span class="org-comment">auto (LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK) -&gt; HRESULT;</span>

<span class="org-keyword">auto</span> <span class="org-variable-name">DownloadFile</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">URLDownloadToFileW_t</span>*<span class="org-rainbow-delimiters-depth-1">&gt;(</span>hFunc2<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">HRESULT</span> <span class="org-variable-name">hresult2</span> = DownloadFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">nullptr</span>, fileURL.c_str<span class="org-rainbow-delimiters-depth-2">()</span>, file2.c_str<span class="org-rainbow-delimiters-depth-2">()</span>, 0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-2">(</span>result1<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Download successful OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-keyword">else</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Download failure. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
</pre>
</div>

<ul class="org-ul">
<li><b>Release acquired resource hLib</b>. This operation is unsafe and prone
to resource leaking, therefore the code would be safer and more
robust if it used RAII (Resource Acquisition Is Initialization)
idiom for releasing the resouce.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">::FreeLibrary<span class="org-rainbow-delimiters-depth-1">(</span>hLib<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Application ended gracefully. OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
</pre>
</div>

<p>
<b>Show symbols (functions) exported by DLL urmon.dll</b>
</p>

<ul class="org-ul">
<li>Open the MSVC developer shell prompt and use the following
commands:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Print to console </span>
$ dumpbin /exports C:\Windows\System32\urlmon.dll

<span class="org-comment-delimiter"># </span><span class="org-comment">Or print to file redirecting the stdout to a file result.txt </span>
$ dumpbin /exports C:\Windows\System32\urlmon.dll &gt; C:\Users\archbox\Desktop\result.txt
</pre>
</div>

<p>
Command output: 
</p>

<div class="org-src-container">
<pre class="src src-cpp">$ dumpbin /exports C:\Windows\System32\urlmon.dll &gt; C:\Users\archbox\Desktop\result.txt

Microsoft <span class="org-rainbow-delimiters-depth-1">(</span>R<span class="org-rainbow-delimiters-depth-1">)</span> COFF/PE Dumper Version 14.12.25835.0
Copyright <span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">Microsoft</span> <span class="org-variable-name">Corporation</span>.  All rights reserved.


Dump of file C:\Windows\System32\urlmon.dll

File Type: DLL

  Section contains the following exports <span class="org-keyword">for</span> urlmon.dll

    00000000 characteristics
    F6A98BC3 time date stamp
        0.00 version
         100 ordinal base
         481 number of functions
         132 number of names

    ordinal hint RVA      name

        121    0 000718E0 AsyncGetClassBits
        122    1 000AE7A0 AsyncInstallDistributionUnit
        123    2 000A0CD0 BindAsyncMoniker
        124    3 000CF110 CAuthenticateHostUI_CreateInstance
        125    4 000AF130 CDLGetLongPathNameA
        126    5 000AF150 CDLGetLongPathNameW
        127    6 00107B70 CORPolicyProvider
        128    7 000AE830 CoGetClassObjectFromURL
        129    8 000AED90 CoInstall
        130    9 00035E90 CoInternetCanonicalizeIUri
        131    A 00035FB0 CoInternetCombineIUri     
    ... ... ...     ... ... ...     ... ... ...     ... ... ... 
        227   71 000E48C0 URLDownloadA
        228   72 000EDF10 URLDownloadToCacheFileA
        229   73 000EE090 URLDownloadToCacheFileW
        230   74 000EE200 URLDownloadToFileA
        231   75 0006D300 URLDownloadToFileW
        232   76 000E4920 URLDownloadW
        233   77 000EE350 URLOpenBlockingStreamA
        234   78 000EE430 URLOpenBlockingStreamW
        235   79 000EE540 URLOpenPullStreamA
        236   7A 000EE610 URLOpenPullStreamW
        237   7B 000EE6E0 URLOpenStreamA
    ... ... ...     ... ... ...     ... ... ...     ... ... ... 
  Summary

        D000 .data
        1000 .didat
        1000 .isoapis
        F000 .pdata
       3D000 .rdata
        3000 .reloc
       52000 .rsrc
      117000 .text
</pre>
</div>

<p>
<b>Further Reading:</b>
</p>

<ul class="org-ul">
<li>WinAPIS:  <a href="https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-loadlibraryw">LoadLibraryW</a>,  <a href="https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-getprocaddress">GetProcAddress</a> and <a href="https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-freelibrary">FreeLibrary</a>.</li>

<li><a href="https://github.com/numpy/numpy/wiki/windows-dll-notes">https://github.com/numpy/numpy/wiki/windows-dll-notes</a></li>

<li><a href="http://www.flounder.com/loadlibrary_explorer.htm">The LoadLibrary Explorer</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/desktop/dlls/dynamic-link-library-search-order">Dynamic-Link Library Search Order</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/desktop/dlls/dynamic-link-library-data">Dynamic-Link Library Data</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/desktop/dlls/dynamic-link-library-redirection">Dynamic-Link Library Redirection</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/desktop/dlls/dynamic-link-library-security">Dynamic-Link Library Security</a></li>

<li><a href="https://docs.python.org/2/library/ctypes.html">15.17. ctypes — A foreign function library for Python — Python 2.7.15 documentation</a></li>
</ul>
</div>
</div>
<div id="outline-container-org89b5d0a" class="outline-4">
<h4 id="org89b5d0a"><span class="section-number-4">1.33.2</span> Example 2 - Dynamic loading with a class Wrapper</h4>
<div class="outline-text-4" id="text-1-33-2">
<p>
This code uses a class DLLoader to load a shared library hiding the
complexity and implementation detail. It also uses RAII for ensuring
that the resource is released.
</p>

<p>
Source: 
</p>
<ul class="org-ul">
<li>File: <a href="src/windows/dynamic-loading2.cpp">file:src/windows/dynamic-loading2.cpp</a></li>
<li>GIST: <a href="https://gist.github.com/caiorss/c5dd06a401f4816920bb682367455f5e">dynamic-loading2.cpp</a></li>
</ul>


<p>
<b>Files</b> 
</p>

<p>
FIle: <span class="underline">dymaic-loading2.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">//</span><span class="org-comment">========== File: DLLLoader.hpp =======//</span>
<span class="org-keyword">class</span> <span class="org-type">DLLLoader</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
     <span class="org-type">HMODULE</span>      <span class="org-variable-name">m_hLib</span>;
     <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-variable-name">m_file</span>;
<span class="org-function-name">public</span>:
     <span class="org-function-name">DLLLoader</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-function-name">DLLLoader</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">DLLLoader</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;  
     <span class="org-function-name">DLLLoader</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">DLLLoader</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     ~<span class="org-function-name">DLLLoader</span><span class="org-rainbow-delimiters-depth-2">()</span>;
     <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">DLLLoader</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
     <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">DLLLoader</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">auto</span> <span class="org-function-name">GetFile</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt;  <span class="org-constant">std</span>::<span class="org-type">string</span>;
     <span class="org-keyword">auto</span> <span class="org-function-name">IsLoaded</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">bool</span>;
     <span class="org-keyword">operator</span> <span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>;

     <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">class</span> <span class="org-type">FunctionSignature</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
     <span class="org-keyword">auto</span> <span class="org-function-name">GetFunction</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">functionName</span> <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">FunctionSignature</span>*
     <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_hLib == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">return</span> <span class="org-constant">nullptr</span>; <span class="org-rainbow-delimiters-depth-3">}</span>                       
          <span class="org-type">FARPROC</span> <span class="org-variable-name">hFunc</span> = ::GetProcAddress<span class="org-rainbow-delimiters-depth-3">(</span>m_hLib, functionName.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>hFunc == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">return</span> <span class="org-constant">nullptr</span>; <span class="org-rainbow-delimiters-depth-3">}</span>          
          <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">FunctionSignature</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>hFunc<span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>  
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">//</span><span class="org-comment">========== File: Main.cpp =======//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Wide-unicode strings </span>
        <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">fileURL</span> = L<span class="org-string">"http://httpbin.org/image/jpeg"</span>;
        <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">file1</span>   = L<span class="org-string">"download-file1.jpeg"</span>;
        <span class="org-constant">std</span>::<span class="org-type">wstring</span> <span class="org-variable-name">file2</span>   = L<span class="org-string">"download-file2.jpeg"</span>;  

        <span class="org-keyword">auto</span> <span class="org-variable-name">dll</span> = DLLLoader<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"urlmon.dll"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>dll<span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[Error] failed to load DLL."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-keyword">return</span> EXIT_FAILURE;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[INFO] DLL loaded OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;

        <span class="org-comment-delimiter">// </span><span class="org-comment">-----------------------------------------------------------------//</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"===== Experiment 1 =========== "</span> &lt;&lt; <span class="org-constant">std</span>::endl;

        <span class="org-keyword">auto</span> <span class="org-variable-name">URLDownloadToFileW</span> =
                dll.GetFunction<span class="org-rainbow-delimiters-depth-2">&lt;</span>HRESULT <span class="org-rainbow-delimiters-depth-3">(</span>LPUNKNOWN,
                                         LPCWSTR,
                                         LPCWSTR,
                                         DWORD,
                                         LPBINDSTATUSCALLBACK<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"URLDownloadToFileW"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>URLDownloadToFileW == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[Error] failed to load function. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
                <span class="org-keyword">return</span> EXIT_FAILURE;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[INFO] Function URLDownloadToFileW loaded OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;


        <span class="org-type">HRESULT</span> <span class="org-variable-name">result1</span> = URLDownloadToFileW<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, fileURL.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, file1.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, 0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>result1<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Download successful OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">else</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Download failure. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;       

        <span class="org-comment-delimiter">// </span><span class="org-comment">-----------------------------------------------------------------//</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"===== Experiment 2 =========== "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Note: Calling convention __cdecl can be omitted</span>
        <span class="org-keyword">using</span> <span class="org-type">URLDownloadToFileW_t</span> =
                HRESULT <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span>LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK<span class="org-rainbow-delimiters-depth-2">)</span>; 

        <span class="org-keyword">auto</span> <span class="org-variable-name">URLDownloadToFileW2</span> =
                dll.GetFunction<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">URLDownloadToFileW_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"URLDownloadToFileW"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-type">HRESULT</span> <span class="org-variable-name">result2</span> =
                URLDownloadToFileW<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, fileURL.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, file2.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, 0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-3">(</span>result2<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Download successful OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">else</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Download failure. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;        
        <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">///</span><span class="org-comment">==== Implementations - file: DLLoader.hpp =======//</span>

<span class="org-function-name">DLLLoader</span>::DLLLoader<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-1">)</span>:
   m_file<span class="org-rainbow-delimiters-depth-1">(</span>file<span class="org-rainbow-delimiters-depth-1">)</span>,
   m_hLib<span class="org-rainbow-delimiters-depth-1">(</span>::LoadLibraryA<span class="org-rainbow-delimiters-depth-2">(</span>file.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Move CTOR</span>
<span class="org-function-name">DLLLoader</span>::DLLLoader<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">DLLLoader</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span>:
    m_hLib<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_hLib<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>,
    m_file<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_file<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>       
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Move assignment operator</span>
<span class="org-keyword">auto</span> <span class="org-constant">DLLLoader</span>::<span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">DLLLoader</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span>      
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">this</span>-&gt;m_hLib, rhs.m_hLib<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">this</span>-&gt;m_file, rhs.m_file<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">DLLLoader</span>::~DLLLoader<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] DLL handler released OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>m_hLib != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
            ::FreeLibrary<span class="org-rainbow-delimiters-depth-2">(</span>m_hLib<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">DLLLoader</span>::<span class="org-function-name">GetFile</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span> -&gt;  <span class="org-constant">std</span>::<span class="org-type">string</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> m_file;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">DLLLoader</span>::<span class="org-function-name">IsLoaded</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">bool</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> m_hLib == <span class="org-constant">nullptr</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">DLLLoader</span>::<span class="org-keyword">operator</span> <span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-keyword">return</span> m_hLib != <span class="org-constant">nullptr</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Build and run with MSVC</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cl.exe dynamic-loading2.cpp /EHsc /Zi /nologo /Fe:out.exe &amp;&amp; out.exe

dynamic-loading2.cpp
[INFO] DLL loaded OK.
===== Experiment 1 =========== 
[INFO] Function URLDownloadToFileW loaded OK. 
 [INFO] Download successful OK. 
===== Experiment 2 =========== 
 [INFO] Download successful OK. 
 [INFO] DLL handler released OK.
</pre>
</div>

<p>
<b>Build and run with Mingw/GCC</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ dynamic-loading2.cpp -std=c++14 -g -o <span class="org-keyword">out-gcc.exe</span> &amp;&amp; out-gcc.exe

[INFO] DLL loaded OK.
===== Experiment 1 =========== 
[INFO] Function URLDownloadToFileW loaded OK. 
 [INFO] Download successful OK. 
===== Experiment 2 =========== 
 [INFO] Download successful OK. 
 [INFO] DLL handler released OK.
</pre>
</div>

<p>
<b>Parts</b> 
</p>

<p>
Main function - Load Library: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Wide-unicode strings </span>
<span class="org-function-name">std</span>::wstring fileURL = L<span class="org-string">"http://httpbin.org/image/jpeg"</span>;
<span class="org-function-name">std</span>::wstring file1   = L<span class="org-string">"download-file1.jpeg"</span>;
<span class="org-function-name">std</span>::wstring file2   = L<span class="org-string">"download-file2.jpeg"</span>;  

<span class="org-keyword">auto</span> <span class="org-variable-name">dll</span> = DLLLoader<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"urlmon.dll"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-negation-char">!</span>dll<span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[Error] failed to load DLL."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">return</span> EXIT_FAILURE;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-function-name">std</span>::cerr &lt;&lt; <span class="org-string">"[INFO] DLL loaded OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;

</pre>
</div>

<p>
Main function - Experiment 1: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"===== Experiment 1 =========== "</span> &lt;&lt; <span class="org-constant">std</span>::endl;

<span class="org-keyword">auto</span> <span class="org-variable-name">URLDownloadToFileW</span> =
    dll.GetFunction<span class="org-rainbow-delimiters-depth-1">&lt;</span>HRESULT <span class="org-rainbow-delimiters-depth-2">(</span>LPUNKNOWN,
                             LPCWSTR,
                             LPCWSTR,
                             DWORD,
                             LPBINDSTATUSCALLBACK<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"URLDownloadToFileW"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>URLDownloadToFileW == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"[Error] failed to load function. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-keyword">return</span> EXIT_FAILURE;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-function-name">std</span>::cerr &lt;&lt; <span class="org-string">"[INFO] Function URLDownloadToFileW loaded OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;

<span class="org-type">HRESULT</span> <span class="org-variable-name">result1</span> = URLDownloadToFileW<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">nullptr</span>, fileURL.c_str<span class="org-rainbow-delimiters-depth-2">()</span>, file1.c_str<span class="org-rainbow-delimiters-depth-2">()</span>, 0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-2">(</span>result1<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Download successful OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-keyword">else</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Download failure. "</span> &lt;&lt; <span class="org-constant">std</span>::endl; 
</pre>
</div>

<p>
Main function - Experiment 2: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"===== Experiment 2 =========== "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-comment-delimiter">// </span><span class="org-comment">Note: Calling convention __cdecl can be omitted</span>
<span class="org-keyword">using</span> <span class="org-type">URLDownloadToFileW_t</span> =
    HRESULT <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span>LPUNKNOWN, LPCWSTR, LPCWSTR, DWORD, LPBINDSTATUSCALLBACK<span class="org-rainbow-delimiters-depth-1">)</span>; 

<span class="org-keyword">auto</span> <span class="org-variable-name">URLDownloadToFileW2</span> =
    dll.GetFunction<span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">URLDownloadToFileW_t</span><span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"URLDownloadToFileW"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">HRESULT</span> <span class="org-variable-name">result2</span> =
    URLDownloadToFileW<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">nullptr</span>, fileURL.c_str<span class="org-rainbow-delimiters-depth-2">()</span>, file2.c_str<span class="org-rainbow-delimiters-depth-2">()</span>, 0, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>SUCCEEDED<span class="org-rainbow-delimiters-depth-2">(</span>result2<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] Download successful OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-keyword">else</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Download failure. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;        
<span class="org-keyword">return</span> 0;
</pre>
</div>

<p>
Class DLLoader: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">//</span><span class="org-comment">========== File: DLLLoader.hpp =======//</span>
<span class="org-keyword">class</span> <span class="org-type">DLLLoader</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
     <span class="org-type">HMODULE</span>      <span class="org-variable-name">m_hLib</span>;
     <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-variable-name">m_file</span>;
<span class="org-function-name">public</span>:
   <span class="org-function-name">DLLLoader</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-function-name">DLLLoader</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">DLLLoader</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;    
   <span class="org-function-name">DLLLoader</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">DLLLoader</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   ~<span class="org-function-name">DLLLoader</span><span class="org-rainbow-delimiters-depth-2">()</span>;
   <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">DLLLoader</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
   <span class="org-keyword">auto</span> <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">DLLLoader</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-keyword">auto</span> <span class="org-function-name">GetFile</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt;  <span class="org-constant">std</span>::<span class="org-type">string</span>;
   <span class="org-keyword">auto</span> <span class="org-function-name">IsLoaded</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">bool</span>;
   <span class="org-keyword">operator</span> <span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>;

   <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">class</span> <span class="org-type">FunctionSignature</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
   <span class="org-keyword">auto</span> <span class="org-function-name">GetFunction</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">functionName</span> <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">FunctionSignature</span>*
   <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_hLib == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-keyword">return</span> <span class="org-constant">nullptr</span>;        
      <span class="org-type">FARPROC</span> <span class="org-variable-name">hFunc</span> = ::GetProcAddress<span class="org-rainbow-delimiters-depth-3">(</span>m_hLib, functionName.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>hFunc == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-keyword">return</span> <span class="org-constant">nullptr</span>;
      <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">FunctionSignature</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>hFunc<span class="org-rainbow-delimiters-depth-3">)</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>    
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Member functions of class DLLoader:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">///</span><span class="org-comment">==== Implementations - file: DLLoader.hpp =======//</span>

<span class="org-function-name">DLLLoader</span>::DLLLoader<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-1">)</span>:
     m_file<span class="org-rainbow-delimiters-depth-1">(</span>file<span class="org-rainbow-delimiters-depth-1">)</span>,
     m_hLib<span class="org-rainbow-delimiters-depth-1">(</span>::LoadLibraryA<span class="org-rainbow-delimiters-depth-2">(</span>file.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Move CTOR</span>
<span class="org-function-name">DLLLoader</span>::DLLLoader<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">DLLLoader</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span>:
        m_hLib<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_hLib<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>,
        m_file<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-2">(</span>rhs.m_file<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>       
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-keyword">auto</span> <span class="org-constant">DLLLoader</span>::<span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">DLLLoader</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">)</span>      
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">this</span>-&gt;m_hLib, rhs.m_hLib<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">this</span>-&gt;m_file, rhs.m_file<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">DLLLoader</span>::~DLLLoader<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [INFO] DLL handler released OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
   <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>m_hLib != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
           ::FreeLibrary<span class="org-rainbow-delimiters-depth-2">(</span>m_hLib<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">DLLLoader</span>::<span class="org-function-name">GetFile</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span> -&gt;  <span class="org-constant">std</span>::<span class="org-type">string</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-keyword">return</span> m_file;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-constant">DLLLoader</span>::<span class="org-function-name">IsLoaded</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">bool</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-keyword">return</span> m_hLib == <span class="org-constant">nullptr</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">DLLLoader</span>::<span class="org-keyword">operator</span> <span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-keyword">const</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-keyword">return</span> m_hLib != <span class="org-constant">nullptr</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org259ca1d" class="outline-3">
<h3 id="org259ca1d"><span class="section-number-3">1.34</span> Runnable Shared Libraries DLLs - rundll32</h3>
<div class="outline-text-3" id="text-1-34">
</div>
<div id="outline-container-org8c72def" class="outline-4">
<h4 id="org8c72def"><span class="section-number-4">1.34.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-34-1">
<p>
Windows shared libraries DLLs, such as control panel applets, can be
executed in a similar way to executable if they contain entry point
functions matching the type signature expected by rundll32.exe
application. 
</p>

<p>
<b>Some Runnable DLLs</b> 
</p>

<p>
File Explorer Options: 
</p>
<ul class="org-ul">
<li>The following command calls the <span class="underline">Options_RunDLL</span> entry point of the
DLL shell32.dll which opens a window where is possible to set file
explorer options.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ RunDll32.exe shell32.dll,Options_RunDLL 0
</pre>
</div>

<p>
Environment variables control panel applet: 
</p>
<ul class="org-ul">
<li>It opens a Window where is possible to set and add news environment variables.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ rundll32.exe sysdm.cpl,EditEnvironmentVariables
</pre>
</div>

<p>
Check DLL locations: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ where shell32.dll
<span class="org-function-name">C</span>:\Windows\System32\shell32.dll

$ where sysdm.cpl
<span class="org-function-name">C</span>:\Windows\System32\sysdm.cpl

$ file C:\Windows\System32\sysdm.cpl
<span class="org-function-name">C</span>:\Windows\System32\sysdm.cpl: PE32+ executable (DLL) (GUI) x86-64, for MS Windows
</pre>
</div>
</div>
</div>

<div id="outline-container-orgac1eed0" class="outline-4">
<h4 id="orgac1eed0"><span class="section-number-4">1.34.2</span> Creating a runnable DLL</h4>
<div class="outline-text-4" id="text-1-34-2">
<p>
<b>File: runnable.cpp</b>
</p>

<p>
Sample runnable DLL with two entry points. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">DLL_EXPORT</span> <span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-keyword">__declspec</span><span class="org-rainbow-delimiters-depth-1">(</span>dllexport<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">DLL_EXPORT_STDCALL</span> <span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-keyword">__declspec</span><span class="org-rainbow-delimiters-depth-1">(</span>dllexport<span class="org-rainbow-delimiters-depth-1">)</span> __stdcall

DLL_EXPORT
<span class="org-type">void</span> <span class="org-function-name">entryPoint1</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HWND</span> <span class="org-variable-name">hwn</span>, <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hinst</span>, <span class="org-type">LPSTR</span> <span class="org-variable-name">cmdLine</span>, <span class="org-type">int</span> <span class="org-variable-name">nCmdShow</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>  
  <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
  ss &lt;&lt; __FILE__ &lt;&lt; <span class="org-string">":"</span> &lt;&lt; __LINE__ &lt;&lt; <span class="org-string">":"</span> &lt;&lt; <span class="org-string">"Entry point 1 running!"</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Note: Does not work because the DLL is loaded by a program built for</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">the window subsystem.</span>
  <span class="org-constant">std</span>::cout &lt;&lt; ss.str<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
  ss &lt;&lt; <span class="org-string">" cmdLine = "</span> &lt;&lt; cmdLine;

  <span class="org-comment-delimiter">//</span><span class="org-comment">Print logging to shared memory </span>
  OutputDebugStringA<span class="org-rainbow-delimiters-depth-2">(</span>ss.str<span class="org-rainbow-delimiters-depth-3">()</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Show graphical messagebox </span>
  MessageBoxA<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span>, ss.str<span class="org-rainbow-delimiters-depth-3">()</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-string">"EntryPoint1-DLL"</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

DLL_EXPORT
<span class="org-type">void</span> <span class="org-function-name">entryPoint2</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HWND</span> <span class="org-variable-name">hwn</span>, <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hinst</span>, <span class="org-type">LPSTR</span> <span class="org-variable-name">cmdLine</span>, <span class="org-type">int</span> <span class="org-variable-name">nCmdShow</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>  
        <span class="org-comment-delimiter">// </span><span class="org-comment">Show graphical messagebox </span>
        MessageBoxA<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, <span class="org-string">"Launching Notepad.exe"</span>, <span class="org-string">"EntryPoint2-DLL"</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Launch Notepad.exe</span>
        ::system<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"notepad.exe"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">/** </span><span class="org-comment">DLL Entry Point on Windows, similar to main() function */</span>
DLL_EXPORT BOOL
<span class="org-type">APIENTRY</span> <span class="org-function-name">DllMain</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInst</span>, <span class="org-type">DWORD</span> <span class="org-variable-name">reason</span>, <span class="org-type">LPVOID</span> <span class="org-variable-name">lpReserved</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
  ss &lt;&lt; __FILE__ &lt;&lt; <span class="org-string">":"</span> &lt;&lt; __LINE__ &lt;&lt; <span class="org-string">": =&gt; DLL Loaded OK."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
  OutputDebugString<span class="org-rainbow-delimiters-depth-2">(</span>ss.str<span class="org-rainbow-delimiters-depth-3">()</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  ss.clear<span class="org-rainbow-delimiters-depth-2">()</span>;
  <span class="org-keyword">switch</span> <span class="org-rainbow-delimiters-depth-2">(</span>reason<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">case</span> DLL_PROCESS_ATTACH:
      ss &lt;&lt; __FILE__ &lt;&lt; <span class="org-string">":"</span> &lt;&lt; __LINE__ &lt;&lt; <span class="org-string">": =&gt; DLL attached."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
      OutputDebugString<span class="org-rainbow-delimiters-depth-3">(</span>ss.str<span class="org-rainbow-delimiters-depth-4">()</span>.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      ss.clear<span class="org-rainbow-delimiters-depth-3">()</span>;
      <span class="org-keyword">break</span>;
    <span class="org-keyword">case</span> DLL_PROCESS_DETACH:
      ss &lt;&lt; __FILE__ &lt;&lt; <span class="org-string">":"</span> &lt;&lt; __LINE__ &lt;&lt; <span class="org-string">": =&gt; DLL detached."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
      OutputDebugString<span class="org-rainbow-delimiters-depth-3">(</span>ss.str<span class="org-rainbow-delimiters-depth-4">()</span>.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      ss.clear<span class="org-rainbow-delimiters-depth-3">()</span>;      
      <span class="org-keyword">break</span>;
    <span class="org-keyword">case</span> DLL_THREAD_ATTACH:
      ss &lt;&lt; __FILE__ &lt;&lt; <span class="org-string">":"</span> &lt;&lt; __LINE__ &lt;&lt; <span class="org-string">": =&gt; DLL thread attached."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
      OutputDebugString<span class="org-rainbow-delimiters-depth-3">(</span>ss.str<span class="org-rainbow-delimiters-depth-4">()</span>.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      ss.clear<span class="org-rainbow-delimiters-depth-3">()</span>;      
       <span class="org-keyword">break</span>;
    <span class="org-keyword">case</span> DLL_THREAD_DETACH:
      ss &lt;&lt; __FILE__ &lt;&lt; <span class="org-string">":"</span> &lt;&lt; __LINE__ &lt;&lt; <span class="org-string">": =&gt; DLL thread detached."</span> &lt;&lt; <span class="org-constant">std</span>::endl;
      OutputDebugString<span class="org-rainbow-delimiters-depth-3">(</span>ss.str<span class="org-rainbow-delimiters-depth-4">()</span>.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      ss.clear<span class="org-rainbow-delimiters-depth-3">()</span>;      
      <span class="org-keyword">break</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">return</span> TRUE;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>File: CMakeLists.txt</b> 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(RunnableDLL)

<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)
<span class="org-function-name">set</span>(CMAKE_CXX_EXTENSIONS OFF)

<span class="org-comment">#=========== CMake Functions ===================#</span>

<span class="org-comment"># Copy target file to current directory whenerver it is rebuilt</span>
<span class="org-keyword">function</span>(copy_after_build TARGET_NAME )
    <span class="org-comment"># Note: CMAKE_CURRENT_LIST_DIR is the directory where is this</span>
    <span class="org-comment"># CMakeLists.txt file.</span>
    <span class="org-function-name">set</span>(DESTDIR ${<span class="org-variable-name">CMAKE_CURRENT_LIST_DIR</span>}/bin/)
    <span class="org-function-name">file</span>(MAKE_DIRECTORY ${<span class="org-variable-name">DESTDIR</span>})

    <span class="org-comment"># Copy binary file to &lt;CMakeLists.txt didctory&gt;./bin</span>
    <span class="org-comment"># after target is compiled.</span>
    <span class="org-function-name">add_custom_command</span>(TARGET ${<span class="org-variable-name">TARGET_NAME</span>} POST_BUILD
      COMMAND ${<span class="org-variable-name">CMAKE_COMMAND</span>} -E copy
                               $&lt;TARGET_FILE:${<span class="org-variable-name">TARGET_NAME</span>}&gt; ${<span class="org-variable-name">DESTDIR</span>}
                               )
<span class="org-keyword">endfunction</span>()


<span class="org-comment">#========== Targets Configurations ============#</span>

<span class="org-comment"># Generates DLL named: 'applet.cpl' </span>
<span class="org-function-name">add_library</span>(runnable SHARED runnable.cpp)

<span class="org-comment"># Change the DLL name from 'runnable.dll' to 'applet.cpl'</span>
<span class="org-function-name">set_target_properties</span>( runnable PROPERTIES
  OUTPUT_NAME  <span class="org-string">"applet"</span>
  SUFFIX       <span class="org-string">".cpl"</span>
)

<span class="org-function-name">copy_after_build</span>(runnable)
</pre>
</div>

<p>
<b>Building</b> 
</p>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cd &lt;PROJECT-ROOT-DIRECTORY&gt;

<span class="org-comment-delimiter"># </span><span class="org-comment">Configure </span>
$ cmake -H. -B_build -G<span class="org-string">"Visual Studio 15 2017 Win64"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Compile </span>
$ cmake --build _build --target all
</pre>
</div>

<p>
Check building system output: 
</p>
<ul class="org-ul">
<li>Note: The tools 'ls' and 'file' are not native to Windows, they
come bundled with GIT.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ls bin
applet.cpl*

$ file bin\applet.cpl
bin\applet.cpl: PE32+ executable (DLL) (console) x86-64, for MS Windows
</pre>
</div>

<p>
<b>Running</b> 
</p>

<p>
Check where is rundll32:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ where rundll32
<span class="org-function-name">C</span>:\Windows\System32\rundll32.exe
</pre>
</div>

<p>
Execute <span class="underline">entryPoint1</span> function
</p>

<ul class="org-ul">
<li>As the DLL applet.cpl is loaded by an executable compiled to the
Window-subsystem, the <b>cout</b> output is not displayed in the
terminal. A workaround to this issue is logging to a file;
redirect std::cout to a file output stream or using the
OutputDebugString API and <b>DebugView</b> application from SysInternals.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ rundll32 bin\applet.cpl,entryPoint1 arg0 arg1 arg2
</pre>
</div>

<p>
DebugView Output:
</p>

<pre class="example">
[5276] C:\Users\dummy-user\Desktop\Runnable-DLL\runnable.cpp:41: =&gt; DLL Loaded OK.
[5276] C:\Users\dummy-user\Desktop\Runnable-DLL\runnable.cpp:41: =&gt; DLL Loaded OK.
[5276] C:\Users\dummy-user\Desktop\Runnable-DLL\runnable.cpp:47: =&gt; DLL attached.
[5276] C:\Users\dummy-user\Desktop\Runnable-DLL\runnable.cpp:41: =&gt; DLL Loaded OK.
[5276] C:\Users\dummy-user\Desktop\Runnable-DLL\runnable.cpp:41: =&gt; DLL Loaded OK.
[5276] C:\Users\dummy-user\Desktop\Runnable-DLL\runnable.cpp:57: =&gt; DLL thread attached.
[5276] C:\Users\dummy-user\Desktop\Runnable-DLL\runnable.cpp:13:Entry point 1 running! cmdLine = arg0 arg1 arg2 
[5276] C:\Users\dummy-user\Desktop\Runnable-DLL\runnable.cpp:41: =&gt; DLL Loaded OK.
[5276] C:\Users\dummy-user\Desktop\Runnable-DLL\runnable.cpp:41: =&gt; DLL Loaded OK.
[5276] C:\Users\dummy-user\Desktop\Runnable-DLL\runnable.cpp:52: =&gt; DLL detached.
</pre>

<p>
Execute <span class="underline">entryPoint2</span> function 
</p>
<ul class="org-ul">
<li>The entryPoint2 launches notepad.exe application.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ rundll32 bin\applet.cpl,entryPoint2
</pre>
</div>
</div>
</div>

<div id="outline-container-orgab1f868" class="outline-4">
<h4 id="orgab1f868"><span class="section-number-4">1.34.3</span> Creating a DLL runner</h4>
<div class="outline-text-4" id="text-1-34-3">
<p>
The following code is a DLL runner, akin to rundll32.exe built-in
application. It can run any DLL containing entry rundll32 entry points
or the functions with the same type signature as <b>Rundll32EntryPoint_t</b>.
</p>

<p>
<b>File: dll-runner.cpp</b>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">windows.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">DLL_EXPORT</span> <span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-keyword">__declspec</span><span class="org-rainbow-delimiters-depth-1">(</span>dllexport<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">DLL_EXPORT_STDCALL</span> <span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-keyword">__declspec</span><span class="org-rainbow-delimiters-depth-1">(</span>dllexport<span class="org-rainbow-delimiters-depth-1">)</span> __stdcall

<span class="org-keyword">using</span> <span class="org-type">Rundll32EntryPoint_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">HWND</span> <span class="org-variable-name">hwn</span>
                                       , <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hinst</span>
                                       , <span class="org-type">LPSTR</span> <span class="org-variable-name">cmdLine</span>
                                       , <span class="org-type">int</span> <span class="org-variable-name">nCmdShow</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-2">[]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 4<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" Usage: "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" &lt;DLL-FILE&gt; &lt;ENTRY-POINT&gt; &lt;ENTRY_COMMAND_LINE&gt; "</span>
                   &lt;&lt; <span class="org-constant">std</span>::endl;
         <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Invalid arguments. Abort."</span>
                   &lt;&lt; <span class="org-constant">std</span>::endl;        
         <span class="org-keyword">return</span> EXIT_FAILURE;
   <span class="org-rainbow-delimiters-depth-2">}</span>

   <span class="org-comment-delimiter">/// </span><span class="org-comment">Shared library that will be executed </span>
   <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">dll_file</span>     = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-comment-delimiter">/// </span><span class="org-comment">Entry point that will be called </span>
   <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">entry_point</span>  = argv<span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span>;
   <span class="org-comment-delimiter">/// </span><span class="org-comment">Command line arguments to the called entry point </span>
   <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">command_line</span> = argv<span class="org-rainbow-delimiters-depth-2">[</span>3<span class="org-rainbow-delimiters-depth-2">]</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Wide unicode version for LoadLibrary API</span>
   <span class="org-type">HMODULE</span> <span class="org-variable-name">hLib</span> = ::LoadLibraryA<span class="org-rainbow-delimiters-depth-2">(</span>dll_file.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   assert<span class="org-rainbow-delimiters-depth-2">(</span>hLib != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-type">FARPROC</span> <span class="org-variable-name">hFunc</span> = ::GetProcAddress<span class="org-rainbow-delimiters-depth-2">(</span>hLib, entry_point.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   assert<span class="org-rainbow-delimiters-depth-2">(</span>hFunc != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">//</span><span class="org-comment">--- Execute Entry Point ----//</span>
   <span class="org-type">HINSTANCE</span> <span class="org-variable-name">hInstance</span> = GetModuleHandle<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-keyword">auto</span> <span class="org-variable-name">entry_point_handler</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Rundll32EntryPoint_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hFunc<span class="org-rainbow-delimiters-depth-2">)</span>;
   entry_point_handler<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, hInstance, command_line.data<span class="org-rainbow-delimiters-depth-3">()</span>, 1<span class="org-rainbow-delimiters-depth-2">)</span>;     

   <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Testing</b> 
</p>

<p>
Show usage: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ bin\dll-runner.exe
 Usage: bin\dll-runner.exe &lt;DLL-FILE&gt; &lt;ENTRY-POINT&gt; &lt;ENTRY_COMMAND_LINE&gt;
 [ERROR] Invalid arguments. Abort.
</pre>
</div>

<p>
Execute <span class="underline">EditEnvironmentvariables</span> entry point of sysdm.cpl DLL (Control
Panel Applet). 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">$ RunDll32.exe sysdm.cpl,EditEnvironmentVariables</span>

$ dll-runner.exe sysdm.cpl EditEnvironmentVariables <span class="org-string">""</span>

$ dll-runner.exe C:<span class="org-string">\\</span>Windows\system32\sysdm.cpl EditEnvironmentVariables <span class="org-string">""</span>
</pre>
</div>

<p>
Execute <span class="underline">Options_RunDLL</span> entry point of shell32.dll which opens File
Explorer Options window. 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">$ RunDll32.exe shell32.dll,Options_RunDLL 0</span>

$ dll-runner.exe shell32.dll Options_RunDLL <span class="org-string">"0"</span>

$ dll-runner.exe C:<span class="org-string">\\</span>Windows\system32\shell32.dll Options_RunDLL <span class="org-string">"0"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1b24ce0" class="outline-3">
<h3 id="org1b24ce0"><span class="section-number-3">1.35</span> Read metadata from Windows PE Portable Executable files</h3>
<div class="outline-text-3" id="text-1-35">
<p>
PE (Portable Executable), which main variants are PE-32 and PE-64, is
the binary file format used by Windows executable (.exe files),
shared libraries (.dll files); device drivers (.sys files) and also
Windows kernel.
</p>

<p>
More infor about PE32 files: 
</p>

<ul class="org-ul">
<li><a href="https://blog.malwarebytes.com/threat-analysis/2014/05/five-pe-analysis-tools-worth-looking-at/">Five PE Analysis Tools Worth Looking At</a></li>

<li><a href="http://www.pelib.com/resources/luevel.txt">http://www.pelib.com/resources/luevel.txt</a></li>

<li><a href="https://wiki.osdev.org/PE">https://wiki.osdev.org/PE</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format">PE Format - Microsft Docs</a></li>

<li><a href="https://en.wikibooks.org/wiki/X86_Disassembly/Windows_Executable_Files">Wikibooks - x86 Disassembly/Windows Executable Files</a></li>

<li><a href="https://en.wikipedia.org/wiki/Portable_Executable">Portable Executable</a></li>

<li><a href="http://www.csn.ul.ie/~caolan/publink/winresdump/winresdump/doc/pefile2.html">The Portable Executable File Format from Top to Bottom</a></li>

<li><a href="http://www.sunshine2k.de/reversing/tuts/tut_pe.htm">PE File Format Offsets - by Sunshine</a></li>

<li><a href="https://www.aldeid.com/wiki/PE-Portable-executable">PE-Portable-executable  - aldeid</a></li>

<li><a href="https://blog.kowalczyk.info/articles/pefileformat.html">Portable Executable File Format - blog kowalczyk</a></li>

<li><a href="https://codereview.stackexchange.com/questions/106037/pulling-pe32-header-info">Question - Pulling PE32 header info</a></li>

<li><a href="https://webserver2.tecgraf.puc-rio.br/~ismael/Cursos/YC++/apostilas/win32_xcoff_pe/tyne-example/Tiny%20PE.htm">Tiny PE - Creating the smallest possible PE executable</a></li>

<li><a href="http://www.cse.tkk.fi/fi/opinnot/T-110.6220/2010_Spring_Malware_Analysis_and_Antivirus_Tchnologies/luennot-files/Erdelyi-Reverse_engineering_2.pdf">Reverse Engineering III: PE Format</a></li>

<li><a href="https://tech-zealots.com/malware-analysis/pe-portable-executable-structure-malware-analysis-part-2/">Undestanding PE Structure - Part 2</a></li>

<li><a href="https://formats.kaitai.io/uefi_te/index.html">https://formats.kaitai.io/uefi_te/index.html</a></li>
</ul>

<p>
<b>Project Files</b> 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/f5edeaa4d929f5acf258d71caf6915cd">https://gist.github.com/f5edeaa4d929f5acf258d71caf6915cd</a></li>
</ul>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(pe-metadata)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>
<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-function-name">add_executable</span>(pe-info pe-info.cpp pe_data.hpp)
</pre>
</div>

<p>
File: pe_data.hpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span> _PE_DATA_ 
<span class="org-preprocessor">#define</span> <span class="org-variable-name">_PE_DATA_</span> 

<span class="org-comment-delimiter">//</span><span class="org-comment">#include &lt;windows.h&gt;</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">#include &lt;winnt.h&gt;</span>
<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_SIZEOF_SHORT_NAME</span> = 8;
<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span> = 16;

<span class="org-comment-delimiter">// </span><span class="org-comment">using LONG      = long;</span>
<span class="org-keyword">using</span> <span class="org-type">LONG</span>      = <span class="org-constant">std</span>::int32_t;
<span class="org-keyword">using</span> <span class="org-type">WORD</span>      = <span class="org-constant">std</span>::uint16_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned short;</span>
<span class="org-keyword">using</span> <span class="org-type">DWORD</span>     = <span class="org-constant">std</span>::uint32_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long; </span>
<span class="org-keyword">using</span> <span class="org-type">BYTE</span>      = <span class="org-constant">std</span>::uint8_t;   <span class="org-comment-delimiter">//</span><span class="org-comment">unsigned char;</span>
<span class="org-keyword">using</span> <span class="org-type">ULONGLONG</span> = <span class="org-constant">std</span>::uint64_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long long </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: &lt;winttt.h&gt;  =&gt; Original: typedef struct _IMAGE_DOS_HEADER</span>
<span class="org-keyword">struct</span> <span class="org-type">IMAGE_DOS_HEADER</span> <span class="org-rainbow-delimiters-depth-1">{</span>            
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_magic</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cblp</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_crlc</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cparhdr</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_minalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_maxalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ss</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_sp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_csum</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ip</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cs</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_lfarlc</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ovno</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res</span><span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oemid</span>;                  
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oeminfo</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;               
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Offset to the PE header from the beginning of the file. </span>
    <span class="org-type">LONG</span>   <span class="org-variable-name">e_lfanew</span>;                    
  <span class="org-rainbow-delimiters-depth-1">}</span>;

 <span class="org-keyword">struct</span> <span class="org-type">PE_HEADER</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">Signature</span>; 
    <span class="org-type">WORD</span>  <span class="org-variable-name">Machine</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">NumberOfSections</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">TimeDateStamp</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">PointerToSymbolTable</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">NumberOfSymbols</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">SizeOfOptionalHeader</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">Characteristics</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">PE_IMAGE_DATA_DIRECTORY</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span>   <span class="org-variable-name">VirtualAddress</span>;
    <span class="org-type">DWORD</span>   <span class="org-variable-name">Size</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">PE_OPTIONAL_HEADER64</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">WORD</span>        <span class="org-variable-name">Magic</span>;
    <span class="org-type">BYTE</span>        <span class="org-variable-name">MajorLinkerVersion</span>;
    <span class="org-type">BYTE</span>        <span class="org-variable-name">MinorLinkerVersion</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">SizeOfCode</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">SizeOfInitializedData</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">SizeOfUninitializedData</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">AddressOfEntryPoint</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">BaseOfCode</span>;
    <span class="org-type">ULONGLONG</span>   <span class="org-variable-name">ImageBase</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">SectionAlignment</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">FileAlignment</span>;
    <span class="org-type">WORD</span>        <span class="org-variable-name">MajorOperatingSystemVersion</span>;
    <span class="org-type">WORD</span>        <span class="org-variable-name">MinorOperatingSystemVersion</span>;
    <span class="org-type">WORD</span>        <span class="org-variable-name">MajorImageVersion</span>;
    <span class="org-type">WORD</span>        <span class="org-variable-name">MinorImageVersion</span>;
    <span class="org-type">WORD</span>        <span class="org-variable-name">MajorSubsystemVersion</span>;
    <span class="org-type">WORD</span>        <span class="org-variable-name">MinorSubsystemVersion</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">Win32VersionValue</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">SizeOfImage</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">SizeOfHeaders</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">CheckSum</span>;
    <span class="org-type">WORD</span>        <span class="org-variable-name">Subsystem</span>;
    <span class="org-type">WORD</span>        <span class="org-variable-name">DllCharacteristics</span>;
    <span class="org-type">ULONGLONG</span>   <span class="org-variable-name">SizeOfStackReserve</span>;
    <span class="org-type">ULONGLONG</span>   <span class="org-variable-name">SizeOfStackCommit</span>;
    <span class="org-type">ULONGLONG</span>   <span class="org-variable-name">SizeOfHeapReserve</span>;
    <span class="org-type">ULONGLONG</span>   <span class="org-variable-name">SizeOfHeapCommit</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">LoaderFlags</span>;
    <span class="org-type">DWORD</span>       <span class="org-variable-name">NumberOfRvaAndSizes</span>;    
    <span class="org-type">PE_IMAGE_DATA_DIRECTORY</span> <span class="org-variable-name">DataDirectory</span><span class="org-rainbow-delimiters-depth-2">[</span>IMAGE_NUMBEROF_DIRECTORY_ENTRIES<span class="org-rainbow-delimiters-depth-2">]</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">source: winnt.h header </span>
<span class="org-keyword">struct</span> <span class="org-type">PE_SECTION_HEADER</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">BYTE</span>    <span class="org-variable-name">Name</span><span class="org-rainbow-delimiters-depth-2">[</span>IMAGE_SIZEOF_SHORT_NAME<span class="org-rainbow-delimiters-depth-2">]</span>;
    <span class="org-keyword">union</span> <span class="org-rainbow-delimiters-depth-2">{</span>
            <span class="org-type">DWORD</span>   <span class="org-variable-name">PhysicalAddress</span>;
            <span class="org-type">DWORD</span>   <span class="org-variable-name">VirtualSize</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-variable-name">Misc</span>;    
    <span class="org-type">DWORD</span>   <span class="org-variable-name">VirtualAddress</span>;
    <span class="org-type">DWORD</span>   <span class="org-variable-name">SizeOfRawData</span>;
    <span class="org-type">DWORD</span>   <span class="org-variable-name">PointerToRawData</span>;
    <span class="org-type">DWORD</span>   <span class="org-variable-name">PointerToRelocations</span>;
    <span class="org-type">DWORD</span>   <span class="org-variable-name">PointerToLinenumbers</span>;
    <span class="org-type">WORD</span>    <span class="org-variable-name">NumberOfRelocations</span>;
    <span class="org-type">WORD</span>    <span class="org-variable-name">NumberOfLinenumbers</span>;
    <span class="org-type">DWORD</span>   <span class="org-variable-name">Characteristics</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-preprocessor">#endif</span> 
</pre>
</div>

<p>
File: pe-info.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">optional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">C++17 </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">algorithm</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string">"pe_data.hpp"</span>

<span class="org-comment-delimiter">/**  </span><span class="org-comment">Read binary data from a input stream at a given offset.</span>
<span class="org-comment"> * </span>
<span class="org-comment"> * @param tref    Reference to type that will be read from input stream </span>
<span class="org-comment"> * @param ifs     Input stream </span>
<span class="org-comment"> * @param offset  Offset from the beggining of the input stream or file.</span>
<span class="org-comment"> */</span>
<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-type">void</span> <span class="org-function-name">read_at</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">T</span>&amp; <span class="org-variable-name">tref</span>
            , <span class="org-constant">std</span>::<span class="org-type">istream</span>&amp; <span class="org-variable-name">ifs</span>
            , <span class="org-constant">std</span>::<span class="org-type">optional</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">size_t</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">offset</span> = <span class="org-rainbow-delimiters-depth-2">{}</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>offset<span class="org-rainbow-delimiters-depth-2">)</span> ifs.seekg<span class="org-rainbow-delimiters-depth-2">(</span>offset.value<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    ifs.read<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>&amp;tref<span class="org-rainbow-delimiters-depth-3">)</span>, <span class="org-keyword">sizeof</span> <span class="org-rainbow-delimiters-depth-3">(</span>T<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Usage: $ pe-info &lt;FILE&gt; "</span> &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">auto</span> <span class="org-variable-name">file_path</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-rainbow-delimiters-depth-2">}</span> ;  

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" File: "</span> &lt;&lt; file_path &lt;&lt; <span class="org-string">"\n"</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream <span class="org-rainbow-delimiters-depth-2">(</span>file_path, <span class="org-constant">std</span>::<span class="org-constant">ios</span>::in | <span class="org-constant">std</span>::<span class="org-constant">ios</span>::binary <span class="org-rainbow-delimiters-depth-2">)</span>;    
    assert<span class="org-rainbow-delimiters-depth-2">(</span> ifs.good<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">IMAGE_DOS_HEADER</span> <span class="org-variable-name">dos_header</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Position cursor at beggining of file </span>
    read_at<span class="org-rainbow-delimiters-depth-2">(</span>dos_header, ifs, 0x00 <span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> dos_header.e_magic == 0x5A4D <span class="org-rainbow-delimiters-depth-2">)</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Offset of PE-Header from the beggining of the file </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">e_lfanew</span> = dos_header.e_lfanew;      

    <span class="org-type">char</span> <span class="org-variable-name">magic</span><span class="org-rainbow-delimiters-depth-2">[</span>3<span class="org-rainbow-delimiters-depth-2">]</span> = <span class="org-rainbow-delimiters-depth-2">{</span> 
      dos_header.e_magic &amp; 0xFF          <span class="org-comment-delimiter">// </span><span class="org-comment">Fist byte</span>
    , <span class="org-rainbow-delimiters-depth-3">(</span>dos_header.e_magic &gt;&gt; 8<span class="org-rainbow-delimiters-depth-3">)</span>  &amp; 0xff  <span class="org-comment-delimiter">// </span><span class="org-comment">Second byte </span>
    , 0x00                               <span class="org-comment-delimiter">// </span><span class="org-comment">Null character </span>
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ------ DOS HEADER ---------------\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [DOS_HEADER] MAGIC NUMBER = 0x%X (hex) \n"</span>, dos_header.e_magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [DOS_HEADER] MAGIC NUMBER = %s   (str) \n"</span>, magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [DOS_HEADER]     e_lfanew = 0x%X \n"</span>, e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------//</span>
    <span class="org-comment-delimiter">//   </span><span class="org-comment">PE HEADER                                      // </span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------//</span>
    <span class="org-type">PE_HEADER</span> <span class="org-variable-name">pe_header</span>;    
    read_at<span class="org-rainbow-delimiters-depth-2">(</span>pe_header, ifs, dos_header.e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">//</span><span class="org-comment">The signature should always have this value (0x4550)</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> pe_header.Signature == 0x4550 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n -------- PE - Header ----------------------\n\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"          Signature = 0x%X \n"</span>, pe_header.Signature<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"            Machine = 0x%X \n"</span>, pe_header.Machine<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Number of sections = %d \n"</span>,   pe_header.NumberOfSections<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------//</span>
    <span class="org-comment-delimiter">//   </span><span class="org-comment">PE OPTIONAL HEADER                             // </span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------//</span>
    <span class="org-type">PE_OPTIONAL_HEADER64</span> <span class="org-variable-name">pe_opt</span>;
    read_at<span class="org-rainbow-delimiters-depth-2">(</span>pe_opt, ifs<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">subsystem</span> = <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-variable-name">pe_opt</span><span class="org-rainbow-delimiters-depth-2">]()</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pe_opt.Subsystem == 1<span class="org-rainbow-delimiters-depth-3">)</span>  <span class="org-keyword">return</span> <span class="org-string">"No subsystem required (device drivers)"</span>;      
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pe_opt.Subsystem == 2<span class="org-rainbow-delimiters-depth-3">)</span>  <span class="org-keyword">return</span> <span class="org-string">"gui / graphical"</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pe_opt.Subsystem == 3<span class="org-rainbow-delimiters-depth-3">)</span>  <span class="org-keyword">return</span> <span class="org-string">"console"</span>;      
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pe_opt.Subsystem == 9<span class="org-rainbow-delimiters-depth-3">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Windows CE system"</span>;        
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pe_opt.Subsystem == 10<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">return</span> <span class="org-string">"EFI - Extensible Firmware Interfgace"</span>;                
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pe_opt.Subsystem == 16<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">return</span> <span class="org-string">"Windows Boot"</span>;                

        <span class="org-keyword">return</span> <span class="org-string">"Unknown"</span>;
    <span class="org-rainbow-delimiters-depth-2">}()</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n -------- PE Optional Header ----------------------\n\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"                           Magic = 0x%X \n"</span>, pe_opt.Magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"                       Subsystem = 0x%X \n"</span>, pe_opt.Subsystem<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"                       Subsystem = %s   \n"</span>, subsystem.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"           Address of Entrypoint = 0x%X \n"</span>, pe_opt.AddressOfEntryPoint<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"              Major link version = 0x%X \n"</span>, pe_opt.MajorLinkerVersion<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"                    Size of code = 0x%X \n"</span>, pe_opt.SizeOfCode<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"  Major Operating System Version = 0x%X \n"</span>, pe_opt.MajorOperatingSystemVersion<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"  Minor Operating System Version = 0x%X \n"</span>, pe_opt.MinorOperatingSystemVersion<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------//</span>
    <span class="org-comment-delimiter">//   </span><span class="org-comment">DATA SECTIONS                                  // </span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------//</span>
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n -------- PE Sections ---------------\n\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">PE_SECTION_HEADER</span> <span class="org-variable-name">sec</span>;

    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; pe_header.NumberOfSections; i++<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        read_at<span class="org-rainbow-delimiters-depth-3">(</span>sec, ifs<span class="org-rainbow-delimiters-depth-3">)</span>;        
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [%d] section name = %s \n"</span>, i, sec.Name<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"     =&gt; Virtual Address = 0x%X \n"</span>, sec.VirtualAddress<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"     =&gt;     Raw Address = 0x%X \n"</span>, sec.PointerToRawData<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>       

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building</b>
</p>

<ul class="org-ul">
<li>This proof-of-concept application is cross-platform and does not
depend on the Windows API, therefore, it can also be built on
Linux or any Unix-like operating system.</li>
</ul>

<p>
Build on Windows 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/f5edeaa4d929f5acf258d71caf6915cd pe-info &amp;&amp; <span class="org-builtin">cd</span> pe-info 
$ cmake -H. -B_build -G <span class="org-string">"Visual Studio 16 2019"</span> -DCMAKE_BUILD_TYPE=Debug
$ cmake --build _build --target all
</pre>
</div>

<p>
Build on Linux 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/f5edeaa4d929f5acf258d71caf6915cd pe-info &amp;&amp; <span class="org-builtin">cd</span> pe-info 
$ cmake -H. -B_build_linux -DCMAKE_BUILD_TYPE=Debug 
$ cmake --build _build_linux --target 
</pre>
</div>

<p>
<b>Running</b> 
</p>

<p>
Note: the following results can be checked with the application <a href="http://www.ntcore.com/exsuite.php">CFF Explorer</a> 
which allows viewing PE32 files in intuitive and lightweight GUI. 
</p>

<p>
Inspect: ipconfig.exe 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ pe-info.exe C:\Windows\System32\ipconfig.exe

 File: C:\Windows\System32\ipconfig.exe

 ------ DOS HEADER ---------------
 [DOS_HEADER] MAGIC NUMBER = 0x5A4D (hex)
 [DOS_HEADER] MAGIC NUMBER = MZ   (str)
 [DOS_HEADER]     e_lfanew = 0xE8

 -------- PE - Header ----------------------

 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64

          Signature = 0x4550
            Machine = 0x8664
 Number of sections = 6

 -------- PE Optional Header ----------------------

                           Magic = 0x20B
                       Subsystem = 0x3
                       Subsystem = console
           Address of Entrypoint = 0x4EB0
              Major link version = 0xE
                    Size of code = 0x4800
  Major Operating System Version = 0xA
  Minor Operating System Version = 0x0

 -------- PE Sections ---------------

 [0] section name = .text
     =&gt; Virtual Address = 0x1000
     =&gt;     Raw Address = 0x400

 [1] section name = .rdata
     =&gt; Virtual Address = 0x6000
     =&gt;     Raw Address = 0x4C00

 [2] section name = .data
     =&gt; Virtual Address = 0x9000
     =&gt;     Raw Address = 0x7600

 [3] section name = .pdata
     =&gt; Virtual Address = 0xA000
     =&gt;     Raw Address = 0x7800

 [4] section name = .rsrc
     =&gt; Virtual Address = 0xB000
     =&gt;     Raw Address = 0x7C00

 [5] section name = .reloc
     =&gt; Virtual Address = 0xC000
     =&gt;     Raw Address = 0x8600

</pre>
</div>

<p>
Inspect: notepad.exe 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ pe-info.exe C:\Windows\System32\notepad.exe

<span class="org-function-name">File</span>: C:\Windows\System32\notepad.exe

------ DOS HEADER ---------------
[DOS_HEADER] MAGIC NUMBER = 0x5A4D (hex)
[DOS_HEADER] MAGIC NUMBER = MZ   (str)
[DOS_HEADER]     e_lfanew = 0xF8

-------- PE - Header ----------------------

<span class="org-function-name">Note</span>: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64

         Signature = 0x4550
           Machine = 0x8664
Number of sections = 7

-------- PE Optional Header ----------------------

                          Magic = 0x20B
                      Subsystem = 0x2
                      Subsystem = gui / graphical
          Address of Entrypoint = 0x20110
             Major link version = 0xE
                   Size of code = 0x20600
 Major Operating System Version = 0xA
 Minor Operating System Version = 0x0

-------- PE Sections ---------------

[0] section name = .text
    =&gt; Virtual Address = 0x1000
    =&gt;     Raw Address = 0x400

[1] section name = .rdata
    =&gt; Virtual Address = 0x22000
    =&gt;     Raw Address = 0x20A00

[2] section name = .data
    =&gt; Virtual Address = 0x2B000
    =&gt;     Raw Address = 0x29600

[3] section name = .pdata
    =&gt; Virtual Address = 0x2E000
    =&gt;     Raw Address = 0x2A200

[4] section name = .didat
    =&gt; Virtual Address = 0x2F000
    =&gt;     Raw Address = 0x2B200

[5] section name = .rsrc
    =&gt; Virtual Address = 0x30000
    =&gt;     Raw Address = 0x2B400

[6] section name = .reloc
    =&gt; Virtual Address = 0x31000
    =&gt;     Raw Address = 0x2C000
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaa2ec3c" class="outline-3">
<h3 id="orgaa2ec3c"><span class="section-number-3">1.36</span> Install Development Tools and Compilers</h3>
<div class="outline-text-3" id="text-1-36">
</div>
<div id="outline-container-orgf268d40" class="outline-4">
<h4 id="orgf268d40"><span class="section-number-4">1.36.1</span> C++ Compilers</h4>
<div class="outline-text-4" id="text-1-36-1">
</div>
<ol class="org-ol">
<li><a id="org5f23975"></a>Install GCC/Mingw + a couple of GNU tools<br />
<div class="outline-text-5" id="text-1-36-1-1">
<p>
Migw - gcc/g++ GNU C/C++ Compiler ported for Windows  - <a href="https://chocolatey.org/packages/mingw">mingw</a>
</p>

<p>
Tools: 
</p>
<ul class="org-ul">
<li>gcc =&gt; GNU C compiler</li>
<li>g++ =&gt; GNU C++ compiler</li>
<li>gfortran =&gt; GNU Fortran Compiler</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ choco install -f mingw 
</pre>
</div>

<p>
Note the tools are installed at: <code>C:\tools\mingw64\bin\</code>
</p>

<p>
Check installed tools:
</p>

<div class="org-src-container">
<pre class="src src-sh">&#955; dir C:\tools\mingw64\bin
 Volume<span class="org-keyword"> in</span> drive C has no label.
 Volume Serial Number is CEFD-3D70

 Directory of C:\tools\mingw64\bin

12/28/2015  08:49 PM    &lt;DIR&gt;          .
12/28/2015  08:49 PM    &lt;DIR&gt;          ..
12/28/2015  05:51 PM         1,003,008 addr2line.exe
12/28/2015  05:51 PM         1,029,120 ar.exe
12/28/2015  05:51 PM         1,781,248 as.exe
12/28/2015  07:32 PM         1,812,480 c++.exe
12/28/2015  05:51 PM         1,001,472 c++filt.exe
12/28/2015  07:32 PM         1,810,944 cpp.exe
12/28/2015  05:51 PM         1,061,888 dlltool.exe
12/28/2015  05:51 PM            55,296 dllwrap.exe
12/28/2015  05:51 PM         3,037,696 dwp.exe
12/28/2015  05:51 PM            41,984 elfedit.exe
12/28/2015  07:32 PM         1,812,480 g++.exe
12/28/2015  07:32 PM            62,464 gcc-ar.exe
12/28/2015  07:32 PM            61,952 gcc-nm.exe
12/28/2015  07:32 PM            61,952 gcc-ranlib.exe
12/28/2015  07:32 PM         1,809,920 gcc.exe
12/28/2015  07:32 PM         1,391,616 gcov-tool.exe
12/28/2015  07:32 PM         1,409,536 gcov.exe
12/28/2015  08:47 PM            58,333 gdb.exe
12/28/2015  08:47 PM         7,786,103 gdborig.exe
12/28/2015  08:47 PM           412,003 gdbserver.exe
12/28/2015  07:34 PM            57,856 gendef.exe
12/28/2015  07:34 PM            75,264 genidl.exe
12/28/2015  07:34 PM            31,232 genpeimg.exe
12/28/2015  07:32 PM         1,811,968 gfortran.exe
12/28/2015  05:51 PM         1,069,568 gprof.exe
12/28/2015  05:51 PM         1,419,264 ld.bfd.exe
12/28/2015  05:51 PM         1,419,264 ld.exe
12/28/2015  05:51 PM         4,806,144 ld.gold.exe
12/28/2015  07:33 PM            37,888 libatomic-1.dll
12/28/2015  07:33 PM            82,944 libgcc_s_seh-1.dll
12/28/2015  07:33 PM         1,293,312 libgfortran-3.dll
12/28/2015  07:33 PM           112,640 libgomp-1.dll
12/28/2015  07:33 PM            17,920 libgomp-plugin-host_nonshm-1.dll
12/28/2015  07:33 PM           333,824 libquadmath-0.dll
12/28/2015  07:33 PM            19,968 libssp-0.dll
12/28/2015  07:33 PM         1,424,896 libstdc++-6.dll
12/28/2015  07:33 PM            16,384 libvtv-0.dll
12/28/2015  07:33 PM            16,384 libvtv_stubs-0.dll
12/28/2015  07:33 PM            83,456 libwinpthread-1.dll
12/28/2015  08:49 PM           219,648 mingw32-make.exe
12/28/2015  05:51 PM         1,013,760 nm.exe
12/28/2015  05:51 PM         1,171,456 objcopy.exe
12/28/2015  05:51 PM         2,101,760 objdump.exe
12/28/2015  05:51 PM         1,029,120 ranlib.exe
12/28/2015  05:51 PM           490,496 readelf.exe
12/28/2015  05:51 PM         1,004,032 size.exe
12/28/2015  05:51 PM         1,003,520 strings.exe
12/28/2015  05:51 PM         1,171,456 strip.exe
12/28/2015  07:35 PM           437,760 widl.exe
12/28/2015  05:51 PM         1,027,072 windmc.exe
12/28/2015  05:51 PM         1,115,648 windres.exe
12/28/2015  07:32 PM         1,812,480 x86_64-w64-mingw32-c++.exe
12/28/2015  07:32 PM         1,812,480 x86_64-w64-mingw32-g++.exe
12/28/2015  07:32 PM         1,809,920 x86_64-w64-mingw32-gcc-5.3.0.exe
12/28/2015  07:32 PM            62,464 x86_64-w64-mingw32-gcc-ar.exe
12/28/2015  07:32 PM            61,952 x86_64-w64-mingw32-gcc-nm.exe
12/28/2015  07:32 PM            61,952 x86_64-w64-mingw32-gcc-ranlib.exe
12/28/2015  07:32 PM         1,809,920 x86_64-w64-mingw32-gcc.exe
12/28/2015  07:32 PM         1,811,968 x86_64-w64-mingw32-gfortran.exe
              59 File(s)     62,660,535 bytes
               2 Dir(s)  19,433,713,664 bytes free

</pre>
</div>

<p>
See: 
</p>

<ul class="org-ul">
<li><a href="https://www.transmissionzero.co.uk/computing/building-dlls-with-mingw/">Building Windows DLLs with MinGW</a></li>
<li><a href="https://www.codeproject.com/Articles/84461/MinGW-Static-and-Dynamic-Libraries">MinGW Static and Dynamic Libraries - CodeProject</a></li>
<li></li>

<li></li>
</ul>
</div>
</li>
<li><a id="orgecedc03"></a>Install Visual Studio + Microsft MSVC C++ Compiler<br />
<div class="outline-text-5" id="text-1-36-1-2">
<p>
Installing Visual Studio building tools directly is hassle as
Microsoft doesn't provide an easy and quick way to install it as Linux
development tools which can be quick installed by using the command
line and trusted repositories. However <a href="https://chocolatey.org/">chocolately</a> package manager
provides a Linux-like solution to install those development tools in
an automatic and seamlessly way.
</p>

<p>
Visual Studio Build Tools 2015 - <a href="https://chocolatey.org/packages/VisualCppBuildTools">Visual C++ Build Tools 2015 14.0.25420.1</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ choco install visualcppbuildtools
</pre>
</div>

<p>
Visual C++ 2017 - <a href="https://chocolatey.org/packages/visualstudio2017buildtools">Visual Studio 2017 Build Tools 15.2.26430.20170650</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ choco install hoco install visualstudio2017buildtools 
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org086328b" class="outline-4">
<h4 id="org086328b"><span class="section-number-4">1.36.2</span> IDEs and Text Editors</h4>
<div class="outline-text-4" id="text-1-36-2">
</div>
<ol class="org-ol">
<li><a id="org56b4fa9"></a>Install Visual Studio Code<br />
<div class="outline-text-6" id="text-1-36-2-0-1">
<p>
Package: <a href="https://chocolatey.org/packages/vscode">https://chocolatey.org/packages/vscode</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ choco install -y vscode
</pre>
</div>

<p>
More:
</p>

<ul class="org-ul">
<li><a href="https://marketplace.visualstudio.com/items?itemName=formulahendry.code-runner">Code Runner - Visual Studio Marketplace</a> - Compile and run single
file. However, it is not so fast and flexible as Emacs' M-x
compile.</li>
<li><a href="https://blogs.msdn.microsoft.com/vcblog/2016/10/24/building-your-c-application-with-visual-studio-code/">Building your C++ application with Visual Studio Code | Visual C++ Team Blog</a></li>
</ul>
</div>
</li>
<li><a id="orgc1377a1"></a>Install Codeblocks<br />
<div class="outline-text-6" id="text-1-36-2-0-2">
<p>
Package: <a href="https://chocolatey.org/packages/codeblocks">https://chocolatey.org/packages/codeblocks</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ choco install -y codeblocks
</pre>
</div>
</div>
</li>
<li><a id="orgcb6cfb2"></a>Install QTCreator Standalone<br />
<div class="outline-text-6" id="text-1-36-2-0-3">
<p>
Install QTCreator quasi-IDE. This 'IDE' can work with CMake projects
and provides code completion on the fly, without any configuration. 
</p>

<ul class="org-ul">
<li><a href="https://chocolatey.org/packages/qtcreator">Chocolatey Gallery | Qt Creator 4.8.0</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ choco install -y qtcreator 
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org4ffc588" class="outline-4">
<h4 id="org4ffc588"><span class="section-number-4">1.36.3</span> Essential Windows Instrospection and Debugging Tools</h4>
<div class="outline-text-4" id="text-1-36-3">
</div>
<ol class="org-ol">
<li><a id="org7bd8308"></a>Install SysInternals<br />
<div class="outline-text-5" id="text-1-36-3-1">
<p>
SysInterals - <a href="https://chocolatey.org/packages/sysinternals">https://chocolatey.org/packages/sysinternals</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">$  choco install sysinternals 
</pre>
</div>

<p>
Process Explorer - <a href="https://chocolatey.org/packages/procexp">https://chocolatey.org/packages/procexp</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ choco install procexp 
</pre>
</div>
</div>
</li>
<li><a id="orga320769"></a>Install CMDER Terminal Emulator<br />
<div class="outline-text-5" id="text-1-36-3-2">
<p>
CMDER Is decent ANSI/VT100 compliant terminal emulator which supports
ANI Escape sequences, ANSI colors and Emacs Keybindigns used on bash.
</p>

<div class="org-src-container">
<pre class="src src-sh">$ choco install cmder 
</pre>
</div>
</div>
</li>

<li><a id="org51b0c08"></a>COM, OLE and RPC Views<br />
<ol class="org-ol">
<li><a id="org7a4c1bf"></a>Oleview.exe<br />
<div class="outline-text-6" id="text-1-36-3-3-1">
<ul class="org-ul">
<li><b>Oleview.exe</b> =&gt; Tool for viewing system COM Components. It comes
with Visual studio tools. It can be launched from development
prompt by typing oleview.exe</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Tested for MSVC - 2017 tools:</span>
<span class="org-function-name">C</span>:\Users\archbox &gt; where oleview
<span class="org-function-name">C</span>:\Program Files (x86)\Windows Kits\10\bin\10.0.17763.0\x64\oleview.exe
</pre>
</div>

<p>
For MSVC - 2017, it can be launched directly by running oleview.exe with
absolute path: 
</p>

<div class="org-src-container">
<pre class="src src-text">Windows Key + R + "C:\Program Files (x86)\Windows Kits\10\bin\10.0.17763.0\x64\oleview.exe"
</pre>
</div>
</div>
</li>
<li><a id="org5c11d11"></a>RPCView<br />
<div class="outline-text-6" id="text-1-36-3-3-2">
<ul class="org-ul">
<li>"A free and powerful tool to explore and decompile all RPC
functionalities present on a Microsoft system."</li>

<li><a href="http://rpcview.org/">http://rpcview.org/</a></li>
</ul>
</div>
</li>

<li><a id="orgf8e1c82"></a>API Monitor - Monitor WinAPI and system calls<br />
<div class="outline-text-6" id="text-1-36-3-3-3">
<p>
"Monitor is a free software that lets you monitor and control API
calls made by applications and services. Its a powerful tool for
seeing how applications and services work or for tracking down
problems that you have in your own applications."
</p>

<ul class="org-ul">
<li><a href="http://www.rohitab.com/apimonitor">http://www.rohitab.com/apimonitor</a></li>
</ul>
</div>
</li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-orge3806a4" class="outline-4">
<h4 id="orge3806a4"><span class="section-number-4">1.36.4</span> Other Tools</h4>
<div class="outline-text-4" id="text-1-36-4">
</div>
<ol class="org-ol">
<li><a id="org835bb1a"></a>Install JOM - NMake Clone<br />
<div class="outline-text-5" id="text-1-36-4-1">
<p>
JOM is a NMake clone created by the QT company which allows faster and
parallel building:
</p>

<ul class="org-ul">
<li><a href="https://chocolatey.org/packages/jom">Chocolatey Gallery | jom 1.1.2</a></li>
<li><a href="http://blog.qt.io/blog/2009/03/27/speeding-up-visual-c-qt-builds/">Speeding up Visual C++ Qt Builds - Qt Blog</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ choco install jom
</pre>
</div>
</div>
</li>
<li><a id="org96ebe27"></a>Install IDA Free Disassembler<br />
<div class="outline-text-5" id="text-1-36-4-2">
<p>
IDA - Free - Famous Disassembler - <a href="https://chocolatey.org/packages/ida-free">https://chocolatey.org/packages/ida-free</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ choco install ida-free 
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org0e5a061" class="outline-3">
<h3 id="org0e5a061"><span class="section-number-3">1.37</span> WINAPI Map</h3>
<div class="outline-text-3" id="text-1-37">
</div>
<div id="outline-container-orgd4a53b9" class="outline-4">
<h4 id="orgd4a53b9"><span class="section-number-4">1.37.1</span> Misc.</h4>
<div class="outline-text-4" id="text-1-37-1">
<p>
Source Codes:
</p>

<ul class="org-ul">
<li>Repository: <a href="https://github.com/Microsoft/Windows-classic-samples">https://github.com/Microsoft/Windows-classic-samples</a>
<ul class="org-ul">
<li>Windows Registry - <a href="https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/Win7Samples/winbase/registry/RegExplorer.c">RegExplorer.c</a></li>
<li>Windows Service  - <a href="https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/Win7Samples/winbase/service/Service.c">Service.c</a></li>
</ul></li>

<li>Repository: <a href="https://github.com/strobejb/winspy/">https://github.com/strobejb/winspy/</a> (Winspy++ Tool) for
inspecting Windows Messages.</li>
</ul>

<p>
General:
</p>

<ul class="org-ul">
<li><a href="https://www.pinvoke.net/">https://www.pinvoke.net/</a>
<ul class="org-ul">
<li>Note: Lists of Windows API functions grouped by system DLLs. It
has better discoverability and usability than MSDN docs.</li>
<li><a href="https://www.pinvoke.net/default.aspx/kernel32.AllocConsole">kernel32.dll</a></li>
<li><a href="https://www.pinvoke.net/default.aspx/advapi32.CreateService">advapi32.dll</a></li>
<li><a href="https://www.pinvoke.net/default.aspx/wininet.FtpCommand">wininet.dll</a> - High level functions for Http and Ftp protocol.</li>
<li></li>
</ul></li>

<li><a href="https://www-user.tu-chemnitz.de/~heha/viewchm.php/hs/Win32SEH.chm/">Win32 Structured Exception Handler</a></li>

<li><a href="https://blogs.windows.com/buildingapps/2017/07/06/calling-winrt-components-win32-process-via-desktop-bridge/">Calling WinRT Components from a Win32 process via the Desktop Bridge</a></li>
</ul>
</div>
</div>
<div id="outline-container-org4b087a7" class="outline-4">
<h4 id="org4b087a7"><span class="section-number-4">1.37.2</span> Header Files</h4>
<div class="outline-text-4" id="text-1-37-2">
<p>
Windows header files collected in a GIST: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c#file-windows-h">Windows.h</a> -</li>

<li><a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c#file-winreg-h">winreg.h</a>  - <a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c/raw/e66b9ff34ad80b84ee90decb512dc1a3f25625f5/winreg.h">raw</a>
<ul class="org-ul">
<li>Registry API.</li>
</ul></li>

<li><a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c#file-sal-h">sal.h</a> - <a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c/raw/e66b9ff34ad80b84ee90decb512dc1a3f25625f5/sal.h">raw</a>
<ul class="org-ul">
<li>Source annotation language.</li>
</ul></li>

<li><a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c#file-winuser-h">winuser.h</a> - <a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c/raw/e66b9ff34ad80b84ee90decb512dc1a3f25625f5/winuser.h">raw</a>
<ul class="org-ul">
<li>Graphical User Interface header.</li>
</ul></li>

<li><a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c#file-wtypes-h">wtypes.h</a> - <a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c/raw/e66b9ff34ad80b84ee90decb512dc1a3f25625f5/wtypes.h">raw</a>
<ul class="org-ul">
<li>Basic types definitions.</li>
</ul></li>

<li><a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c#file-winbase-h">winbase.h</a> - <a href="https://gist.github.com/caiorss/0678b5efb2aa2eff120b9e9284fdbb0c/raw/e66b9ff34ad80b84ee90decb512dc1a3f25625f5/WinBase.h">raw</a>
<ul class="org-ul">
<li>Kernel Functions</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org542d330" class="outline-4">
<h4 id="org542d330"><span class="section-number-4">1.37.3</span> Common HRESULT values</h4>
<div class="outline-text-4" id="text-1-37-3">
<p>
Reference: <a href="https://docs.microsoft.com/en-us/windows/desktop/seccrypto/common-hresult-values">Common HRESULT Values - Windows applications | Microsoft Docs</a>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-right">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">S_OK</td>
<td class="org-left">Operation successful</td>
<td class="org-right">0x00000000</td>
</tr>

<tr>
<td class="org-left">E_ABORT</td>
<td class="org-left">Operation aborted</td>
<td class="org-right">0x80004004</td>
</tr>

<tr>
<td class="org-left">E_ACCESSDENIED</td>
<td class="org-left">General access denied error</td>
<td class="org-right">0x80070005</td>
</tr>

<tr>
<td class="org-left">E_FAIL</td>
<td class="org-left">Unspecified failure</td>
<td class="org-right">0x80004005</td>
</tr>

<tr>
<td class="org-left">E_HANDLE</td>
<td class="org-left">Handle that is not valid</td>
<td class="org-right">0x80070006</td>
</tr>

<tr>
<td class="org-left">E_INVALIDARG</td>
<td class="org-left">One or more arguments are not valid</td>
<td class="org-right">0x80070057</td>
</tr>

<tr>
<td class="org-left">E_NOINTERFACE</td>
<td class="org-left">No such interface supported</td>
<td class="org-right">0x80004002</td>
</tr>

<tr>
<td class="org-left">E_NOTIMPL</td>
<td class="org-left">Not implemented</td>
<td class="org-right">0x80004001</td>
</tr>

<tr>
<td class="org-left">E_OUTOFMEMORY</td>
<td class="org-left">Failed to allocate necessary memory</td>
<td class="org-right">0x8007000E</td>
</tr>

<tr>
<td class="org-left">E_POINTER</td>
<td class="org-left">Pointer that is not valid</td>
<td class="org-right">0x80004003</td>
</tr>

<tr>
<td class="org-left">E_UNEXPECTED</td>
<td class="org-left">Unexpected failure</td>
<td class="org-right">0x8000FFFF</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org466ad11" class="outline-4">
<h4 id="org466ad11"><span class="section-number-4">1.37.4</span> Typedefs</h4>
<div class="outline-text-4" id="text-1-37-4">
<p>
WINAPI (several headers)
</p>

<ul class="org-ul">
<li>Macro used fro main function entry point.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#define</span> <span class="org-variable-name">WINAPI</span> __stdcall
</pre>
</div>

<p>
CALLBACK macro used for Window procedure callback.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#define</span> <span class="org-variable-name">CALLBACK</span> __stdcall
</pre>
</div>

<p>
Boolean (WinBase.h)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#define</span> <span class="org-variable-name">FALSE</span> 0
<span class="org-preprocessor">#define</span> <span class="org-variable-name">TRUE</span>  1
</pre>
</div>

<p>
Handle types - (opaque pointers) - (WinBase.h)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HANDLE</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HMODULE</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HINSTANCE</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HTASK</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HKEY</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HDESK</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HMF</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HEMF</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HPEN</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HRSRC</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HSTR</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HWINSTA</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HKL</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*  <span class="org-type">HGDIOBJ</span>;

<span class="org-keyword">typedef</span> <span class="org-type">HANDLE</span>  <span class="org-type">HDWP</span>;
<span class="org-keyword">typedef</span> <span class="org-type">HANDLE</span>* <span class="org-type">LPHANDLE</span>;
</pre>
</div>

<p>
Graphical Hadles - used by GUI functions. (WinBase.h)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">typedef</span> <span class="org-type">void</span>* <span class="org-type">HWND</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>* <span class="org-type">HMENU</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>* <span class="org-type">HACCEL</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>* <span class="org-type">HBRUSH</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>* <span class="org-type">HFONT</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>* <span class="org-type">HDC</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>* <span class="org-type">HICON</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>* <span class="org-type">HRGN</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>* <span class="org-type">HMONITOR</span>;
</pre>
</div>

<p>
HRESULT macros and definitions (winerror.h)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#define</span> <span class="org-function-name">SUCCEEDED</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">hr</span><span class="org-rainbow-delimiters-depth-1">)</span>         <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>HRESULT<span class="org-rainbow-delimiters-depth-3">)(</span>hr<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> &gt;= 0<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">FAILED</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">hr</span><span class="org-rainbow-delimiters-depth-1">)</span>            <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>HRESULT<span class="org-rainbow-delimiters-depth-3">)(</span>hr<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> &lt; 0<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">HRESULT_CODE</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">hr</span><span class="org-rainbow-delimiters-depth-1">)</span>      <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>hr<span class="org-rainbow-delimiters-depth-2">)</span> &amp; 0xFFFF<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">HRESULT_FACILITY</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">hr</span><span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>hr<span class="org-rainbow-delimiters-depth-3">)</span> &gt;&gt; 16<span class="org-rainbow-delimiters-depth-2">)</span> &amp; 0x1fff<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">HRESULT_SEVERITY</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">hr</span><span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>hr<span class="org-rainbow-delimiters-depth-3">)</span> &gt;&gt; 31<span class="org-rainbow-delimiters-depth-2">)</span> &amp; 0x1<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Create an HRESULT value from component pieces</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">MAKE_HRESULT</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">sev</span>,<span class="org-variable-name">fac</span>,<span class="org-variable-name">code</span><span class="org-rainbow-delimiters-depth-1">)</span> \
    <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>HRESULT<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-4">)(</span>sev<span class="org-rainbow-delimiters-depth-4">)</span>&lt;&lt;31<span class="org-rainbow-delimiters-depth-3">)</span> | <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-4">)(</span>fac<span class="org-rainbow-delimiters-depth-4">)</span>&lt;&lt;16<span class="org-rainbow-delimiters-depth-3">)</span> | <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-4">)(</span>code<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-preprocessor">#define</span> <span class="org-function-name">_HRESULT_TYPEDEF_</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">_sc</span><span class="org-rainbow-delimiters-depth-1">)</span> _sc
<span class="org-preprocessor">#define</span> <span class="org-function-name">_HRESULT_TYPEDEF_</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">_sc</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">HRESULT</span><span class="org-rainbow-delimiters-depth-2">)</span>_sc<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_UNEXPECTED</span>                     _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x8000FFFFL<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_NOTIMPL</span>                        _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80004001L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_OUTOFMEMORY</span>                    _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x8007000EL<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_INVALIDARG</span>                     _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80070057L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_NOINTERFACE</span>                    _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80004002L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_POINTER</span>                        _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80004003L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_HANDLE</span>                         _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80070006L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_ABORT</span>                          _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80004004L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_FAIL</span>                           _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80004005L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_ACCESSDENIED</span>                   _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80070005L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_NOTIMPL</span>                        _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80000001L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_OUTOFMEMORY</span>                    _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80000002L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_INVALIDARG</span>                     _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80000003L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_NOINTERFACE</span>                    _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80000004L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_POINTER</span>                        _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80000005L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_HANDLE</span>                         _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80000006L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_ABORT</span>                          _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80000007L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_FAIL</span>                           _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80000008L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_ACCESSDENIED</span>                   _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x80000009L<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_PENDING</span>                        _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x8000000AL<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_BOUNDS</span>                         _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x8000000BL<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_CHANGED_STATE</span>                  _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x8000000CL<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_ILLEGAL_STATE_CHANGE</span>           _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x8000000DL<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">E_ILLEGAL_METHOD_CALL</span>            _HRESULT_TYPEDEF_<span class="org-rainbow-delimiters-depth-1">(</span>0x8000000EL<span class="org-rainbow-delimiters-depth-1">)</span>


</pre>
</div>

<p>
Window Messages (Winuser.h)
</p>

<div class="org-src-container">
<pre class="src src-cpp"> ... ... 
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_NULL</span>         0x0000
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_CREATE</span>       0x0001
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_DESTROY</span>      0x0002
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_MOVE</span>         0x0003
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_SIZE</span>         0x0005
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_ACTIVATE</span>     0x0006

<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_SETFOCUS</span>                     0x0007
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_KILLFOCUS</span>                    0x0008
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_ENABLE</span>                       0x000A
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_SETREDRAW</span>                    0x000B
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_SETTEXT</span>                      0x000C
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_GETTEXT</span>                      0x000D
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_GETTEXTLENGTH</span>                0x000E
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_PAINT</span>                        0x000F
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_CLOSE</span>                        0x0010
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_DEVMODECHANGE</span>                0x001B
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_ACTIVATEAPP</span>                  0x001C
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_FONTCHANGE</span>                   0x001D
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_TIMECHANGE</span>                   0x001E
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_CANCELMODE</span>                   0x001F
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_SETCURSOR</span>                    0x0020
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_MOUSEACTIVATE</span>                0x0021
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_CHILDACTIVATE</span>                0x0022
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_QUEUESYNC</span>                    0x0023
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_GETMINMAXINFO</span>                0x002
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_COPYDATA</span>                     0x004A
<span class="org-preprocessor">#define</span> <span class="org-variable-name">WM_CANCELJOURNAL</span>                0x004B
  ... ... ... 
</pre>
</div>
</div>
</div>

<div id="outline-container-org8be6048" class="outline-4">
<h4 id="org8be6048"><span class="section-number-4">1.37.5</span> Console</h4>
<div class="outline-text-4" id="text-1-37-5">
<p>
APIs: 
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/console/getconsolecp">GetConsoleCP</a>
<ul class="org-ul">
<li>MSDN: "Retrieves the input code page used by the console
associated with the calling process. A console uses its input
code page to translate keyboard input into the corresponding
character value."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/console/getconsoletitle">GetConsoleTitle</a>
<ul class="org-ul">
<li>"Retrieves the title for the current console window."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/console/attachconsole">AttachConsole</a>
<ul class="org-ul">
<li>MSDN: "Attaches the calling process to the console of the specified process."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/console/allocconsole">AllocConsole</a> -
<ul class="org-ul">
<li>MSDN: "Allocates a new console for the calling process."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/console/freeconsole">FreeConsole</a>
<ul class="org-ul">
<li>MSDN: "Detaches the calling process from its console."</li>
</ul></li>
</ul>

<p>
Console Information
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/console/creation-of-a-console">Creation of a Console</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/console/attaching-to-a-console">Attaching to a Console</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/console/closing-a-console">Closing a Console</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/console/pseudoconsoles">Pseudoconsoles</a></li>
</ul>
</div>
</div>

<div id="outline-container-org5d1567a" class="outline-4">
<h4 id="org5d1567a"><span class="section-number-4">1.37.6</span> Memory Allocation</h4>
<div class="outline-text-4" id="text-1-37-6">
<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/memory/heap-functions">Heap Functions - Windows applications | Microsoft Docs</a></li>

<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/heapapi/nf-heapapi-heapalloc">HeapAlloc</a>
<ul class="org-ul">
<li>MSDN: "Allocates a block of memory from a heap. The allocated
memory is not movable."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/heapapi/nf-heapapi-heapcreate">HeapCreate</a>
<ul class="org-ul">
<li>MSDN: "Creates a private heap object that can be used by the
calling process. The function reserves space in the virtual
address space of the process and allocates physical storage for a
specified initial portion of this block."</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org69eaebe" class="outline-4">
<h4 id="org69eaebe"><span class="section-number-4">1.37.7</span> File</h4>
<div class="outline-text-4" id="text-1-37-7">
<p>
Ref: 
</p>
<ul class="org-ul">
<li><a href="https://www.ugrad.cs.ubc.ca/~cs219/CourseNotes/Windows/win32-functions.html">Win32 Functions</a></li>
<li><a href="https://support.dce.felk.cvut.cz/pos/os_api/win32-2.html">System Software Win32 File API</a></li>
</ul>

<p>
CreateFile.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HANDLE</span> <span class="org-function-name">CreateFile</span><span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpFileName</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">pointer to name of the file </span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">dwDesiredAccess</span>,  <span class="org-comment-delimiter">// </span><span class="org-comment">access (read-write) mode </span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">dwShareMode</span>,  <span class="org-comment-delimiter">// </span><span class="org-comment">share mode </span>
    <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpSecurityAttributes</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">pointer to security descriptor </span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">dwCreationDistribution</span>,   <span class="org-comment-delimiter">// </span><span class="org-comment">how to create </span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">dwFlagsAndAttributes</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">file attributes </span>
    <span class="org-type">HANDLE</span> <span class="org-variable-name">hTemplateFile</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">handle to file with attributes to copy  </span>
   <span class="org-rainbow-delimiters-depth-1">)</span>;   
</pre>
</div>

<p>
ReadFile: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">ReadFile</span><span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-type">HANDLE</span> <span class="org-variable-name">hFile</span>,   <span class="org-comment-delimiter">// </span><span class="org-comment">handle of file to read </span>
    <span class="org-type">LPVOID</span> <span class="org-variable-name">lpBuffer</span>,    <span class="org-comment-delimiter">// </span><span class="org-comment">address of buffer that receives data  </span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">nNumberOfBytesToRead</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">number of bytes to read </span>
    <span class="org-type">LPDWORD</span> <span class="org-variable-name">lpNumberOfBytesRead</span>,    <span class="org-comment-delimiter">// </span><span class="org-comment">address of number of bytes read </span>
    <span class="org-type">LPOVERLAPPED</span> <span class="org-variable-name">lpOverlapped</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">address of structure for data </span>
   <span class="org-rainbow-delimiters-depth-1">)</span>;   

</pre>
</div>

<p>
WriteFile:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">WriteFile</span><span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-type">HANDLE</span> <span class="org-variable-name">hFile</span>,   <span class="org-comment-delimiter">// </span><span class="org-comment">handle to file to write to </span>
    <span class="org-type">LPCVOID</span> <span class="org-variable-name">lpBuffer</span>,   <span class="org-comment-delimiter">// </span><span class="org-comment">pointer to data to write to file </span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">nNumberOfBytesToWrite</span>,    <span class="org-comment-delimiter">// </span><span class="org-comment">number of bytes to write </span>
    <span class="org-type">LPDWORD</span> <span class="org-variable-name">lpNumberOfBytesWritten</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">pointer to number of bytes written </span>
    <span class="org-type">LPOVERLAPPED</span> <span class="org-variable-name">lpOverlapped</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">pointer to structure needed for overlapped I/O</span>
   <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Copy File: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CopyFile</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpExistingFileName</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">name of an existing file</span>
  <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpNewFileName</span>,      <span class="org-comment-delimiter">// </span><span class="org-comment">name of new file</span>
  <span class="org-type">BOOL</span> <span class="org-variable-name">bFailIfExists</span>          <span class="org-comment-delimiter">// </span><span class="org-comment">operation if file exists</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;

</pre>
</div>

<p>
Delete File: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">DeleteFile</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpFileName</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">file name</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Move File: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">MoveFile</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpExistingFileName</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">file name</span>
  <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpNewFileName</span>       <span class="org-comment-delimiter">// </span><span class="org-comment">new file name</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Create Directory: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CreateDirectory</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpPathName</span>,                         <span class="org-comment-delimiter">// </span><span class="org-comment">directory name</span>
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpSecurityAttributes</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">SD</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Remove Directory: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">RemoveDirectory</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCTSTR</span> <span class="org-variable-name">lpPathName</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">directory name</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org984b538" class="outline-4">
<h4 id="org984b538"><span class="section-number-4">1.37.8</span> Handle - Kernel "Objects"</h4>
<div class="outline-text-4" id="text-1-37-8">
<ul class="org-ul">
<li><a href="https://msdn.microsoft.com/en-us/library/ms724211(v=VS.85).aspx">CloseHandle</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/handleapi/nf-handleapi-compareobjecthandles">CompareObjectHandles</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/ms724251(v=VS.85).aspx">DuplicateHandle</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/ms724329(v=VS.85).aspx">GetHandleInformation</a></li>
</ul>
</div>
</div>

<div id="outline-container-org5081219" class="outline-4">
<h4 id="org5081219"><span class="section-number-4">1.37.9</span> Process Creation</h4>
<div class="outline-text-4" id="text-1-37-9">
<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/system-wsystem?view=vs-2017">system, _wsystem</a>
<ul class="org-ul">
<li>Note: This functions always shows a console window.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">ANSI </span>
<span class="org-type">int</span> <span class="org-function-name">system</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">command</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Wide-unicode version </span>
<span class="org-type">int</span> <span class="org-function-name">_wsystem</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">wchar_t</span>* <span class="org-variable-name">command</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/popen-wpopen?view=vs-2017">_popen, _wpopen</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">FILE</span> *<span class="org-function-name">_popen</span><span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">command</span>,
    <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">mode</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">FILE</span> *<span class="org-function-name">_wpopen</span><span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-keyword">const</span> <span class="org-type">wchar_t</span> *<span class="org-variable-name">command</span>,
    <span class="org-keyword">const</span> <span class="org-type">wchar_t</span> *<span class="org-variable-name">mode</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa">CreateProcessA</a> (ANSI Version)
<ul class="org-ul">
<li>MSDN: "Creates a new process and its primary thread. The new
process runs in the security context of the calling process."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CreateProcessA</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCSTR</span>                <span class="org-variable-name">lpApplicationName</span>,   <span class="org-comment-delimiter">// </span><span class="org-comment">const char*</span>
  <span class="org-type">LPSTR</span>                 <span class="org-variable-name">lpCommandLine</span>,       <span class="org-comment-delimiter">// </span><span class="org-comment">char*</span>
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpProcessAttributes</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">SECURITY_ATTRIBUTES*</span>
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpThreadAttributes</span>,  <span class="org-comment-delimiter">// </span><span class="org-comment">SECURITY_ATTRIBUTES*</span>
  <span class="org-type">BOOL</span>                  <span class="org-variable-name">bInheritHandles</span>,     <span class="org-comment-delimiter">// </span>
  <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwCreationFlags</span>,     <span class="org-comment-delimiter">// </span><span class="org-comment">DWORD - int </span>
  <span class="org-type">LPVOID</span>                <span class="org-variable-name">lpEnvironment</span>,       <span class="org-comment-delimiter">// </span><span class="org-comment">void*</span>
  <span class="org-type">LPCSTR</span>                <span class="org-variable-name">lpCurrentDirectory</span>,  <span class="org-comment-delimiter">// </span><span class="org-comment">const char*</span>
  <span class="org-type">LPSTARTUPINFOA</span>        <span class="org-variable-name">lpStartupInfo</span>,       <span class="org-comment-delimiter">// </span><span class="org-comment">STARTUPINFOA*</span>
  <span class="org-type">LPPROCESS_INFORMATION</span> <span class="org-variable-name">lpProcessInformation</span> <span class="org-comment-delimiter">// </span><span class="org-comment">PROCESS_INFORMATION*</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessw">CreateProcessW</a> (wide Unicode version)</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">CreateProcessW</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">LPCWSTR</span>               <span class="org-variable-name">lpApplicationName</span>,   <span class="org-comment-delimiter">// </span><span class="org-comment">const wchar_t*</span>
  <span class="org-type">LPWSTR</span>                <span class="org-variable-name">lpCommandLine</span>,       <span class="org-comment-delimiter">// </span><span class="org-comment">wchar_t*</span>
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpProcessAttributes</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">SECURITY_ATTRIBUTES*</span>
  <span class="org-type">LPSECURITY_ATTRIBUTES</span> <span class="org-variable-name">lpThreadAttributes</span>,  <span class="org-comment-delimiter">// </span><span class="org-comment">SECURITY_ATTRIBUTES*</span>
  <span class="org-type">BOOL</span>                  <span class="org-variable-name">bInheritHandles</span>,     <span class="org-comment-delimiter">// </span><span class="org-comment">C++ bool </span>
  <span class="org-type">DWORD</span>                 <span class="org-variable-name">dwCreationFlags</span>,     <span class="org-comment-delimiter">// </span><span class="org-comment">DWORD / int </span>
  <span class="org-type">LPVOID</span>                <span class="org-variable-name">lpEnvironment</span>,       <span class="org-comment-delimiter">// </span><span class="org-comment">void* </span>
  <span class="org-type">LPCWSTR</span>               <span class="org-variable-name">lpCurrentDirectory</span>,  <span class="org-comment-delimiter">// </span><span class="org-comment">const wchar_t*</span>
  <span class="org-type">LPSTARTUPINFOW</span>        <span class="org-variable-name">lpStartupInfo</span>,       <span class="org-comment-delimiter">// </span><span class="org-comment">STARTUPINFOW*</span>
  <span class="org-type">LPPROCESS_INFORMATION</span> <span class="org-variable-name">lpProcessInformation</span> <span class="org-comment-delimiter">// </span><span class="org-comment">PPROCESS_INFORMATION*</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org4605397" class="outline-4">
<h4 id="org4605397"><span class="section-number-4">1.37.10</span> Process Information</h4>
<div class="outline-text-4" id="text-1-37-10">
<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-getcurrentprocessid">GetCurrentProcessId</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">DWORD</span> <span class="org-function-name">GetCurrentProcessId</span><span class="org-rainbow-delimiters-depth-1">()</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-getcurrentprocess">GetCurrentProcess</a>
<ul class="org-ul">
<li>Returns handle to current process.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HANDLE</span> <span class="org-function-name">GetCurrentProcess</span><span class="org-rainbow-delimiters-depth-1">()</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgea53c4f" class="outline-4">
<h4 id="orgea53c4f"><span class="section-number-4">1.37.11</span> Process Manipulation</h4>
<div class="outline-text-4" id="text-1-37-11">
<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa">CreateProcessA</a> and <a href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessw">CreateProcessW</a>
<ul class="org-ul">
<li>MSDN: "Creates a new process and its primary thread. The new
process runs in the security context of the calling process."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess">TerminateProcess</a>
<ul class="org-ul">
<li>MSDN: "Terminates the specified process and all of its threads."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">TerminateProcess</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span> <span class="org-variable-name">hProcess</span>,
  <span class="org-type">UINT</span>   <span class="org-variable-name">uExitCode</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-openprocess">OpenProcess</a>
<ul class="org-ul">
<li>MSDN: "Opens an existing local process object."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HANDLE</span> <span class="org-function-name">OpenProcess</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">DWORD</span> <span class="org-variable-name">dwDesiredAccess</span>,
  <span class="org-type">BOOL</span>  <span class="org-variable-name">bInheritHandle</span>,
  <span class="org-type">DWORD</span> <span class="org-variable-name">dwProcessId</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680553(v=vs.85).aspx">ReadProcessMemory</a>
<ul class="org-ul">
<li>MSDN: "Reads data <span class="underline">from an area of memory in a specified process</span>. The
entire area to be read must be accessible or the operation
fails."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">BOOL <span class="org-type">WINAPI</span> <span class="org-function-name">ReadProcessMemory</span><span class="org-rainbow-delimiters-depth-1">(</span>
  _In_  <span class="org-type">HANDLE</span>  <span class="org-variable-name">hProcess</span>,
  _In_  <span class="org-type">LPCVOID</span> <span class="org-variable-name">lpBaseAddress</span>,
  _Out_ <span class="org-type">LPVOID</span>  <span class="org-variable-name">lpBuffer</span>,
  _In_  <span class="org-type">SIZE_T</span>  <span class="org-variable-name">nSize</span>,
  _Out_ <span class="org-type">SIZE_T</span>  *<span class="org-variable-name">lpNumberOfBytesRead</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createremotethread">CreateRemoteThread</a>
<ul class="org-ul">
<li>MSDN: "Use the CreateRemoteThreadEx <span class="underline">function to create a thread that</span>
<span class="underline">runs in the virtual address space of another process and</span>
optionally specify extended attributes."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">HANDLE</span> <span class="org-function-name">CreateRemoteThread</span><span class="org-rainbow-delimiters-depth-1">(</span>
  <span class="org-type">HANDLE</span>                 <span class="org-variable-name">hProcess</span>,
  <span class="org-type">LPSECURITY_ATTRIBUTES</span>  <span class="org-variable-name">lpThreadAttributes</span>,
  <span class="org-type">SIZE_T</span>                 <span class="org-variable-name">dwStackSize</span>,
  <span class="org-type">LPTHREAD_START_ROUTINE</span> <span class="org-variable-name">lpStartAddress</span>,
  <span class="org-type">LPVOID</span>                 <span class="org-variable-name">lpParameter</span>,
  <span class="org-type">DWORD</span>                  <span class="org-variable-name">dwCreationFlags</span>,
  <span class="org-type">LPDWORD</span>                <span class="org-variable-name">lpThreadId</span>
<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orge5a362a" class="outline-4">
<h4 id="orge5a362a"><span class="section-number-4">1.37.12</span> GUI _ Graphical User Interface</h4>
<div class="outline-text-4" id="text-1-37-12">
</div>
<ol class="org-ol">
<li><a id="org13ec5a6"></a>GDI - Graphics Device Interface<br />
<div class="outline-text-5" id="text-1-37-12-1">
<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/gdi/windows-gdi">Windows GDI - Windows applications | Microsoft Docs</a></li>
</ul>

<p>
Functions:
</p>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/wingdi/nf-wingdi-anglearc">AngleArc</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/wingdi/nf-wingdi-arc">Arc</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/wingdi/nf-wingdi-ellipse">Ellipse</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-drawtext">DrawText</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-getmonitorinfow">GetMonitorInfoW</a></li>
</ul>
</div>
</li>

<li><a id="orgec6aca2"></a>Common Dialogs<br />
<div class="outline-text-5" id="text-1-37-12-2">
<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/dlgbox/common-dialog-box-library">Common Dialog Box Library</a></li>
</ul>
</div>
</li>
</ol>
</div>

<div id="outline-container-org4e24cf6" class="outline-4">
<h4 id="org4e24cf6"><span class="section-number-4">1.37.13</span> Dynamic Linking or Runtime Linking</h4>
<div class="outline-text-4" id="text-1-37-13">
<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-loadlibrarya">LoadLibraryA</a> and <a href="https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-loadlibraryw">LoadLibraryW</a>
<ul class="org-ul">
<li>MSDN: "Loads the specified module into the address space of the calling
process. The specified module may cause other modules to be
loaded."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">ANSI API </span>
<span class="org-type">HMODULE</span> <span class="org-function-name">LoadLibraryA</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">LPCSTR</span> <span class="org-variable-name">lpLibFileName</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Unicode API </span>
<span class="org-type">HMODULE</span> <span class="org-function-name">LoadLibraryW</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">LPCWSTR</span> <span class="org-variable-name">lpLibFileName</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-getprocaddress">GetProcAddress</a>
<ul class="org-ul">
<li>MSDN: "Retrieves the <span class="underline">address of an exported function</span> (function pointer)
or variable from the specified dynamic-link library (DLL)."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">FARPROC</span> <span class="org-function-name">GetProcAddress</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HMODULE</span> <span class="org-variable-name">hModule</span>, <span class="org-type">LPCSTR</span>  <span class="org-variable-name">lpProcName</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-freelibrary">FreeLibrary</a>
<ul class="org-ul">
<li>MSDN: "Frees the loaded dynamic-link library (DLL) module and, if
necessary, decrements its reference count. When the reference
count reaches zero, the module is unloaded from the address space
of the calling process and the handle is no longer valid."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">BOOL</span> <span class="org-function-name">FreeLibrary</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">HMODULE</span> <span class="org-variable-name">hLibModule</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgaf0962a" class="outline-3">
<h3 id="orgaf0962a"><span class="section-number-3">1.38</span> Books</h3>
<div class="outline-text-3" id="text-1-38">
<p>
Books: 
</p>

<ul class="org-ul">
<li>Mark Russinovitch et al - <b>Windows Internals</b> - 5th edition -
Microsft Press 2000.</li>

<li><b>Windows Operating System Internals Curriculum</b>  Development Kit,
developed by David A. Solomon and  Mark E. Russinovich with
Andreas Polze.</li>

<li>Penny Orwick and Guy Smith. <b>Developing Drivers with Windows Driver Foundation</b>.</li>

<li>Charles Petzold: <b>Windows Programming</b> - Microsoft Press.</li>

<li>Visual Basic - <b>Programmer’s Guide to the Win32 API</b>, The
Authoritative Solution by Dan Appleman</li>

<li>Johnson M. Hart, <b>Win32 System Programming: A Windows® 2000</b> -
<b>Application Developer's Guide</b>, 2nd Edition, Addison -
Wesley, 2000.
<ul class="org-ul">
<li>Note: This book discusses select Windows programming problems
and addresses  the problem of portable programming by comparing
Windows and Unixapproaches.</li>
</ul></li>

<li>Jeffrey Richter, <b>Programming Applications for Microsoft Windows</b>,
4th Edition, Microsoft Press, September 1999.
<ul class="org-ul">
<li>Note: This book provides a comprehensive discussion of the
Windows API suggested reading.</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2022-08-16 Tue 23:27</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
